<!DOCTYPE html>
<!--
  ============================================================
  Lingua v26 - Auth & Daily Fix
  ============================================================
  
  üîß Fixes in v26:
  ‚úÖ Google login redirect now properly navigates to dashboard
  ‚úÖ Daily sentence display fixed (no more "‚Äî")
  ‚úÖ Improved data loading synchronization
  
  Changes from v25:
  1. Made loadUserDataFromFirestore async/await in auth flow
  2. Added fallback for daily sentence when S.lang is undefined
  3. Added console logging for debugging dashboard entry
  4. Better error handling in daily sentence display
  
  All v25 features still included:
  - Stripe payment integration
  - IndexedDB for unlimited storage
  - Mobile UI improvements (dvh units)
  - AI usage limits
  - Pro/Free tier differentiation
  
  Firebase Console setup required (same as v25)
  
  ============================================================
-->
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lingua ‚Äî „Ç≥„É≥„É©„É≥„Ç∞„Éì„É´„ÉÄ„Éº</title>

<!-- Stripe.js SDK -->
<script src="https://js.stripe.com/v3/"></script>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Pro:ital,wght@0,300;0,400;0,500;1,300;1,400&family=Noto+Sans+JP:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0a0e;--surface:#13131a;--surface-hover:#1a1a24;--surface-2:#1e1e28;--surface-3:#252532;
  --border:rgba(140,120,255,0.09);--border-hover:rgba(140,120,255,0.2);--border-bright:rgba(140,120,255,0.35);
  --text-primary:#e8e4f0;--text-secondary:#8a8498;--text-muted:#44404e;
  --accent:#8c7eff;--accent-dim:rgba(140,126,255,0.10);--accent-border:rgba(140,126,255,0.28);
  --accent2:#c07bff;--accent2-dim:rgba(192,123,255,0.10);
  --success:#4db87a;--success-dim:rgba(77,184,122,0.10);--success-border:rgba(77,184,122,0.28);
  --gold:#c9a96e;--gold-dim:rgba(201,169,110,0.10);--gold-border:rgba(201,169,110,0.28);
  --rose:#e87a7a;--rose-dim:rgba(232,122,122,0.10);--rose-border:rgba(232,122,122,0.28);
  --nebula:linear-gradient(135deg,#1a0a2e,#0a0a1e,#0e1a2e);
  --glow-accent:0 0 20px rgba(140,126,255,0.15);
  --glow-gold:0 0 20px rgba(201,169,110,0.12);
  --bottom-nav-h:64px;
  --vh-full: 100dvh; /* Fallback for browsers without dvh support */
}

/* dvh support detection for mobile browsers */
@supports (height: 100dvh) {
  :root {
    --vh-full: 100dvh;
  }
}
body{background:var(--bg);color:var(--text-primary);font-family:'Crimson Pro','Noto Sans JP',serif;min-height:var(--vh-full);-webkit-font-smoothing:antialiased;font-size:15px;background-image:var(--nebula);background-attachment:fixed;overscroll-behavior-y:none;-webkit-overflow-scrolling:touch}
body::before{content:'';position:fixed;inset:0;background-image:radial-gradient(1px 1px at 10% 20%,rgba(255,255,255,0.3) 0%,transparent 100%),radial-gradient(1px 1px at 30% 60%,rgba(255,255,255,0.2) 0%,transparent 100%),radial-gradient(1px 1px at 60% 10%,rgba(255,255,255,0.25) 0%,transparent 100%),radial-gradient(1px 1px at 80% 45%,rgba(255,255,255,0.2) 0%,transparent 100%),radial-gradient(1px 1px at 90% 80%,rgba(255,255,255,0.15) 0%,transparent 100%),radial-gradient(1px 1px at 50% 90%,rgba(255,255,255,0.2) 0%,transparent 100%),radial-gradient(1px 1px at 20% 85%,rgba(255,255,255,0.15) 0%,transparent 100%),radial-gradient(1.5px 1.5px at 70% 70%,rgba(140,126,255,0.35) 0%,transparent 100%),radial-gradient(1.5px 1.5px at 15% 50%,rgba(192,123,255,0.25) 0%,transparent 100%);pointer-events:none;z-index:0}
body>*{position:relative;z-index:1}

/* TOPBAR */
.topbar{height:54px;border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 24px;justify-content:space-between;position:sticky;top:0;background:rgba(10,10,14,0.88);backdrop-filter:blur(18px) saturate(1.5);z-index:100}
.brand{font-family:'Cinzel',serif;font-size:1.1rem;font-weight:700;cursor:pointer;color:var(--text-primary);letter-spacing:0.12em;background:linear-gradient(135deg,#e8e4f0,#8c7eff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.topbar-right{display:flex;align-items:center;gap:8px}
.avatar{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));border:1px solid var(--accent-border);color:#fff;display:flex;align-items:center;justify-content:center;font-size:0.68rem;font-weight:700;cursor:pointer;box-shadow:var(--glow-accent)}
.pro-badge{font-size:0.65rem;padding:3px 8px;border-radius:6px;background:linear-gradient(135deg,var(--gold),#d4a76a);color:#1a0a0a;font-weight:700;letter-spacing:0.08em;box-shadow:var(--glow-gold)}
.free-badge{font-size:0.65rem;padding:3px 8px;border-radius:6px;background:var(--surface-2);color:var(--text-muted);font-weight:600;letter-spacing:0.06em;border:1px solid var(--border)}
.topbar-nav{display:flex;align-items:center;gap:2px}
.topbar-navbtn{font-family:'Crimson Pro',serif;font-size:0.82rem;font-weight:500;padding:5px 13px;border-radius:6px;border:none;background:transparent;color:var(--text-secondary);cursor:pointer;transition:all 0.15s;letter-spacing:0.01em}
.topbar-navbtn:hover{background:var(--surface);color:var(--text-primary)}
.topbar-navbtn.active{background:var(--accent-dim);color:var(--accent);border:1px solid var(--accent-border)}

/* BOTTOM NAV (mobile) */
.bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;height:var(--bottom-nav-h);background:rgba(10,10,14,0.98);backdrop-filter:blur(20px) saturate(1.5);border-top:1px solid var(--border);z-index:200;padding:0 4px;padding-bottom:env(safe-area-inset-bottom,0px);-webkit-tap-highlight-color:transparent}
.bottom-nav-inner{display:flex;align-items:center;height:100%;gap:2px}
.bnav-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;padding:8px 4px;border:none;background:transparent;cursor:pointer;border-radius:10px;transition:all 0.18s;color:var(--text-muted);position:relative;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
.bnav-btn:active{transform:scale(0.94)}
.bnav-btn.active{color:var(--accent)}
.bnav-btn.active .bnav-icon-wrap{background:var(--accent-dim);border-color:var(--accent-border)}
.bnav-icon-wrap{width:40px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:12px;border:1px solid transparent;transition:all 0.18s;font-size:1.1rem}
.bnav-label{font-family:'Noto Sans JP',sans-serif;font-size:0.58rem;font-weight:500;letter-spacing:0.03em;transition:color 0.18s;white-space:nowrap}

/* BUTTONS */
.btn{font-family:inherit;font-size:0.83rem;font-weight:500;padding:7px 16px;border-radius:7px;border:1px solid var(--border);background:var(--surface);color:var(--text-primary);cursor:pointer;transition:all 0.15s;display:inline-flex;align-items:center;gap:6px}
.btn:hover{background:var(--surface-hover);border-color:var(--border-hover)}
.btn:active{transform:scale(0.97)}
.btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border-color:transparent;box-shadow:var(--glow-accent)}
.btn-primary:hover{filter:brightness(1.1);background:linear-gradient(135deg,var(--accent),var(--accent2))}
.btn-ghost{background:transparent;border-color:transparent;color:var(--text-secondary)}
.btn-ghost:hover{background:var(--surface);border-color:var(--border);color:var(--text-primary)}
.btn-sm{font-size:0.76rem;padding:5px 11px;border-radius:6px}
.btn-gold{background:var(--gold-dim);color:var(--gold);border-color:var(--gold-border)}
.btn-gold:hover{background:rgba(201,169,110,0.18)}

/* PAGES */
.page{display:none}
.page.active{display:block}
#page-login.active{display:flex;min-height:calc(100dvh - 54px);align-items:center;justify-content:center;padding:40px 24px}

/* LOGIN */
.login-box{width:100%;max-width:360px}
.login-box h2{font-family:'Cinzel',serif;font-size:1.6rem;font-weight:700;letter-spacing:0.06em;margin-bottom:6px;background:linear-gradient(135deg,var(--text-primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.login-box .sub{font-size:0.85rem;color:var(--text-secondary);margin-bottom:28px;font-style:italic}
.form-group{margin-bottom:14px}
.form-group label{display:block;font-size:0.76rem;font-weight:500;color:var(--text-secondary);margin-bottom:6px;letter-spacing:0.06em;text-transform:uppercase}
.form-group input{width:100%;padding:10px 13px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:0.88rem;background:var(--surface-2);color:var(--text-primary);outline:none;transition:all 0.15s}
.form-group input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim)}
.form-group input::placeholder{color:var(--text-muted)}
.divider-or{display:flex;align-items:center;gap:12px;margin:18px 0;font-size:0.72rem;color:var(--text-muted)}
.divider-or::before,.divider-or::after{content:'';flex:1;height:1px;background:var(--border)}
.login-footer{margin-top:16px;font-size:0.75rem;color:var(--text-muted);text-align:center}
.login-footer a{color:var(--accent);text-decoration:none;cursor:pointer}
.login-divider{display:flex;align-items:center;gap:10px;margin:20px 0;color:var(--text-muted);font-size:0.72rem;letter-spacing:0.06em;text-transform:uppercase}
.login-divider::before,.login-divider::after{content:'';flex:1;height:1px;background:var(--border)}
.login-google-btn{width:100%;padding:12px 18px;border-radius:10px;border:1px solid var(--border-hover);background:var(--surface-2);display:flex;align-items:center;justify-content:center;gap:12px;cursor:pointer;transition:all 0.18s;font-size:0.88rem;font-weight:600;color:var(--text-primary);font-family:inherit}
.login-google-btn:hover{background:var(--surface-3);border-color:var(--border-bright);box-shadow:0 2px 14px rgba(0,0,0,0.3)}
.login-google-btn svg{width:20px;height:20px;flex-shrink:0}
.login-guest-btn{width:100%;padding:9px;border:none;background:transparent;color:var(--text-muted);font-size:0.78rem;font-family:inherit;cursor:pointer;transition:color 0.15s;text-decoration:underline;text-underline-offset:3px}
.login-guest-btn:hover{color:var(--text-secondary)}
.login-features{display:flex;flex-direction:column;gap:7px;margin:18px 0;padding:16px;background:var(--surface-2);border:1px solid var(--border);border-radius:10px}
.login-feature-item{display:flex;align-items:flex-start;gap:10px;font-size:0.8rem;color:var(--text-secondary);line-height:1.5}
.login-feature-icon{font-size:0.9rem;flex-shrink:0;margin-top:1px}

/* SETUP */
#page-setup{min-height:calc(100dvh - 54px);display:none;align-items:center;justify-content:center;padding:40px 24px}
#page-setup.active{display:flex}
.setup-box{width:100%;max-width:560px}
.setup-step{display:none;animation:fadeUp 0.3s ease both}
.setup-step.active{display:block}
.setup-title{font-family:'Cinzel',serif;font-size:1.4rem;font-weight:600;letter-spacing:0.04em;margin-bottom:8px}
.setup-sub{font-size:0.86rem;color:var(--text-secondary);margin-bottom:32px;line-height:1.7;font-style:italic}
.setup-progress{display:flex;gap:6px;margin-bottom:36px}
.setup-dot{height:3px;flex:1;border-radius:2px;background:var(--surface-3);transition:background 0.3s}
.setup-dot.done{background:var(--text-primary)}
.setup-dot.active{background:linear-gradient(90deg,var(--accent),var(--accent2))}
.route-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.route-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:24px;cursor:pointer;transition:all 0.18s;text-align:left}
.route-card:hover{background:var(--surface-hover);border-color:var(--border-hover);transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,0,0,0.4)}
.route-card.selected{border-color:var(--accent-border);background:var(--accent-dim);box-shadow:var(--glow-accent)}
.route-icon{font-size:1.4rem;margin-bottom:12px}
.route-title{font-size:0.9rem;font-weight:600;margin-bottom:6px}
.route-desc{font-size:0.77rem;color:var(--text-secondary);line-height:1.6}
.script-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.script-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px 12px;cursor:pointer;transition:all 0.15s;text-align:center}
.script-card:hover{border-color:var(--border-hover);background:var(--surface-hover)}
.script-card.selected{border-color:var(--accent-border);background:var(--accent-dim);box-shadow:var(--glow-accent)}
.script-sample{font-size:1.1rem;margin-bottom:6px;line-height:1.3}
.script-name{font-size:0.76rem;font-weight:500;color:var(--text-primary)}
.script-sub{font-size:0.65rem;color:var(--text-muted);margin-top:3px}

/* DASHBOARD */
#page-dashboard{padding:36px 40px 120px;max-width:1040px;margin:0 auto}
.dash-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:32px;flex-wrap:wrap;gap:16px}
.dash-langname{font-family:'Cinzel',serif;font-size:1.8rem;font-weight:700;letter-spacing:0.04em;margin-bottom:4px;background:linear-gradient(135deg,var(--text-primary) 60%,var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.dash-meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
.meta-chip{font-size:0.68rem;color:var(--text-muted);background:var(--surface);border:1px solid var(--border);border-radius:5px;padding:3px 9px;letter-spacing:0.04em}
.meta-chip.accent{color:var(--accent);border-color:var(--accent-border);background:var(--accent-dim);cursor:pointer}
.dash-progress{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:22px;margin-bottom:28px;display:flex;align-items:center;gap:28px;flex-wrap:wrap;box-shadow:inset 0 0 40px rgba(140,126,255,0.04)}
.progress-ring{position:relative;width:84px;height:84px;flex-shrink:0}
.progress-ring svg{transform:rotate(-90deg)}
.ring-num{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.ring-pct{font-family:'Cinzel',serif;font-size:1.1rem;font-weight:700;background:linear-gradient(135deg,var(--text-primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.ring-label{font-size:0.55rem;color:var(--text-muted);letter-spacing:0.1em;text-transform:uppercase;margin-top:1px}
.dash-stats{display:flex;gap:24px;flex-wrap:wrap}
.stat{text-align:center}
.stat-num{font-family:'Cinzel',serif;font-size:1.4rem;font-weight:600;letter-spacing:-0.01em;color:var(--text-primary)}
.stat-label{font-size:0.65rem;color:var(--text-muted);margin-top:2px;letter-spacing:0.06em;text-transform:uppercase}
.section-label{font-size:0.6rem;font-weight:600;letter-spacing:0.18em;text-transform:uppercase;color:var(--text-muted);margin-bottom:12px;margin-top:32px;display:flex;align-items:center;gap:8px}
.section-label::after{content:'';flex:1;height:1px;background:var(--border)}
.module-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:10px}
.module-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;cursor:pointer;transition:all 0.18s;position:relative;overflow:hidden}
.module-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent 60%,rgba(140,126,255,0.03));pointer-events:none}
.module-card:hover{background:var(--surface-hover);border-color:var(--border-hover);transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,0,0,0.35)}
.module-card.done{border-color:var(--success-border);box-shadow:0 0 20px rgba(77,184,122,0.06)}
.module-card.in-progress{border-color:var(--gold-border);box-shadow:0 0 20px rgba(201,169,110,0.06)}
.module-badge{position:absolute;top:14px;right:14px;font-size:0.6rem;font-weight:600;border-radius:20px;padding:2px 8px;letter-spacing:0.05em}
.badge-done{color:var(--success);background:var(--success-dim);border:1px solid var(--success-border)}
.badge-progress{color:var(--gold);background:var(--gold-dim);border:1px solid var(--gold-border)}
.module-icon{font-size:1.3rem;margin-bottom:10px}
.module-title{font-size:0.88rem;font-weight:600;margin-bottom:5px}
.module-desc{font-size:0.76rem;color:var(--text-secondary);line-height:1.6}
.module-preview{margin-top:10px;padding-top:10px;border-top:1px solid var(--border);display:flex;flex-wrap:wrap;gap:4px;min-height:24px}
.preview-chip{font-size:0.63rem;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;padding:2px 7px;color:var(--text-secondary)}
.preview-chip.accent{color:var(--accent);border-color:var(--accent-border);background:var(--accent-dim)}

/* DAILY card */
.daily-card{background:var(--surface);border:1px solid var(--gold-border);border-radius:14px;padding:22px;margin-bottom:10px;position:relative;overflow:hidden;box-shadow:var(--glow-gold)}
.daily-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--gold),var(--accent2),transparent)}
.daily-badge{font-size:0.6rem;font-weight:600;color:var(--gold);letter-spacing:0.14em;text-transform:uppercase;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.daily-sentence{font-family:'Cinzel',serif;font-size:1.1rem;font-weight:600;margin-bottom:8px;color:var(--text-primary);letter-spacing:0.02em}
.daily-sub{font-size:0.78rem;color:var(--text-secondary);font-style:italic}
.daily-input-wrap{margin-top:14px;display:flex;gap:8px}
.daily-input{flex:1;padding:9px 13px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:0.88rem;background:var(--surface-2);color:var(--text-primary);outline:none;transition:all 0.15s}
.daily-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim)}
.daily-input::placeholder{color:var(--text-muted)}

/* EDITOR OVERLAY */
.editor-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.72);backdrop-filter:blur(6px);z-index:200;display:none;align-items:flex-end;justify-content:center}
.editor-overlay.open{display:flex;animation:fadeIn 0.2s ease both}
.editor-panel{background:var(--surface);border:1px solid var(--border);border-radius:18px 18px 0 0;width:100%;max-width:760px;max-height:92vh;overflow-y:auto;animation:slideUp 0.32s cubic-bezier(0.32,0.72,0,1) both;padding:28px 32px 52px;box-shadow:0 -20px 60px rgba(0,0,0,0.5)}
.editor-panel::-webkit-scrollbar{width:5px}
.editor-panel::-webkit-scrollbar-track{background:transparent}
.editor-panel::-webkit-scrollbar-thumb{background:var(--border-hover);border-radius:3px}
.editor-handle{width:36px;height:4px;background:var(--border-hover);border-radius:2px;margin:0 auto 22px}
.editor-header{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;margin-bottom:24px}
.editor-title{font-family:'Cinzel',serif;font-size:1.15rem;font-weight:600;letter-spacing:0.04em}
.editor-desc{font-size:0.78rem;color:var(--text-secondary);margin-top:5px;line-height:1.6;font-style:italic}
.editor-close{width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:var(--surface-2);color:var(--text-secondary);cursor:pointer;font-size:0.9rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.15s}
.editor-close:hover{background:var(--rose-dim);border-color:var(--rose-border);color:var(--rose)}
.editor-footer{display:flex;justify-content:flex-end;gap:8px;margin-top:28px;padding-top:20px;border-top:1px solid var(--border)}

/* TABS */
.editor-tabs{display:flex;gap:2px;border-bottom:1px solid var(--border);margin-bottom:22px;overflow-x:auto;scrollbar-width:none}
.editor-tabs::-webkit-scrollbar{display:none}
.editor-tab{padding:8px 15px;font-size:0.77rem;font-weight:500;color:var(--text-muted);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all 0.15s;white-space:nowrap;flex-shrink:0;letter-spacing:0.03em}
.editor-tab:hover{color:var(--text-secondary)}
.editor-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab-content{display:none}
.tab-content.active{display:block;animation:fadeIn 0.2s ease both}

/* FORM */
.field-block{margin-bottom:22px}
.field-label{font-size:0.72rem;font-weight:600;color:var(--text-secondary);margin-bottom:9px;display:block;letter-spacing:0.08em;text-transform:uppercase}
.field-hint{font-size:0.7rem;color:var(--text-muted);margin-top:6px;line-height:1.6;font-style:italic}
.textarea-field{width:100%;padding:11px 13px;border:1px solid var(--border);border-radius:9px;font-family:inherit;font-size:0.85rem;background:var(--surface-2);color:var(--text-primary);outline:none;transition:all 0.15s;resize:none;min-height:80px;overflow:hidden}
.textarea-field:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim)}
.textarea-field::placeholder{color:var(--text-muted)}
.input-field{width:100%;padding:9px 13px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:0.85rem;background:var(--surface-2);color:var(--text-primary);outline:none;transition:all 0.15s}
.input-field:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim)}
.input-field::placeholder{color:var(--text-muted)}
/* Validation states */
.input-field.valid{border-color:var(--success-border)}
.input-field.invalid{border-color:var(--rose-border);box-shadow:0 0 0 2px var(--rose-dim)}
.validation-msg{font-size:0.68rem;margin-top:4px;line-height:1.5;display:none}
.validation-msg.show{display:block}
.validation-msg.error{color:var(--rose)}
.validation-msg.ok{color:var(--success)}

/* PHONEME */
.phoneme-grid{display:flex;flex-wrap:wrap;gap:6px}
.phoneme-btn{width:46px;height:42px;border:1px solid var(--border);border-radius:8px;background:var(--surface-2);font-size:0.9rem;font-weight:500;cursor:pointer;transition:all 0.12s;display:flex;align-items:center;justify-content:center;color:var(--text-primary);font-family:monospace}
.phoneme-btn:hover{border-color:var(--border-hover)}
.phoneme-btn.selected{border-color:var(--accent-border);background:var(--accent-dim);color:var(--accent);font-weight:700;box-shadow:var(--glow-accent)}
.phoneme-btn.playing{border-color:var(--gold-border);background:var(--gold-dim);color:var(--gold)}

/* IPA FLOATING TOOLBAR */
.ipa-float-toolbar{background:var(--surface-3);border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:10px;position:sticky;top:0;z-index:10;backdrop-filter:blur(10px)}
.ipa-float-inner{display:flex;flex-direction:column;gap:8px}
.ipa-float-row{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.ipa-float-label{font-size:0.58rem;color:var(--text-muted);letter-spacing:0.1em;text-transform:uppercase;min-width:40px;flex-shrink:0}
.ipa-float-btn{padding:4px 8px;border:1px solid var(--border);border-radius:6px;background:var(--surface-2);font-size:0.84rem;font-family:monospace;color:var(--text-primary);cursor:pointer;transition:all 0.1s;min-width:32px;text-align:center}
.ipa-float-btn:hover{border-color:var(--accent-border);background:var(--accent-dim);color:var(--accent)}
.ipa-float-btn.pinned{border-color:var(--gold-border);background:var(--gold-dim);color:var(--gold)}
.ipa-float-hint{font-size:0.62rem;color:var(--text-muted);font-style:italic;margin-top:3px}

/* FULL IPA TABLE */
.ipa-table-wrap{overflow-x:auto;overflow-y:auto;max-height:340px;margin-top:8px;border-radius:8px;border:1px solid var(--border);scrollbar-width:thin;scrollbar-color:var(--border) transparent;-webkit-overflow-scrolling:touch;touch-action:pan-x pan-y}
.ipa-table{width:100%;border-collapse:collapse;font-size:0.75rem}
.ipa-table th{background:var(--surface-3);color:var(--text-muted);padding:6px 8px;border:1px solid var(--border);font-size:0.62rem;font-weight:600;letter-spacing:0.06em;text-align:center;white-space:nowrap}
.ipa-table th:first-child{text-align:left;min-width:90px}
.ipa-table td{border:1px solid var(--border);padding:4px;text-align:center;background:var(--surface-2)}
.ipa-cell{display:inline-flex;flex-direction:column;gap:2px}
/* V11: larger tap targets + vivid flash feedback */
.ipa-cell-btn{padding:5px 7px;border:1px solid transparent;border-radius:5px;background:transparent;font-size:0.85rem;font-family:monospace;color:var(--text-primary);cursor:pointer;transition:background 0.08s,border-color 0.08s,transform 0.08s;min-width:32px;min-height:32px;line-height:1.2;-webkit-tap-highlight-color:transparent;user-select:none;display:flex;align-items:center;justify-content:center}
.ipa-cell-btn:hover{border-color:var(--accent-border);background:var(--accent-dim);color:var(--accent)}
.ipa-cell-btn:active,.ipa-cell-btn.tapped{background:var(--accent) !important;color:#fff !important;border-color:var(--accent) !important;transform:scale(0.88) !important;box-shadow:0 0 12px rgba(140,126,255,0.6) !important}
.ipa-cell-btn.vd{color:var(--accent2)}/* voiced */
.ipa-cell-btn.vl{color:var(--text-secondary)}/* voiceless */
.ipa-cell-btn.registered{background:var(--accent-dim);border-color:var(--accent-border);color:var(--accent)}
.ipa-section-head{background:var(--surface-3) !important}
.ipa-section-label{font-size:0.62rem;font-weight:600;letter-spacing:0.1em;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px;margin-top:14px}
.ipa-row{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:4px}
.ipa-btn{padding:5px 9px;border:1px solid var(--border);border-radius:6px;background:var(--surface-2);font-size:0.82rem;font-family:monospace;color:var(--text-primary);cursor:pointer;transition:background 0.08s,border-color 0.08s,transform 0.08s;-webkit-tap-highlight-color:transparent;user-select:none;min-height:34px;display:inline-flex;align-items:center;justify-content:center}
.ipa-btn:hover{border-color:var(--accent-border);background:var(--accent-dim);color:var(--accent)}
.ipa-btn:active,.ipa-btn.tapped{background:var(--accent) !important;color:#fff !important;border-color:var(--accent) !important;transform:scale(0.88) !important;box-shadow:0 0 10px rgba(140,126,255,0.5) !important}
.ipa-pinbar{display:flex;align-items:center;gap:6px;flex-wrap:wrap;padding:8px 10px;background:var(--surface-2);border:1px solid var(--border);border-radius:8px;margin-bottom:10px;min-height:40px}
.ipa-pinbar-label{font-size:0.58rem;color:var(--text-muted);letter-spacing:0.1em;text-transform:uppercase;flex-shrink:0}
.ipa-pin-btn{padding:4px 9px;border:1px solid var(--gold-border);border-radius:6px;background:var(--gold-dim);font-size:0.82rem;font-family:monospace;color:var(--gold);cursor:pointer;display:inline-flex;align-items:center;gap:3px}
.ipa-pin-btn .unpin{font-size:0.6rem;color:var(--text-muted);margin-left:2px}
.ipa-pin-btn .unpin:hover{color:var(--rose)}

/* SELECT / TOGGLE */
.select-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px}
.select-grid-2{grid-template-columns:repeat(2,1fr)}
.select-option{padding:11px 13px;border:1px solid var(--border);border-radius:9px;background:var(--surface-2);cursor:pointer;transition:all 0.15s;text-align:center}
.select-option:hover{border-color:var(--border-hover);background:var(--surface-hover)}
.select-option.selected{border-color:var(--accent-border);background:var(--accent-dim);box-shadow:var(--glow-accent)}
.opt-label{font-size:0.8rem;font-weight:600;color:var(--text-primary);margin-bottom:3px}
.opt-sub{font-size:0.64rem;color:var(--text-muted);line-height:1.4}
.select-option.selected .opt-label{color:var(--accent)}
.select-option.selected .opt-sub{color:var(--accent);opacity:0.6}
.toggle-grid{display:flex;gap:6px;flex-wrap:wrap}
.toggle-chip{padding:6px 13px;border:1px solid var(--border);border-radius:20px;background:var(--surface-2);font-size:0.76rem;color:var(--text-secondary);cursor:pointer;transition:all 0.12s}
.toggle-chip:hover{border-color:var(--border-hover);color:var(--text-primary)}
.toggle-chip.selected{border-color:var(--accent-border);background:var(--accent-dim);color:var(--accent);font-weight:500}

/* WORD CARD */
.word-card{display:flex;align-items:center;gap:10px;padding:10px 14px;border:1px solid var(--border);border-radius:9px;background:var(--surface-2);margin-bottom:7px;animation:fadeUp 0.2s ease both;transition:border-color 0.15s}
.word-card:hover{border-color:var(--border-hover)}
.word-main{font-size:0.9rem;font-weight:500;color:var(--text-primary)}
.word-meaning{font-size:0.74rem;color:var(--text-secondary);margin-top:2px}
.word-pos{font-size:0.6rem;font-weight:700;color:var(--text-muted);background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:2px 7px;white-space:nowrap;flex-shrink:0;letter-spacing:0.05em;text-transform:uppercase}
.word-tags{display:flex;gap:4px;flex-wrap:wrap;margin-top:3px}
.word-tag{font-size:0.58rem;padding:1px 5px;border:1px solid var(--accent-border);border-radius:3px;color:var(--accent);background:var(--accent-dim)}
.word-play{width:26px;height:26px;border-radius:50%;border:1px solid var(--border);background:var(--surface);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:0.65rem;color:var(--text-muted);transition:all 0.15s;flex-shrink:0}
.word-play:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
.pos-filter-bar{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:12px}
.pos-filter-btn{padding:4px 11px;border:1px solid var(--border);border-radius:20px;background:transparent;font-family:inherit;font-size:0.72rem;color:var(--text-muted);cursor:pointer;transition:all 0.12px}
.pos-filter-btn:hover{border-color:var(--border-hover);color:var(--text-primary)}
.pos-filter-btn.active{border-color:var(--accent-border);background:var(--accent-dim);color:var(--accent);font-weight:500}

/* VOICE */
.voice-row{display:flex;gap:7px;flex-wrap:wrap;margin-top:6px}
.voice-chip{display:flex;align-items:center;gap:6px;padding:5px 12px;border:1px solid var(--border);border-radius:8px;background:var(--surface-2);cursor:pointer;transition:all 0.15s;font-size:0.74rem;color:var(--text-secondary)}
.voice-chip:hover{border-color:var(--border-hover);color:var(--text-primary)}
.voice-chip.playing{border-color:var(--gold-border);background:var(--gold-dim);color:var(--gold)}

/* AI BOX */
.ai-box{background:var(--surface-2);border:1px solid var(--border);border-radius:11px;padding:15px 17px;margin:14px 0}
.ai-label{font-size:0.62rem;font-weight:700;color:var(--accent);letter-spacing:0.12em;text-transform:uppercase;margin-bottom:8px;display:flex;align-items:center;gap:5px}
.ai-content{font-size:0.82rem;color:var(--text-secondary);line-height:1.75}
.ai-chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px}
.ai-chip{padding:5px 12px;background:var(--surface);border:1px solid var(--border);border-radius:7px;font-size:0.74rem;color:var(--text-primary);cursor:pointer;transition:all 0.15s}
.ai-chip:hover{border-color:var(--accent-border);color:var(--accent);background:var(--accent-dim)}

/* CORRECTIONS */
.correction-box{background:var(--rose-dim);border:1px solid var(--rose-border);border-radius:10px;padding:14px 16px;margin-top:12px}
.correction-label{font-size:0.62rem;font-weight:700;color:var(--rose);letter-spacing:0.12em;text-transform:uppercase;margin-bottom:8px}
.correction-item{font-size:0.8rem;color:var(--text-secondary);margin-bottom:4px;line-height:1.6}

/* GACHA */
.gacha-btn{width:100%;padding:13px;border:1px dashed var(--accent-border);border-radius:10px;background:transparent;font-family:inherit;font-size:0.83rem;color:var(--accent);cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:12px}
.gacha-btn:hover{background:var(--accent-dim);box-shadow:var(--glow-accent)}

/* SCRIPT PREVIEW */
.script-preview-wrap{background:var(--surface-2);border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:20px}
.script-preview-input-row{display:flex;gap:8px;margin-bottom:14px;align-items:center}
.preview-source{font-size:1rem;flex:1;text-align:center;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-family:inherit}
.preview-arrow{color:var(--accent);font-size:1rem;flex-shrink:0}
.preview-target{font-size:1.4rem;flex:1;text-align:center;padding:10px 14px;background:var(--surface);border:1px solid var(--accent-border);border-radius:8px;color:var(--accent);font-family:monospace;min-height:50px;display:flex;align-items:center;justify-content:center;letter-spacing:0.1em;word-break:break-all;transition:all 0.2s}
.script-map-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:6px}
.script-map-row{display:flex;gap:6px;align-items:center;background:var(--surface);border:1px solid var(--border);border-radius:7px;padding:5px 8px}
.script-map-from{font-size:0.8rem;color:var(--text-secondary);width:24px;text-align:center;font-family:monospace}
.script-map-arrow{font-size:0.7rem;color:var(--text-muted)}
.script-map-to{font-size:0.9rem;flex:1;background:transparent;border:none;outline:none;color:var(--text-primary);font-family:monospace;text-align:center}

/* SYLLABLE INSPECTOR */
.insp-btn{width:100%;padding:12px;border-radius:10px;border:1px solid var(--accent-border);background:var(--accent-dim);font-family:inherit;font-size:0.85rem;color:var(--accent);cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:8px;font-weight:500}
.insp-btn:hover{background:rgba(140,126,255,0.18);box-shadow:var(--glow-accent)}
.generated-words{display:flex;flex-wrap:wrap;gap:7px;margin-top:14px}
.gen-word-chip{padding:8px 14px;border:1px solid var(--border);border-radius:8px;background:var(--surface-2);font-size:0.88rem;color:var(--text-primary);cursor:pointer;transition:all 0.15s;display:flex;align-items:center;gap:8px;font-family:monospace}
.gen-word-chip:hover{border-color:var(--accent-border);color:var(--accent);background:var(--accent-dim)}
.gen-word-chip span{font-size:0.62rem;color:var(--text-muted);font-family:inherit}

/* DECLENSION MATRIX */
.matrix-wrap{border:1px solid var(--border);border-radius:10px;overflow:auto}
.matrix-table{width:100%;border-collapse:collapse;font-size:0.8rem}
.matrix-table th{background:var(--surface-3);color:var(--text-secondary);font-weight:600;padding:9px 12px;text-align:center;border:1px solid var(--border);font-size:0.7rem;letter-spacing:0.06em;text-transform:uppercase}
.matrix-table th:first-child{text-align:left;color:var(--text-muted)}
.matrix-cell{padding:7px 10px;border:1px solid var(--border);text-align:center;position:relative}
.matrix-cell input{width:100%;background:transparent;border:none;outline:none;color:var(--accent);font-family:monospace;font-size:0.85rem;text-align:center;caret-color:var(--accent)}
.matrix-cell input:focus{background:var(--accent-dim)}
.matrix-cell input::placeholder{color:var(--text-muted);font-family:inherit;font-size:0.72rem}
.matrix-add{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}
.matrix-chip-sel{padding:5px 11px;border:1px solid var(--border);border-radius:6px;background:var(--surface-2);font-family:inherit;font-size:0.74rem;color:var(--text-secondary);cursor:pointer;transition:all 0.12s}
.matrix-chip-sel:hover{border-color:var(--accent-border);color:var(--accent)}
.matrix-chip-sel.active{border-color:var(--accent-border);background:var(--accent-dim);color:var(--accent)}

/* CORPUS */
.corpus-card{border:1px solid var(--border);border-radius:12px;padding:18px 20px;margin-bottom:10px;background:var(--surface);position:relative;overflow:hidden;transition:all 0.18s}
.corpus-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:linear-gradient(180deg,var(--accent),var(--accent2))}
.corpus-card:hover{border-color:var(--border-hover);transform:translateY(-1px)}
.corpus-conlang{font-family:'Cinzel',serif;font-size:1.05rem;font-weight:600;color:var(--text-primary);margin-bottom:4px;letter-spacing:0.04em}
.corpus-kana{font-size:0.78rem;color:var(--accent);margin-bottom:6px;font-family:monospace}
.corpus-jp{font-size:0.82rem;color:var(--text-secondary);font-style:italic;margin-bottom:10px}
.corpus-actions{display:flex;gap:6px}

/* SHARE CARD */
.share-card-preview{border:1px solid var(--gold-border);border-radius:12px;overflow:hidden;margin:14px 0;position:relative}
#share-canvas{display:block;width:100%;border-radius:0}
.share-btns{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}

/* PATTERN CARD */
.pattern-card{background:var(--surface-2);border:1px solid var(--border);border-radius:10px;padding:13px 15px;margin-bottom:8px;display:flex;align-items:center;gap:12px}
.pattern-form{font-size:0.88rem;font-weight:700;color:var(--accent);font-family:monospace;min-width:90px}
.pattern-meaning{font-size:0.8rem;color:var(--text-secondary);flex:1}
.pattern-category{font-size:0.6rem;color:var(--text-muted);background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:2px 7px;letter-spacing:0.04em}
.pattern-delete{width:24px;height:24px;border-radius:50%;border:1px solid var(--border);background:transparent;color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:0.8rem;transition:all 0.15s;flex-shrink:0}
.pattern-delete:hover{background:var(--rose-dim);border-color:var(--rose-border);color:var(--rose)}

/* MARKDOWN */
.md-editor-wrap{border:1px solid var(--border);border-radius:10px;overflow:hidden}
.md-toolbar{display:flex;gap:2px;padding:7px 10px;background:var(--surface-3);border-bottom:1px solid var(--border);flex-wrap:wrap}
.md-tbtn{padding:4px 9px;border:1px solid transparent;border-radius:5px;background:transparent;font-family:inherit;font-size:0.74rem;color:var(--text-secondary);cursor:pointer;transition:all 0.12s;font-weight:600}
.md-tbtn:hover{background:var(--surface);border-color:var(--border);color:var(--text-primary)}
.md-tabs{display:flex;background:var(--surface-3);border-bottom:1px solid var(--border)}
.md-tab{padding:6px 14px;font-size:0.73rem;font-weight:500;color:var(--text-muted);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.15s}
.md-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.md-textarea{width:100%;padding:12px 14px;border:none;outline:none;font-family:monospace;font-size:0.82rem;background:var(--surface-2);color:var(--text-primary);resize:none;min-height:160px;overflow:hidden;display:block}
.md-preview{padding:13px 15px;min-height:160px;font-size:0.83rem;line-height:1.85;color:var(--text-secondary);display:none}
.md-preview.active{display:block}
.md-preview h1,.md-preview h2,.md-preview h3{color:var(--text-primary);font-family:'Cinzel',serif;font-weight:600;margin:16px 0 8px;letter-spacing:0.04em}
.md-preview h1{font-size:1.1rem}.md-preview h2{font-size:0.95rem}.md-preview h3{font-size:0.85rem}
.md-preview strong{color:var(--text-primary)}
.md-preview em{font-style:italic;color:var(--accent)}
.md-preview code{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:1px 5px;font-family:monospace;font-size:0.78rem;color:var(--gold)}
.md-preview ul,.md-preview ol{padding-left:18px;margin:8px 0}
.md-preview li{margin-bottom:4px}
.md-preview table{width:100%;border-collapse:collapse;margin:12px 0;font-size:0.78rem}
.md-preview th,.md-preview td{border:1px solid var(--border);padding:7px 11px;text-align:left}
.md-preview th{background:var(--surface-3);color:var(--text-primary);font-weight:600}
.md-preview blockquote{border-left:3px solid var(--accent-border);padding:8px 14px;margin:10px 0;background:var(--accent-dim);border-radius:0 7px 7px 0;font-style:italic}
.md-preview hr{border:none;border-top:1px solid var(--border);margin:16px 0}

/* TAG INPUT */
.tag-input-wrap{display:flex;flex-wrap:wrap;gap:5px;align-items:center;padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:var(--surface-2);cursor:text;min-height:40px}
.tag-pill{display:flex;align-items:center;gap:4px;padding:3px 9px;border:1px solid var(--accent-border);border-radius:20px;background:var(--accent-dim);font-size:0.72rem;color:var(--accent)}
.tag-pill button{background:none;border:none;color:var(--accent);cursor:pointer;padding:0;font-size:0.75rem;line-height:1;display:flex;align-items:center}
.tag-inline-input{background:transparent;border:none;outline:none;font-family:inherit;font-size:0.78rem;color:var(--text-primary);min-width:80px;flex:1}
.tag-inline-input::placeholder{color:var(--text-muted)}
.tag-filter-wrap{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px}
.tag-filter-chip{padding:3px 10px;border:1px solid var(--border);border-radius:20px;background:transparent;font-family:inherit;font-size:0.7rem;color:var(--text-muted);cursor:pointer;transition:all 0.12s}
.tag-filter-chip:hover{border-color:var(--border-hover);color:var(--text-primary)}
.tag-filter-chip.active{background:var(--accent2-dim);color:var(--accent2);border-color:rgba(192,123,255,0.35)}

/* DICT SEARCH ROW */
.dict-search-row{display:flex;gap:8px;margin-bottom:10px;align-items:center}
.dict-search-wrap{position:relative;flex:1}
.dict-search-wrap input{padding-right:30px}
.dict-search-mode{position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:0.65rem;color:var(--accent);cursor:pointer;border:none;background:transparent;padding:2px 4px;border-radius:3px}
.dict-search-mode:hover{background:var(--accent-dim)}

/* ANIMATIONS */
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideUp{from{opacity:0;transform:translateY(48px)}to{opacity:1;transform:translateY(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
.spinning{animation:spin 0.7s linear infinite;display:inline-block}
.pulsing{animation:pulse 1.5s ease-in-out infinite}

/* HELP TOOLTIP */
.help-btn{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;border:1px solid var(--border-hover);background:var(--surface-3);color:var(--text-muted);font-size:0.6rem;font-weight:700;cursor:pointer;vertical-align:middle;margin-left:5px;transition:all 0.15s;flex-shrink:0;font-family:'Noto Sans JP',sans-serif;line-height:1}
.help-btn:hover{border-color:var(--accent-border);background:var(--accent-dim);color:var(--accent)}
/* Inline beginner tip card */
.tip-card{background:linear-gradient(135deg,rgba(140,126,255,0.08),rgba(192,123,255,0.05));border:1px solid var(--accent-border);border-radius:12px;padding:13px 16px;margin-bottom:16px;position:relative;overflow:hidden}
.tip-card::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:linear-gradient(180deg,var(--accent),var(--accent2))}
.tip-card-icon{font-size:1rem;margin-right:6px;vertical-align:middle}
.tip-card-title{font-size:0.72rem;font-weight:700;color:var(--accent);letter-spacing:0.06em;text-transform:uppercase;margin-bottom:5px}
.tip-card-body{font-size:0.8rem;color:var(--text-secondary);line-height:1.75}
.tip-card-body strong{color:var(--text-primary)}
.tip-ex-lang{display:inline-block;font-family:monospace;font-size:0.72rem;background:var(--surface-2);border:1px solid var(--border);border-radius:5px;padding:1px 7px;margin:2px 3px;color:var(--gold)}
.help-modal{position:fixed;inset:0;z-index:500;display:flex;align-items:center;justify-content:center;padding:20px;background:rgba(0,0,0,0.7);backdrop-filter:blur(6px)}
.help-modal-box{background:var(--surface);border:1px solid var(--border-bright);border-radius:16px;padding:28px 28px 22px;max-width:460px;width:100%;position:relative;box-shadow:0 20px 60px rgba(0,0,0,0.6)}
.help-modal-close{position:absolute;top:14px;right:14px;width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:var(--surface-2);color:var(--text-secondary);cursor:pointer;font-size:0.9rem;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
.help-modal-close:hover{background:var(--rose-dim);border-color:var(--rose-border);color:var(--rose)}
.help-modal-title{font-family:'Cinzel',serif;font-size:1rem;font-weight:600;margin-bottom:10px;padding-right:24px;color:var(--text-primary);letter-spacing:0.04em}
.help-modal-body{font-size:0.82rem;color:var(--text-secondary);line-height:1.9}
.help-modal-body strong{color:var(--text-primary)}
.help-modal-body .help-ex{margin-top:10px;padding:10px 13px;background:var(--surface-2);border:1px solid var(--border);border-radius:8px;font-family:monospace;font-size:0.78rem;color:var(--accent)}
.help-modal-body .real-lang-tag{display:inline-block;background:var(--gold-dim);border:1px solid var(--gold-border);border-radius:4px;padding:1px 7px;font-size:0.68rem;color:var(--gold);margin:2px;font-family:sans-serif}
.help-modal-body .lang-example-row{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.help-modal-body .lang-example-box{background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:0.76rem}
.help-modal-body .lang-example-box .flag{font-size:1rem;margin-right:4px}
.help-modal-body .lang-example-box .name{font-weight:700;color:var(--text-primary);display:block}
.help-modal-body .lang-example-box .desc{color:var(--text-secondary)}

/* MINI IPA KEYBOARD (for vocab entry) */
.mini-ipa-keyboard{background:var(--surface-2);border:1px solid var(--border);border-radius:10px;padding:10px;margin-top:8px;display:none}
.mini-ipa-keyboard.show{display:block;animation:fadeUp 0.15s ease both}
.mini-kb-label{font-size:0.6rem;color:var(--text-muted);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:6px;display:flex;align-items:center;gap:6px}
.mini-kb-row{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:4px}
.mini-kb-btn{padding:4px 9px;border:1px solid var(--border);border-radius:6px;background:var(--surface-3);font-size:0.82rem;font-family:monospace;color:var(--text-primary);cursor:pointer;transition:all 0.1s}
.mini-kb-btn:hover{border-color:var(--accent-border);background:var(--accent-dim);color:var(--accent)}
.mini-kb-btn.vowel{color:var(--accent2)}
.mini-kb-btn.cons{color:var(--accent)}

/* SYLLABLE SLOT BUILDER */
.syll-slot-row{display:flex;gap:6px;align-items:center;flex-wrap:wrap;padding:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:10px;margin-bottom:10px}
.syll-slot{display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;user-select:none}
.syll-slot-box{width:44px;height:44px;border:2px solid var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1rem;font-weight:700;transition:all 0.15s;background:var(--surface)}
.syll-slot-box.slot-C{border-color:var(--accent-border);background:var(--accent-dim);color:var(--accent)}
.syll-slot-box.slot-V{border-color:rgba(192,123,255,0.35);background:var(--accent2-dim);color:var(--accent2)}
.syll-slot-box.slot-N{border-color:var(--gold-border);background:var(--gold-dim);color:var(--gold)}
.syll-slot-box.slot-empty{border-style:dashed;color:var(--text-muted)}
.syll-slot-label{font-size:0.52rem;color:var(--text-muted);letter-spacing:0.06em;text-transform:uppercase}
.syll-slot-controls{display:flex;gap:6px;align-items:center;margin-top:10px;flex-wrap:wrap}
.slot-add-btn{padding:5px 11px;border:1px solid var(--border);border-radius:6px;background:var(--surface);font-size:0.74rem;color:var(--text-secondary);cursor:pointer;transition:all 0.12s;font-family:inherit}
.slot-add-btn:hover{border-color:var(--border-hover);color:var(--text-primary)}
.slot-add-btn.C{color:var(--accent);border-color:var(--accent-border);background:var(--accent-dim)}
.slot-add-btn.V{color:var(--accent2);border-color:rgba(192,123,255,0.35);background:var(--accent2-dim)}
.slot-add-btn.N{color:var(--gold);border-color:var(--gold-border);background:var(--gold-dim)}
.slot-violation{background:var(--rose-dim);border:1px solid var(--rose-border);border-radius:8px;padding:8px 12px;font-size:0.76rem;color:var(--rose);margin-top:6px;display:none}
.slot-violation.show{display:block}

/* GLOSS (ÈÄêË™ûË®≥) field */
.gloss-row{display:flex;gap:4px;flex-wrap:wrap;margin-top:6px}
.gloss-chip{padding:4px 10px;border:1px solid var(--border);border-radius:5px;background:var(--surface-2);font-size:0.72rem;color:var(--text-secondary);cursor:pointer;transition:all 0.12s;display:flex;flex-direction:column;align-items:center;gap:1px}
.gloss-chip:hover{border-color:var(--accent-border);color:var(--text-primary)}
.gloss-chip .gc-word{font-family:monospace;font-size:0.8rem;color:var(--accent)}
.gloss-chip .gc-gloss{font-size:0.6rem;color:var(--text-muted)}
.corpus-gloss{font-size:0.72rem;color:var(--gold);font-family:monospace;margin-bottom:4px;padding:3px 8px;background:var(--gold-dim);border-radius:4px;display:inline-block}

/* V5 VERSION BADGE */
.v5-badge{font-size:0.6rem;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border-radius:4px;padding:2px 7px;letter-spacing:0.08em;font-weight:700;vertical-align:middle;margin-left:6px}

/* ===== V21 ONBOARDING & TEMPLATES ===== */
.onboarding-quest{background:var(--surface);border:2px solid var(--gold-border);border-radius:14px;padding:18px 20px;margin-bottom:12px;position:relative;overflow:hidden;cursor:pointer;transition:all 0.2s;box-shadow:0 0 20px rgba(201,169,110,0.1)}
.onboarding-quest:hover{transform:translateY(-2px);border-color:var(--gold);box-shadow:0 8px 32px rgba(201,169,110,0.2)}
.onboarding-quest::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--gold),transparent)}
.template-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden}
.template-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent 60%,rgba(140,126,255,0.05));pointer-events:none}
.template-card:hover{transform:translateY(-3px);border-color:var(--accent-border);box-shadow:0 12px 40px rgba(140,126,255,0.15)}
.template-icon{font-size:3rem;text-align:center;margin-bottom:12px}
.template-name{font-size:1rem;font-weight:700;color:var(--text-primary);margin-bottom:8px;text-align:center}
.template-desc{font-size:0.78rem;color:var(--text-secondary);line-height:1.6;text-align:center;margin-bottom:12px}
.template-phonemes{display:flex;flex-direction:column;gap:4px;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:8px;font-size:0.72rem;color:var(--text-muted);font-family:monospace;margin-bottom:10px}
.template-sample{text-align:center;font-family:'Cinzel',serif;font-size:0.9rem;color:var(--accent);font-weight:600;padding:8px;background:var(--accent-dim);border-radius:6px}
@keyframes questPop{0%{transform:translate(-50%,-50%) scale(0.5);opacity:0}70%{transform:translate(-50%,-50%) scale(1.05)}100%{transform:translate(-50%,-50%) scale(1);opacity:1}}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}

/* ===== V8 STYLES ===== */

/* Ê†ºÂ§âÂåñ„Éó„É¨„Éì„É•„Éº„Éë„Éç„É´ */
.matrix-preview-panel{margin-top:14px;background:var(--surface-2);border:1px solid var(--gold-border);border-radius:10px;overflow:hidden}
.matrix-preview-header{padding:10px 14px;background:var(--gold-dim);display:flex;align-items:center;justify-content:space-between;gap:8px}
.matrix-preview-title{font-size:0.7rem;font-weight:700;color:var(--gold);letter-spacing:0.08em;text-transform:uppercase}
.matrix-preview-word{font-family:monospace;font-size:1.1rem;color:var(--text-primary)}
.matrix-preview-body{padding:12px 14px;overflow-x:auto}
.mp-table{border-collapse:collapse;font-size:0.8rem;width:100%}
.mp-table th{background:var(--surface-3);color:var(--text-muted);font-weight:600;padding:7px 12px;text-align:center;border:1px solid var(--border);font-size:0.68rem;letter-spacing:0.05em;text-transform:uppercase}
.mp-table th:first-child{text-align:left}
.mp-table td{padding:7px 12px;border:1px solid var(--border);text-align:center}
.mp-cell-suffix{font-family:monospace;font-size:0.75rem;color:var(--text-muted);display:block;margin-top:2px}
.mp-cell-word{font-family:monospace;font-size:0.92rem;color:var(--accent);font-weight:600}
.mp-cell-empty{color:var(--text-muted);font-style:italic;font-size:0.72rem}

/* ÊØçÈü≥‰∏âËßíÂΩ¢„ÉªÂ≠êÈü≥Âõ≥ */
.phonology-charts{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:14px}
@media(max-width:600px){.phonology-charts{grid-template-columns:1fr}}
.phon-chart-card{background:var(--surface-2);border:1px solid var(--border);border-radius:10px;overflow:hidden}
.phon-chart-header{padding:8px 12px;background:var(--surface-3);font-size:0.68rem;font-weight:700;color:var(--accent);letter-spacing:0.08em;text-transform:uppercase;border-bottom:1px solid var(--border)}
.phon-chart-body{padding:12px;position:relative;min-height:150px}
.vowel-triangle-wrap{position:relative;width:100%;height:160px}
.vt-svg{width:100%;height:100%}
.vt-label{font-size:11px;fill:var(--text-muted);font-family:monospace}
.vt-axis{stroke:var(--border-hover);stroke-width:1.5;fill:none}
.vt-phoneme{fill:var(--accent);font-size:13px;font-family:monospace;font-weight:700;cursor:default}
.vt-phoneme-circle{fill:var(--accent-dim);stroke:var(--accent-border);stroke-width:1.5}
.cons-chart-grid{display:flex;flex-direction:column;gap:3px}
.cons-row{display:flex;gap:3px;align-items:center}
.cons-row-label{font-size:0.58rem;color:var(--text-muted);width:52px;flex-shrink:0;letter-spacing:-0.01em;text-align:right;padding-right:5px}
.cons-pip{width:26px;height:22px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-family:monospace;font-weight:700;transition:all 0.12s}
.cons-pip.active-vl{background:var(--accent-dim);border:1px solid var(--accent-border);color:var(--accent)}
.cons-pip.active-vd{background:rgba(192,123,255,0.15);border:1px solid rgba(192,123,255,0.35);color:var(--accent2)}
.cons-pip.inactive{background:var(--surface-3);border:1px solid var(--border);color:var(--text-muted);opacity:0.3}
.cons-pip.empty{background:transparent;border:none}

/* IPA„ÉÅ„É£„Éº„Éà„Åã„Çâ„ÅÆÁôªÈå≤„É¢„Éº„Éâ */
.ipa-reg-mode-bar{display:flex;align-items:center;gap:8px;padding:8px 12px;background:linear-gradient(90deg,var(--accent-dim),transparent);border-bottom:1px solid var(--accent-border);margin-bottom:8px;border-radius:8px 8px 0 0}
.ipa-reg-toggle{padding:4px 12px;border-radius:20px;border:1px solid var(--border);background:var(--surface);font-size:0.7rem;color:var(--text-secondary);cursor:pointer;transition:all 0.15s}
.ipa-reg-toggle.on{background:var(--accent);color:#fff;border-color:var(--accent);box-shadow:var(--glow-accent)}
.ipa-reg-badge{font-size:0.65rem;padding:2px 7px;border-radius:10px;background:var(--accent-dim);color:var(--accent);border:1px solid var(--accent-border);font-weight:700}
.ipa-reg-cell-btn{position:relative}
.ipa-reg-cell-btn.registered{background:var(--accent-dim)!important;border-color:var(--accent-border)!important;color:var(--accent)!important}
.ipa-reg-cell-btn.registered::after{content:'‚úì';position:absolute;top:-4px;right:-4px;width:10px;height:10px;border-radius:50%;background:var(--accent);color:#fff;font-size:6px;display:flex;align-items:center;justify-content:center;line-height:10px;text-align:center}

/* „É¢„Éê„Ç§„É´Âõ∫ÂÆö‰øùÂ≠ò„Éú„Çø„É≥ */
.mobile-save-fab{display:none;position:fixed;bottom:calc(var(--bottom-nav-h) + 12px);right:16px;z-index:300;width:52px;height:52px;border-radius:50%;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-size:1.1rem;cursor:pointer;box-shadow:0 4px 20px rgba(140,126,255,0.4);transition:all 0.2s;align-items:center;justify-content:center}
.mobile-save-fab:active{transform:scale(0.92)}
@media(max-width:700px){
  .mobile-save-fab{display:flex}
  /* „Ç®„Éá„Ç£„Çø„Éë„Éç„É´ÂÜÖ„ÅÆ‰øùÂ≠ò„Éú„Çø„É≥„ÇíÊú´Â∞æ„Åß„ÅØ„Å™„ÅèÂÖàÈ†≠„Å´„ÇÇÂá∫„Åô */
  .editor-sticky-save{display:flex;position:sticky;top:54px;z-index:50;background:rgba(10,10,14,0.92);backdrop-filter:blur(12px);padding:8px 16px;margin:-16px -16px 12px;border-bottom:1px solid var(--border);justify-content:space-between;align-items:center}
}
@media(min-width:701px){.editor-sticky-save{display:none}}

/* ËæûÊõ∏„Éï„Ç£„É´„Çø„ÉºÂº∑Âåñ */
.dict-filter-bar{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
.dict-search-hybrid{position:relative}
.dict-search-hybrid input{padding-right:90px}
.dict-hybrid-mode{position:absolute;right:8px;top:50%;transform:translateY(-50%);display:flex;gap:2px}
.dhm-btn{padding:2px 7px;border-radius:4px;border:none;font-size:0.62rem;font-weight:600;cursor:pointer;transition:all 0.12s;letter-spacing:0.03em}
.dhm-btn.active{background:var(--accent);color:#fff}
.dhm-btn:not(.active){background:var(--surface-3);color:var(--text-muted)}

/* ===== END V8 ===== */
#page-login.active{display:flex;min-height:calc(100dvh - 54px);align-items:center;justify-content:center;padding:32px 20px;padding-bottom:100px}
.welcome-wrap{position:relative;width:100%;max-width:520px}
.welcome-glow{position:absolute;inset:-60px;background:radial-gradient(ellipse at 50% 40%,rgba(140,126,255,0.12) 0%,transparent 70%);pointer-events:none;z-index:0}
.welcome-inner{position:relative;z-index:1;text-align:center}
.welcome-logo{font-size:2.8rem;margin-bottom:12px;background:linear-gradient(135deg,#8c7eff,#c07bff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 0 20px rgba(140,126,255,0.4));animation:pulse 3s ease-in-out infinite}
.welcome-title{font-family:'Cinzel',serif;font-size:2rem;font-weight:700;letter-spacing:0.1em;background:linear-gradient(135deg,var(--text-primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:8px}
.welcome-sub{font-size:0.88rem;color:var(--text-secondary);font-style:italic;margin-bottom:36px;line-height:1.6}
.welcome-field{text-align:left;margin-bottom:22px}
.welcome-label{display:block;font-size:0.72rem;font-weight:600;color:var(--text-secondary);letter-spacing:0.08em;text-transform:uppercase;margin-bottom:8px}
.welcome-hint{font-size:0.68rem;color:var(--text-muted);margin-top:5px;display:block;font-style:italic}
.welcome-input{width:100%;padding:13px 16px;border:1px solid var(--border);border-radius:10px;font-family:'Cinzel',serif;font-size:1rem;background:var(--surface-2);color:var(--text-primary);outline:none;transition:all 0.2s;letter-spacing:0.04em}
.welcome-input:focus{border-color:var(--accent-border);box-shadow:0 0 0 3px var(--accent-dim)}
.welcome-input::placeholder{color:var(--text-muted);font-family:'Crimson Pro',serif;letter-spacing:0;font-size:0.9rem}
.welcome-vibe-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.welcome-vibe{display:flex;flex-direction:column;align-items:center;gap:6px;padding:14px 10px;border:1px solid var(--border);border-radius:10px;background:var(--surface-2);cursor:pointer;transition:all 0.15s;font-size:1.3rem}
.welcome-vibe span{font-size:0.72rem;color:var(--text-secondary);font-weight:600;font-family:'Noto Sans JP',sans-serif;text-align:center}
.welcome-vibe:hover{border-color:var(--border-hover);background:var(--surface-hover);transform:translateY(-2px)}
.welcome-vibe.selected{border-color:var(--accent-border);background:var(--accent-dim);box-shadow:0 0 12px rgba(140,126,255,0.15)}
.welcome-vibe.selected span{color:var(--accent)}
.welcome-btn{width:100%;margin-top:8px;padding:14px 20px;border-radius:10px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-family:'Cinzel',serif;font-size:0.95rem;font-weight:600;letter-spacing:0.06em;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;box-shadow:var(--glow-accent);transition:all 0.2s}
.welcome-btn:hover{filter:brightness(1.1);transform:translateY(-1px);box-shadow:0 8px 32px rgba(140,126,255,0.3)}
.welcome-btn:active{transform:scale(0.98)}
.welcome-skip{font-size:0.75rem;color:var(--text-muted);margin-top:12px;cursor:pointer;transition:color 0.15s}
.welcome-skip:hover{color:var(--text-secondary)}
.welcome-restore{margin-top:24px;padding:14px 18px;border:1px solid var(--gold-border);border-radius:10px;background:var(--gold-dim);text-align:center}
.restore-label{font-size:0.7rem;color:var(--gold);letter-spacing:0.06em;text-transform:uppercase;margin-bottom:4px}
.restore-name{font-family:'Cinzel',serif;font-size:1rem;color:var(--text-primary)}
/* Ëá™Âãï‰øùÂ≠ò„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */
.autosave-indicator{position:fixed;bottom:80px;right:16px;padding:5px 12px;border-radius:20px;background:var(--surface-2);border:1px solid var(--border);font-size:0.65rem;color:var(--text-muted);z-index:500;opacity:0;transition:opacity 0.3s;pointer-events:none;display:flex;align-items:center;gap:5px}
.autosave-indicator.show{opacity:1}
.autosave-dot{width:6px;height:6px;border-radius:50%;background:var(--success)}
/* ===== END V7 STYLES ===== */
.ai-assist-bar{position:sticky;bottom:0;left:0;right:0;z-index:50;margin:0 -32px;padding:10px 32px 14px;background:linear-gradient(0deg,rgba(10,10,14,0.98) 80%,transparent);border-top:1px solid var(--border);display:flex;align-items:center;gap:8px;flex-wrap:wrap}
@media(max-width:700px){.ai-assist-bar{margin:0 -16px;padding:8px 16px 12px}}
.ai-assist-input-wrap{flex:1;min-width:180px;display:flex;gap:6px;align-items:center;background:var(--surface-2);border:1px solid var(--border);border-radius:10px;padding:6px 10px;transition:all 0.15s}
.ai-assist-input-wrap:focus-within{border-color:var(--accent-border);box-shadow:0 0 0 3px var(--accent-dim)}
.ai-assist-icon{font-size:0.9rem;flex-shrink:0}
.ai-assist-input{background:transparent;border:none;outline:none;font-family:inherit;font-size:0.82rem;color:var(--text-primary);flex:1;min-width:0}
.ai-assist-input::placeholder{color:var(--text-muted)}
.ai-assist-send{width:30px;height:30px;border-radius:8px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;cursor:pointer;font-size:0.75rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.15s;box-shadow:var(--glow-accent)}
.ai-assist-send:hover{filter:brightness(1.15)}
.ai-assist-send:active{transform:scale(0.92)}
.ai-suggest-chips{display:flex;gap:5px;flex-wrap:wrap;width:100%}
.ai-suggest-chip{padding:4px 11px;border:1px solid var(--accent-border);border-radius:20px;background:var(--accent-dim);font-size:0.7rem;color:var(--accent);cursor:pointer;transition:all 0.12s;white-space:nowrap}
.ai-suggest-chip:hover{background:rgba(140,126,255,0.2);transform:translateY(-1px)}

/* AI CHAT BUBBLE */
.ai-chat-wrap{max-height:320px;overflow-y:auto;margin-bottom:10px;display:flex;flex-direction:column;gap:8px;scrollbar-width:thin;scrollbar-color:var(--border) transparent}
.ai-chat-wrap::-webkit-scrollbar{width:4px}
.ai-chat-wrap::-webkit-scrollbar-thumb{background:var(--border-hover);border-radius:2px}
.ai-bubble{max-width:88%;padding:10px 14px;border-radius:12px;font-size:0.81rem;line-height:1.7;animation:fadeUp 0.2s ease both}
.ai-bubble.user{align-self:flex-end;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border-radius:12px 12px 2px 12px}
.ai-bubble.bot{align-self:flex-start;background:var(--surface-2);border:1px solid var(--border);color:var(--text-secondary);border-radius:2px 12px 12px 12px}
.ai-bubble.bot strong{color:var(--text-primary)}
.ai-bubble.thinking{color:var(--text-muted);font-style:italic}
.ai-bubble-meta{font-size:0.6rem;color:var(--text-muted);margin-top:4px;letter-spacing:0.04em}
.ai-action-chips{display:flex;gap:5px;flex-wrap:wrap;margin-top:6px}
.ai-action-chip{padding:3px 9px;border:1px solid var(--border);border-radius:6px;background:var(--surface);font-size:0.7rem;color:var(--accent);cursor:pointer;transition:all 0.12s}
.ai-action-chip:hover{background:var(--accent-dim);border-color:var(--accent-border)}

/* ASSISTANT PANEL (collapsible) */
.assist-panel{background:var(--surface-2);border:1px solid var(--border);border-radius:12px;margin-bottom:14px;overflow:hidden;transition:all 0.2s}
.assist-panel-header{display:flex;align-items:center;gap:8px;padding:12px 16px;cursor:pointer;user-select:none}
.assist-panel-header:hover{background:var(--surface-hover)}
.assist-panel-toggle{font-size:0.7rem;color:var(--text-muted);margin-left:auto;transition:transform 0.2s}
.assist-panel.open .assist-panel-toggle{transform:rotate(180deg)}
.assist-panel-body{display:none;padding:0 16px 16px}
.assist-panel.open .assist-panel-body{display:block}
.assist-title{font-size:0.78rem;font-weight:600;color:var(--accent);letter-spacing:0.06em}
.assist-dot{width:7px;height:7px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:0 0 6px var(--accent);animation:pulse 2s ease-in-out infinite}

/* CHAR PICKER PANEL */
.char-picker-tabs{display:flex;gap:2px;border-bottom:1px solid var(--border);margin-bottom:10px;overflow-x:auto;scrollbar-width:none}
.char-picker-tabs::-webkit-scrollbar{display:none}
.char-tab{padding:6px 11px;font-size:0.68rem;font-weight:600;color:var(--text-muted);cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;transition:all 0.15s;letter-spacing:0.04em;text-transform:uppercase}
.char-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.char-tab-content{display:none}
.char-tab-content.active{display:block;animation:fadeIn 0.15s ease both}
.char-category{margin-bottom:12px}
.char-cat-label{font-size:0.58rem;color:var(--text-muted);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:5px;display:block}
.char-grid{display:flex;flex-wrap:wrap;gap:4px}
.char-btn{padding:5px 8px;min-width:34px;border:1px solid var(--border);border-radius:6px;background:var(--surface);font-size:0.88rem;color:var(--text-primary);cursor:pointer;transition:all 0.1s;text-align:center;font-family:monospace;position:relative}
.char-btn:hover{border-color:var(--accent-border);background:var(--accent-dim);color:var(--accent);transform:scale(1.08)}
.char-btn:active{transform:scale(0.94)}
.char-btn title{display:none}
.char-btn[data-lang]::after{content:attr(data-lang);position:absolute;bottom:-14px;left:50%;transform:translateX(-50%);font-size:0.42rem;color:var(--text-muted);white-space:nowrap;pointer-events:none;opacity:0;transition:opacity 0.15s}
.char-btn:hover::after{opacity:1}

/* ===== END V6 STYLES ===== */
/* ===== V9 STYLES ===== */

/* Visibility badge in header */
.vis-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;font-size:0.65rem;font-weight:700;letter-spacing:0.05em;cursor:pointer;transition:all 0.15s;border:1px solid}
.vis-private{color:var(--text-muted);border-color:var(--border);background:var(--surface)}
.vis-unlisted{color:var(--gold);border-color:var(--gold-border);background:var(--gold-dim)}
.vis-public{color:var(--success);border-color:var(--success-border);background:var(--success-dim)}

/* Visibility popup */
.vis-popup{position:fixed;inset:0;z-index:500;display:flex;align-items:center;justify-content:center;padding:20px;background:rgba(0,0,0,0.7);backdrop-filter:blur(6px);animation:fadeIn 0.15s ease}
.vis-popup-box{background:var(--surface);border:1px solid var(--border-bright);border-radius:18px;padding:28px;max-width:380px;width:100%;box-shadow:0 24px 64px rgba(0,0,0,0.6)}
.vis-popup-title{font-family:'Cinzel',serif;font-size:1rem;font-weight:600;letter-spacing:0.06em;margin-bottom:18px;color:var(--text-primary)}
.vis-option{padding:14px 16px;border:1px solid var(--border);border-radius:12px;margin-bottom:8px;cursor:pointer;transition:all 0.15s;position:relative}
.vis-option:hover{background:var(--surface-hover);border-color:var(--border-hover)}
.vis-option.selected{border-color:var(--accent-border);background:var(--accent-dim)}
.vis-option-title{font-size:0.88rem;font-weight:600;margin-bottom:3px;display:flex;align-items:center;gap:8px}
.vis-option-desc{font-size:0.75rem;color:var(--text-secondary);line-height:1.6}
.vis-check{position:absolute;right:14px;top:50%;transform:translateY(-50%);color:var(--accent);font-size:1rem;opacity:0}
.vis-option.selected .vis-check{opacity:1}

/* Library page */
#page-library{padding:36px 40px 120px;max-width:1040px;margin:0 auto}
.lib-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:28px;flex-wrap:wrap;gap:12px}
.lib-title{font-family:'Cinzel',serif;font-size:1.5rem;font-weight:700;letter-spacing:0.06em;background:linear-gradient(135deg,var(--text-primary),var(--success));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.lib-search{flex:1;max-width:320px;padding:8px 14px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:0.85rem;background:var(--surface-2);color:var(--text-primary);outline:none}
.lib-search:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim)}
.lib-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.lang-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden}
.lang-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent 70%,rgba(140,126,255,0.05));pointer-events:none}
.lang-card:hover{transform:translateY(-3px);box-shadow:0 12px 40px rgba(0,0,0,0.4);border-color:var(--border-hover)}
.lang-card-name{font-family:'Cinzel',serif;font-size:1.05rem;font-weight:700;letter-spacing:0.04em;color:var(--text-primary);margin-bottom:6px}
.lang-card-meta{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
.lang-card-stat{font-size:0.62rem;color:var(--text-muted);background:var(--surface-2);border:1px solid var(--border);border-radius:4px;padding:2px 7px}
.lang-card-desc{font-size:0.78rem;color:var(--text-secondary);line-height:1.6;margin-bottom:12px;font-style:italic}
.lang-card-actions{display:flex;gap:6px}
.lang-card-author{font-size:0.62rem;color:var(--text-muted);margin-top:8px}
.lang-sample{font-family:monospace;font-size:0.82rem;color:var(--accent);padding:6px 10px;background:var(--accent-dim);border-radius:6px;margin-bottom:10px;border:1px solid var(--accent-border)}

/* AI Chat page */
#page-aichat{display:none}
#page-aichat.active{display:flex;flex-direction:column;height:calc(100dvh - 54px)}
.aichat-header{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;background:rgba(10,10,14,0.88);backdrop-filter:blur(12px)}
.aichat-lang-name{font-family:'Cinzel',serif;font-size:0.95rem;font-weight:600;color:var(--text-primary)}
.aichat-mode-badge{font-size:0.62rem;font-weight:700;padding:2px 8px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;letter-spacing:0.06em}
.aichat-messages{flex:1;overflow-y:auto;padding:24px 20px;display:flex;flex-direction:column;gap:12px}
.chat-msg{max-width:75%;border-radius:14px;padding:12px 16px;font-size:0.85rem;line-height:1.7;animation:fadeUp 0.2s ease}
.chat-msg.user{align-self:flex-end;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border-radius:14px 14px 2px 14px}
.chat-msg.ai{align-self:flex-start;background:var(--surface);border:1px solid var(--border);color:var(--text-primary);border-radius:14px 14px 14px 2px}
.chat-msg.correction{align-self:flex-start;background:var(--gold-dim);border:1px solid var(--gold-border);color:var(--gold);border-radius:14px 14px 14px 2px;font-size:0.78rem}
.aichat-input-row{padding:14px 20px;border-top:1px solid var(--border);display:flex;gap:10px;background:rgba(10,10,14,0.92);backdrop-filter:blur(12px)}
.aichat-input{flex:1;padding:10px 14px;border:1px solid var(--border);border-radius:10px;font-family:inherit;font-size:0.88rem;background:var(--surface-2);color:var(--text-primary);outline:none;transition:border-color 0.15s}
.aichat-input:focus{border-color:var(--accent)}
.chat-typing{display:flex;gap:4px;padding:12px 16px;align-self:flex-start;background:var(--surface);border:1px solid var(--border);border-radius:14px;animation:fadeUp 0.2s ease}
.typing-dot{width:6px;height:6px;border-radius:50%;background:var(--text-muted);animation:pulse 1.2s ease-in-out infinite}
.typing-dot:nth-child(2){animation-delay:0.2s}
.typing-dot:nth-child(3){animation-delay:0.4s}

/* Import/Export panel */
.impexp-panel{background:var(--surface-2);border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:12px}
.impexp-title{font-size:0.72rem;font-weight:700;color:var(--text-muted);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:12px;display:flex;align-items:center;gap:8px}

/* FAQ Styles */
.faq-section{margin-bottom:40px}
.faq-category{font-family:'Cinzel',serif;font-size:1.1rem;font-weight:700;color:var(--accent);margin-bottom:20px;padding-bottom:10px;border-bottom:2px solid var(--accent-border)}
.faq-item{margin-bottom:20px;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;transition:all 0.2s}
.faq-item:hover{border-color:var(--accent-border);background:var(--surface-hover)}
.faq-question{font-size:1rem;font-weight:600;color:var(--text-primary);margin-bottom:10px}
.faq-answer{font-size:0.88rem;color:var(--text-secondary);line-height:1.7}
.faq-answer strong{color:var(--accent);font-weight:600}
.faq-answer a{color:var(--accent);text-decoration:none;transition:color 0.15s}
.faq-answer a:hover{color:var(--accent2)}

/* Fork/Import animations */
@keyframes forkPop{0%{transform:scale(0.85);opacity:0}60%{transform:scale(1.05)}100%{transform:scale(1);opacity:1}}
.fork-success{animation:forkPop 0.4s ease both;color:var(--success)}

/* Language status indicator in topbar */
.lang-vis-indicator{display:flex;align-items:center;gap:5px;cursor:pointer;padding:4px 8px;border-radius:6px;transition:all 0.15s;border:1px solid transparent}
.lang-vis-indicator:hover{background:var(--surface);border-color:var(--border)}
.lang-vis-dot{width:7px;height:7px;border-radius:50%}

/* Preset library selector */
.preset-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;margin-top:10px}
.preset-card{background:var(--surface-2);border:1px solid var(--border);border-radius:10px;padding:14px 12px;cursor:pointer;transition:all 0.15s;text-align:center}
.preset-card:hover{border-color:var(--accent-border);background:var(--accent-dim);transform:translateY(-1px)}
.preset-icon{font-size:1.3rem;margin-bottom:6px}
.preset-name{font-size:0.78rem;font-weight:600;color:var(--text-primary);margin-bottom:2px}
.preset-words{font-size:0.6rem;color:var(--text-muted)}

/* ===== END V9 ===== */

/* ===== V23 PRO UI COMPONENTS ===== */

/* Pro CTA Banner */
.pro-cta-banner {
  background: linear-gradient(135deg, rgba(201,169,110,0.12), rgba(140,126,255,0.08));
  border: 1px solid var(--gold-border);
  border-radius: 12px;
  padding: 18px 20px;
  margin-bottom: 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  animation: fadeIn 0.3s ease;
}
.pro-cta-content { flex: 1; }
.pro-cta-title {
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--gold);
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.pro-cta-desc {
  font-size: 0.78rem;
  color: var(--text-secondary);
  line-height: 1.5;
}
.pro-cta-btn { white-space: nowrap; }

/* AI Limit Badge */
.ai-limit-badge {
  font-size: 0.7rem;
  padding: 4px 10px;
  border-radius: 6px;
  background: var(--surface-2);
  color: var(--text-secondary);
  border: 1px solid var(--border);
  font-weight: 600;
  white-space: nowrap;
  transition: all 0.2s;
}
.ai-limit-badge.pro {
  background: var(--gold-dim);
  color: var(--gold);
  border-color: var(--gold-border);
}
.ai-limit-badge.warning {
  background: var(--rose-dim);
  color: var(--rose);
  border-color: var(--rose-border);
  animation: pulse 2s ease-in-out infinite;
}

/* Pro Status Card */
.pro-status-card {
  padding: 24px;
  background: var(--surface-2);
  border-radius: 12px;
  border: 1px solid var(--border);
}
.plan-status {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
}
.plan-info { flex: 1; }
.plan-name {
  font-size: 0.9rem;
  font-weight: 600;
  margin-bottom: 4px;
}
.plan-subtitle {
  font-size: 0.75rem;
  color: var(--text-muted);
}
.plan-divider {
  height: 1px;
  background: var(--border);
  margin: 20px 0;
}

/* Pro Features List */
.pro-features { margin-bottom: 24px; }
.pro-features-title {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 14px;
}
.pro-features-list {
  list-style: none;
  padding: 0;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.pro-features-list li {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  font-size: 0.8rem;
  line-height: 1.5;
}
.feature-icon {
  font-size: 1.2rem;
  flex-shrink: 0;
}
.feature-title {
  color: var(--text-primary);
  font-weight: 500;
  margin-bottom: 2px;
}
.feature-desc {
  color: var(--text-muted);
  font-size: 0.75rem;
}

/* Pricing */
.pro-pricing {
  text-align: center;
  margin-bottom: 20px;
  padding: 20px;
  background: var(--surface);
  border-radius: 10px;
  border: 1px solid var(--gold-border);
}
.price-amount {
  font-size: 2.2rem;
  font-weight: 700;
  color: var(--gold);
  font-family: 'Cinzel', serif;
}
.price-period {
  font-size: 1rem;
  font-weight: 400;
  color: var(--text-muted);
}
.price-note {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 6px;
}
.btn-upgrade {
  width: 100%;
  padding: 12px 20px;
  font-size: 0.9rem;
  font-weight: 600;
}
.upgrade-footer {
  text-align: center;
  font-size: 0.72rem;
  color: var(--text-muted);
  margin-top: 12px;
}

/* Pro Active Status */
.pro-active-status {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 16px;
  background: var(--success-dim);
  border: 1px solid var(--success-border);
  border-radius: 10px;
  margin-bottom: 16px;
}
.status-icon {
  font-size: 1.8rem;
  flex-shrink: 0;
}
.status-content { flex: 1; }
.status-title {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--success);
  margin-bottom: 2px;
}
.status-desc {
  font-size: 0.75rem;
  color: var(--text-secondary);
}
.pro-benefits-summary {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}
.benefit-item {
  padding: 12px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  text-align: center;
}
.benefit-label {
  font-size: 0.7rem;
  color: var(--text-muted);
  margin-bottom: 4px;
}
.benefit-value {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-primary);
}

/* Feature Lock Overlay */
.feature-lock-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(8px);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
  animation: fadeIn 0.2s ease;
}
.lock-content {
  max-width: 320px;
  padding: 32px 24px;
  background: var(--surface-2);
  border: 1px solid var(--gold-border);
  border-radius: 16px;
  text-align: center;
}
.lock-icon {
  font-size: 3rem;
  margin-bottom: 16px;
}
.lock-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--gold);
  margin-bottom: 8px;
}
.lock-desc {
  font-size: 0.85rem;
  color: var(--text-secondary);
  line-height: 1.6;
  margin-bottom: 20px;
}

/* ===== END V23 PRO UI ===== */

/* RESPONSIVE */
@media(max-width:700px){
  #page-dashboard{padding:20px 14px calc(var(--bottom-nav-h) + 20px)}
  #page-library{padding:20px 14px calc(var(--bottom-nav-h)+20px)}
  .lib-grid{grid-template-columns:1fr}
  .lib-header{flex-direction:column;align-items:flex-start}
  .lib-search{max-width:100%;width:100%}
  .preset-grid{grid-template-columns:repeat(2,1fr)}
  .editor-panel{padding:18px 16px 40px;border-radius:16px 16px 0 0}
  .module-grid{grid-template-columns:1fr}
  .route-grid{grid-template-columns:1fr}
  .script-grid{grid-template-columns:repeat(2,1fr)}
  .dash-progress{flex-direction:column;align-items:flex-start}
  .topbar-nav{display:none !important}
  .bottom-nav{display:flex}
  .topbar{padding:0 14px}
  .daily-input-wrap{flex-wrap:wrap}
  .daily-input-wrap .btn{flex:1;justify-content:center}
  .matrix-wrap{overflow-x:auto}
  .script-map-grid{grid-template-columns:repeat(auto-fill,minmax(100px,1fr))}
  .ipa-table{font-size:0.65rem}
  .ipa-cell-btn{min-width:22px;padding:2px 3px}
}
@media(min-width:701px){
  .bottom-nav{display:none !important}
}
/* Lang toggle */
.lang-toggle-pill{font-size:0.78rem !important;letter-spacing:0.04em;border:1px solid var(--border-bright) !important;border-radius:20px !important;padding:4px 12px !important;background:var(--surface-2) !important;color:var(--text-secondary) !important;transition:all 0.15s}
.lang-toggle-pill:hover{background:var(--accent-dim) !important;color:var(--accent) !important;border-color:var(--accent-border) !important}
.lang-menu-btn{display:block;width:100%;padding:8px 12px;border:none;background:transparent;color:var(--text-secondary);font-size:0.82rem;font-family:inherit;cursor:pointer;border-radius:8px;text-align:left;transition:background 0.1s}
.lang-menu-btn:hover{background:var(--accent-dim);color:var(--accent)}
.lang-menu-btn.active{color:var(--accent);font-weight:700}

/* Memo card styles */
.memo-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px;cursor:pointer;transition:all 0.15s;position:relative}
.memo-card:hover{background:var(--surface-hover);border-color:var(--border-hover);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}
.memo-card-title{font-size:1rem;font-weight:600;color:var(--text-primary);margin-bottom:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.memo-card-preview{font-size:0.82rem;color:var(--text-secondary);line-height:1.6;margin-bottom:12px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.memo-card-footer{display:flex;align-items:center;justify-content:space-between;font-size:0.72rem;color:var(--text-muted)}
.memo-card-date{display:flex;align-items:center;gap:5px}

@keyframes slideUp{from{opacity:0;transform:translate(-50%,20px)}to{opacity:1;transform:translate(-50%,0)}}
@keyframes fadeOut{to{opacity:0}}
</style>
<!-- Firebase SDK -->
<script type="module">
  try {
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js");
    const { getAuth, signInWithRedirect, getRedirectResult, GoogleAuthProvider, onAuthStateChanged, signOut } = await import("https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js");
    const { getFirestore, doc, setDoc, getDoc, collection, addDoc } = await import("https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js");

    const firebaseConfig = {
      apiKey: "AIzaSyBsrxUHZCsfMJvlQ-rgLemmw8anvkp7tGw",
      authDomain: "lingua-17cd3.firebaseapp.com",
      projectId: "lingua-17cd3",
      storageBucket: "lingua-17cd3.firebasestorage.app",
      messagingSenderId: "513351849309",
      appId: "1:513351849309:web:ec0219544b09fdcdabc4b4",
      measurementId: "G-3B5NVCCYDT"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // „Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨ÈñãÔºà„É°„Ç§„É≥„Çπ„ÇØ„É™„Éó„Éà„Åã„Çâ‰ΩøÁî®Ôºâ
    window.firebaseAuth = auth;
    window.firebaseDb = db;
    window.GoogleAuthProvider = GoogleAuthProvider;
    window.signInWithRedirect = signInWithRedirect;
    window.getRedirectResult = getRedirectResult;
    window.signOut = signOut;
    window.onAuthStateChanged = onAuthStateChanged;
    window.firestoreDoc = doc;
    window.firestoreSetDoc = setDoc;
    window.firestoreGetDoc = getDoc;
    window.firestoreCollection = collection;
    window.firestoreAddDoc = addDoc;
    
    // ÂàùÊúüÂåñÂÆå‰∫Ü„ÇíÈÄöÁü•
    window.firebaseReady = true;
    console.log('‚úÖ Firebase initialized');
  } catch(error) {
    console.error('‚ö†Ô∏è Firebase SDK loading failed:', error);
    console.log('‚ÑπÔ∏è App will work in offline mode (localStorage only)');
    window.firebaseReady = false;
  }
</script>
</head>
<body>

<div class="topbar">
  <span class="brand" onclick="goTo('dashboard')">‚ú¶ Lingua<span class="v5-badge">V26</span></span>
  <div class="topbar-nav" id="topbar-nav" style="display:none">
    <button class="topbar-navbtn" id="nav-dash" onclick="goTo('dashboard');setNav('nav-dash')" data-i18n="nav_home">„Éõ„Éº„É†</button>
    <button class="topbar-navbtn" id="nav-script" onclick="openEditor('script');setNav('nav-script')" data-i18n="nav_script">ÊñáÂ≠ó‰ΩìÁ≥ª</button>
    <button class="topbar-navbtn" id="nav-phoneme" onclick="openEditor('phoneme');setNav('nav-phoneme')" data-i18n="nav_phoneme">Èü≥Èüª</button>
    <button class="topbar-navbtn" id="nav-grammar" onclick="openEditor('grammar');setNav('nav-grammar')" data-i18n="nav_grammar">ÊñáÊ≥ï</button>
    <button class="topbar-navbtn" id="nav-vocab" onclick="goTo('vocab');setNav('nav-vocab')" data-i18n="nav_vocab">Ë™ûÂΩô</button>
    <button class="topbar-navbtn" id="nav-corpus" onclick="openEditor('corpus');setNav('nav-corpus')" data-i18n="nav_corpus">‰æãÊñá</button>
    <button class="topbar-navbtn" id="nav-daily" onclick="openEditor('daily');setNav('nav-daily')" data-i18n="nav_daily">1Êó•1Êñá</button>
    <button class="topbar-navbtn" id="nav-library" onclick="goTo('library');setNav('nav-library')" data-i18n="nav_library" style="color:var(--success)">üåø „É©„Ç§„Éñ„É©„É™</button>
    <button class="topbar-navbtn" id="nav-aichat" onclick="goTo('aichat');setNav('nav-aichat')" data-i18n="nav_aichat" style="color:var(--accent2)">ü§ñ AI‰ºöË©±</button>
    <button class="topbar-navbtn" id="nav-faq" onclick="goTo('faq');setNav('nav-faq')" data-i18n="nav_faq">‚ùì FAQ</button>
  </div>
  <div class="topbar-right">
    <!-- Language switcher ‚Äî 4 languages dropdown -->
    <div style="position:relative" id="lang-menu-wrap">
      <button class="btn btn-ghost btn-sm lang-toggle-pill" onclick="toggleLangMenu(event)" id="lang-toggle-btn">üåê <span id="lang-cur">JA</span> ‚ñæ</button>
      <div id="lang-menu" style="display:none;position:absolute;top:calc(100%+6px);right:0;min-width:140px;background:rgba(13,13,20,0.98);border:1px solid var(--border-bright);border-radius:12px;padding:6px;z-index:300;box-shadow:0 8px 32px rgba(0,0,0,0.5);backdrop-filter:blur(16px)">
        <button class="lang-menu-btn" onclick="setLang('ja')">üáØüáµ Êó•Êú¨Ë™û</button>
        <button class="lang-menu-btn" onclick="setLang('en')">üá¨üáß English</button>
        <button class="lang-menu-btn" onclick="setLang('zh')">üá®üá≥ ‰∏≠Êñá</button>
        <button class="lang-menu-btn" onclick="setLang('es')">üá™üá∏ Espa√±ol</button>
      </div>
    </div>
    <!-- Visibility indicator (shown when logged in) -->
    <div class="lang-vis-indicator" id="vis-indicator" style="display:none" onclick="openVisPopup()" title="ÂÖ¨ÈñãË®≠ÂÆö">
      <div class="lang-vis-dot" id="vis-dot" style="background:var(--text-muted)"></div>
      <span style="font-size:0.68rem;color:var(--text-muted)" id="vis-label" data-i18n="vis_private">ÈùûÂÖ¨Èñã</span>
    </div>
    <div id="topbar-login-btns" style="display:none">
      <button class="btn btn-ghost btn-sm" onclick="goTo('login')" data-i18n="btn_login">„É≠„Ç∞„Ç§„É≥</button>
      <button class="btn btn-primary btn-sm" onclick="goTo('login')" data-i18n="btn_start">ÁÑ°Êñô„ÅßÂßã„ÇÅ„Çã</button>
    </div>
    <div id="topbar-user-area" style="display:flex;align-items:center;gap:8px">
      <span id="topbar-plan-badge"></span>
      <div class="avatar" id="topbar-avatar" onclick="logout()" data-i18n-title="btn_logout" title="„É≠„Ç∞„Ç¢„Ç¶„Éà" style="cursor:pointer">‚ú¶</div>
    </div>
  </div>
</div>

<!-- BOTTOM NAV (mobile) ‚Äî 5 thumb-friendly tabs -->
<nav class="bottom-nav" id="bottom-nav" style="display:none">
  <div class="bottom-nav-inner">
    <button class="bnav-btn active" id="bnav-dash" onclick="goTo('dashboard');setBNav('bnav-dash')">
      <div class="bnav-icon-wrap">üè†</div><span class="bnav-label" data-i18n="bnav_home">„Éõ„Éº„É†</span>
    </button>
    <button class="bnav-btn" id="bnav-memo" onclick="goTo('memo');setBNav('bnav-memo')">
      <div class="bnav-icon-wrap">üìù</div><span class="bnav-label" data-i18n="bnav_memo">„É°„É¢</span>
    </button>
    <button class="bnav-btn" id="bnav-vocab" onclick="goTo('vocab');setBNav('bnav-vocab')">
      <div class="bnav-icon-wrap">üìñ</div><span class="bnav-label" data-i18n="bnav_vocab">Ë™ûÂΩô</span>
    </button>
    <button class="bnav-btn" id="bnav-aichat" onclick="goTo('aichat');setBNav('bnav-aichat')">
      <div class="bnav-icon-wrap">ü§ñ</div><span class="bnav-label" data-i18n="bnav_aichat">AI‰ºöË©±</span>
    </button>
  </div>
</nav>

<!-- MOBILE MORE MENU -->
<div id="mobile-more-menu" style="display:none;position:fixed;bottom:calc(var(--bottom-nav-h) + 8px);left:8px;right:8px;background:rgba(13,13,20,0.97);border:1px solid var(--border-bright);border-radius:16px;padding:12px;z-index:199;backdrop-filter:blur(20px);animation:slideUp 0.2s ease">
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
    <button class="bnav-btn" style="flex-direction:column;padding:10px 4px;border:1px solid var(--border);border-radius:10px;background:var(--surface)" onclick="openEditor('corpus');toggleMobileMore()">
      <div style="font-size:1.1rem">üí¨</div><span class="bnav-label" style="font-size:0.6rem;margin-top:3px" data-i18n="mm_corpus">‰æãÊñá</span>
    </button>
    <button class="bnav-btn" style="flex-direction:column;padding:10px 4px;border:1px solid var(--border);border-radius:10px;background:var(--surface)" onclick="openEditor('daily');toggleMobileMore()">
      <div style="font-size:1.1rem">‚ú¶</div><span class="bnav-label" style="font-size:0.6rem;margin-top:3px" data-i18n="mm_daily">1Êó•1Êñá</span>
    </button>
    <button class="bnav-btn" style="flex-direction:column;padding:10px 4px;border:1px solid var(--border);border-radius:10px;background:var(--surface)" onclick="openEditor('script');toggleMobileMore()">
      <div style="font-size:1.1rem">‚úç</div><span class="bnav-label" style="font-size:0.6rem;margin-top:3px" data-i18n="mm_script">ÊñáÂ≠ó‰ΩìÁ≥ª</span>
    </button>
    <button class="bnav-btn" style="flex-direction:column;padding:10px 4px;border:1px solid var(--border);border-radius:10px;background:var(--surface)" onclick="openEditor('vibe');toggleMobileMore()">
      <div style="font-size:1.1rem">üåå</div><span class="bnav-label" style="font-size:0.6rem;margin-top:3px" data-i18n="mm_vibe">‰∏ñÁïåË¶≥</span>
    </button>
    <button class="bnav-btn" style="flex-direction:column;padding:10px 4px;border:1px solid var(--success-border);border-radius:10px;background:var(--success-dim);color:var(--success)" onclick="goTo('library');toggleMobileMore()">
      <div style="font-size:1.1rem">üåø</div><span class="bnav-label" style="font-size:0.6rem;margin-top:3px;color:var(--success)" data-i18n="mm_library">„É©„Ç§„Éñ„É©„É™</span>
    </button>
    <button class="bnav-btn" style="flex-direction:column;padding:10px 4px;border:1px solid var(--accent-border);border-radius:10px;background:var(--accent-dim);color:var(--accent)" onclick="goTo('aichat');toggleMobileMore()">
      <div style="font-size:1.1rem">ü§ñ</div><span class="bnav-label" style="font-size:0.6rem;margin-top:3px;color:var(--accent)" data-i18n="mm_aichat">AI‰ºöË©±</span>
    </button>
  </div>
</div>

<!-- Ëá™Âãï‰øùÂ≠ò„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº -->
<div class="autosave-indicator" id="autosave-indicator">
  <div class="autosave-dot"></div><span id="autosave-text" data-i18n="autosave_saved">‰øùÂ≠òÊ∏à„Åø</span>
</div>

<!-- WELCOME (ÂêçÂâçÔºã„Ç§„É°„Éº„Ç∏ÈÅ∏Êäû„ÅÆ„Åø) -->
<div class="page active" id="page-login">
  <div class="welcome-wrap">
    <div class="welcome-glow"></div>
    <div class="welcome-inner">
      <div class="welcome-logo">‚ú¶</div>
      <h1 class="welcome-title">Lingua</h1>
      <p class="welcome-sub" data-i18n="w_sub">„ÅÇ„Å™„Åü„Å†„Åë„ÅÆË®ÄË™û„Çí„ÄÅ‰ªä„Åô„Åê‰Ωú„Çä„ÅØ„Åò„ÇÅ„Çà„ÅÜ</p>

      <!-- Google login „ÇíÊúÄÂàù„Å´ -->
      <button class="login-google-btn" id="google-login-btn" onclick="loginWithGoogle()" style="margin-top:24px">
        <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
          <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
          <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
          <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
          <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
          <path fill="none" d="M0 0h48v48H0z"/>
        </svg>
        <span data-i18n="w_google_login">Google„Åß„É≠„Ç∞„Ç§„É≥</span>
      </button>

      <!-- Ê©üËÉΩË™¨Êòé -->
      <div class="login-features" style="margin-top:16px">
        <div class="login-feature-item"><span class="login-feature-icon">üíæ</span><span data-i18n="w_feat_sync">„Çπ„Éû„Éõ„ÉªPC „Å©„Åì„Åß„ÇÇÂêåÊúü„Åó„Å¶Á∂ö„Åë„Çâ„Çå„Çã</span></div>
        <div class="login-feature-item"><span class="login-feature-icon">ü§ñ</span><span data-i18n="w_feat_ai">AI‰ºöË©±„ÅßË®ÄË™û„Çí„Å©„Çì„Å©„ÇìËÇ≤„Å¶„Çâ„Çå„Çã</span></div>
        <div class="login-feature-item"><span class="login-feature-icon">‚ú¶</span><span data-i18n="w_feat_trial">„Éó„É¨„Éü„Ç¢„É†„ÅØ‰ªä„Å™„Çâ14Êó•ÈñìÁÑ°Êñô„Åß„ÅäË©¶„Åó</span></div>
      </div>

      <!-- „É≠„Ç∞„Ç§„É≥Ê∏à„Åø„Éê„Éä„ÉºÔºà„É≠„Ç∞„Ç§„É≥‰∏≠„ÅÆ„ÅøË°®Á§∫Ôºâ -->
      <div id="logged-in-banner" style="display:none;margin-top:16px;padding:14px 18px;border:1px solid var(--success-border);border-radius:12px;background:var(--success-dim);text-align:center">
        <div style="font-size:0.8rem;color:var(--success);font-weight:600;margin-bottom:8px" data-i18n="w_logged_in">‚úì „É≠„Ç∞„Ç§„É≥‰∏≠„Åß„Åô</div>
        <div id="logged-in-name" style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:12px"></div>
        <button onclick="enterDashboard()" style="width:100%;padding:10px;border-radius:10px;border:none;background:var(--success);color:#fff;font-family:inherit;font-size:0.88rem;font-weight:700;cursor:pointer" data-i18n="w_continue">
          ‚òëÔ∏è „Åì„ÅÆ„Åæ„ÅæÁ∂ö„Åë„Çã ‚Üí
        </button>
      </div>

      <!-- „Ç≤„Çπ„Éà„Å®„Åó„Å¶Á∂ö„Åë„Çã -->
      <div class="login-divider" style="margin:20px 0 16px" data-i18n="w_or_guest">„Åæ„Åü„ÅØ</div>
      <button class="login-guest-btn" onclick="toggleGuestForm()" data-i18n="w_guest_start">„Ç≤„Çπ„Éà„Å®„Åó„Å¶Âßã„ÇÅ„ÇãÔºà„É≠„Ç∞„Ç§„É≥„Å™„ÅóÔºâ</button>

      <!-- „Ç≤„Çπ„ÉàÁî®„Éï„Ç©„Éº„É†ÔºàÂàùÊúüÈùûË°®Á§∫Ôºâ -->
      <div id="guest-form" style="display:none;margin-top:20px">
        <!-- Ë®ÄË™ûÂêç -->
        <div class="welcome-field">
          <label class="welcome-label" data-i18n="w_name_label">Ë®ÄË™û„ÅÆÂêçÂâç</label>
          <input class="welcome-input" id="w-langname"
            placeholder="‰æãÔºöSilv√°ri„ÄÅKaelon„ÄÅDrathun‚Ä¶"
            data-i18n-placeholder="w_name_placeholder"
            oninput="wCheckReady()"
            onkeydown="if(event.key==='Enter')wStart(true)">
          <span class="welcome-hint" data-i18n="w_name_hint">„ÅÇ„Å®„Åß„ÅÑ„Å§„Åß„ÇÇÂ§â„Åà„Çâ„Çå„Åæ„Åô</span>
        </div>

        <!-- „Ç§„É°„Éº„Ç∏ÈÅ∏Êäû -->
        <div class="welcome-field">
          <label class="welcome-label" data-i18n="w_vibe_label">„Å©„Çì„Å™Èõ∞Âõ≤Ê∞óÔºüÔºà„Çπ„Ç≠„ÉÉ„ÉóÂèØÔºâ</label>
          <div class="welcome-vibe-grid">
            <div class="welcome-vibe" data-vibe-key="w_vibe_elf" onclick="toggleWVibe(this,t('w_vibe_elf'))">üåø<span data-i18n="w_vibe_elf">Ëá™ÁÑ∂</span></div>
            <div class="welcome-vibe" data-vibe-key="w_vibe_dark" onclick="toggleWVibe(this,t('w_vibe_dark'))">‚öîÔ∏è<span data-i18n="w_vibe_dark">Â∏ùÂõΩ</span></div>
            <div class="welcome-vibe" data-vibe-key="w_vibe_cute" onclick="toggleWVibe(this,t('w_vibe_cute'))">üå∏<span data-i18n="w_vibe_cute">Â¶ñÁ≤æ</span></div>
            <div class="welcome-vibe" data-vibe-key="w_vibe_scifi" onclick="toggleWVibe(this,t('w_vibe_scifi'))">‚öôÔ∏è<span data-i18n="w_vibe_scifi">SF</span></div>
            <div class="welcome-vibe" data-vibe-key="w_vibe_ocean" onclick="toggleWVibe(this,t('w_vibe_ocean'))">üåä<span data-i18n="w_vibe_ocean">Êµ∑Ê¥ã</span></div>
            <div class="welcome-vibe" data-vibe-key="w_vibe_ancient" onclick="toggleWVibe(this,t('w_vibe_ancient'))">üèîÔ∏è<span data-i18n="w_vibe_ancient">Á•ûË©±</span></div>
          </div>
        </div>

        <button class="welcome-btn" id="w-start-btn" onclick="wStart(true)">
          <span data-i18n="w_start">„Ç≤„Çπ„Éà„ÅßÂßã„ÇÅ„Çã</span> <span style="font-size:1rem">‚Üí</span>
        </button>
        <p class="welcome-skip" onclick="wStart(true)" data-i18n="w_skip" style="margin-top:8px">ÂêçÂâç„Å™„Åó„Åß„Åô„ÅêÂßã„ÇÅ„Çã</p>
      </div>



      <!-- ÂâçÂõû„ÅÆÁ∂ö„Åç -->
      <div class="welcome-restore" id="w-restore" style="display:none">
        <div class="restore-label" data-i18n="w_restore_label">üíæ ÂâçÂõû„ÅÆÁ∂ö„Åç„Åå„ÅÇ„Çä„Åæ„Åô</div>
        <div class="restore-name" id="w-restore-name">‚Äî</div>
        <button class="btn btn-sm btn-gold" onclick="wRestore()" style="margin-top:8px" data-i18n="w_restore_btn">Á∂ö„Åç„Åã„ÇâÂÜçÈñã„Åô„Çã</button>
      </div>
    </div>
  </div>
</div>

<!-- SETUP „ÅØÂªÉÊ≠¢ ‚Äî page-setup „ÅØÁ©∫„Éö„Éº„Ç∏„Å®„Åó„Å¶ÊÆã„Åó„Å¶„Ç®„É©„ÉºÂõûÈÅø -->
<div class="page" id="page-setup"></div>

<!-- VOCAB PAGE (Áã¨Á´ãËæûÊõ∏„Éª„Éï„É©„ÉÉ„Ç∑„É•„Ç´„Éº„Éâ) -->
<div class="page" id="page-vocab">
  <div style="max-width:900px;margin:0 auto;padding:24px 20px calc(var(--bottom-nav-h) + 24px)">

    <!-- Êàª„Çã„Éú„Çø„É≥ -->
    <div style="margin-bottom:16px">
      <button onclick="goTo('dashboard');setNav('nav-dash');setBNav('bnav-dash')" style="display:flex;align-items:center;gap:6px;background:none;border:none;color:var(--text-secondary);font-family:inherit;font-size:0.82rem;cursor:pointer;padding:4px 0;transition:color 0.15s" onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-secondary)'">
        <span data-i18n="btn_back_home">‚Üê „Éõ„Éº„É†„Å´Êàª„Çã</span>
      </button>
    </div>
    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px">
      <div>
        <h1 style="font-family:'Cinzel',serif;font-size:1.5rem;font-weight:700;background:linear-gradient(135deg,var(--text-primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">üìñ ËæûÊõ∏</h1>
        <div style="font-size:0.75rem;color:var(--text-muted);margin-top:2px" id="vocab-page-count">0Ë™ûÁôªÈå≤Ê∏à„Åø</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-sm btn-primary" onclick="startFlashcard()" id="flashcard-start-btn">üÉè „Éï„É©„ÉÉ„Ç∑„É•„Ç´„Éº„Éâ</button>
        <button class="btn btn-sm btn-gold" onclick="openEditor('vocab')">Ôºã ÂçòË™û„ÇíËøΩÂä†</button>
      </div>
    </div>

    <!-- „É¢„Éº„Éâ„Çø„Éñ -->
    <div style="display:flex;gap:2px;border-bottom:1px solid var(--border);margin-bottom:20px;overflow-x:auto;scrollbar-width:none">
      <button class="editor-tab active" id="vp-tab-dict" onclick="switchVocabPageTab('dict')">üìñ ËæûÊõ∏</button>
      <button class="editor-tab" id="vp-tab-flash" onclick="switchVocabPageTab('flash')">üÉè „Éï„É©„ÉÉ„Ç∑„É•„Ç´„Éº„Éâ</button>
      <button class="editor-tab" id="vp-tab-add" onclick="switchVocabPageTab('add')">Ôºã ËøΩÂä†</button>
    </div>

    <!-- ËæûÊõ∏„Çø„Éñ -->
    <div id="vp-content-dict">
      <!-- Ê§úÁ¥¢„Éê„Éº -->
      <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center">
        <div style="position:relative;flex:1">
          <input class="input-field" placeholder="üîç ÂçòË™û„ÉªÊÑèÂë≥„ÅßÊ§úÁ¥¢‚Ä¶" id="vp-search" oninput="renderVocabPage()" style="padding-right:36px">
          <button style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.75rem" onclick="document.getElementById('vp-search').value='';renderVocabPage()">‚úï</button>
        </div>
        <button class="btn btn-sm" onclick="vpSortToggle()" id="vp-sort-btn" style="white-space:nowrap">A‚Üë</button>
      </div>

      <!-- ÂìÅË©û„Éï„Ç£„É´„Çø„Éº -->
      <div id="vp-pos-filter" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px"></div>

      <!-- ÂçòË™û„É™„Çπ„Éà -->
      <div id="vp-word-list"></div>
    </div>

    <!-- „Éï„É©„ÉÉ„Ç∑„É•„Ç´„Éº„Éâ„Çø„Éñ -->
    <div id="vp-content-flash" style="display:none">
      <!-- Ë®≠ÂÆö„Éë„Éç„É´ -->
      <div id="vp-flash-setup">
        <div style="background:var(--surface);border:1px solid var(--accent-border);border-radius:16px;padding:24px;margin-bottom:16px;box-shadow:var(--glow-accent)">
          <div style="font-size:0.7rem;font-weight:700;color:var(--accent);letter-spacing:0.14em;text-transform:uppercase;margin-bottom:18px">üÉè „Éï„É©„ÉÉ„Ç∑„É•„Ç´„Éº„ÉâË®≠ÂÆö</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:18px">
            <div>
              <div style="font-size:0.7rem;color:var(--text-muted);letter-spacing:0.08em;text-transform:uppercase;margin-bottom:8px">Âá∫È°åÊñπÂêë</div>
              <div style="display:flex;flex-direction:column;gap:8px">
                <label style="display:flex;align-items:center;gap:10px;font-size:0.82rem;color:var(--text-secondary);cursor:pointer;padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:var(--surface-2);transition:all 0.15s" onmouseover="this.style.borderColor='var(--accent-border)'" onmouseout="this.style.borderColor='var(--border)'">
                  <input type="radio" name="fc-dir" value="cl2jp" checked style="accent-color:var(--accent)"> „Ç≥„É≥„É©„É≥„Ç∞ ‚Üí ÊÑèÂë≥
                </label>
                <label style="display:flex;align-items:center;gap:10px;font-size:0.82rem;color:var(--text-secondary);cursor:pointer;padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:var(--surface-2);transition:all 0.15s" onmouseover="this.style.borderColor='var(--accent-border)'" onmouseout="this.style.borderColor='var(--border)'">
                  <input type="radio" name="fc-dir" value="jp2cl" style="accent-color:var(--accent)"> ÊÑèÂë≥ ‚Üí „Ç≥„É≥„É©„É≥„Ç∞
                </label>
                <label style="display:flex;align-items:center;gap:10px;font-size:0.82rem;color:var(--text-secondary);cursor:pointer;padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:var(--surface-2);transition:all 0.15s" onmouseover="this.style.borderColor='var(--accent-border)'" onmouseout="this.style.borderColor='var(--border)'">
                  <input type="radio" name="fc-dir" value="random" style="accent-color:var(--accent)"> „É©„É≥„ÉÄ„É†
                </label>
              </div>
            </div>
            <div>
              <div style="font-size:0.7rem;color:var(--text-muted);letter-spacing:0.08em;text-transform:uppercase;margin-bottom:8px">Âá∫È°åÁØÑÂõ≤</div>
              <div style="display:flex;flex-direction:column;gap:8px">
                <label style="display:flex;align-items:center;gap:10px;font-size:0.82rem;color:var(--text-secondary);cursor:pointer;padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:var(--surface-2);transition:all 0.15s" onmouseover="this.style.borderColor='var(--accent-border)'" onmouseout="this.style.borderColor='var(--border)'">
                  <input type="radio" name="fc-range" value="all" checked style="accent-color:var(--accent)"> ÂÖ®ÂçòË™û
                </label>
                <label style="display:flex;align-items:center;gap:10px;font-size:0.82rem;color:var(--text-secondary);cursor:pointer;padding:8px 10px;border-radius:8px;border:1px solid var(--gold-border);background:var(--gold-dim);transition:all 0.15s">
                  <input type="radio" name="fc-range" value="stared" style="accent-color:var(--gold)"> ‚≠ê „Çπ„Çø„ÉºÊ∏à„Åø„ÅÆ„Åø
                </label>
                <label style="display:flex;align-items:center;gap:10px;font-size:0.82rem;color:var(--text-secondary);cursor:pointer;padding:8px 10px;border-radius:8px;border:1px solid var(--rose-border);background:var(--rose-dim);transition:all 0.15s">
                  <input type="radio" name="fc-range" value="wrong" style="accent-color:var(--rose)"> ‚úó ‰∏çÊ≠£Ëß£„ÅÆ„Åø
                </label>
              </div>
            </div>
          </div>
          <div style="margin-bottom:18px">
            <div style="font-size:0.7rem;color:var(--text-muted);letter-spacing:0.08em;text-transform:uppercase;margin-bottom:8px">ÊûöÊï∞</div>
            <div style="display:flex;gap:8px">
              <button class="toggle-chip selected" id="fc-count-10" onclick="setFcCount(10,this)">10Êûö</button>
              <button class="toggle-chip" id="fc-count-20" onclick="setFcCount(20,this)">20Êûö</button>
              <button class="toggle-chip" id="fc-count-all" onclick="setFcCount(0,this)">ÂÖ®ÈÉ®</button>
            </div>
          </div>
          <button onclick="launchFlashcard()" style="width:100%;padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-family:inherit;font-size:1rem;font-weight:700;cursor:pointer;letter-spacing:0.04em;transition:filter 0.15s;box-shadow:var(--glow-accent)" onmouseover="this.style.filter='brightness(1.12)'" onmouseout="this.style.filter=''">
            üÉè „Çπ„Çø„Éº„Éà
          </button>
        </div>
        <div style="font-size:0.75rem;color:var(--text-muted);text-align:center" id="fc-stats-summary"></div>
      </div>

      <!-- „Ç´„Éº„ÉâUI -->
      <div id="vp-flash-card" style="display:none">
        <!-- ÈÄ≤Êçó„Éê„Éº -->
        <div style="margin-bottom:24px">
          <div style="display:flex;justify-content:space-between;font-size:0.72rem;color:var(--text-muted);margin-bottom:8px">
            <span id="fc-progress-label" style="color:var(--accent);font-weight:600">1 / 10</span>
            <span id="fc-score-label">‚úì <span style="color:var(--success)">0</span>„ÄÄ‚úó <span style="color:var(--rose)">0</span></span>
          </div>
          <div style="height:5px;background:var(--surface-3);border-radius:3px;overflow:hidden">
            <div id="fc-progress-bar" style="height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:3px;transition:width 0.4s ease;width:0%"></div>
          </div>
        </div>

        <!-- „Éï„É™„ÉÉ„Éó„Ç´„Éº„Éâ -->
        <div id="fc-card-wrap" style="perspective:1200px;margin:0 auto 28px;max-width:480px;cursor:pointer" onclick="flipCard()">
          <div id="fc-card-inner" style="position:relative;width:100%;padding-top:58%;transform-style:preserve-3d;transition:transform 0.55s cubic-bezier(0.4,0,0.2,1)">
            <!-- Ë°®Èù¢ -->
            <div style="position:absolute;inset:0;backface-visibility:hidden;background:linear-gradient(145deg,var(--surface),var(--surface-2));border:2px solid var(--accent-border);border-radius:22px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px;box-shadow:0 0 30px rgba(140,126,255,0.15)">
              <div style="font-size:0.6rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--accent);font-weight:700;margin-bottom:18px" id="fc-front-label">„Ç≥„É≥„É©„É≥„Ç∞</div>
              <div style="font-family:'Cinzel',serif;font-size:2rem;font-weight:700;color:var(--text-primary);text-align:center;word-break:break-all;letter-spacing:0.05em;line-height:1.2" id="fc-front-text">‚Äî</div>
              <div style="font-size:0.8rem;color:var(--accent2);font-family:monospace;margin-top:12px;letter-spacing:0.04em" id="fc-front-read"></div>
              <button onclick="event.stopPropagation();fcSpeak()" style="margin-top:16px;padding:7px 20px;border-radius:20px;border:1px solid var(--accent-border);background:var(--accent-dim);color:var(--accent);font-family:inherit;font-size:0.78rem;font-weight:600;cursor:pointer;transition:all 0.15s" onmouseover="this.style.background='var(--accent)';this.style.color='#fff'" onmouseout="this.style.background='var(--accent-dim)';this.style.color='var(--accent)'" id="fc-speak-btn">üîä Áô∫Èü≥</button>
              <div style="position:absolute;bottom:14px;font-size:0.62rem;color:var(--text-muted);display:flex;align-items:center;gap:4px">„Çø„ÉÉ„Éó„ÅßÁ≠î„Åà„ÇíÁ¢∫Ë™ç ‚Üë</div>
            </div>
            <!-- Ë£èÈù¢ -->
            <div style="position:absolute;inset:0;backface-visibility:hidden;background:linear-gradient(145deg,var(--surface),rgba(201,169,110,0.06));border:2px solid var(--gold-border);border-radius:22px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px;box-shadow:0 0 30px rgba(201,169,110,0.12);transform:rotateY(180deg)">
              <div style="font-size:0.6rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--gold);font-weight:700;margin-bottom:18px" id="fc-back-label">ÊÑèÂë≥</div>
              <div style="font-size:1.9rem;font-weight:700;color:var(--gold);text-align:center;line-height:1.2" id="fc-back-text">‚Äî</div>
              <div style="font-size:0.8rem;color:var(--text-secondary);margin-top:10px;padding:3px 10px;border-radius:6px;background:var(--surface-2);border:1px solid var(--border)" id="fc-back-pos"></div>
              <div style="font-size:0.72rem;color:var(--accent2);margin-top:8px" id="fc-back-tags"></div>
            </div>
          </div>
        </div>

        <!-- Ê≠£Ëß£/‰∏çÊ≠£Ëß£„Éú„Çø„É≥ -->
        <div id="fc-answer-btns" style="display:none;gap:12px;justify-content:center">
          <button onclick="fcAnswer(false)" style="flex:1;max-width:180px;padding:16px;border-radius:16px;border:2px solid var(--rose-border);background:var(--rose-dim);color:var(--rose);font-family:inherit;font-size:1rem;font-weight:700;cursor:pointer;transition:all 0.18s;letter-spacing:0.02em" onmouseover="this.style.background='var(--rose)';this.style.color='#fff'" onmouseout="this.style.background='var(--rose-dim)';this.style.color='var(--rose)'">
            ‚úó „ÇÇ„ÅÜ‰∏ÄÂ∫¶
          </button>
          <button onclick="fcAnswer(true)" style="flex:1;max-width:180px;padding:16px;border-radius:16px;border:2px solid var(--success-border);background:var(--success-dim);color:var(--success);font-family:inherit;font-size:1rem;font-weight:700;cursor:pointer;transition:all 0.18s;letter-spacing:0.02em" onmouseover="this.style.background='var(--success)';this.style.color='#fff'" onmouseout="this.style.background='var(--success-dim)';this.style.color='var(--success)'">
            ‚úì Ê≠£Ëß£ÔºÅ
          </button>
        </div>
        <div id="fc-flip-hint" style="text-align:center;margin-top:14px;font-size:0.7rem;color:var(--text-muted);letter-spacing:0.06em">„Çø„ÉÉ„Éó„Åó„Å¶„ÇÅ„Åè„Çã</div>
      </div>

      <!-- ÁµêÊûúÁîªÈù¢ -->
      <div id="vp-flash-result" style="display:none;text-align:center;padding:40px 20px">
        <div style="font-size:3.5rem;margin-bottom:14px;animation:fadeUp 0.4s ease both" id="fc-result-emoji">üéâ</div>
        <div style="font-family:'Cinzel',serif;font-size:1.4rem;font-weight:700;color:var(--text-primary);margin-bottom:8px" id="fc-result-title">„ÅäÁñ≤„ÇåÊßòÔºÅ</div>
        <div style="font-size:0.88rem;color:var(--text-secondary);margin-bottom:32px" id="fc-result-body"></div>
        <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
          <button onclick="launchFlashcard()" style="padding:11px 24px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-family:inherit;font-size:0.9rem;font-weight:700;cursor:pointer;transition:filter 0.15s" onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter=''">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
          <button onclick="showWrongWords()" id="fc-retry-wrong-btn" style="display:none;padding:11px 24px;border-radius:12px;border:2px solid var(--rose-border);background:var(--rose-dim);color:var(--rose);font-family:inherit;font-size:0.9rem;font-weight:700;cursor:pointer;transition:all 0.15s" onmouseover="this.style.background='var(--rose)';this.style.color='#fff'" onmouseout="this.style.background='var(--rose-dim)';this.style.color='var(--rose)'">‚úó ‰∏çÊ≠£Ëß£„Å†„ÅëÂæ©Áøí</button>
          <button onclick="switchVocabPageTab('dict')" style="padding:11px 24px;border-radius:12px;border:1px solid var(--border);background:var(--surface-2);color:var(--text-secondary);font-family:inherit;font-size:0.9rem;font-weight:600;cursor:pointer;transition:all 0.15s" onmouseover="this.style.borderColor='var(--accent-border)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-secondary)'">ËæûÊõ∏„Å´Êàª„Çã</button>
        </div>
        <div id="fc-wrong-list" style="margin-top:28px;text-align:left"></div>
      </div>
    </div>

    <!-- ËøΩÂä†„Çø„ÉñÔºàÊó¢Â≠ò„ÅÆbuildVocab„ÅÆËøΩÂä†ÈÉ®ÂàÜÔºâ -->
    <div id="vp-content-add" style="display:none">
      <div id="vp-add-body"></div>
    </div>

  </div>
</div>

<!-- DASHBOARD -->
<div class="page" id="page-dashboard">
  <div style="max-width:1040px;margin:0 auto;padding:36px 40px 100px">
    <div class="dash-header">
      <div>
        <div class="dash-langname" id="dash-langname">‚Äî</div>
        <div class="dash-meta">
          <span class="meta-chip" id="meta-script">ÊñáÂ≠ó: ‚Äî</span>
          <span class="meta-chip" id="meta-route">‚Äî</span>
          <span class="meta-chip accent" onclick="editLangName()" data-i18n="dash_rename">‚úé ÂêçÂâç„ÇíÂ§â„Åà„Çã</span>
          <span class="meta-chip" style="color:var(--text-muted);cursor:pointer" onclick="resetConfirm()" data-i18n-title="confirm_reset_title" data-i18n="dash_reset">‚Ü∫ „É™„Çª„ÉÉ„Éà</span>
          <!-- V9: Visibility chip -->
          <span class="meta-chip" id="dash-vis-chip" onclick="openVisPopup()" style="cursor:pointer">üîí ÈùûÂÖ¨Èñã</span>
        </div>
      </div>
      <!-- V9: Quick actions -->
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button class="btn btn-sm btn-primary" onclick="showTemplateSelector()" style="font-size:0.72rem">üé® „ÉÜ„É≥„Éó„É¨„Éº„Éà</button>
        <button class="btn btn-sm" onclick="exportJSON()" data-i18n-title="dash_export" style="font-size:0.72rem" data-i18n="dash_export">üì§ „Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
        <button class="btn btn-sm btn-gold" onclick="goTo('aichat')" style="font-size:0.72rem" data-i18n="nav_aichat">ü§ñ AI‰ºöË©±</button>
        <button class="btn btn-sm" onclick="goTo('library')" style="font-size:0.72rem;color:var(--success)" data-i18n="nav_library">üåø „É©„Ç§„Éñ„É©„É™</button>
      </div>
    </div>
    <div class="dash-progress">
      <div class="progress-ring">
        <svg width="84" height="84" viewBox="0 0 84 84">
          <circle cx="42" cy="42" r="36" fill="none" stroke="var(--surface-3)" stroke-width="7"/>
          <circle cx="42" cy="42" r="36" fill="none" stroke="url(#arc-grad)" stroke-width="7"
            stroke-dasharray="226.2" stroke-dashoffset="226.2" stroke-linecap="round"
            id="progress-arc" style="transition:stroke-dashoffset 1s ease"/>
          <defs>
            <linearGradient id="arc-grad" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#8c7eff"/>
              <stop offset="100%" stop-color="#c07bff"/>
            </linearGradient>
          </defs>
        </svg>
        <div class="ring-num">
          <span class="ring-pct" id="dash-pct">0%</span>
          <span class="ring-label" data-i18n="dash_complete">ÂÆåÊàêÂ∫¶</span>
        </div>
      </div>
      <div class="dash-stats">
        <div class="stat"><div class="stat-num" id="stat-words">0</div><div class="stat-label" data-i18n="dash_words">Ë™ûÂΩôÊï∞</div></div>
        <div class="stat"><div class="stat-num" id="stat-patterns">0</div><div class="stat-label" data-i18n="dash_patterns">ÊñáÊ≥ï„Éë„Çø„Éº„É≥</div></div>
        <div class="stat"><div class="stat-num" id="stat-corpus">0</div><div class="stat-label" data-i18n="dash_corpus">‰æãÊñáÊï∞</div></div>
        <div class="stat"><div class="stat-num" id="stat-done">0/6</div><div class="stat-label" data-i18n="dash_done">Ë®≠ÂÆöÊ∏à„Åø</div></div>
      </div>
    </div>
    
    <!-- V21: „ÇØ„Ç®„Çπ„Éà„Ç∑„Çπ„ÉÜ„É† -->
    <p class="section-label">üéØ „ÅØ„Åò„ÇÅ„Å¶„ÅÆ„ÇØ„Ç®„Çπ„Éà</p>
    <div id="quest-container"></div>
    
    <p class="section-label" data-i18n="daily_label">‰ªäÊó•„ÅÆ1Êñá„ÉÅ„É£„É¨„É≥„Ç∏</p>
    <div class="daily-card">
      <div class="daily-badge">‚ú¶ <span data-i18n="mm_daily">1Êó•1Êñá</span> ‚Äî <span id="daily-date">2Êúà24Êó•</span></div>
      <div class="daily-sentence" id="daily-sentence">‰ªäÊó•„ÅØÁ©∫„ÅåÈùí„ÅÑ</div>
      <div class="daily-sub" data-i18n="daily_input_hint">„Åì„ÅÆÊñá„Çí„ÅÇ„Å™„Åü„ÅÆË®ÄË™û„ÅßÊõ∏„ÅÑ„Å¶„Åø„Çà„ÅÜ</div>
      <div class="daily-input-wrap">
        <input class="daily-input" id="daily-input" data-i18n-placeholder="daily_input_hint">
        <button class="btn btn-primary btn-sm" onclick="submitDaily()" data-i18n="btn_send">ÈÄÅ‰ø°</button>
        <button class="btn btn-sm" onclick="checkGrammar(document.getElementById('daily-input').value)" data-i18n="daily_check">‚úì Ê∑ªÂâä</button>
      </div>
      <div id="daily-feedback" style="margin-top:10px"></div>
    </div>
    <script>
    // 1Êó•1Êñá„ÇíÂç≥Â∫ß„Å´Ë®≠ÂÆöÔºà„Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„Å´Á¢∫ÂÆü„Å´ÂÆüË°åÔºâ
    (function(){
      const sentences={
        ja:['‰ªäÊó•„ÅØÁ©∫„ÅåÈùí„ÅÑ','ÂèãÈÅî„Å´‰ºö„ÅÑ„Å´Ë°å„Åè','Â•Ω„Åç„Å™È£ü„ÅπÁâ©„ÅØ‰Ωï„Åß„Åô„ÅãÔºü','ÊòéÊó•„Åæ„Åü‰ºö„ÅÑ„Åæ„Åó„Çá„ÅÜ','Êòü„ÅåÁ∂∫È∫ó„Å™Â§ú„Åß„Åô„Å≠','„Åì„ÅÆÈÅì„ÅØ„Å©„Åì„Å∏Á∂ö„Åè„ÅÆ„Åã','Ê∞¥„Çí‰∏ÄÊùØ„Åè„Å†„Åï„ÅÑ','„ÅÇ„Å™„Åü„ÅÆÂêçÂâç„ÅØ‰Ωï„Åß„Åô„ÅãÔºü','Â§¢„ÅÆ‰∏≠„ÅßÈ£õ„Çì„Åß„ÅÑ„Åü','Â±±„ÅÆÂêë„Åì„ÅÜ„Å´‰Ωï„Åå„ÅÇ„Çã„Å†„Çç„ÅÜ','ÁÅ´„ÅÆÂë®„Çä„ÅßÊ≠å„ÇíÊ≠å„Å£„Åü','Êµ∑„ÅØÂ∫É„Åè„ÄÅÊ∑±„ÅÑ'],
        en:["The sky is blue today","I'm going to meet a friend","What is your favorite food?","Let's meet again tomorrow","What a beautiful starry night","Where does this road lead?","Please give me a glass of water","What is your name?","I was flying in a dream","What lies beyond the mountains?","We sang songs around the fire","The sea is wide and deep"],
        zh:['‰ªäÂ§©Â§©Á©∫ÂæàËìù','ÊàëË¶ÅÂéªËßÅÊúãÂèã','‰Ω†ÊúÄÂñúÊ¨¢ÁöÑÈ£üÁâ©ÊòØ‰ªÄ‰πàÔºü','ÊòéÂ§©ÂÜçËßÅÂêß','Â§ö‰πàÁæé‰∏ΩÁöÑÊòüÂ§úÂïä','ËøôÊù°Ë∑ØÈÄöÂêëÂì™ÈáåÔºü','ËØ∑ÁªôÊàë‰∏ÄÊùØÊ∞¥','‰Ω†Âè´‰ªÄ‰πàÂêçÂ≠óÔºü','ÊàëÂú®Ê¢¶‰∏≠È£ûÁøî','Â±±ÁöÑÈÇ£ËæπÊúâ‰ªÄ‰πàÔºü','Êàë‰ª¨Âõ¥ÁùÄÁÅ´Â†ÜÂî±Ê≠å','Â§ßÊµ∑ÂÆΩÂπøËÄåÊ∑±ÈÇÉ'],
        es:['El cielo est√° azul hoy','Voy a ver a un amigo','¬øCu√°l es tu comida favorita?','Nos vemos ma√±ana','¬°Qu√© noche tan estrellada!','¬øAd√≥nde lleva este camino?','Por favor, dame un vaso de agua','¬øCu√°l es tu nombre?','Estaba volando en un sue√±o','¬øQu√© hay m√°s all√° de las monta√±as?','Cantamos canciones alrededor del fuego','El mar es ancho y profundo']
      };
      
      // Ë®ÄË™ûÂ§âÊõ¥ÊôÇ„Å´Êõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞„Çí„Ç∞„É≠„Éº„Éê„É´„Å´ÁôªÈå≤
      window.updateDailySentence = function(){
        const today=new Date();
        const lang=(typeof S!=='undefined'&&S.lang)?S.lang:'ja';
        const list=sentences[lang]||sentences.ja;
        const text=list[today.getDate()%list.length];
        const el=document.getElementById('daily-sentence');
        if(el)el.textContent=text;
        
        // Êó•‰ªò„ÇÇÊõ¥Êñ∞
        const dateEl=document.getElementById('daily-date');
        if(dateEl){
          try{
            const locales={ja:'ja-JP',en:'en-US',zh:'zh-CN',es:'es-ES'};
            dateEl.textContent=today.toLocaleDateString(locales[lang]||'ja-JP',{month:'long',day:'numeric'});
          }catch(e){
            dateEl.textContent=today.toLocaleDateString('ja-JP',{month:'long',day:'numeric'});
          }
        }
      };
      
      // ÂàùÂõûÂÆüË°å
      window.updateDailySentence();
    })();
    </script>
    <p class="section-label" data-i18n="settings_label">Ë®ÄË™û„ÅÆË®≠ÂÆö</p>
    <div class="module-grid">
      <div class="module-card" id="card-vibe" onclick="openEditor('vibe')">
        <div class="module-icon">‚ú¶</div><div class="module-title" data-i18n="card_vibe_title">‰∏ñÁïåË¶≥„Éª„Ç§„É°„Éº„Ç∏</div>
        <div class="module-desc" data-i18n="card_vibe_desc">Ë®ÄË™û„ÅÆÈõ∞Âõ≤Ê∞ó„ÇíAI„Å´‰ºù„Åà„Å¶„ÄÅÈü≥„ÉªÊñáÊ≥ï„ÅÆÊñπÂêëÊÄß„ÇíÊèêÊ°à„Åó„Å¶„ÇÇ„Çâ„ÅÑ„Åæ„Åô„ÄÇ</div>
        <div class="module-preview" id="preview-vibe"><span style="color:var(--text-muted);font-size:0.7rem" data-i18n="card_not_set">„Åæ„Å†Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</span></div>
      </div>
      <div class="module-card" id="card-script" onclick="openEditor('script')">
        <div class="module-icon">‚úç</div><div class="module-title" data-i18n="card_script_title">ÊñáÂ≠ó‰ΩìÁ≥ª„Éª„Éï„Ç©„É≥„Éà„Éû„ÉÉ„Éî„É≥„Ç∞</div>
        <div class="module-desc" data-i18n="card_script_desc">„Ç¢„É´„Éï„Ç°„Éô„ÉÉ„Éà„Å´Áã¨Ëá™„ÅÆÊñáÂ≠ó„ÇíÂØæÂøú‰ªò„Åë„ÄÇ„É™„Ç¢„É´„Çø„Ç§„É†„Éó„É¨„Éì„É•„Éº„ÅßÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ</div>
        <div class="module-preview" id="preview-script"><span style="color:var(--text-muted);font-size:0.7rem" data-i18n="card_not_set">„Åæ„Å†Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</span></div>
      </div>
      <div class="module-card" id="card-phoneme" onclick="openEditor('phoneme')">
        <div class="module-icon">üîä</div><div class="module-title" data-i18n="nav_phoneme">Èü≥Èüª</div>
        <div class="module-desc" data-i18n="card_phoneme_desc">ÊØçÈü≥„ÉªÂ≠êÈü≥„ÉªÈü≥ÁØÄÊßãÈÄ†„ÇíË®≠ÂÆö„ÄÇ„Ç§„É≥„Çπ„Éî„É¨„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅßÊñ∞ÂçòË™û„ÅÆÈüø„Åç„ÇíÁîüÊàê„ÄÇ</div>
        <div class="module-preview" id="preview-phoneme"><span style="color:var(--text-muted);font-size:0.7rem" data-i18n="card_not_set">„Åæ„Å†Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</span></div>
      </div>
      <div class="module-card" id="card-grammar" onclick="openEditor('grammar')">
        <div class="module-icon">‚öôÔ∏è</div><div class="module-title" data-i18n="card_grammar_title">ÊñáÊ≥ï + Ê†ºÂ§âÂåñ„Éû„Éà„É™„ÉÉ„ÇØ„Çπ</div>
        <div class="module-desc" data-i18n="card_grammar_desc">Ë™ûÈ†Ü„ÉªÊ†º„ÉªÊôÇÂà∂„ÉªÊ¥ªÁî®„ÄÇÊ†ºÂ§âÂåñË°®„Çí„Éù„ÉÅ„Éù„ÉÅÈÅ∏„Å∂„Å†„Åë„ÅßËá™ÂãïÁîüÊàê„ÄÇ</div>
        <div class="module-preview" id="preview-grammar"><span style="color:var(--text-muted);font-size:0.7rem" data-i18n="card_not_set">„Åæ„Å†Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</span></div>
      </div>
      <div class="module-card" id="card-vocab" onclick="goTo('vocab')">
        <div class="module-icon">üìñ</div><div class="module-title" data-i18n="card_vocab_title">Ë™ûÂΩô„ÉªËæûÊõ∏ÔºàÈÄÜÂºï„ÅçÂØæÂøúÔºâ</div>
        <div class="module-desc" data-i18n="card_vocab_desc">„Çø„Ç∞ÁÆ°ÁêÜ„ÉªÊó•Êú¨Ë™û‚Üí„Ç≥„É≥„É©„É≥„Ç∞ÈÄÜÂºï„Åç„Éª„Ç¨„ÉÅ„É£ÁîüÊàê„ÄÇ‰∏°ÊñπÂêë„Ç§„É≥„ÇØ„É™„É°„É≥„Çø„É´„Çµ„Éº„ÉÅ‰ªò„Åç„ÄÇ</div>
        <div class="module-preview" id="preview-vocab"><span style="color:var(--text-muted);font-size:0.7rem" data-i18n="card_vocab_empty">„Åæ„Å†ÂçòË™û„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</span></div>
      </div>
      <div class="module-card" id="card-corpus" onclick="openEditor('corpus')">
        <div class="module-icon">üí¨</div><div class="module-title" data-i18n="card_corpus_title">‰æãÊñá„Ç≥„Éº„Éë„Çπ + „Ç∑„Çß„Ç¢</div>
        <div class="module-desc" data-i18n="card_corpus_desc">‰æãÊñá„Ç´„Éº„ÉâÔºà„Ç≥„É≥„É©„É≥„Ç∞„ÉªË™≠„Åø„ÉªÊó•Êú¨Ë™ûË®≥Ôºâ„ÇíËìÑÁ©ç„ÄÇÁîªÂÉè„ÅßSNS„Ç∑„Çß„Ç¢„ÄÇ</div>
        <div class="module-preview" id="preview-corpus"><span style="color:var(--text-muted);font-size:0.7rem" data-i18n="card_corpus_empty">„Åæ„Å†‰æãÊñá„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</span></div>
      </div>
    </div>
  </div>
</div>

<!-- EDITOR OVERLAY -->
<div class="editor-overlay" id="editor-overlay" onclick="overlayClick(event)">
  <div class="editor-panel">
    <div class="editor-handle"></div>
    <!-- „É¢„Éê„Ç§„É´Áî®„Çπ„ÉÜ„Ç£„ÉÉ„Ç≠„Éº‰øùÂ≠ò„Éê„Éº -->
    <div class="editor-sticky-save">
      <span style="font-size:0.78rem;color:var(--text-secondary)" id="editor-sticky-title-m">Á∑®ÈõÜ‰∏≠</span>
      <div style="display:flex;gap:6px">
        <button class="btn btn-ghost btn-sm" onclick="closeEditor()">Èñâ„Åò„Çã</button>
        <button class="btn btn-primary btn-sm" onclick="saveEditor()">‰øùÂ≠ò ‚úì</button>
      </div>
    </div>
    <div class="editor-header">
      <div>
        <div class="editor-title" id="editor-title"></div>
        <div class="editor-desc" id="editor-desc"></div>
      </div>
      <button class="editor-close" onclick="closeEditor()">‚úï</button>
    </div>
    <div id="editor-body"></div>
    <div class="editor-footer">
      <button class="btn btn-ghost" onclick="closeEditor()">Èñâ„Åò„Çã</button>
      <button class="btn btn-primary" onclick="saveEditor()">‰øùÂ≠ò„Åô„Çã</button>
    </div>
  </div>
</div>

<canvas id="share-canvas-hidden" style="display:none"></canvas>

<!-- HELP MODAL -->
<div id="help-modal" style="display:none" class="help-modal" onclick="if(event.target===this)closeHelp()">
  <div class="help-modal-box">
    <button class="help-modal-close" onclick="closeHelp()">‚úï</button>
    <div class="help-modal-title" id="help-modal-title"></div>
    <div class="help-modal-body" id="help-modal-body"></div>
  </div>
</div>

<!-- LIBRARY PAGE -->
<div class="page" id="page-library">
  <div style="position:sticky;top:54px;z-index:50;background:rgba(10,10,14,0.88);backdrop-filter:blur(18px);border-bottom:1px solid var(--border);padding:10px 20px">
    <button onclick="goTo('dashboard');setNav('nav-dash');setBNav('bnav-dash')" style="display:flex;align-items:center;gap:6px;background:none;border:none;color:var(--text-secondary);font-family:inherit;font-size:0.82rem;cursor:pointer;padding:4px 0;transition:color 0.15s" onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-secondary)'">
      <span data-i18n="btn_back_home">‚Üê „Éõ„Éº„É†„Å´Êàª„Çã</span>
    </button>
  </div>
  <div style="max-width:1040px;margin:0 auto;padding:36px 40px 120px">
    <div class="lib-header">
      <div>
        <div class="lib-title" data-i18n="lib_title">üåø Ë®ÄË™û„É©„Ç§„Éñ„É©„É™</div>
        <p style="font-size:0.82rem;color:var(--text-secondary);margin-top:4px;font-style:italic" data-i18n="lib_sub">‰∏ñÁïå„ÅÆ„Ç≥„É≥„É©„É≥„Ç¨„Éº„Åå‰Ωú„Å£„ÅüË®ÄË™û„ÇíÁú∫„ÇÅ„Çà„ÅÜ</p>
      </div>
      <input class="lib-search" placeholder="üîç Ë®ÄË™ûÂêç„Éª„Ç∏„É£„É≥„É´„ÅßÊ§úÁ¥¢‚Ä¶" id="lib-search" oninput="filterLibrary()" data-i18n-placeholder="lib_search">
    </div>

    <p class="section-label" data-i18n="lib_community">„Ç≥„Éü„É•„Éã„ÉÜ„Ç£„ÅÆË®ÄË™û</p>
    <div class="lib-grid" id="lib-grid">
      <!-- populated by JS -->
    </div>
  </div>
</div>

<!-- LANG DETAIL MODAL -->
<div id="lang-detail-modal" style="display:none" class="help-modal" onclick="if(event.target===this)closeLangDetail()">
  <div class="help-modal-box" style="max-width:520px;max-height:80vh;overflow-y:auto">
    <button class="help-modal-close" onclick="closeLangDetail()">‚úï</button>
    <div id="lang-detail-body"></div>
  </div>
</div>

<!-- AI CHAT PAGE -->
<div class="page" id="page-aichat">
  <div style="position:sticky;top:54px;z-index:50;background:rgba(10,10,14,0.88);backdrop-filter:blur(18px);border-bottom:1px solid var(--border);padding:10px 20px">
    <button onclick="goTo('dashboard');setNav('nav-dash');setBNav('bnav-dash')" style="display:flex;align-items:center;gap:6px;background:none;border:none;color:var(--text-secondary);font-family:inherit;font-size:0.82rem;cursor:pointer;padding:4px 0;transition:color 0.15s" onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-secondary)'">
      <span data-i18n="btn_back_home">‚Üê „Éõ„Éº„É†„Å´Êàª„Çã</span>
    </button>
  </div>
  <div class="aichat-header">
    <div style="font-size:1.1rem">ü§ñ</div>
    <div>
      <div class="aichat-lang-name" id="aichat-lang-name">‚Äî</div>
      <div style="font-size:0.68rem;color:var(--text-muted)" data-i18n="aichat_sub">„ÅÇ„Å™„Åü„ÅÆË®ÄË™û„É´„Éº„É´„Åß‰ºöË©±„Åô„Çã</div>
    </div>
    <div class="aichat-mode-badge" data-i18n="aichat_badge">Conlang-AI</div>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button class="btn btn-sm" onclick="clearChat()" data-i18n="btn_clear_chat">üóë „ÇØ„É™„Ç¢</button>
      <button class="btn btn-sm btn-gold" onclick="exportChatVocab()" data-i18n="btn_export_vocab">üìñ Êñ∞Ë™û„ÇíËæûÊõ∏„Å∏</button>
    </div>
  </div>

  <div class="aichat-messages" id="aichat-messages">
    <div class="chat-msg ai" id="aichat-welcome">
      <strong data-i18n="aichat_welcome_title">‚ú¶ Conlang-AI „Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ</strong><br>
      <span data-i18n="aichat_welcome_body">„ÅÇ„Å™„Åü„ÅÆËæûÊõ∏„ÉªÊñáÊ≥ï„É´„Éº„É´„ÇíË™≠„ÅøËæº„Çì„Åß‰ºöË©±„Åó„Åæ„Åô„ÄÇ„Åæ„Åö„ÅØËá™ÂàÜ„ÅÆË®ÄË™û„ÅßË©±„Åó„Åã„Åë„Å¶„Åø„Çà„ÅÜÔºÅÊñáÊ≥ï„ÇíÈñìÈÅï„Åà„Çã„Å®Ê∑ªÂâä„Åó„Å¶„Åè„Çå„Åæ„Åô„ÄÇ</span>
    </div>
  </div>

  <div style="padding:10px 20px;background:rgba(10,10,14,0.6);border-top:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap">
    <button class="btn btn-sm" onclick="sendChatPrompt(t('aichat_quick_hi'))" style="font-size:0.72rem" data-i18n="aichat_quick_hi">„Åì„Çì„Å´„Å°„ÅØ</button>
    <button class="btn btn-sm" onclick="sendChatPrompt(t('aichat_quick_name'))" style="font-size:0.72rem" data-i18n="aichat_quick_name">ÁßÅ„ÅÆÂêçÂâç„ÅØ‚Ä¶</button>
    <button class="btn btn-sm" onclick="sendChatPrompt(t('aichat_quick_date'))" style="font-size:0.72rem" data-i18n="aichat_quick_date">‰ªäÊó•„ÅØ‰ΩïÊó•Ôºü</button>
    <button class="btn btn-sm" onclick="askForNewWord()" style="font-size:0.72rem" data-i18n="aichat_quick_word">‚ú¶ Êñ∞Ë™û„ÇíÊèêÊ°à„Åó„Å¶</button>
  </div>

  <div class="aichat-input-row">
    <input class="aichat-input" id="aichat-input" placeholder="„ÅÇ„Å™„Åü„ÅÆË®ÄË™û„ÅßÂÖ•Âäõ‚Ä¶ „Åæ„Åü„ÅØÊó•Êú¨Ë™û„Åß„ÇÇOK" data-i18n-placeholder="aichat_placeholder"
      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}">
    <button class="btn btn-primary" onclick="sendChat()" data-i18n="btn_send">ÈÄÅ‰ø°</button>
  </div>
</div>

<!-- FAQ PAGE -->
<div class="page" id="page-faq">
  <div style="padding:36px 40px 180px;max-width:800px;margin:0 auto">
    <div style="text-align:center;margin-bottom:40px">
      <div style="font-family:'Cinzel',serif;font-size:2rem;font-weight:700;margin-bottom:10px;background:linear-gradient(135deg,var(--text-primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent" data-i18n="faq_title">‚ùì „Çà„Åè„ÅÇ„ÇãË≥™Âïè</div>
      <div style="font-size:0.9rem;color:var(--text-secondary)" data-i18n="faq_subtitle">Lingua„ÅÆ‰Ωø„ÅÑÊñπ„ÉªÊ©üËÉΩ„ÉªÊñôÈáë„Å´„Å§„ÅÑ„Å¶</div>
    </div>
    
    <div class="faq-section">
      <div class="faq-category" data-i18n="faq_cat_basic">üåü Âü∫Êú¨Ê©üËÉΩ</div>
      
      <div class="faq-item">
        <div class="faq-question" data-i18n="faq_q1">Lingua„Å£„Å¶‰Ωï„Åå„Åß„Åç„Çã„ÅÆÔºü</div>
        <div class="faq-answer" data-i18n="faq_a1">Lingua„ÅØ‰∫∫Â∑•Ë®ÄË™ûÔºà„Ç≥„É≥„É©„É≥„Ç∞Ôºâ„Çí‰ΩúÊàê„ÉªÁÆ°ÁêÜ„Åß„Åç„ÇãWeb„Ç¢„Éó„É™„Åß„Åô„ÄÇÊñáÂ≠ó‰ΩìÁ≥ª„ÄÅÈü≥Èüª„ÄÅÊñáÊ≥ï„ÄÅËæûÊõ∏„ÄÅ‰æãÊñá„Ç≥„Éº„Éë„Çπ„Çí‰∏ÄÂÖÉÁÆ°ÁêÜ„ÄÇAIÊ©üËÉΩ„ÅßÊñ∞Ë™ûÁîüÊàê„ÇÑÊñáÊ≥ï„ÉÅ„Çß„ÉÉ„ÇØ„ÇÇÂèØËÉΩ„Åß„Åô„ÄÇ</div>
      </div>
      
      <div class="faq-item">
        <div class="faq-question" data-i18n="faq_q2">ÁÑ°Êñô„Åß‰Ωø„Åà„ÇãÔºü</div>
        <div class="faq-answer" data-i18n="faq_a2">„ÅØ„ÅÑÔºÅÂü∫Êú¨Ê©üËÉΩ„ÅØÂÆåÂÖ®ÁÑ°Êñô„Åß„Åô„ÄÇËæûÊõ∏„ÉªÊñáÊ≥ï„Éª‰æãÊñá„ÅÆ‰ΩúÊàê„ÄÅJSON„Ç®„ÇØ„Çπ„Éù„Éº„Éà„ÄÅ„É©„Ç§„Éñ„É©„É™Èñ≤Ë¶ß„Åå„Åô„Åπ„Å¶ÁÑ°Êñô„ÄÇPro„Éó„É©„É≥„Åß„ÅØAIÊ©üËÉΩÁÑ°Âà∂Èôê„ÄÅ„ÇØ„É©„Ç¶„ÉâÂêåÊúü„ÄÅË§áÊï∞Ë®ÄË™û‰ΩúÊàê„ÅåÂèØËÉΩ„Å´„Å™„Çä„Åæ„Åô„ÄÇ</div>
      </div>
      
      <div class="faq-item">
        <div class="faq-question" data-i18n="faq_q3">„Éá„Éº„Çø„ÅØ‰øùÂ≠ò„Åï„Çå„ÇãÔºü</div>
        <div class="faq-answer" data-i18n="faq_a3">„Éñ„É©„Ç¶„Ç∂„ÅÆ„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´Ëá™Âãï‰øùÂ≠ò„Åï„Çå„Åæ„Åô„ÄÇPro„É¶„Éº„Ç∂„Éº„ÅØ„ÇØ„É©„Ç¶„ÉâÂêåÊúüÊ©üËÉΩ„ÅßË§áÊï∞„Éá„Éê„Ç§„ÇπÈñì„Åß„Éá„Éº„Çø„ÇíÂÖ±Êúâ„Åß„Åç„Åæ„Åô„ÄÇ</div>
      </div>
    </div>
    
    <div class="faq-section">
      <div class="faq-category" data-i18n="faq_cat_features">‚ö° Ê©üËÉΩ„Å´„Å§„ÅÑ„Å¶</div>
      
      <div class="faq-item">
        <div class="faq-question" data-i18n="faq_q4">AIÊ©üËÉΩ„ÅØ„Å©„ÅÜ‰Ωø„ÅÜ„ÅÆÔºü</div>
        <div class="faq-answer" data-i18n="faq_a4">ËæûÊõ∏„Çø„Éñ„ÅÆ„Äå„Ç¨„ÉÅ„É£ÁîüÊàê„Äç„ÅßÈü≥Èüª„É´„Éº„É´„Å´Âü∫„Å•„ÅÑ„ÅüÊñ∞Ë™û„ÇíËá™ÂãïÁîüÊàê„ÄÇAI‰ºöË©±Ê©üËÉΩ„Åß„ÅØ„ÄÅ„ÅÇ„Å™„Åü„ÅÆË®ÄË™û„É´„Éº„É´„Åß‰ºöË©±Á∑¥Áøí„ÇÑÊñáÊ≥ï„ÉÅ„Çß„ÉÉ„ÇØ„Åå„Åß„Åç„Åæ„Åô„ÄÇ</div>
      </div>
      
      <div class="faq-item">
        <div class="faq-question" data-i18n="faq_q5">Ë§áÊï∞„ÅÆË®ÄË™û„Çí‰Ωú„Çå„ÇãÔºü</div>
        <div class="faq-answer" data-i18n="faq_a5">Free„Éó„É©„É≥„ÅØ1Ë®ÄË™û„ÅÆ„Åø„ÄÇLite„Éó„É©„É≥„Å®Premium„Éó„É©„É≥„Åß„ÅØÁÑ°Âà∂Èôê„Å´‰ΩúÊàê„Åß„Åç„Åæ„Åô„ÄÇ</div>
      </div>
      
      <div class="faq-item">
        <div class="faq-question" data-i18n="faq_q6">‰ªñ„ÅÆ‰∫∫„ÅÆË®ÄË™û„ÇíË¶ã„Çå„ÇãÔºü</div>
        <div class="faq-answer" data-i18n="faq_a6">„ÅØ„ÅÑÔºÅ„Äåüåø „É©„Ç§„Éñ„É©„É™„Äç„Åã„ÇâÂÖ¨Èñã„Åï„Çå„Å¶„ÅÑ„ÇãË®ÄË™û„ÇíÈñ≤Ë¶ß„Éª„Ç§„É≥„Éù„Éº„Éà„Åß„Åç„Åæ„Åô„ÄÇËá™ÂàÜ„ÅÆË®ÄË™û„ÇÇÂÖ¨ÈñãË®≠ÂÆö„ÅßÂÖ±ÊúâÂèØËÉΩ„Åß„Åô„ÄÇ</div>
      </div>
    </div>
    
    <div class="faq-section">
      <div class="faq-category" data-i18n="faq_cat_pricing">üíé ÊñôÈáë„Éó„É©„É≥</div>
      
      <div class="faq-item">
        <div class="faq-question" data-i18n="faq_q7">Pro„Éó„É©„É≥„ÅÆÊñôÈáë„ÅØÔºü</div>
        <div class="faq-answer" data-i18n="faq_a7">Lite: $4.99/Êúà„ÄÅPremium: $9.99/Êúà„ÄÇ14Êó•ÈñìÁÑ°Êñô„Éà„É©„Ç§„Ç¢„É´„ÅÇ„Çä„ÄÇ„ÅÑ„Å§„Åß„ÇÇ„Ç≠„É£„É≥„Çª„É´ÂèØËÉΩ„Åß„Åô„ÄÇ</div>
      </div>
      
      <div class="faq-item">
        <div class="faq-question" data-i18n="faq_q8">ÁÑ°ÊñôÁâà„Å®„ÅÆÈÅï„ÅÑ„ÅØÔºü</div>
        <div class="faq-answer" data-i18n="faq_a8">
          <strong>Free:</strong> 1Ë®ÄË™û„ÄÅAI‰ºöË©±10Âõû/Êó•„ÄÅ„É≠„Éº„Ç´„É´‰øùÂ≠ò„ÅÆ„Åø<br>
          <strong>Lite:</strong> ÁÑ°Âà∂Èôê„ÅÆË®ÄË™û„ÄÅAI‰ºöË©±50Âõû/Êó•„ÄÅ„ÇØ„É©„Ç¶„ÉâÂêåÊúü<br>
          <strong>Premium:</strong> „Åô„Åπ„Å¶ÁÑ°Âà∂Èôê„ÄÅÂÑ™ÂÖà„Çµ„Éù„Éº„Éà„ÄÅÊñ∞Ê©üËÉΩÂÖàË°å„Ç¢„ÇØ„Çª„Çπ
        </div>
      </div>
    </div>
    
    <div class="faq-section">
      <div class="faq-category" data-i18n="faq_cat_support">üí¨ „Çµ„Éù„Éº„Éà</div>
      
      <div class="faq-item">
        <div class="faq-question" data-i18n="faq_q9">„Éê„Ç∞„ÇíË¶ã„Å§„Åë„ÅüÂ†¥Âêà„ÅØÔºü</div>
        <div class="faq-answer">
          <span data-i18n="faq_a9">ÁîªÈù¢Âè≥‰∏ä„ÅÆ„Äåüí¨ „ÅäÂïè„ÅÑÂêà„Çè„Åõ„Äç„Åã„Çâ„ÅîÂ†±Âëä„Åè„Å†„Åï„ÅÑ„ÄÇ„Åæ„Åü„ÅØÁõ¥Êé•</span> 
          <a href="/cdn-cgi/l/email-protection#1764626767786563577b7e797062767b7679703974787a" style="color:var(--accent)"><span class="__cf_email__" data-cfemail="83f0f6f3f3ecf1f7c3efeaede4f6e2efe2ede4ade0ecee">[email&#160;protected]</span></a> 
          <span data-i18n="faq_a9_2">„Åæ„Åß„É°„Éº„É´„Çí„ÅäÈÄÅ„Çä„Åè„Å†„Åï„ÅÑ„ÄÇ</span>
        </div>
      </div>
      
      <div class="faq-item">
        <div class="faq-question" data-i18n="faq_q10">Ê©üËÉΩ„É™„ÇØ„Ç®„Çπ„Éà„ÅØÂèó„Åë‰ªò„Åë„Å¶„ÇãÔºü</div>
        <div class="faq-answer" data-i18n="faq_a10">Â§ßÊ≠ìËøé„Åß„ÅôÔºÅ„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Éï„Ç©„Éº„É†„Åã„Çâ„Äå‚ú® Ê©üËÉΩ„É™„ÇØ„Ç®„Çπ„Éà„Äç„ÇíÈÅ∏Êäû„Åó„Å¶„ÅäÈÄÅ„Çä„Åè„Å†„Åï„ÅÑ„ÄÇ„É¶„Éº„Ç∂„Éº„ÅÆÂ£∞„ÇíÂ§ßÂàá„Å´„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ</div>
      </div>
    </div>
    
    <div style="text-align:center;margin-top:50px;padding:30px;background:var(--surface);border:1px solid var(--border);border-radius:16px">
      <div style="font-size:1.1rem;font-weight:600;margin-bottom:10px" data-i18n="faq_more">‰ªñ„Å´Ë≥™Âïè„Åå„ÅÇ„ÇãÂ†¥Âêà</div>
      <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:20px" data-i18n="faq_more_desc">„ÅäÊ∞óËªΩ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ</div>
      <button class="btn btn-primary" onclick="openContactForm()" data-i18n="btn_contact">üí¨ „ÅäÂïè„ÅÑÂêà„Çè„Åõ</button>
    </div>
  </div>
</div>

<!-- VISIBILITY POPUP -->
<div id="vis-popup" style="display:none" class="vis-popup" onclick="if(event.target===this)closeVisPopup()">
  <div class="vis-popup-box">
    <div class="vis-popup-title" data-i18n="vis_popup_title">üåç ÂÖ¨ÈñãË®≠ÂÆö</div>
    <div class="vis-option" onclick="setVisibility('private')" id="vopt-private">
      <div class="vis-option-title">üîí <span data-i18n="vis_private">ÈùûÂÖ¨Èñã</span></div>
      <div class="vis-option-desc" data-i18n="vis_private_desc">Ëá™ÂàÜ„Å†„Åë„ÅåË¶ã„Çâ„Çå„Åæ„Åô„ÄÇ‰∏ãÊõ∏„ÅçÁä∂ÊÖã„ÄÇ</div>
      <div class="vis-check">‚úì</div>
    </div>
    <div class="vis-option" onclick="setVisibility('unlisted')" id="vopt-unlisted">
      <div class="vis-option-title">üîó <span data-i18n="vis_unlisted">ÈôêÂÆöÂÖ¨Èñã</span></div>
      <div class="vis-option-desc" data-i18n="vis_unlisted_desc">URL„ÇíÁü•„Å£„Å¶„ÅÑ„Çã‰∫∫„Å†„Åë„ÅåË¶ã„Çâ„Çå„Åæ„Åô„ÄÇÂèãÈÅî„Å∏„ÅÆ„Ç∑„Çß„Ç¢„Å´‰æøÂà©„ÄÇ</div>
      <div class="vis-check">‚úì</div>
    </div>
    <div class="vis-option" onclick="setVisibility('public')" id="vopt-public">
      <div class="vis-option-title">üåø <span data-i18n="vis_public">ÂÖ¨Èñã</span></div>
      <div class="vis-option-desc" data-i18n="vis_public_desc">„É©„Ç§„Éñ„É©„É™„Å´Êé≤Ëºâ„ÄÇË™∞„Åß„ÇÇÈñ≤Ë¶ß„Éª„Ç§„É≥„Éù„Éº„Éà„Åß„Åç„Åæ„Åô„ÄÇ</div>
      <div class="vis-check">‚úì</div>
    </div>
    <div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.78rem;color:var(--text-secondary)">
        <input type="checkbox" id="vis-importable" style="accent-color:var(--accent)">
        <span data-i18n="vis_importable">„Ç§„É≥„Éù„Éº„ÉàË®±ÂèØ</span>
      </label>
      <button class="btn btn-sm" onclick="closeVisPopup()" data-i18n="btn_close">Èñâ„Åò„Çã</button>
    </div>
  </div>
</div>

<!-- CONTACT FORM POPUP -->
<!-- CONTACT PAGE -->
<div class="page" id="page-contact">
  <div style="max-width:700px;margin:0 auto;padding:24px 20px calc(var(--bottom-nav-h) + 24px)">
    
    <!-- Êàª„Çã„Éú„Çø„É≥ -->
    <div style="margin-bottom:16px">
      <button onclick="goTo('dashboard');setNav('nav-dash');setBNav('bnav-dash')" style="display:flex;align-items:center;gap:6px;background:none;border:none;color:var(--text-secondary);font-family:inherit;font-size:0.82rem;cursor:pointer;padding:4px 0;transition:color 0.15s" onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-secondary)'">
        <span>‚Üê „Éõ„Éº„É†„Å´Êàª„Çã</span>
      </button>
    </div>

    <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:28px;margin-bottom:24px">
      <div style="font-family:'Cinzel',serif;font-size:1.3rem;font-weight:700;margin-bottom:8px;background:linear-gradient(135deg,var(--text-primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent">üí¨ „ÅäÂïè„ÅÑÂêà„Çè„Åõ</div>
      <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:20px">„ÅîÊÑèË¶ã„Éª„ÅîË¶ÅÊúõ„Éª„Éê„Ç∞Â†±Âëä„Çí„ÅäÂæÖ„Å°„Åó„Å¶„Åä„Çä„Åæ„Åô</div>
      
      <div style="margin-bottom:16px">
        <label style="display:block;font-size:0.8rem;color:var(--text-secondary);margin-bottom:8px">„Ç´„ÉÜ„Ç¥„É™„Éº</label>
        <select id="contact-category" style="width:100%;padding:11px;border:1px solid var(--border);border-radius:8px;background:var(--surface-2);color:var(--text-primary);font-family:inherit;font-size:0.88rem">
          <option value="bug">üêõ „Éê„Ç∞Â†±Âëä</option>
          <option value="feature">‚ú® Ê©üËÉΩ„É™„ÇØ„Ç®„Çπ„Éà</option>
          <option value="feedback">üí≠ „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ</option>
          <option value="support">üôã „Çµ„Éù„Éº„Éà</option>
          <option value="other">„Åù„ÅÆ‰ªñ</option>
        </select>
      </div>
      
      <div style="margin-bottom:16px">
        <label style="display:block;font-size:0.8rem;color:var(--text-secondary);margin-bottom:8px">„É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÔºà‰ªªÊÑèÔºâ</label>
        <input type="email" id="contact-email" placeholder="your@email.com" style="width:100%;padding:11px;border:1px solid var(--border);border-radius:8px;background:var(--surface-2);color:var(--text-primary);font-family:inherit;font-size:0.88rem">
      </div>
      
      <div style="margin-bottom:20px">
        <label style="display:block;font-size:0.8rem;color:var(--text-secondary);margin-bottom:8px">„É°„ÉÉ„Çª„Éº„Ç∏</label>
        <textarea id="contact-message" placeholder="„ÅäÊ∞óËªΩ„Å´„ÅäÊõ∏„Åç„Åè„Å†„Åï„ÅÑ..." rows="8" style="width:100%;padding:11px;border:1px solid var(--border);border-radius:8px;background:var(--surface-2);color:var(--text-primary);font-family:inherit;resize:vertical;font-size:0.88rem;line-height:1.6"></textarea>
      </div>
      
      <div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:16px">
        „Åæ„Åü„ÅØÁõ¥Êé•„É°„Éº„É´„ÅßÔºö<a href="/cdn-cgi/l/email-protection#fb888e8b8b94898fbb9792959c8e9a979a959cd5989496" style="color:var(--accent);text-decoration:none"><span class="__cf_email__" data-cfemail="87f4f2f7f7e8f5f3c7ebeee9e0f2e6ebe6e9e0a9e4e8ea">[email&#160;protected]</span></a>
      </div>
      
      <button class="btn btn-primary" onclick="submitContactForm()" style="width:100%">ÈÄÅ‰ø°</button>
    </div>

  </div>
</div>

<!-- MEMO PAGE -->
<div id="page-memo" style="display:none" class="page-section">
  <div class="topbar-spacer"></div>
  <div class="container">
    <div style="max-width:900px;margin:0 auto;padding-bottom:calc(var(--bottom-nav-h) + 20px)">
      
      <!-- „Éò„ÉÉ„ÉÄ„Éº -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px">
        <div>
          <div style="font-family:'Cinzel',serif;font-size:1.6rem;font-weight:700;margin-bottom:6px;background:linear-gradient(135deg,var(--text-primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent">
            üìù „É°„É¢
          </div>
          <div style="font-size:0.82rem;color:var(--text-secondary)">
            „Ç¢„Ç§„Éá„Ç¢„ÇÑ„É°„É¢„ÇíËá™Áî±„Å´Ë®òÈå≤
          </div>
        </div>
        <button class="btn btn-primary" onclick="createNewMemo()">
          ‚ûï Êñ∞Ë¶è„É°„É¢
        </button>
      </div>

      <!-- Ê§úÁ¥¢„Éê„Éº -->
      <div style="margin-bottom:20px">
        <input type="text" id="memo-search" placeholder="üîç „É°„É¢„ÇíÊ§úÁ¥¢..." 
          oninput="filterMemos(this.value)"
          style="width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:10px;background:var(--surface-2);color:var(--text-primary);font-family:inherit;font-size:0.88rem">
      </div>

      <!-- „É°„É¢„É™„Çπ„Éà -->
      <div id="memo-list" style="display:grid;gap:14px">
        <!-- „É°„É¢„Ç´„Éº„Éâ„ÅåÂãïÁöÑ„Å´ÊåøÂÖ•„Åï„Çå„Çã -->
      </div>

      <!-- Á©∫„ÅÆÁä∂ÊÖã -->
      <div id="memo-empty" style="display:none;text-align:center;padding:60px 20px;color:var(--text-muted)">
        <div style="font-size:3rem;margin-bottom:16px;opacity:0.3">üìù</div>
        <div style="font-size:0.9rem;margin-bottom:12px">„Åæ„Å†„É°„É¢„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
        <div style="font-size:0.8rem;margin-bottom:20px">Êñ∞„Åó„ÅÑ„É°„É¢„Çí‰ΩúÊàê„Åó„Å¶„Ç¢„Ç§„Éá„Ç¢„ÇíË®òÈå≤„Åó„Åæ„Åó„Çá„ÅÜ</div>
        <button class="btn btn-primary" onclick="createNewMemo()">
          ‚ûï ÊúÄÂàù„ÅÆ„É°„É¢„Çí‰ΩúÊàê
        </button>
      </div>
    </div>
  </div>
</div>

<!-- IMPORT JSON POPUP (kept as popup) -->
<div id="import-popup" style="display:none" class="vis-popup" onclick="if(event.target===this)closeImportPopup()">
  <div class="vis-popup-box" style="max-width:440px">
    <div class="vis-popup-title" data-i18n="import_title">üì• Ë®ÄË™û„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà</div>
    <p style="font-size:0.78rem;color:var(--text-secondary);margin-bottom:14px;line-height:1.6" data-i18n="import_desc">Lingua„ÅÆJSON„Éï„Ç°„Ç§„É´„ÇíË≤º„Çä‰ªò„Åë„Å¶„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åô„ÄÇÁèæÂú®„ÅÆ„Éá„Éº„Çø„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇ</p>
    <textarea id="import-json-area" style="width:100%;height:150px;padding:10px;border:1px solid var(--border);border-radius:8px;font-family:monospace;font-size:0.75rem;background:var(--surface-2);color:var(--text-primary);outline:none;resize:vertical" placeholder='{"langName":"Silv√°ri","dictionary":[...]}'></textarea>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button class="btn btn-sm btn-ghost" onclick="closeImportPopup()" data-i18n="btn_cancel">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="btn btn-primary btn-sm" onclick="doImportJSON()" data-i18n="btn_import">„Ç§„É≥„Éù„Éº„ÉàÂÆüË°å</button>
    </div>
  </div>
</div>

<!-- MEMO EDITOR OVERLAY -->
<div id="memo-editor-overlay" class="editor-overlay" style="display:none" onclick="if(event.target===this)closeMemoEditor()">
  <div class="editor-panel" style="max-width:800px;max-height:90dvh;display:flex;flex-direction:column" onclick="event.stopPropagation()">
    <div class="editor-handle"></div>
    <div class="editor-header">
      <div style="flex:1">
        <input type="text" id="memo-editor-title" placeholder="„É°„É¢„ÅÆ„Çø„Ç§„Éà„É´" 
          style="background:transparent;border:none;color:var(--text-primary);font-size:1.1rem;font-weight:600;width:100%;outline:none;font-family:inherit">
      </div>
      <button class="editor-close" onclick="closeMemoEditor()">√ó</button>
    </div>
    
    <div style="flex:1;overflow-y:auto;padding:0 4px">
      <textarea id="memo-editor-content" placeholder="„É°„É¢„ÅÆÂÜÖÂÆπ„ÇíÂÖ•Âäõ..." 
        style="width:100%;min-height:400px;padding:16px;border:1px solid var(--border);border-radius:10px;background:var(--surface-2);color:var(--text-primary);font-family:inherit;resize:vertical;font-size:0.9rem;line-height:1.8;outline:none"></textarea>
    </div>

    <div style="padding:16px 4px;display:flex;gap:10px;border-top:1px solid var(--border)">
      <button class="btn btn-ghost" onclick="closeMemoEditor()">
        „Ç≠„É£„É≥„Çª„É´
      </button>
      <button class="btn" onclick="deleteMemo()" id="memo-delete-btn" style="margin-left:auto;color:var(--rose)">
        üóëÔ∏è ÂâäÈô§
      </button>
      <button class="btn btn-primary" onclick="saveMemo()">
        üíæ ‰øùÂ≠ò
      </button>
    </div>
  </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// ===== STATE =====
const S = {
  langName:'Êñ∞„Åó„ÅÑË®ÄË™û', script:'latin', route:'self',
  vibe:[], vibeText:'', aiVibeResult:'',
  scriptMap:{},
  phoneme:{ vowels:['a','i','u','e','o'], consonants:['k','s','t','n','h','m','r'], syllable:'CVÂûã', accent:'„Å™„Åó' },
  grammar:{ order:'SOV', cases:'„Å™„Åó', verbConj:'„Å™„Åó', tense:['ÁèæÂú®','ÈÅéÂéª','Êú™Êù•'], patterns:[], gender:[], matrix:{rows:[],cols:[],cells:{}} },
  dictionary:[], corpus:[], sentences:[],
  grammarNotes:'', done:{},
  pinnedIPA:[], // user-pinned IPA symbols
  syllableSlots: [], // V5: phonotactics slots e.g. ['C','V','C']
  // V9 additions
  visibility: 'private', // private | unlisted | public
  importable: false,
  lang: 'ja', // ui language: ja | en
};

// ===== V12 HELP SYSTEM ‚Äî ÂàùÂøÉËÄÖÂêë„ÅëÊã°ÂÖÖÁâà =====
const HELP_TEXTS = {
  'Ê†ºÔºà„Åã„ÅèÔºâ': {
    title: 'üìö Ê†ºÔºàCaseÔºâ„Å£„Å¶„Å™„Å´Ôºü',
    body: `<strong>ÂêçË©û„ÅåÊñá„ÅÆ‰∏≠„Åß„Å©„Çì„Å™ÂΩπÂâ≤„Çí„Åó„Å¶„ÅÑ„Çã„Åã</strong>„ÇíÂΩ¢„ÅßÁ§∫„Åô‰ªïÁµÑ„Åø„Åß„Åô„ÄÇ<br><br>
Êó•Êú¨Ë™û„Åß„ÅÑ„ÅÜ„Äå<strong>„Åå„Éª„Çí„Éª„Å´„Éª„ÅÆ</strong>„Äç„Åå„Åæ„Åï„Å´„Åù„ÇåÔºÅ<br><br>
<div class="help-ex">
üê± „Éç„Ç≥<strong>„Åå</strong> È≠ö<strong>„Çí</strong> È£ü„Åπ„Çã<br>
‚îî „Äå„Åå„ÄçÔºù‰∏ªÊ†ºÔºàÂãï„Åè‰∏ª‰ΩìÔºâ„ÄÄ„Äå„Çí„ÄçÔºùÂØæÊ†ºÔºà„Åï„Çå„ÇãÂÅ¥Ôºâ
</div>
<div class="lang-example-row">
<div class="lang-example-box"><span class="flag">üáØüáµ</span><span class="name">Êó•Êú¨Ë™ûÔºà2„Äú4Ê†ºÔºâ</span><span class="desc">„Åå„Éª„Çí„Éª„Å´„Éª„ÅÆ„Éª„Åß„Éª„Å∏</span></div>
<div class="lang-example-box"><span class="flag">üá∑üá∫</span><span class="name">„É≠„Ç∑„Ç¢Ë™ûÔºà6Ê†ºÔºâ</span><span class="desc">ÂêçË©û„ÅÆÂΩ¢„ÅßÂΩπÂâ≤„ÇíÁ§∫„Åô</span></div>
<div class="lang-example-box"><span class="flag">üèõ</span><span class="name">„É©„ÉÜ„É≥Ë™ûÔºà7Ê†ºÔºâ</span><span class="desc">Ë™ûÈ†Ü„ÅåËá™Áî±„Å™„ÅÆ„ÅØÊ†º„ÅÆ„Åä„Åã„Åí</span></div>
<div class="lang-example-box"><span class="flag">üá´üáÆ</span><span class="name">„Éï„Ç£„É≥„É©„É≥„ÉâË™ûÔºà15Ê†ºÔºÅÔºâ</span><span class="desc">Â†¥ÊâÄ„ÉªÊñπÂêë„Åæ„ÅßÊ†º„ÅßË°®„Åô</span></div>
</div>
Ê†º„ÅåÂ§ö„ÅÑ„Åª„Å©Ë°®Áèæ„ÅåË±ä„Åã„Å´„Å™„Çä„Åæ„Åô„Åå„ÄÅË§áÈõë„Å´„ÇÇ„Å™„Çä„Åæ„Åô„ÄÇ<strong>ÊúÄÂàù„ÅØ2„Äú4Ê†º</strong>„Åå„Åä„Åô„Åô„ÇÅÔºÅ`
  },
  'Â•≥ÊÄßË©û': {
    title: '‚ôÄ Â•≥ÊÄßË©û„ÉªÁî∑ÊÄßË©ûÔºàÊñáÊ≥ïÁöÑÊÄßÂà•Ôºâ„Å£„Å¶„Å™„Å´Ôºü',
    body: `Ëã±Ë™û„ÅÆ he/she/it „ÅÆ„Çà„ÅÜ„Å´„ÄÅ<strong>ÂêçË©û„Å´„ÄåÁî∑ÊÄß„ÉªÂ•≥ÊÄß„Éª‰∏≠ÊÄß„Äç„Å™„Å©„ÅÆÂå∫Âà•„Åå„ÅÇ„Çã</strong>Ë®ÄË™ûÊ©üËÉΩ„Åß„Åô„ÄÇ<br><br>
„ÄåÂ•≥ÊÄßË©û„Äç„ÄåÁî∑ÊÄßË©û„Äç„ÅØÁîüÁâ©Â≠¶ÁöÑ„Å™ÊÄßÂà•„Å®„ÅØÂøÖ„Åö„Åó„ÇÇÈñ¢‰øÇ„Å™„Åè„ÄÅÂçò„Å™„Çã<strong>ÂêçË©û„ÅÆ„Ç∞„É´„Éº„Éó</strong>„ÅÆ„Çà„ÅÜ„Å™„ÇÇ„ÅÆ„Åß„Åô„ÄÇ<br><br>
<div class="help-ex">
üåï „Éï„É©„É≥„ÇπË™ûÔºöla luneÔºàÊúàÔºâ‚Üí Â•≥ÊÄß<br>
‚òÄ „Éï„É©„É≥„ÇπË™ûÔºöle soleilÔºàÂ§™ÈôΩÔºâ‚Üí Áî∑ÊÄß<br>
üçû „Éâ„Ç§„ÉÑË™ûÔºödas BrotÔºà„Éë„É≥Ôºâ‚Üí ‰∏≠ÊÄß
</div>
<div class="lang-example-row">
<div class="lang-example-box"><span class="flag">üá´üá∑</span><span class="name">„Éï„É©„É≥„ÇπË™ûÔºà2ÊÄßÔºâ</span><span class="desc">leÔºàÁî∑Ôºâ/ laÔºàÂ•≥Ôºâ</span></div>
<div class="lang-example-box"><span class="flag">üá©üá™</span><span class="name">„Éâ„Ç§„ÉÑË™ûÔºà3ÊÄßÔºâ</span><span class="desc">der / die / das</span></div>
<div class="lang-example-box"><span class="flag">üá∏üá¶</span><span class="name">„Ç¢„É©„Éì„Ç¢Ë™ûÔºà2ÊÄßÔºâ</span><span class="desc">ÂãïË©û„Åæ„ÅßÊÄßÂà•Â§âÂåñ„Åô„Çã</span></div>
<div class="lang-example-box"><span class="flag">üáØüáµ</span><span class="name">Êó•Êú¨Ë™û</span><span class="desc">ÊÄßÂà•„Å™„ÅóÔºÅ„Ç∑„É≥„Éó„É´Ê¥æ</span></div>
</div>
„Ç≥„É≥„É©„É≥„Ç∞„Åß„ÅØ„ÄåÁî∑Â•≥ÊÄß„Äç„Äå„Ç¢„Éã„É°„Ç§„ÉàÔºàÁîü„ÅçÁâ©Ôºâ/„Ç§„Éä„Éã„É°„Ç§„ÉàÔºàÁâ©Ôºâ„Äç„ÄåÁ≤æÈúä/Áâ©Ë≥™„Äç„Å™„Å©<strong>Áã¨Ëá™„ÅÆÂàÜÈ°û</strong>„Çí‰Ωú„Çã„Åì„Å®„ÇÇ„Åß„Åç„Åæ„ÅôÔºÅ`
  },
  'Êé•È†≠Ëæû„ÉªÊé•Â∞æËæû': {
    title: '‚ö° Êé•È†≠Ëæû„ÉªÊé•Â∞æËæû„ÉªÊé•‰∏≠Ëæû„Å£„Å¶„Å™„Å´Ôºü',
    body: `ÂçòË™û„Å´ÊÑèÂë≥„Çí‰ªò„ÅëÂä†„Åà„Çã„Åü„ÇÅ„Å´<strong>„Åè„Å£„Å§„Åë„ÇãÈÉ®ÂìÅ</strong>„ÅÆ„Åì„Å®„Åß„Åô„ÄÇ<br><br>
<div class="help-ex">
üîπ <strong>Êé•È†≠Ëæû</strong>ÔºàÂçòË™û„ÅÆÂâç„Å´„Å§„ÅèÔºâ<br>
„ÄÄ <span style="color:var(--accent)">un-</span>happy ‚Üí „Äå‰∏çÂπ∏„Åõ„ÄçÔºàËã±Ë™ûÔºâ<br>
„ÄÄ <span style="color:var(--accent)">„Åä-</span>ÂºÅÂΩì ‚Üí ‰∏ÅÂØßË™ûÔºàÊó•Êú¨Ë™ûÔºâ<br><br>
üîπ <strong>Êé•Â∞æËæû</strong>ÔºàÂçòË™û„ÅÆÂæå„Çç„Å´„Å§„ÅèÔºâ<br>
„ÄÄ happy<span style="color:var(--accent2)">-ness</span> ‚Üí „ÄåÂπ∏Á¶è„Åï„ÄçÔºàËã±Ë™ûÔºâ<br>
„ÄÄ „Åü„Åπ<span style="color:var(--accent2)">-„Åü„ÅÑ</span> ‚Üí „ÄåÈ£ü„Åπ„Åü„ÅÑ„ÄçÔºàÊó•Êú¨Ë™ûÔºâ<br><br>
üîπ <strong>Êé•‰∏≠Ëæû</strong>ÔºàÂçòË™û„ÅÆ‰∏≠„Å´ÂÖ•„ÇãÔºâ<br>
„ÄÄ Áµ∂ÂØæ„Å´ÂÖ•„Çå<span style="color:var(--gold)">„Çâ</span>„Çå„Çã ‚Üí ÂèØËÉΩÂΩ¢ÔºàÊó•Êú¨Ë™û„ÅÆ‰∏ÄÈÉ®ÊñπË®ÄÔºâ<br>
„ÄÄ „Éï„Ç£„É™„Éî„É≥Ë™û„Åß„ÅØ‰∏≠Èñì„Å´ÂÖ•„Çå„ÇãÔºÅ
</div>
<div class="lang-example-row">
<div class="lang-example-box"><span class="flag">üá∞üá∑</span><span class="name">ÈüìÂõΩË™û</span><span class="desc">-Í≥† Ïã∂Ïñ¥Ôºà„Äú„Åó„Åü„ÅÑÔºâÊé•Â∞æËæû„ÅåË±äÂØå</span></div>
<div class="lang-example-box"><span class="flag">üá©üá™</span><span class="name">„Éâ„Ç§„ÉÑË™û</span><span class="desc">ge-ÔºàÈÅéÂéªÂΩ¢Ôºâun-ÔºàÂê¶ÂÆöÔºâ„Å™„Å©„Åü„Åè„Åï„Çì</span></div>
<div class="lang-example-box"><span class="flag">üáµüá≠</span><span class="name">„Çø„Ç¨„É≠„Ç∞Ë™û</span><span class="desc">Êé•‰∏≠Ëæû„ÅåÁô∫ÈÅî„Åó„ÅüÁèç„Åó„ÅÑË®ÄË™û</span></div>
</div>`
  },
  'Ë™ûÊ†πÂ§âÂåñ': {
    title: 'üîÑ Ë™ûÊ†πÂ§âÂåñÔºàË™ûÂππÂ§âÂåñÔºâ„Å£„Å¶„Å™„Å´Ôºü',
    body: `Ë™ûÂ∞æ„Çí„Å§„Åë„Çã„ÅÆ„Åß„ÅØ„Å™„Åè„ÄÅ<strong>ÂçòË™ûËá™‰Ωì„ÅÆÊØçÈü≥„ÇÑÂΩ¢„ÅåÂ§â„Çè„Çã</strong>Â§âÂåñ„ÅÆ„Åì„Å®„Åß„Åô„ÄÇ<br><br>
<div class="help-ex">
üîπ Ëã±Ë™ûÔºà‰∏çË¶èÂâáÂãïË©ûÔºâ<br>
„ÄÄ go ‚Üí <strong>went</strong>ÔºàÈÅéÂéªÂΩ¢„ÅåÂÖ®ÁÑ∂ÈÅï„ÅÜÔºÅÔºâ<br>
„ÄÄ man ‚Üí <strong>men</strong>ÔºàÊØçÈü≥„ÅåÂ§â„Çè„Å£„Å¶Ë§áÊï∞ÂΩ¢Ôºâ<br><br>
üîπ „Ç¢„É©„Éì„Ç¢Ë™ûÔºà‰∏âÂ≠êÈü≥Ë™ûÊ†πÔºâ<br>
„ÄÄ k-t-bÔºàÊõ∏„ÅèÁ≥ªÔºâ„Åã„ÇâÊ¥æÁîüÔºö<br>
„ÄÄ <strong>kataba</strong>ÔºàÊõ∏„ÅÑ„ÅüÔºâ/ <strong>kitƒÅb</strong>ÔºàÊú¨Ôºâ/ <strong>kƒÅtib</strong>ÔºàÊõ∏„Åè‰∫∫Ôºâ<br>
</div>
„Ç≥„É≥„É©„É≥„Ç∞„Åß„Åì„Çå„Çí‰Ωø„ÅÜ„Å®<strong>Ê∑±„Åø„ÅÆ„ÅÇ„ÇãË®ÄË™ûÊÑü</strong>„ÅåÂá∫„Åæ„ÅôÔºÅ`
  },
  'Ê†ºÂ§âÂåñ„Éû„Éà„É™„ÉÉ„ÇØ„Çπ': {
    title: 'üìä Ê†ºÂ§âÂåñ„Éû„Éà„É™„ÉÉ„ÇØ„Çπ„Å£„Å¶„Å™„Å´Ôºü',
    body: `ÂêçË©û„ÅåÊ†º„ÉªÊï∞„ÉªÊÄß„Å´„Çà„Å£„Å¶<strong>„Å©„ÅÜÂΩ¢„ÇíÂ§â„Åà„Çã„Åã„Çí‰∏ÄË¶ßË°®</strong>„Å´„Åó„Åü„ÇÇ„ÅÆ„Åß„Åô„ÄÇ<br><br>
<div class="help-ex">
‰æãÔºö„É©„ÉÜ„É≥Ë™û "rosa"Ôºà„Éê„É©Ôºâ<br>
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ÂçòÊï∞ ‚îÇ Ë§áÊï∞<br>
‰∏ªÊ†ºÔºà„Äú„ÅåÔºâ„ÄÄ „ÄÄrosa ‚îÇ rosae<br>
Â±ûÊ†ºÔºà„Äú„ÅÆÔºâ„ÄÄ  rosae ‚îÇ rosarum<br>
‰∏éÊ†ºÔºà„Äú„Å´Ôºâ„ÄÄ  rosae ‚îÇ rosis<br>
ÂØæÊ†ºÔºà„Äú„ÇíÔºâ„ÄÄ   rosam ‚îÇ rosas
</div>
<div class="lang-example-row">
<div class="lang-example-box"><span class="flag">üèõ</span><span class="name">„É©„ÉÜ„É≥Ë™û</span><span class="desc">6Ê†º√ó2Êï∞„ÅÆÂ§âÂåñË°®</span></div>
<div class="lang-example-box"><span class="flag">üá∑üá∫</span><span class="name">„É≠„Ç∑„Ç¢Ë™û</span><span class="desc">6Ê†º√ó2Êï∞Ôºã3ÊÄß</span></div>
<div class="lang-example-box"><span class="flag">üá´üáÆ</span><span class="name">„Éï„Ç£„É≥„É©„É≥„ÉâË™û</span><span class="desc">15Ê†ºÔºÅ„Åß„ÇÇË¶èÂâáÁöÑ</span></div>
</div>
„Åæ„Åö<strong>‰∏ªÊ†º„ÉªÂØæÊ†º„ÅÆ2Ê†º„Åã„Çâ</strong>Âßã„ÇÅ„Å¶„Åø„Çà„ÅÜÔºÅÂ∞ë„Åó„Åö„Å§Â¢ó„ÇÑ„Åõ„Åæ„Åô„ÄÇ`
  },
  'Ë™ûÈ†Ü': {
    title: 'üìù Ë™ûÈ†ÜÔºàWord OrderÔºâ„Å£„Å¶„Å™„Å´Ôºü',
    body: `Êñá„ÅÆ‰∏≠„Åß<strong>‰∏ªË™û„ÉªÂãïË©û„ÉªÁõÆÁöÑË™û„Çí„Å©„ÅÆÈ†Ü„Å´ÁΩÆ„Åè„Åã</strong>„ÅÆ„É´„Éº„É´„Åß„Åô„ÄÇ<br><br>
<div class="help-ex">
ÁßÅ„ÅåÔºàSÔºâ„ÄÄ„É™„É≥„Ç¥„ÇíÔºàOÔºâ„ÄÄÈ£ü„Åπ„ÇãÔºàVÔºâ‚Üí SOV<br>
IÔºàSÔºâ eatÔºàVÔºâ appleÔºàOÔºâ‚Üí SVO<br>
EatÔºàVÔºâ IÔºàSÔºâ appleÔºàOÔºâ‚Üí VSO
</div>
<div class="lang-example-row">
<div class="lang-example-box"><span class="flag">üáØüáµ</span><span class="name">Êó•Êú¨Ë™û„ÉªÈüìÂõΩË™û</span><span class="desc">SOVÔºà‰∏ñÁïåÊúÄÂ§öÔºâ</span></div>
<div class="lang-example-box"><span class="flag">üá¨üáß</span><span class="name">Ëã±Ë™û„Éª‰∏≠ÂõΩË™û</span><span class="desc">SVOÔºà2Áï™ÁõÆ„Å´Â§ö„ÅÑÔºâ</span></div>
<div class="lang-example-box"><span class="flag">üá∏üá¶</span><span class="name">„Ç¢„É©„Éì„Ç¢Ë™û</span><span class="desc">VSOÔºàÂãïË©û„ÅåÊúÄÂàùÔºÅÔºâ</span></div>
<div class="lang-example-box"><span class="flag">üèõ</span><span class="name">„É©„ÉÜ„É≥Ë™û</span><span class="desc">Ëá™Áî±Ë™ûÈ†ÜÔºàÊ†º„ÅßÁ§∫„ÅôÔºâ</span></div>
</div>
Ëá™ÂàÜ„ÅÆÂ•Ω„Åø„ÅßÈÅ∏„Çì„ÅßOKÔºÅÊ†º„Åå„ÅÇ„Çå„Å∞Ë™ûÈ†Ü„ÇíËá™Áî±„Å´„ÇÇ„Åß„Åç„Åæ„Åô„ÄÇ`
  },
  'IPA': {
    title: 'üî§ IPAÔºàÂõΩÈöõÈü≥Â£∞Ë®òÂè∑Ôºâ„Å£„Å¶„Å™„Å´Ôºü',
    body: `‰∏ñÁïå‰∏≠„ÅÆË®ÄË™û„ÅÆÈü≥„Çí<strong>Áµ±‰∏Ä„Åó„ÅüË®òÂè∑„ÅßÊõ∏„ÅçË°®„Åô</strong>„Åü„ÇÅ„ÅÆÂõΩÈöõÁöÑ„Å™„Ç∑„Çπ„ÉÜ„É†„Åß„Åô„ÄÇ<br><br>
<div class="help-ex">
/a/ ‚Üí „Äå„Ç¢„Äç„ÅÆÈü≥<br>
/Œ∏/ ‚Üí Ëã±Ë™û„ÅÆ "think" „ÅÆÊúÄÂàù„ÅÆÈü≥ÔºàÊó•Êú¨Ë™û„Å´„Å™„ÅÑÔºÅÔºâ<br>
/ í/ ‚Üí „Éï„É©„É≥„ÇπË™û "bonjour" „ÅÆ j „ÅÆÈü≥<br>
/≈ã/ ‚Üí „Äå„É≥„Ç∞„Äç„ÅÆÊúÄÂæå„ÅÆÈºªÈü≥
</div>
„Ç≥„É≥„É©„É≥„Ç∞„Åß„ÅØ<strong>Ëá™ÂàÜ„ÅÆË®ÄË™û„ÅÆÈü≥„ÇíÊ≠£Á¢∫„Å´Ë®òÈå≤</strong>„Åô„Çã„Åü„ÇÅ„Å´‰Ωø„ÅÑ„Åæ„Åô„ÄÇ<br>
Ë™≠„ÅøÊñπ„ÇíÁü•„Çâ„Å™„Åè„Å¶„ÇÇ„ÄÅË¶ã„ÅüÁõÆ„ÇÑÈõ∞Âõ≤Ê∞ó„ÅßÈÅ∏„Çì„Åß„ÇÇÂ§ß‰∏àÂ§´ÔºÅ`
  },
  'Èü≥ÁØÄÊßãÈÄ†': {
    title: 'üéµ Èü≥ÁØÄÊßãÈÄ†„Å£„Å¶„Å™„Å´Ôºü',
    body: `<strong>Â≠êÈü≥(C)„Å®ÊØçÈü≥(V)„Çí„Å©„ÅÜÁµÑ„ÅøÂêà„Çè„Åõ„Çã„Åã</strong>„ÅÆ„É´„Éº„É´„Åß„Åô„ÄÇË®ÄË™û„ÅÆ„ÄåÈü≥„ÅÆÁôñ„Äç„ÅåÊ±∫„Åæ„Çä„Åæ„Åô„ÄÇ<br><br>
<div class="help-ex">
CVÂûã ‚Üí „Åã„Éª„Åç„Éª„ÅèÔºàÊó•Êú¨Ë™û„ÅÆ„Å≤„Çâ„Åå„Å™„ÅØ„Åô„Åπ„Å¶CVÔºÅÔºâ<br>
CVCÂûã ‚Üí cat„Éªdog„ÉªsunÔºàËã±Ë™ûÈ¢®Ôºâ<br>
CCVCÂûã ‚Üí plan„ÉªgrowÔºàËã±Ë™û„ÅÆË§áÈõë„Å™Ë™ûÈ†≠Â≠êÈü≥Ôºâ<br>
VÂûã ‚Üí a„Éªe„ÉªiÔºàÊØçÈü≥„Å†„Åë„ÅßÈü≥ÁØÄ„Çí‰Ωú„Çå„ÇãÔºâ
</div>
<div class="lang-example-row">
<div class="lang-example-box"><span class="flag">üáØüáµ</span><span class="name">Êó•Êú¨Ë™û</span><span class="desc">„Åª„ÅºCVÂûã„Åß„Ç∑„É≥„Éó„É´</span></div>
<div class="lang-example-box"><span class="flag">üå∫</span><span class="name">„Éè„ÉØ„Ç§Ë™û</span><span class="desc">CVÂûã„ÅÆ„Åø„ÄÅ„Å®„Å¶„ÇÇÂÑ™„Åó„ÅÑÈü≥</span></div>
<div class="lang-example-box"><span class="flag">üá¨üá™</span><span class="name">„Ç∏„Éß„Éº„Ç∏„Ç¢Ë™û</span><span class="desc">Â≠êÈü≥„Åå7„Å§ÈÄ£Á∂ö„Åô„Çã„Åì„Å®„ÇÇÔºÅ</span></div>
</div>
„Ç∑„É≥„Éó„É´„Å™CVÂûã„Åã„ÇâÂßã„ÇÅ„Çã„Å®<strong>Êüî„Çâ„Åã„ÅèÊ≠å„ÅÜ„Çà„ÅÜ„Å™Ë®ÄË™û</strong>„Å´„Å™„Çä„Åæ„ÅôÔºÅ`
  },
  'Èü≥Èüª': {
    title: 'üîä Èü≥ÈüªÔºàPhonologyÔºâ„Å£„Å¶„Å™„Å´Ôºü',
    body: `<strong>„Åù„ÅÆË®ÄË™û„Åß‰Ωø„ÅÜÈü≥„ÅÆ„Çª„ÉÉ„Éà</strong>„ÅÆ„Åì„Å®„Åß„Åô„ÄÇ„Å©„ÅÆÈü≥„Çí‰Ωø„ÅÜ„Åã„ÅßË®ÄË™û„ÅÆÈõ∞Âõ≤Ê∞ó„ÅåÊ±∫„Åæ„Çä„Åæ„ÅôÔºÅ<br><br>
<div class="help-ex">
l, r, n, m, s ‚Üí ÊµÅ„Çå„Çã„Çà„ÅÜ„Å™ÂÑ™„Åó„ÅÑÈüø„ÅçÔºà„Ç®„É´„ÉïË™ûÈ¢®Ôºâ<br>
k, g, d, r, z ‚Üí Á°¨„Åè„Å¶ÂäõÂº∑„ÅÑÈüø„ÅçÔºà„Éâ„É©„Ç¥„É≥Ë™ûÈ¢®Ôºâ<br>
p, m, n, f, i, u ‚Üí „Åã„Çè„ÅÑ„Åè„Å¶‰∏∏„ÅÑÈü≥ÔºàÂ¶ñÁ≤æË™ûÈ¢®Ôºâ
</div>
<div class="lang-example-row">
<div class="lang-example-box"><span class="flag">üáØüáµ</span><span class="name">Êó•Êú¨Ë™û</span><span class="desc">ÊØçÈü≥5„Å§„ÄÅÊØîËºÉÁöÑ„Ç∑„É≥„Éó„É´</span></div>
<div class="lang-example-box"><span class="flag">üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø</span><span class="name">Ëã±Ë™û</span><span class="desc">ÊØçÈü≥12‰ª•‰∏äÔºÅÊõñÊòßÊØçÈü≥„Åå„ÅÇ„Çã</span></div>
<div class="lang-example-box"><span class="flag">üå∫</span><span class="name">„Éè„ÉØ„Ç§Ë™û</span><span class="desc">Â≠êÈü≥8„Å§„Å†„Åë„ÄÅ„Å®„Å¶„ÇÇÂÑ™„Åó„ÅÑ</span></div>
</div>`
  },
  'ÈÄêË™ûË®≥': {
    title: 'üìã ÈÄêË™ûË®≥Ôºà„Ç∞„É≠„ÇπÔºâ„Å£„Å¶„Å™„Å´Ôºü',
    body: `Êñá„ÅÆÂêÑÂçòË™û„Çí<strong>‰∏ÄË™û‰∏ÄË™û„ÄÅÊñáÊ≥ïÊÉÖÂ†±‰ªò„Åç„ÅßË®≥„Åô</strong>Ë®òÊ≥ï„Åß„Åô„ÄÇË®ÄË™ûÂ≠¶ËÄÖ„Åå‰Ωø„ÅÑ„Åæ„Åô„ÄÇ<br><br>
<div class="help-ex">
„Ç≥„É≥„É©„É≥„Ç∞ÊñáÔºösilvara-el solen imal√´<br>
„Ç∞„É≠„ÇπÔºö„ÄÄ„ÄÄ„ÄÄÊ∞¥-<strong>‰∏ªÊ†º</strong>„ÄÄÊ≠©„Åè„ÄÄÁßÅ<br>
Êó•Êú¨Ë™ûË®≥Ôºö„ÄÄ„ÄÄ„ÄåÁßÅ„ÅØÊ∞¥Ëæ∫„ÇíÊ≠©„Åè„Äç
</div>
Áï•Ë™û„ÅÆ‰æãÔºö<br>
<span style="color:var(--accent);font-family:monospace">NOM</span>=‰∏ªÊ†º„ÄÄ<span style="color:var(--accent);font-family:monospace">ACC</span>=ÂØæÊ†º„ÄÄ<span style="color:var(--accent);font-family:monospace">PL</span>=Ë§áÊï∞„ÄÄ<span style="color:var(--accent);font-family:monospace">PST</span>=ÈÅéÂéª<br><br>
„Ç≥„É≥„É©„É≥„Ç∞„Çí‰ªñ„ÅÆ‰∫∫„Å´<strong>„Å°„ÇÉ„Çì„Å®Ë¶ã„Åõ„Åü„ÅÑ„Å®„Åç</strong>„Å´‰Ωø„ÅÜ„Å®„ÄÅ„Ç∞„ÉÉ„Å®„Éó„É≠„Å£„ÅΩ„Åè„Å™„Çä„Åæ„ÅôÔºÅ`
  },
  'ÊñáÂ≠ó‰ΩìÁ≥ª': {
    title: '‚úç ÊñáÂ≠ó‰ΩìÁ≥ª„Å£„Å¶„Å™„Å´Ôºü',
    body: `Ë®ÄË™û„ÅÆÈü≥„ÇÑÊÑèÂë≥„Çí<strong>Êõ∏„ÅçË®ò„Åô„Åü„ÇÅ„ÅÆË®òÂè∑„Ç∑„Çπ„ÉÜ„É†</strong>„ÅÆ„Åì„Å®„Åß„Åô„ÄÇ<br><br>
<div class="help-ex">
„Ç¢„É´„Éï„Ç°„Éô„ÉÉ„Éà ‚Üí ÂêÑÊñáÂ≠ó„ÅåÈü≥„ÇíË°®„ÅôÔºàËã±Ë™ûÔºâ<br>
„Ç¢„Éñ„Ç∏„É£„Éâ ‚Üí Â≠êÈü≥„Å†„Åë„ÇíÊõ∏„ÅèÔºà„Ç¢„É©„Éì„Ç¢Ë™û„Éª„Éò„Éñ„É©„Ç§Ë™ûÔºâ<br>
„Ç∑„É©„Éê„É™„Éº ‚Üí Èü≥ÁØÄ„Åî„Å®„Å´ÊñáÂ≠óÔºà„Å≤„Çâ„Åå„Å™„Éª„Ç´„Çø„Ç´„ÉäÔºâ<br>
„É≠„Ç¥„Ç∞„É©„Éï„Ç£„Éº ‚Üí 1ÊñáÂ≠ó„ÅåÂçòË™û„ÉªÊ¶ÇÂøµ„ÇíË°®„ÅôÔºàÊº¢Â≠óÔºâ
</div>
<div class="lang-example-row">
<div class="lang-example-box"><span class="flag">üáØüáµ</span><span class="name">„Å≤„Çâ„Åå„Å™</span><span class="desc">Èü≥ÁØÄÊñáÂ≠óÔºà„Ç∑„É©„Éê„É™„ÉºÔºâ</span></div>
<div class="lang-example-box"><span class="flag">üá∞üá∑</span><span class="name">„Éè„É≥„Ç∞„É´</span><span class="desc">Â≠êÈü≥„ÉªÊØçÈü≥„ÇíÁµÑ„ÅøÂêà„Çè„Åõ„Çã</span></div>
<div class="lang-example-box"><span class="flag">üîÆ</span><span class="name">„Ç®„É´„ÉïÊñáÂ≠ó</span><span class="desc">„ÉÜ„É≥„Ç≤„ÉØ„Éº„É´„Åå„Ç¢„É´„Éï„Ç°„Éô„ÉÉ„ÉàÂºè</span></div>
</div>
Lingua„Åß„ÅØ„ÄÅ„Ç¢„É´„Éï„Ç°„Éô„ÉÉ„ÉàÂêÑÊñáÂ≠ó„Å´<strong>Áã¨Ëá™„Éá„Ç∂„Ç§„É≥„ÅÆË®òÂè∑„Çí„Éû„ÉÉ„Éî„É≥„Ç∞</strong>„Åß„Åç„Åæ„ÅôÔºÅ`
  },
  'Êé•Ëæû„Ç∑„Çπ„ÉÜ„É†': {
    title: 'üß© Êé•Ëæû„Ç∑„Çπ„ÉÜ„É†„Å£„Å¶„Å™„Å´Ôºü',
    body: `ÂçòË™û„Å´<strong>Ââç„ÉªÂæå„Éª‰∏≠„Å´ÈÉ®ÂìÅ„Çí„Åè„Å£„Å§„Åë„Å¶</strong>ÊÑèÂë≥„ÇíÂ§â„Åà„Çã„Ç∑„Çπ„ÉÜ„É†„ÅÆÁ∑èÁß∞„Åß„Åô„ÄÇ<br><br>
<div class="help-ex">
Êé•È†≠ËæûÔºàÂâçÔºâÔºö<span style="color:var(--accent)">un-</span>happy / <span style="color:var(--accent)">re-</span>do / <span style="color:var(--accent)">„Åä-</span>ÂºÅÂΩì<br>
Êé•Â∞æËæûÔºàÂæåÔºâÔºöhappi<span style="color:var(--accent2)">-ness</span> / È£ü„Åπ<span style="color:var(--accent2)">-„Åü„ÅÑ</span><br>
Êé•‰∏≠ËæûÔºà‰∏≠ÔºâÔºöË™ûÊ†π„ÅÆÁúü„Çì‰∏≠„Å´ÂÖ•„Çå„ÇãÔºà„Çø„Ç¨„É≠„Ç∞Ë™û„Å™„Å©Ôºâ<br>
Áí∞Â¢ÉÊé•ËæûÔºàÂâçÂæåÔºâÔºöÊé•È†≠+Ë™ûÊ†π+Êé•Â∞æ„Çí„Çª„ÉÉ„Éà„Åß‰Ωø„ÅÜ
</div>
„Ç≥„É≥„É©„É≥„Ç∞„Åß„ÅØ<strong>Ëá™Áî±„Å´ÁµÑ„ÅøÂêà„Çè„Åõ</strong>„ÇíË®≠Ë®à„Åß„Åç„Åæ„ÅôÔºÅ<br>
‰æãÔºösolÔºàÂ§™ÈôΩÔºâ‚Üí <span style="color:var(--accent)">al-</span>solÔºàÊöóÈóáÔºâ/ sol<span style="color:var(--accent2)">-vel</span>ÔºàËºù„ÅèÔºâ/ sol<span style="color:var(--accent2)">-ael</span>ÔºàÂ§™ÈôΩ„ÅÆÔºâ`
  }
};

function showHelp(key){
  const data=HELP_TEXTS[key];if(!data)return;
  document.getElementById('help-modal-title').textContent=data.title;
  document.getElementById('help-modal-body').innerHTML=data.body;
  document.getElementById('help-modal').style.display='flex';
  document.body.style.overflow='hidden';
}
function closeHelp(){document.getElementById('help-modal').style.display='none';document.body.style.overflow='';}
function helpBtn(key){return`<button class="help-btn" onclick="event.stopPropagation();showHelp('${key}')" title="${key}„Å´„Å§„ÅÑ„Å¶">?</button>`}

const phonemeMap = {'a':['„ÅÇ','ja-JP'],'i':['„ÅÑ','ja-JP'],'u':['„ÅÜ','ja-JP'],'e':['„Åà','ja-JP'],'o':['„Åä','ja-JP'],'…ô':['„ÅÇ','ja-JP'],'…õ':['„Åà','ja-JP'],'…î':['„Åä','ja-JP'],'y':['„ÇÜ','ja-JP'],'√∏':['„Åà','ja-JP'],'√¶':['„ÅÇ','ja-JP'],'…Ø':['„ÅÜ','ja-JP'],'k':['„Åã','ja-JP'],'s':['„Åï','ja-JP'],'t':['„Åü','ja-JP'],'n':['„Å™','ja-JP'],'h':['„ÅØ','ja-JP'],'m':['„Åæ','ja-JP'],'r':['„Çâ','ja-JP'],'l':['„Çâ','ja-JP'],'p':['„Å±','ja-JP'],'b':['„Å∞','ja-JP'],'d':['„Å†','ja-JP'],'g':['„Åå','ja-JP'],'f':['„Åµ','ja-JP'],'v':['„É¥„Ç°','ja-JP'],'z':['„Åñ','ja-JP'],'w':['„Çè','ja-JP'],'j':['„ÇÑ','ja-JP'],'Œ∏':['the','en-US'],' É':['„Åó„ÇÉ','ja-JP'],'x':['„ÅØ','ja-JP'],'≈ã':['„É≥„Ç∞','ja-JP'],'t É':['„Å°„ÇÉ','ja-JP']};
const voiceSamples = {elvish:{text:'Silmarillion... L√∫thien Tin√∫viel...',lang:'en-GB',rate:0.75,pitch:1.2},dark:{text:'Kraft... Dunkel... Zorn...',lang:'de-DE',rate:0.8,pitch:0.7},cute:{text:'Kawaii... Fiore... Piccolo...',lang:'it-IT',rate:1.1,pitch:1.4},scifi:{text:'Vortex... Nexus... Protocol...',lang:'en-US',rate:0.9,pitch:0.6},ocean:{text:'Nemo... Marina... Celeste...',lang:'es-ES',rate:0.85,pitch:1.1},ancient:{text:'Arka... Deus... Tempus...',lang:'en-GB',rate:0.75,pitch:0.9}};
const DAILY_SENTENCES_MAP={
  ja:['‰ªäÊó•„ÅØÁ©∫„ÅåÈùí„ÅÑ','ÂèãÈÅî„Å´‰ºö„ÅÑ„Å´Ë°å„Åè','Â•Ω„Åç„Å™È£ü„ÅπÁâ©„ÅØ‰Ωï„Åß„Åô„ÅãÔºü','ÊòéÊó•„Åæ„Åü‰ºö„ÅÑ„Åæ„Åó„Çá„ÅÜ','Êòü„ÅåÁ∂∫È∫ó„Å™Â§ú„Åß„Åô„Å≠','„Åì„ÅÆÈÅì„ÅØ„Å©„Åì„Å∏Á∂ö„Åè„ÅÆ„Åã','Ê∞¥„Çí‰∏ÄÊùØ„Åè„Å†„Åï„ÅÑ','„ÅÇ„Å™„Åü„ÅÆÂêçÂâç„ÅØ‰Ωï„Åß„Åô„ÅãÔºü','Â§¢„ÅÆ‰∏≠„ÅßÈ£õ„Çì„Åß„ÅÑ„Åü','Â±±„ÅÆÂêë„Åì„ÅÜ„Å´‰Ωï„Åå„ÅÇ„Çã„Å†„Çç„ÅÜ','ÁÅ´„ÅÆÂë®„Çä„ÅßÊ≠å„ÇíÊ≠å„Å£„Åü','Êµ∑„ÅØÂ∫É„Åè„ÄÅÊ∑±„ÅÑ'],
  en:["The sky is blue today","I'm going to meet a friend","What is your favorite food?","Let's meet again tomorrow","What a beautiful starry night","Where does this road lead?","Please give me a glass of water","What is your name?","I was flying in a dream","What lies beyond the mountains?","We sang songs around the fire","The sea is wide and deep"],
  zh:['‰ªäÂ§©Â§©Á©∫ÂæàËìù','ÊàëË¶ÅÂéªËßÅÊúãÂèã','‰Ω†ÊúÄÂñúÊ¨¢ÁöÑÈ£üÁâ©ÊòØ‰ªÄ‰πàÔºü','ÊòéÂ§©ÂÜçËßÅÂêß','Â§ö‰πàÁæé‰∏ΩÁöÑÊòüÂ§úÂïä','ËøôÊù°Ë∑ØÈÄöÂêëÂì™ÈáåÔºü','ËØ∑ÁªôÊàë‰∏ÄÊùØÊ∞¥','‰Ω†Âè´‰ªÄ‰πàÂêçÂ≠óÔºü','ÊàëÂú®Ê¢¶‰∏≠È£ûÁøî','Â±±ÁöÑÈÇ£ËæπÊúâ‰ªÄ‰πàÔºü','Êàë‰ª¨Âõ¥ÁùÄÁÅ´Â†ÜÂî±Ê≠å','Â§ßÊµ∑ÂÆΩÂπøËÄåÊ∑±ÈÇÉ'],
  es:['El cielo est√° azul hoy','Voy a ver a un amigo','¬øCu√°l es tu comida favorita?','Nos vemos ma√±ana','¬°Qu√© noche tan estrellada!','¬øAd√≥nde lleva este camino?','Por favor, dame un vaso de agua','¬øCu√°l es tu nombre?','Estaba volando en un sue√±o','¬øQu√© hay m√°s all√° de las monta√±as?','Cantamos canciones alrededor del fuego','El mar es ancho y profundo']
};
function getDailySentences(){return DAILY_SENTENCES_MAP[S.lang]||DAILY_SENTENCES_MAP.en;}
const scriptLabels={latin:'„É©„ÉÜ„É≥',cyrillic:'„Ç≠„É™„É´',greek:'„ÇÆ„É™„Ç∑„É£',arabic:'„Ç¢„É©„Éì„Ç¢',hangul:'„Éè„É≥„Ç∞„É´È¢®',hiragana:'„Å≤„Çâ„Åå„Å™È¢®',rune:'„É´„Éº„É≥',devanagari:'„Éá„Éº„É¥„Ç°„Éä„Éº„Ç¨„É™„Éº',custom:'„Ç™„É™„Ç∏„Éä„É´'};
// V6: Script char-picker active cell tracking
let _activeScriptCell=null;
function scriptCharFocus(){}
// Override char-btn to insert into active script map cell
function scriptCellFocus(el){_activeScriptCell=el;document.querySelectorAll('.script-map-to').forEach(i=>i.style.borderColor='');el.style.borderColor='var(--accent-border)';const info=document.getElementById('script-active-cell-info');if(info)info.textContent=t('sc_active_cell').replace('%s',el.closest('.script-map-row').querySelector('.script-map-from').textContent)}
// patch insertCharAt to also handle script picker
const _origInsertCharAt=insertCharAt;
// Script char picker uses dedicated injection: clicking .char-btn calls insertCharAt(target, char)
// target is script-char-target (hidden). We reroute to active cell if set
document.addEventListener('click',function(e){
  if(!e.target.classList.contains('char-btn'))return;
  const ch=e.target.textContent.trim();
  if(!ch)return;
  if(_activeScriptCell){
    _activeScriptCell.value=ch;
    _activeScriptCell.dispatchEvent(new Event('input'));
    livePreview();
    e.preventDefault();
    e.stopPropagation();
  }
});

// ==== FULL IPA DATA (V5 ‚Äî expanded) ====
// [voiceless, voiced] per place of articulation
const IPA_CONSONANTS = {
  rows: ['‰∏°Âîá','ÂîáÊ≠Ø','Ê≠ØÈñì','Ê≠ØËåé','ÂæåÈÉ®Ê≠ØËåé','„Åù„ÇäËàå','Á°¨Âè£Ëìã','ËªüÂè£Ëìã','Âè£ËìãÂûÇ','ÂíΩÈ†≠','Â£∞ÈñÄ'],
  cols: ['Á†¥Ë£Ç','ÈºªÈü≥','„Åµ„Çã„Åà','„ÅØ„Åò„Åç','Êë©Êì¶','ÂÅ¥Èù¢Êë©Êì¶','Êé•Ëøë','ÂÅ¥Èù¢Êé•Ëøë'],
  cells: {
    '‰∏°ÂîáÁ†¥Ë£Ç':['p','b'],'‰∏°ÂîáÈºªÈü≥':['','m'],'‰∏°Âîá„Åµ„Çã„Åà':['',' ô'],'‰∏°ÂîáÊë©Êì¶':['…∏','Œ≤'],'‰∏°ÂîáÊé•Ëøë':['','w'],
    'ÂîáÊ≠ØÊë©Êì¶':['f','v'],'ÂîáÊ≠ØÊé•Ëøë':['',' ã'],
    'Ê≠ØÈñìÊë©Êì¶':['Œ∏','√∞'],
    'Ê≠ØËåéÁ†¥Ë£Ç':['t','d'],'Ê≠ØËåéÈºªÈü≥':['','n'],'Ê≠ØËåé„Åµ„Çã„Åà':['','r'],'Ê≠ØËåé„ÅØ„Åò„Åç':['','…æ'],'Ê≠ØËåéÊë©Êì¶':['s','z'],'Ê≠ØËåéÂÅ¥Èù¢Êë©Êì¶':['…¨','…Æ'],'Ê≠ØËåéÊé•Ëøë':['','…π'],'Ê≠ØËåéÂÅ¥Èù¢Êé•Ëøë':['','l'],
    'ÂæåÈÉ®Ê≠ØËåéÊë©Êì¶':[' É',' í'],
    '„Åù„ÇäËàåÁ†¥Ë£Ç':[' à','…ñ'],'„Åù„ÇäËàåÈºªÈü≥':['','…≥'],'„Åù„ÇäËàå„ÅØ„Åò„Åç':['','…Ω'],'„Åù„ÇäËàåÊë©Êì¶':[' Ç',' ê'],'„Åù„ÇäËàåÊé•Ëøë':['','…ª'],'„Åù„ÇäËàåÂÅ¥Èù¢Êé•Ëøë':['','…≠'],
    'Á°¨Âè£ËìãÈºªÈü≥':['','…≤'],'Á°¨Âè£ËìãÊë©Êì¶':['√ß',' ù'],'Á°¨Âè£ËìãÊé•Ëøë':['','j'],'Á°¨Âè£ËìãÂÅ¥Èù¢Êé•Ëøë':['',' é'],
    'ËªüÂè£ËìãÁ†¥Ë£Ç':['k','g'],'ËªüÂè£ËìãÈºªÈü≥':['','≈ã'],'ËªüÂè£ËìãÊë©Êì¶':['x','…£'],'ËªüÂè£ËìãÊé•Ëøë':['','…∞'],'ËªüÂè£ËìãÂÅ¥Èù¢Êé•Ëøë':['',' ü'],
    'Âè£ËìãÂûÇÁ†¥Ë£Ç':['q','…¢'],'Âè£ËìãÂûÇÈºªÈü≥':['','…¥'],'Âè£ËìãÂûÇ„Åµ„Çã„Åà':['',' Ä'],'Âè£ËìãÂûÇÊë©Êì¶':['œá',' Å'],
    'ÂíΩÈ†≠Êë©Êì¶':['ƒß',' ï'],
    'Â£∞ÈñÄÁ†¥Ë£Ç':[' î',''],'Â£∞ÈñÄÊë©Êì¶':['h','…¶'],
  }
};
const IPA_VOWELS = {
  rows:['È´ò','ÂçäÈ´ò','‰∏≠','Âçä‰Ωé','‰Ωé'],
  cols:['ÂâçËàåÈùûÂÜÜÂîá','ÂâçËàåÂÜÜÂîá','‰∏≠Ëàå','ÂæåËàåÈùûÂÜÜÂîá','ÂæåËàåÂÜÜÂîá'],
  cells:{
    'È´òÂâçËàåÈùûÂÜÜÂîá':'i','È´òÂâçËàåÂÜÜÂîá':'y','È´ò‰∏≠Ëàå':'…®','È´òÂæåËàåÈùûÂÜÜÂîá':'…Ø','È´òÂæåËàåÂÜÜÂîá':'u',
    'ÂçäÈ´òÂâçËàåÈùûÂÜÜÂîá':'…™','ÂçäÈ´òÂâçËàåÂÜÜÂîá':' è','ÂçäÈ´òÂæåËàåÂÜÜÂîá':' ä',
    '‰∏≠ÂâçËàåÈùûÂÜÜÂîá':'e','‰∏≠ÂâçËàåÂÜÜÂîá':'√∏','‰∏≠‰∏≠Ëàå':'…ô','‰∏≠ÂæåËàåÈùûÂÜÜÂîá':'…§','‰∏≠ÂæåËàåÂÜÜÂîá':'o',
    'Âçä‰ΩéÂâçËàåÈùûÂÜÜÂîá':'…õ','Âçä‰ΩéÂâçËàåÂÜÜÂîá':'≈ì','Âçä‰ΩéÂæåËàåÈùûÂÜÜÂîá':' å','Âçä‰ΩéÂæåËàåÂÜÜÂîá':'…î',
    '‰ΩéÂâçËàåÈùûÂÜÜÂîá':'a','‰ΩéÂâçËàåÂÜÜÂîá':'√¶','‰ΩéÂæåËàåÈùûÂÜÜÂîá':'…ë','‰ΩéÂæåËàåÂÜÜÂîá':'…í',
  }
};
const IPA_DIACRITICS = ['Àê','Àà','Àå','ÃÉ','Ãà','Ãä','Ã•','Ã¨','Õ°','Ã§','Ã∞',' ∞',' ∑',' ≤','À§','Ãπ','Ãú','Ãü','Ã†',' º','Ãö','Ã©','ÃØ','Ãù','Ãû'];
const IPA_AFFRICATES = ['t É','d í','ts','dz','t…ï','d ë','t Ç','d ê','pf','bv','kx','qœá'];
// V5: Additional special sounds from diverse languages
const IPA_CLICKS = [' ò','«Ä','«É','«Ç','«Å']; // Click consonants (Khoisan, Zulu, Xhosa)
const IPA_IMPLOSIVES = ['…ì','…ó','…†',' õ',' Ñ']; // Implosives (many African languages)
const IPA_EJECTIVES = ["p'","t'","k'","q'","s'","t É'"]; // Ejectives (Georgian, Amharic)
const IPA_TONES = ['À•','À¶','Àß','À®','À©','‚Üó','‚Üò','À©À•','À•À©']; // Tone markers (Chinese, Thai, Yoruba)
const IPA_EXTRA_VOWELS = ['…∂','…ê','…µ','…ò','…û',' â','…ú','…ö']; // rare vowels

// ===== V6: AI ASSISTANT ENGINE =====
// Context-aware responses per editor section
function getAI_CONTEXTS(){
const lang=typeof S!=='undefined'?S.lang:'ja';
const ctx={
  ja:{
    vibe:{
      greeting:'‚ú¶ ‰∏ñÁïåË¶≥AI„Åß„ÅôÔºÅ„Å©„Çì„Å™Ë®ÄË™û„Çí‰Ωú„Çä„Åü„ÅÑ„Åã„ÄÅÊ∞óËªΩ„Å´Êïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
      suggestions:['„Ç®„É´„Éï„ÅÆÊ£Æ„ÅÆË®ÄË™û„Çí‰Ωú„Çä„Åü„ÅÑ','Ê©üÊ¢∞ÊñáÊòé„ÅÆÂÜ∑„Åü„ÅÑÈüø„Åç„Å´„Åó„Åü„ÅÑ','„Åã„Çè„ÅÑ„Åè„Å¶„Éù„ÉÉ„Éó„Å™Ë®ÄË™û„Å´„Åó„Åü„ÅÑ','Âè§‰ª£„ÅÆÁ•ûË©±„Å£„ÅΩ„Åè„Åó„Åü„ÅÑ'],
      responses:{
        '„Ç®„É´„Éï':'üåø „Ç®„É´„ÉïÁ≥ª„Å™„Çâ**ÊØçÈü≥ a, e, i, √´ „ÇíÂ§öÁî®**„Åó„ÄÅÂ≠êÈü≥„ÅØ**l, r, n, m, th**„ÅåÊò†„Åà„Åæ„Åô„ÄÇË™ûÊú´„ÅØ-el, -iel, -ar„ÅåÂÆöÁï™„ÄÇ‰æãÔºöSilmarien, L√∫thiel, Calavar',
        '„ÉÄ„Éº„ÇØ|Â∏ùÂõΩ|Êöó„ÅÑ|Èªí':'‚öîÔ∏è „ÉÄ„Éº„ÇØÁ≥ª„ÅØ**u, √§ „ÅÆÊöó„ÅÑÊØçÈü≥**„Å®**k, g, d, r, z „ÅÆÁ°¨„ÅÑÂ≠êÈü≥**„ÇíÁµÑ„ÅøÂêà„Çè„Åõ„Åæ„Åô„ÄÇ‰æãÔºöDrakur, Gothrim, Valdenz',
        '„Åã„Çè„ÅÑ„ÅÑ|„Éù„ÉÉ„Éó|Êòé„Çã„ÅÑ|Â¶ñÁ≤æ':'üå∏ „Åã„Çè„ÅÑ„ÅÑÁ≥ª„ÅØ**i, a „ÅÆÊòé„Çã„ÅÑÊØçÈü≥**„Å®**m, n, p „ÅÆÊüî„Çâ„Åã„ÅÑÂ≠êÈü≥**„ÄÇ‰æãÔºöMimika, Pani, Tiritiri',
        'SF|Ê©üÊ¢∞|Êú™Êù•|„É≠„Éú':'‚öôÔ∏è SFÁ≥ª„ÅØ**e, i „ÅÆÈã≠„ÅÑÊØçÈü≥**„Å®**x, z, k „ÅÆÊ©üÊ¢∞ÁöÑ„Å™Â≠êÈü≥**„ÄÇ‰æãÔºöVexon, Nkrial, Zytex',
        'Êµ∑|Ê∞¥|Á≤æÈúä|Ê≥¢':'üåä Êµ∑Ê¥ãÁ≥ª„ÅØ**a, e „ÅÆÂ∫É„ÅÑÊØçÈü≥**„Å®**m, n, l „ÅÆÊµÅ„Çå„ÇãÂ≠êÈü≥**„ÄÇ‰æãÔºöMaelan, Neriva, Coranil',
        'Âè§‰ª£|Á•ûË©±|Á•û|ËÅñ':'üèîÔ∏è Âè§‰ª£Á≥ª„ÅØ**a, u „ÅÆÂ§™„ÅÑÊØçÈü≥**„Å®**k, t, r, v „ÅÆ„Ç∑„É≥„Éó„É´„Å™Â≠êÈü≥**„ÄÇ‰æãÔºöArkanus, Vathar, Torvael',
        default:'Èù¢ÁôΩ„ÅÑ„Ç¢„Ç§„Éá„Ç¢„Åß„Åô„Å≠ÔºÅüìù „Å©„Çì„Å™Èõ∞Âõ≤Ê∞ó„ÇíÁõÆÊåá„Åó„Å¶„ÅÑ„Åæ„Åô„ÅãÔºü\n„Éª„Å©„ÅÆË®ÄË™û„ÅåÂ•Ω„Åç„Åß„Åô„ÅãÔºü\n„ÉªÊüî„Çâ„Åã„ÅÑ/Á°¨„ÅÑ„ÄÅÊòé„Çã„ÅÑ/Êöó„ÅÑ„Å©„Å°„ÇâÔºü\n„Éª„Å©„Çì„Å™‰∏ñÁïåË¶≥„ÅÆË®ÄË™û„Åß„Åô„ÅãÔºü'
      }
    },
    phoneme:{
      greeting:'üîä Èü≥ÈüªAI„Åß„ÅôÔºÅ„Å©„Çì„Å™Èüø„Åç„Å´„Åó„Åü„ÅÑ„ÅãË≥™Âïè„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
      suggestions:['Êó•Êú¨Ë™û„Å£„ÅΩ„ÅÑÈüø„Åç„Å´„Åó„Åü„ÅÑ','R„Å®„Åã„Çà„ÅèÂá∫„Å¶„Åè„ÇãË®ÄË™û„Å´„Åó„Åü„ÅÑ','ÊØçÈü≥„ÅåÂ§ö„ÅÑË®ÄË™û„Å´„Åó„Åü„ÅÑ','Á°¨„Åè„Å¶ÂäõÂº∑„ÅÑÈüø„Åç„Å´„Åó„Åü„ÅÑ'],
      responses:{
        'Êó•Êú¨Ë™û|ÂíåÈ¢®|„ÇÑ„Åï„Åó':'üéå Êó•Êú¨Ë™û„Å£„ÅΩ„ÅÑÈüø„Åç„Å´„ÅØ**a i u e o „ÅÆ5ÊØçÈü≥„ÅÆ„Åø**„Å´Áµû„Çä„ÄÅ**k s t n m r**„ÅÆÂ≠êÈü≥„ÄÅ**CVÂûã„ÅÆÈü≥ÁØÄ**„ÅåÈçµ„Åß„ÅôÔºÅ',
        'R|„É´|„É≠|„É©|rÈü≥':'üîÑ rÈü≥Á≥ª„ÅÆË®ÄË™û„ÅØ**…æÔºàÂºæ„ÅçÈü≥Ôºâ,  ÄÔºàÂè£ËìãÂûÇ„Åµ„Çã„ÅàÔºâ, rÔºà„Åµ„Çã„ÅàÈü≥Ôºâ**„ÅÆ‰∏≠„Åã„ÇâÈÅ∏„Å∂„Å®ÂÄãÊÄß„ÅåÂá∫„Åæ„Åô„ÄÇ',
        'ÊØçÈü≥„ÅåÂ§ö„ÅÑ|ÊØçÈü≥Â§ö|„Éè„ÉØ„Ç§':'üå∫ „Éè„ÉØ„Ç§Ë™ûÈ¢®„Å™„Çâ**ÊØçÈü≥„ÅåË™ûÊú´„Å´Êù•„ÇãCVÂûã**„ÅåÂÆöÁï™„ÄÇÊØçÈü≥ a, e, i, o, u Â≠êÈü≥„ÅØ k, m, n, p, h, l, w „Å†„Åë„ÅßOKÔºÅ',
        'Á°¨„ÅÑ|ÂäõÂº∑„ÅÑ|Âº∑|„É≠„Ç∑„Ç¢':'üí™ Á°¨„ÅÑÈüø„Åç„Å´„ÅØ**r, k, g, t, d, z**„ÅÆÂØæ„ÄÇCVCÂûã„Åæ„Åü„ÅØCCVCÂûã„ÄÇ',
        'Êüî„Çâ„Åã„ÅÑ|„ÇÑ„Çè„Çâ„Åã|„Éï„É©„É≥„Çπ':'ü•ê Êüî„Çâ„Åã„ÅÑÈüø„Åç„Å´„ÅØ**√∏, y, ≈ì „ÅÆÂÜÜÂîáÊØçÈü≥**„Å®** í, v, w „ÅÆÊúâÂ£∞Â≠êÈü≥**„ÅåÂäπÊûúÁöÑ„ÄÇ',
        default:'üîä Èü≥„Å´„Å§„ÅÑ„Å¶‰Ωï„Åß„ÇÇËÅû„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑÔºÅ\n„Éª„Äå‚óã‚óãË™û„Åø„Åü„ÅÑ„Å™Èü≥„Å´„Åó„Åü„ÅÑ„Äç\n„Éª„Äå‚óã‚óã„Å®„ÅÑ„ÅÜÈü≥„ÅÆ‰Ωú„ÇäÊñπ„Äç\n„Å™„Å©Ê∞óËªΩ„Å´„Å©„ÅÜ„ÅûÔºÅ'
      }
    },
    grammar:{
      greeting:'‚öôÔ∏è ÊñáÊ≥ïAI„Åß„ÅôÔºÅÊ†º„ÇÑË™ûÈ†Ü„Å´„Å§„ÅÑ„Å¶Ë≥™Âïè„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
      suggestions:['Ê†ºÂ§âÂåñ„Å£„Å¶Èõ£„Åó„ÅÑ‚Ä¶ÂàùÂøÉËÄÖÂêë„Åë„Å´Êïô„Åà„Å¶','Ë™ûÈ†Ü„ÅØ„Å©„Çå„Åå„ÅÑ„ÅÑÔºü','ÊôÇÂà∂„Çí„Ç∑„É≥„Éó„É´„Å´„Åó„Åü„ÅÑ','Ê†º„Åå„Å™„ÅÑË®ÄË™û„ÇÇ‰Ωú„Çå„ÇãÔºü'],
      responses:{
        'Ê†ºÂ§âÂåñ|Ê†º„Å£„Å¶|Ê†º„ÅåÈõ£|ÂàùÂøÉËÄÖ':'üìö Ê†ºÂ§âÂåñ„ÅÆÂßã„ÇÅÊñπÔºö\n1Ô∏è‚É£ „Åæ„Åö‰∏ªÊ†º„Å®ÂØæÊ†º„ÅÆ2„Å§„Å†„ÅëË®≠ÂÆö\n2Ô∏è‚É£ Ë™ûÊ†π„Äåkali„Äç‚Üí‰∏ªÊ†º=kali„ÄÅÂØæÊ†º=kali-el\n3Ô∏è‚É£ ÊÖ£„Çå„Åü„Çâ‰∏éÊ†º„ÇíËøΩÂä†ÔºÅ',
        'Ë™ûÈ†Ü|SOV|SVO|„Å©„Çå':'üìù Ë™ûÈ†Ü„ÅÆÈÅ∏„Å≥ÊñπÔºö\nüáØüáµ **SOVÔºàÊó•Êú¨Ë™ûÂûãÔºâ**ÔºöËá™ÁÑ∂„ÅßRP„Åó„ÇÑ„Åô„ÅÑ\nüá∫üá∏ **SVOÔºàËã±Ë™ûÂûãÔºâ**ÔºöËã±Ë™ûË©±ËÄÖÂêë„Åë\nüîÄ **Ëá™Áî±Ë™ûÈ†Ü**Ôºö‰∏äÁ¥öËÄÖÂêë„Åë',
        'ÊôÇÂà∂|„Ç∑„É≥„Éó„É´|ÊôÇÈñì':'‚è±Ô∏è ÊôÇÂà∂„Çí„Ç∑„É≥„Éó„É´„Å´„Åô„ÇãÊñπÊ≥ïÔºö\n„ÉªÊôÇÂà∂„Å™„Åó„ÅßÂâØË©û„ÅßË°®Áèæ\n„ÉªÁèæÂú®„ÉªÈÅéÂéª„ÅÆ2„Å§„Å†„Åë\n„ÉªË™ûÂ∞æ„Å´-velÔºàÁèæÂú®Ôºâ, -ranÔºàÈÅéÂéªÔºâ',
        'Ê†º„Åå„Å™„ÅÑ|Ê†º„Å™„Åó|Ê†º„ÅØÂøÖË¶Å':'‚úÖ Ê†º„Å™„ÅóË®ÄË™û„ÅØ‰∏ñÁïå„Å´„Åü„Åè„Åï„Çì„ÅÇ„Çä„Åæ„Åô„ÄÇ‰∏≠ÂõΩË™û„ÉªËã±Ë™û„ÅØË™ûÈ†Ü„ÅßÊÑèÂë≥„ÇíÊ±∫„ÇÅ„Åæ„Åô„ÄÇ',
        default:'‚öôÔ∏è ÊñáÊ≥ï„Å´„Å§„ÅÑ„Å¶‰Ωï„Åß„ÇÇËÅû„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑÔºÅ\n„Éª„Äå‚óã‚óãÊ†º„Å£„Å¶„Å©„ÅÜ‰Ωø„ÅÜÔºü„Äç\n„Éª„Äå„Ç∑„É≥„Éó„É´„Å™ÊñáÊ≥ï„Å´„Åó„Åü„ÅÑ„Äç\n„Å™„Å©ÔºÅ'
      }
    },
    vocab:{
      greeting:'üìñ Ë™ûÂΩôAI„Åß„ÅôÔºÅÂçòË™û‰Ωú„Çä„Çí„Çµ„Éù„Éº„Éà„Åó„Åæ„Åô„ÄÇ',
      suggestions:['ÊúÄÂàù„Å´„Å©„Çì„Å™ÂçòË™û„Åã„Çâ‰Ωú„Çå„Å∞„ÅÑ„ÅÑÔºü','ÂçòË™û„ÅÆÊÑèÂë≥„ÇíÂ∫É„Åí„Çã„Ç≥„ÉÑ„ÅØÔºü','Êé•È†≠Ëæû„ÉªÊé•Â∞æËæû„ÅÆ‰Ωú„ÇäÊñπ','ÂçòË™û„ÅåÈü≥Èüª„É´„Éº„É´„Å´Âêà„Çè„Å™„ÅÑ'],
      responses:{
        'ÊúÄÂàù|‰Ωï„Åã„Çâ|„Å©„Åì„Åã„Çâ':'üå± ÊúÄÂàù„Å´‰Ωú„Çã„Å®‰æøÂà©„Å™ÂçòË™û„Éà„ÉÉ„Éó10Ôºö\n1. ÁßÅ 2. „ÅÇ„Å™„Åü 3. „ÅÇ„Çã„Éª„ÅÑ„Çã 4. Ë°å„Åè 5. È£ü„Åπ„Çã 6. Ê∞¥ 7. ÁÅ´ 8. Â§ß„Åç„ÅÑ 9. Â∞è„Åï„ÅÑ 10. „Åù„Åó„Å¶',
        'ÊÑèÂë≥|Ê¥æÁîü|Â∫É„Åí|Èñ¢ÈÄ£':'üîó Êé•È†≠Ëæû„ÉªÊé•Â∞æËæû„ÅåÂäπÁéáÁöÑÔºÅ\n‰æãÔºösolÔºàÂ§™ÈôΩÔºâ‚Üí sol-velÔºàËºù„ÅèÔºâ, sol-aelÔºàÂÖâ„ÅÆÔºâ, al-solÔºàÊöóÈóáÔºâ',
        'Êé•È†≠Ëæû|Êé•Â∞æËæû|Ë™ûÂ∞æ|Ê¥æÁîüË™û':'‚ö° Ë™ûÂ∞æ„Ç∑„Çπ„ÉÜ„É†„ÅÆ‰æãÔºö\n-el=ÂΩ¢ÂÆπË©ûÂåñ, -vel=ÂãïË©ûÂåñ, -i=Ë§áÊï∞',
        'Èü≥Èüª|„É´„Éº„É´|ÈÅïÂèç|Âêà„Çè„Å™„ÅÑ':'üîç Èü≥Èüª„É´„Éº„É´ÈÅïÂèç„ÅåÂá∫„Åü„Å®„ÅçÔºö\n1. Èü≥Èüª„Çø„Éñ„Åß‰ΩøÁî®„Åô„ÇãÈü≥„ÇíÁ¢∫Ë™ç\n2. ÂçòË™û„Å´Êú™ÁôªÈå≤„ÅÆÊñáÂ≠ó„Åå„Å™„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ',
        default:'üìñ ÂçòË™û„ÉªË™ûÂΩô„Å´„Å§„ÅÑ„Å¶‰Ωï„Åß„ÇÇËÅû„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑÔºÅ\n„Éª„Äå‚óã‚óãË™û„Å£„ÅΩ„ÅÑÂçòË™û„ÅÆ‰Ωú„ÇäÊñπ„Äç\n„Éª„ÄåÂõ∫ÊúâÂêçË©û„ÅÆ‰Ωú„ÇäÊñπ„Äç\n„Å™„Å©ÔºÅ'
      }
    },
    corpus:{
      greeting:'üí¨ ‰æãÊñáAI„Åß„ÅôÔºÅÊñá„Çí‰Ωú„Çã„Çµ„Éù„Éº„Éà„Çí„Åó„Åæ„Åô„ÄÇ',
      suggestions:['‰æãÊñá„Å£„Å¶„Å©„ÅÜ‰Ωú„Çå„Å∞„ÅÑ„ÅÑÔºü','„Ç∞„É≠„ÇπÔºàÈÄêË™ûË®≥Ôºâ„ÅÆÊõ∏„ÅçÊñπ','SNSÊò†„Åà„Åô„Çã‰æãÊñá„Çí‰Ωú„Çä„Åü„ÅÑ','ËæûÊõ∏„ÅåÂ∞ë„Å™„ÅÑÁä∂ÊÖã„Åß‰æãÊñá„ÅØ‰Ωú„Çå„ÇãÔºü'],
      responses:{
        '‰æãÊñá|„Å©„ÅÜ‰Ωú|ÊúÄÂàù':'‚úçÔ∏è ‰æãÊñá„ÅÆ‰Ωú„ÇäÊñπÔºö\n1. ËæûÊõ∏„Å´ÂêçË©û„ÉªÂãïË©û„Çí3„Äú5Ë™ûÁôªÈå≤\n2. „ÄåËæûÊõ∏„Åã„ÇâÁµÑ„ÅøÁ´ã„Å¶„Äç„Éú„Çø„É≥„ÇíÊäº„Åô\n3. Ë™ûÈ†ÜË®≠ÂÆö„Å´Âêà„Çè„Åõ„Å¶‰∏¶„Å≥Êõø„Åà\n4. Ë™≠„Åø„Å®Ë®≥„ÇíÂÖ•„Çå„Å¶‰øùÂ≠òÔºÅ',
        '„Ç∞„É≠„Çπ|ÈÄêË™ûË®≥|Ë®ÄË™ûÂ≠¶':'üìã „Ç∞„É≠„Çπ„ÅÆÊõ∏„ÅçÊñπÔºàLeipzigÊñπÂºèÔºâÔºö\nkali-el kaelo = Ê∞¥-NOM Á©∫-ACC\nÁï•Ë™ûÔºöNOM, ACC, GEN, PL, PST, PRES',
        'SNS|„Ç∑„Çß„Ç¢|Êò†„Åà|„Åã„Å£„Åì„ÅÑ„ÅÑ':'‚ú® SNSÊò†„Åà„ÅÆ„Ç≥„ÉÑÔºöÁü≠„ÇÅÔºà3„Äú6ÂçòË™ûÔºâ„ÄÅ„Ç∞„É≠„Çπ„ÇíÂÖ•„Çå„Çã„Å®„ÄåÊú¨Áâ©„ÅÆË®ÄË™ûÊÑü„Äç„ÅåÂá∫„ÇãÔºÅ',
        'ËæûÊõ∏„ÅåÂ∞ë„Å™„ÅÑ|ÂçòË™û„Åå„Å™„ÅÑ|Ë™ûÂΩôÂ∞ë':'üå± Ë™ûÂΩô„ÅåÂ∞ë„Å™„Åè„Å¶„ÇÇ‰æãÊñá„ÅØ‰Ωú„Çå„Åæ„ÅôÔºÅ„Åæ„Åö5Ë™ûÔºàÂêçË©û2+ÂãïË©û2+ÂΩ¢ÂÆπË©û1Ôºâ„Åã„ÇâÂßã„ÇÅ„Å¶„ÄÇ',
        default:'üí¨ ‰æãÊñá„Éª„Ç≥„Éº„Éë„Çπ„Å´„Å§„ÅÑ„Å¶‰Ωï„Åß„ÇÇËÅû„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑÔºÅ'
      }
    },
    script:{
      greeting:'‚úçÔ∏è ÊñáÂ≠ó‰ΩìÁ≥ªAI„Åß„ÅôÔºÅÊñáÂ≠ó„ÉªË®òÂè∑„ÅÆÈÅ∏„Å≥Êñπ„ÇíÁõ∏Ë´á„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
      suggestions:['„Å©„Çì„Å™ÊñáÂ≠ó‰ΩìÁ≥ª„ÇíÈÅ∏„Åπ„Å∞„ÅÑ„ÅÑÔºü','Áã¨Ëá™ÊñáÂ≠ó„ÅÆ‰Ωú„ÇäÊñπ„ÅÆ„Ç≥„ÉÑ','ÊñáÂ≠óË®òÂè∑„ÅÆ„Åä„Åô„Åô„ÇÅ„ÅØÔºü','Ë§áÊï∞„ÅÆÊñáÂ≠ó„ÇíÁµÑ„ÅøÂêà„Çè„Åõ„Å¶„ÅÑ„ÅÑÔºü'],
      responses:{
        '„Å©„Çå|ÈÅ∏„Åπ„Å∞„ÅÑ„ÅÑ|„Åä„Åô„Åô„ÇÅ|ÂàùÂøÉËÄÖ':'‚úçÔ∏è ÊñáÂ≠ó‰ΩìÁ≥ª„ÅÆÈÅ∏„Å≥ÊñπÔºö\nüî§ „É©„ÉÜ„É≥ÊñáÂ≠ó„Éô„Éº„ÇπÔºöÊúÄ„ÇÇÊâ±„ÅÑ„ÇÑ„Åô„ÅÑ\nüî∫ „É´„Éº„É≥ÊñáÂ≠óÔºöÁ•ûÁßòÁöÑ„ÉªÂè§‰ª£ÁöÑ\nüîµ „ÇÆ„É™„Ç∑„É£ÊñáÂ≠óÔºöÁü•ÁöÑ„ÉªÂ≠¶Ë°ìÁöÑ',
        'Áã¨Ëá™|„Ç™„É™„Ç∏„Éä„É´|‰Ωú„Çã|Ëá™‰Ωú':'üé® Áã¨Ëá™ÊñáÂ≠ó„ÅÆ„Ç≥„ÉÑÔºö\n1. Èü≥„ÅÆ„Ç∞„É´„Éº„Éó„ÇíÊ±∫„ÇÅ„Çã\n2. „Ç∞„É´„Éº„Éó„Åî„Å®„Å´‰ºº„ÅüÂΩ¢„ÅÆË®òÂè∑\n3. „Ç∑„É≥„Éó„É´„Å´ÔºÅ',
        'Ë®òÂè∑|„É¶„Éã„Ç≥„Éº„Éâ|Unicode':'üî° ‰Ωø„Åà„ÇãË®òÂè∑Ôºö\n„É´„Éº„É≥Ôºö·ö† ·ö¢ ·ö¶ ·ö®\n„ÇÆ„É™„Ç∑„É£ÔºöŒ± Œ≤ Œ≥ Œ¥\n„Ç¢„É©„Éì„Ç¢Ôºöÿß ÿ® ÿ™',
        'ÁµÑ„ÅøÂêà„Çè„Åõ|Ê∑∑„Åú':'‚úÖ Ë§áÊï∞„ÅÆÊñáÂ≠ó‰ΩìÁ≥ª„ÇíÊ∑∑„Åú„Å¶„ÇÇOK„Åß„ÅôÔºÅ‰∏ÄË≤´„Åó„Åü„É´„Éº„É´„ÇíÊåÅ„Åü„Åõ„Çã„Å®‰Ωø„ÅÑ„ÇÑ„Åô„Åè„Å™„Çä„Åæ„Åô„ÄÇ',
        default:'‚úçÔ∏è ÊñáÂ≠ó„Å´„Å§„ÅÑ„Å¶‰Ωï„Åß„ÇÇÁõ∏Ë´á„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ'
      }
    }
  },
  en:{
    vibe:{
      greeting:'‚ú¶ Vibe AI! Tell me what kind of language you want to create.',
      suggestions:["I want an elven forest language","I want a cold mechanical feel","I want something cute and poppy","I want an ancient mythological sound"],
      responses:{
        'elf|elv|forest|fae':'üåø For an elven feel, use **vowels a, e, i, √´** with **l, r, n, m, th** consonants. Endings -el, -iel, -ar are classic. Ex: Silmarien, L√∫thiel, Calavar',
        'dark|empire|grim|black':'‚öîÔ∏è For a dark feel, combine **u, √§ dark vowels** with **k, g, d, r, z hard consonants**. Ex: Drakur, Gothrim, Valdenz',
        'cute|pop|bright|fairy':'üå∏ For cute vibes, use **i, a bright vowels** with **m, n, p soft consonants**. Ex: Mimika, Pani, Tiritiri',
        'sci.fi|machine|future|robot':'‚öôÔ∏è For sci-fi, sharp **e, i vowels** with **x, z, k mechanical consonants**. Ex: Vexon, Nkrial, Zytex',
        'ocean|water|spirit|wave':'üåä Ocean vibes: **a, e vowels** with **m, n, l flowing consonants**. Ex: Maelan, Neriva, Coranil',
        'ancient|myth|god|sacred':'üèîÔ∏è Ancient feel: **a, u vowels** with **k, t, r, v consonants**. Add -ar, -us for grandeur. Ex: Arkanus, Vathar, Torvael',
        default:"Interesting idea! üìù What vibe are you going for?\n‚Ä¢ Which languages inspire you? (Elvish, Latin, Japanese...)\n‚Ä¢ Soft/hard? Bright/dark?\n‚Ä¢ What world does this language belong to?"
      }
    },
    phoneme:{
      greeting:'üîä Phoneme AI! Ask me about what sounds you want.',
      suggestions:["I want a Japanese-like sound","I want lots of R sounds","I want a vowel-heavy language","I want a hard powerful sound"],
      responses:{
        'japanese|japan|soft':'üéå For Japanese-like sound, limit to **5 vowels a i u e o**, consonants **k s t n m r**, and **CV syllable structure**!',
        'r.sound|rolling|r heavy':'üîÑ For R-heavy: choose between **…æ (tap),  Ä (uvular trill), r (trill)**.',
        'vowel.heavy|many vowels|hawaiian':'üå∫ Hawaiian style: **CV pattern**. Vowels a, e, i, o, u and consonants k, m, n, p, h, l, w.',
        'hard|powerful|strong':'üí™ Hard sound: pairs of **r, k, g, t, d, z**. CVC or CCVC structure.',
        'soft|gentle|french':'ü•ê Soft sounds: **√∏, y, ≈ì rounded vowels** with ** í, v, w voiced consonants**.',
        default:"üîä Ask me anything about sounds!\n‚Ä¢ 'I want it to sound like...'\n‚Ä¢ 'How do I make this sound?'"
      }
    },
    grammar:{
      greeting:'‚öôÔ∏è Grammar AI! Ask about cases, word order, and more.',
      suggestions:["Cases are tricky... beginner tips please","Which word order is best?","I want to simplify tense","Can I make a language without cases?"],
      responses:{
        'case|cases|beginner':'üìö Easiest start with cases:\n1Ô∏è‚É£ Start with just **nominative and accusative**\n2Ô∏è‚É£ "kali" ‚Üí nominative=kali, accusative=kali-el\n3Ô∏è‚É£ Add dative later!',
        'word.order|sov|svo':'üìù Word order options:\nüáØüáµ **SOV**: Great for roleplay\nüá∫üá∏ **SVO**: Familiar\nüîÄ **Free order**: Advanced',
        'tense|simple|time':'‚è±Ô∏è Simplifying tense:\n‚Ä¢ No tense ‚Äî use adverbs\n‚Ä¢ Just present and past\n‚Ä¢ Suffixes -vel (present), -ran (past)',
        'no.case|caseless':'‚úÖ Absolutely! Chinese and English use word order instead of cases. You can also create particles.',
        default:"‚öôÔ∏è Ask me anything about grammar!\n‚Ä¢ 'How do I use this case?'\n‚Ä¢ 'I want simpler grammar'"
      }
    },
    vocab:{
      greeting:"üìñ Vocabulary AI! I'll help you build words.",
      suggestions:["What words should I make first?","Tips for expanding word meanings?","How to make prefixes/suffixes?","My word violates phonology rules"],
      responses:{
        'first|start|begin':'üå± Top 10 most useful first words:\n1. I/me 2. You 3. To be 4. To go 5. To eat 6. Water 7. Fire 8. Big 9. Small 10. And',
        'expand|derive|meaning':'üîó Prefixes and suffixes!\nExample: sol (sun) ‚Üí sol-vel (shine), sol-ael (solar), al-sol (darkness)',
        'prefix|suffix|ending':'‚ö° Affix system example:\n-el=adjectivize, -vel=verbalize, -i=plural',
        'phonology|rule|violation':'üîç When you get a violation:\n1. Check your phoneme tab\n2. Make sure no unregistered characters are in the word',
        default:"üìñ Ask me anything about vocabulary!\n‚Ä¢ 'How to make words sound like...'\n‚Ä¢ 'How many words do I need?'"
      }
    },
    corpus:{
      greeting:"üí¨ Corpus AI! I'll help you build example sentences.",
      suggestions:["How do I make example sentences?","How to write glosses?","I want impressive sentences","Can I write sentences with few words?"],
      responses:{
        'how|make|first|start':'‚úçÔ∏è Steps to create a sentence:\n1. Register 3-5 nouns/verbs\n2. Click "Build from dictionary"\n3. Arrange by word order\n4. Add reading and translation!',
        'gloss|interlinear|linguistic':'üìã Writing glosses (Leipzig style):\nkali-el kaelo = water-NOM sky-ACC\nAbbreviations: NOM, ACC, GEN, PL, PST, PRES',
        'sns|share|cool|impressive':'‚ú® Tips for impressive sentences:\n‚Ä¢ Keep it short (3-6 words)\n‚Ä¢ Add glosses for authenticity',
        'few.words|small.vocab':'üå± Start with 5 words (2 nouns, 2 verbs, 1 adjective) and try auto-generate!',
        default:"üí¨ Ask me anything about sentences!"
      }
    },
    script:{
      greeting:"‚úçÔ∏è Script AI! Let me help you choose letters and symbols.",
      suggestions:["What writing system should I use?","Tips for creating original characters?","What symbols are recommended?","Can I combine multiple scripts?"],
      responses:{
        'which|recommend|best|beginner':'‚úçÔ∏è Choosing a writing system:\nüî§ **Latin**: Most flexible\nüî∫ **Runic**: Mysterious and ancient\nüîµ **Greek**: Intellectual',
        'original|custom|create':'üé® Tips for original script:\n1. Decide on sound groups\n2. Similar shapes within groups\n3. Keep it simple!',
        'symbol|unicode':'üî° Example symbols:\nRunic: ·ö† ·ö¢ ·ö¶ ·ö®\nGreek: Œ± Œ≤ Œ≥ Œ¥\nArabic: ÿß ÿ® ÿ™',
        'combine|mix':'‚úÖ Mixing scripts is fine! Just keep consistent rules.',
        default:"‚úçÔ∏è Ask me anything about writing systems!"
      }
    }
  },
  zh:{
    vibe:{
      greeting:'‚ú¶ Ê∞õÂõ¥AIÔºÅÂëäËØâÊàëÊÇ®ÊÉ≥ÂàõÂª∫‰ªÄ‰πàÊ†∑ÁöÑËØ≠Ë®Ä„ÄÇ',
      suggestions:['ÊàëÊÉ≥ÂàõÂª∫Á≤æÁÅµÊ£ÆÊûóËØ≠Ë®Ä','ÊàëÊÉ≥Ë¶ÅÂÜ∑ÈÖ∑Êú∫Ê¢∞ÊñáÊòéÁöÑÊÑüËßâ','ÊàëÊÉ≥Ë¶ÅÂèØÁà±Ê¥ªÊ≥ºÁöÑËØ≠Ë®Ä','ÊàëÊÉ≥Ë¶ÅÂè§‰ª£Á•ûËØùÁöÑÊÑüËßâ'],
      responses:{
        'Á≤æÁÅµ|Ê£ÆÊûó':'üåø Á≤æÁÅµÈ£éÊ†ºÔºöÂ§ßÈáè‰ΩøÁî®**ÂÖÉÈü≥ a, e, i, √´**ÔºåËæÖÈü≥Áî®**l, r, n, m, th**„ÄÇËØçÂ∞æÁî®-el, -iel, -ar„ÄÇ‰æãÔºöSilmarien, L√∫thiel',
        'ÊöóÈªë|Â∏ùÂõΩ|ÈªëÊöó':'‚öîÔ∏è ÊöóÈªëÈ£éÊ†ºÔºöÁªìÂêà**u, √§ ÊöóÂÖÉÈü≥**Âíå**k, g, d, r, z Á°¨ËæÖÈü≥**„ÄÇ‰æãÔºöDrakur, Gothrim',
        'ÂèØÁà±|Ê¥ªÊ≥º':'üå∏ ÂèØÁà±È£éÊ†ºÔºö‰ΩøÁî®**i, a Êòé‰∫ÆÂÖÉÈü≥**Âíå**m, n, p ÊüîÂíåËæÖÈü≥**„ÄÇ‰æãÔºöMimika, Pani',
        'ÁßëÂπª|Êú∫Ê¢∞|Êú™Êù•':'‚öôÔ∏è ÁßëÂπªÈ£éÊ†ºÔºöÈîêÂà©ÁöÑ**e, i ÂÖÉÈü≥**Âíå**x, z, k Êú∫Ê¢∞ËæÖÈü≥**„ÄÇ‰æãÔºöVexon, Nkrial',
        'Êµ∑Ê¥ã|Ê∞¥|Ê≥¢Êµ™':'üåä Êµ∑Ê¥ãÈ£éÊ†ºÔºöÂÆΩÂπøÁöÑ**a, e ÂÖÉÈü≥**Âíå**m, n, l ÊµÅÁïÖËæÖÈü≥**„ÄÇ‰æãÔºöMaelan, Neriva',
        'Âè§‰ª£|Á•ûËØù|Á•ûÂú£':'üèîÔ∏è Âè§‰ª£È£éÊ†ºÔºöÊ∑±Ê≤âÁöÑ**a, u ÂÖÉÈü≥**Âíå**k, t, r, v ÁÆÄÂçïËæÖÈü≥**„ÄÇ‰æãÔºöArkanus, Vathar',
        default:'ÊúâË∂£ÁöÑÊÉ≥Ê≥ïÔºÅüìù ÊÇ®ÊÉ≥Ë¶Å‰ªÄ‰πàÊ∞õÂõ¥Ôºü\n‚Ä¢ Âì™ÁßçËØ≠Ë®ÄÁªôÊÇ®ÁÅµÊÑüÔºü\n‚Ä¢ ÊüîÂíå/ÂàöÁ°¨ÔºüÊòé‰∫Æ/ÈªëÊöóÔºü'
      }
    },
    phoneme:{
      greeting:'üîä Èü≥Á≥ªAIÔºÅÈóÆÊàëÊÇ®ÊÉ≥Ë¶Å‰ªÄ‰πàÊ†∑ÁöÑÂ£∞Èü≥„ÄÇ',
      suggestions:['ÊàëÊÉ≥Ë¶ÅÊó•ËØ≠È£éÊ†ºÁöÑÂèëÈü≥','ÊàëÊÉ≥Ë¶ÅÂæàÂ§öRÈü≥','ÊàëÊÉ≥Ë¶ÅÂÖÉÈü≥‰∏∞ÂØåÁöÑËØ≠Ë®Ä','ÊàëÊÉ≥Ë¶ÅÂàöÁ°¨ÊúâÂäõÁöÑÂèëÈü≥'],
      responses:{
        'Êó•ËØ≠|Êó•Êú¨|ÊüîÂíå':'üéå Êó•ËØ≠È£éÊ†ºÔºöÂè™Áî®**5‰∏™ÂÖÉÈü≥ a i u e o**ÔºåËæÖÈü≥Áî®**k s t n m r**Ôºå**CVÈü≥ËäÇÁªìÊûÑ**ÔºÅ',
        'RÈü≥|È¢§Èü≥':'üîÑ RÈü≥ËØ≠Ë®ÄÔºöÈÄâÊã©**…æÔºàÈó™Èü≥Ôºâ,  ÄÔºàÂ∞èËàåÈ¢§Èü≥Ôºâ, rÔºàÈ¢§Èü≥Ôºâ**‰πã‰∏Ä„ÄÇ',
        'ÂÖÉÈü≥Â§ö|Â§èÂ®ÅÂ§∑':'üå∫ Â§èÂ®ÅÂ§∑È£éÊ†ºÔºö**CVÁªìÊûÑ**ÔºåÂÖÉÈü≥ÁªìÂ∞æ„ÄÇ',
        'ÂàöÁ°¨|ÊúâÂäõ|‰øÑËØ≠':'üí™ ÂàöÁ°¨ÂèëÈü≥Ôºö‰ΩøÁî®**r, k, g, t, d, z**ÁöÑÂØπ„ÄÇCVCÊàñCCVCÁªìÊûÑ„ÄÇ',
        'ÊüîÂíå|Ê≥ïËØ≠':'ü•ê ÊüîÂíåÂèëÈü≥Ôºö**√∏, y, ≈ì ÂúÜÂîáÂÖÉÈü≥**Âíå** í, v, w ÊµäËæÖÈü≥**„ÄÇ',
        default:'üîä ‰ªÄ‰πàÈóÆÈ¢òÈÉΩÂèØ‰ª•ÈóÆÔºÅ'
      }
    },
    grammar:{
      greeting:'‚öôÔ∏è ËØ≠Ê≥ïAIÔºÅÈóÆÊàëÂÖ≥‰∫éÊ†º„ÄÅËØ≠Â∫èÁ≠âÈóÆÈ¢ò„ÄÇ',
      suggestions:['Ê†ºÂèòÂåñÂ§™Èöæ‰∫Ü‚Ä¶ÂàùÂ≠¶ËÄÖÂª∫ËÆÆ','Âì™ÁßçËØ≠Â∫èÊúÄÂ•ΩÔºü','ÊàëÊÉ≥ÁÆÄÂåñÊó∂ÊÄÅ','ÂèØ‰ª•‰∏çÁî®Ê†ºÂêóÔºü'],
      responses:{
        'Ê†ºÂèòÂåñ|Ê†º|ÂàùÂ≠¶':'üìö ÊúÄÁÆÄÂçïÁöÑÊ†ºÂèòÂåñÂÖ•Èó®Ôºö\n1Ô∏è‚É£ ÂÖàÂè™ËÆæÁΩÆ**‰∏ªÊ†ºÂíåÂÆæÊ†º**\n2Ô∏è‚É£ ËØçÊ†π"kali"‚Üí‰∏ªÊ†º=kaliÔºåÂÆæÊ†º=kali-el\n3Ô∏è‚É£ ÁÜüÊÇâÂêéÂÜçÂä†‰∏éÊ†ºÔºÅ',
        'ËØ≠Â∫è|SOV|SVO':'üìù ËØ≠Â∫èÈÄâÊã©Ôºö\nüáØüáµ **SOV**ÔºöËßíËâ≤ÊâÆÊºîÊúÄËá™ÁÑ∂\nüá∫üá∏ **SVO**ÔºöËã±ËØ≠‰ΩøÁî®ËÄÖÁÜüÊÇâ\nüîÄ **Ëá™Áî±ËØ≠Â∫è**ÔºöËøõÈò∂',
        'Êó∂ÊÄÅ|ÁÆÄÂçï|Êó∂Èó¥':'‚è±Ô∏è ÁÆÄÂåñÊó∂ÊÄÅÔºö\n‚Ä¢ Êó†Êó∂ÊÄÅÔºåÁî®"Êò®Â§©""ÊòéÂ§©"Á≠âÂâØËØç\n‚Ä¢ Âè™Áî®Áé∞Âú®ÂíåËøáÂéª',
        'Êó†Ê†º|‰∏çÁî®Ê†º':'‚úÖ ÂΩìÁÑ∂ÂèØ‰ª•ÔºÅ‰∏≠ÊñáÂíåËã±ÊñáÁî®ËØ≠Â∫èË°®ÊÑè„ÄÇ',
        default:'‚öôÔ∏è ‰ªÄ‰πàËØ≠Ê≥ïÈóÆÈ¢òÈÉΩÂèØ‰ª•ÈóÆÔºÅ'
      }
    },
    vocab:{
      greeting:'üìñ ËØçÊ±áAIÔºÅÊàëÊù•Â∏ÆÊÇ®ÂàõÈÄ†ÂçïËØç„ÄÇ',
      suggestions:['ÊàëÂ∫îËØ•ÂÖàÂàõÂª∫‰ªÄ‰πàÂçïËØçÔºü','Êâ©Â±ïËØç‰πâÁöÑÊäÄÂ∑ßÔºü','Â¶Ç‰ΩïÂàõÂª∫ÂâçÁºÄ/ÂêéÁºÄÔºü','ÊàëÁöÑÂçïËØçËøùÂèçÈü≥Á≥ªËßÑÂàô'],
      responses:{
        'ÊúÄÂàù|ÂºÄÂßã|ÂÖà':'üå± ÊúÄÊúâÁî®ÁöÑÂâç10‰∏™ËØçÔºö\n1.Êàë 2.‰Ω† 3.Â≠òÂú® 4.Âéª 5.ÂêÉ 6.Ê∞¥ 7.ÁÅ´ 8.Â§ß 9.Â∞è 10.Âíå',
        'Êâ©Â±ï|Ê¥æÁîü|ËØ≠‰πâ':'üîó ÂâçÁºÄ/ÂêéÁºÄÊïàÁéáÊúÄÈ´òÔºÅ\n‰æãÔºösolÔºàÂ§™Èò≥Ôºâ‚Üí sol-velÔºàÁÖßËÄÄÔºâ, sol-aelÔºàÂ§™Èò≥ÁöÑÔºâ',
        'ÂâçÁºÄ|ÂêéÁºÄ|ËØçÂ∞æ':'‚ö° ËØçÁºÄÁ≥ªÁªüÔºö-el=ÂΩ¢ÂÆπËØçÂåñ, -vel=Âä®ËØçÂåñ, -i=Â§çÊï∞',
        'Èü≥Á≥ª|ËßÑÂàô|ËøùÂèç':'üîç ÈÅáÂà∞Èü≥Á≥ªËøùÂèçÊó∂ÔºöÊ£ÄÊü•Èü≥Á≥ªÊ†áÁ≠æÔºåÁ°ÆËÆ§Êó†Êú™Ê≥®ÂÜåÂ≠óÁ¨¶„ÄÇ',
        default:'üìñ ‰ªÄ‰πàËØçÊ±áÈóÆÈ¢òÈÉΩÂèØ‰ª•ÈóÆÔºÅ'
      }
    },
    corpus:{
      greeting:'üí¨ ‰æãÂè•AIÔºÅÊàëÊù•Â∏ÆÊÇ®ÂàõÂª∫Á§∫‰æãÂè•„ÄÇ',
      suggestions:['Â¶Ç‰ΩïÂàõÂª∫‰æãÂè•Ôºü','Â¶Ç‰ΩïÂÜôËØçÂΩ¢Ê≥®Ëß£Ôºü','ÊàëÊÉ≥Ë¶ÅÂ•ΩÁúãÁöÑÂè•Â≠ê','ËØçÊ±áÂ∞ëÁöÑÊÉÖÂÜµ‰∏ãËÉΩÂÜôÂè•Â≠êÂêóÔºü'],
      responses:{
        'Â¶Ç‰Ωï|ÂàõÂª∫|ÂºÄÂßã':'‚úçÔ∏è ÂàõÂª∫Âè•Â≠êÁöÑÊ≠•È™§Ôºö\n1. Âú®ËØçÂÖ∏‰∏≠Ê≥®ÂÜå3-5‰∏™ÂêçËØç/Âä®ËØç\n2. ÁÇπÂáª"‰ªéËØçÂÖ∏ÁªÑÂêà"\n3. ÊåâËØ≠Â∫èÊéíÂàó\n4. ‰øùÂ≠òÔºÅ',
        'Ê≥®Ëß£|ËØçÂΩ¢|ËØ≠Ë®ÄÂ≠¶':'üìã ËØçÂΩ¢Ê≥®Ëß£ÔºàËé±ÊØîÈî°Ê†ºÂºèÔºâÔºö\nkali-el = Ê∞¥-NOM\nÁº©ÂÜôÔºöNOM, ACC, GEN, PL, PST',
        'SNS|ÂàÜ‰∫´|Â•ΩÁúã':'‚ú® Â•ΩÁúãÂè•Â≠êÔºöÁü≠‰∏ÄÁÇπÔºà3-6‰∏™ËØçÔºâÔºåÂä†ËØçÂΩ¢Ê≥®Ëß£ÔºÅ',
        'ËØçÊ±áÂ∞ë|ÂçïËØçÂ∞ë':'üå± ‰ªé5‰∏™ËØçÂºÄÂßãÔºà2ÂêçËØç+2Âä®ËØç+1ÂΩ¢ÂÆπËØçÔºâÔºÅ',
        default:'üí¨ ‰ªÄ‰πà‰æãÂè•ÈóÆÈ¢òÈÉΩÂèØ‰ª•ÈóÆÔºÅ'
      }
    },
    script:{
      greeting:'‚úçÔ∏è ‰π¶ÂÜôAIÔºÅÊàëÊù•Â∏ÆÊÇ®ÈÄâÊã©Â≠óÊØçÂíåÁ¨¶Âè∑„ÄÇ',
      suggestions:['ÊàëÂ∫îËØ•Áî®‰ªÄ‰πà‰π¶ÂÜô‰ΩìÁ≥ªÔºü','ÂàõÂª∫ÂéüÂàõÂ≠óÁ¨¶ÁöÑÊäÄÂ∑ßÔºü','Êé®Ëçê‰ªÄ‰πàÁ¨¶Âè∑Ôºü','ÂèØ‰ª•Ê∑∑ÂêàÂ§öÁßç‰π¶ÂÜô‰ΩìÁ≥ªÂêóÔºü'],
      responses:{
        'Âì™Áßç|Êé®Ëçê|ÂàùÂ≠¶':'‚úçÔ∏è ‰π¶ÂÜô‰ΩìÁ≥ªÈÄâÊã©Ôºö\nüî§ Êãâ‰∏ÅÂ≠óÊØçÔºöÊúÄÊòìÁî®\nüî∫ Â¶ÇÂ∞ºÊñáÔºöÁ•ûÁßòÂè§‰ª£ÊÑü\nüîµ Â∏åËÖäÂ≠óÊØçÔºöÂ≠¶ÊúØÁü•ÊÄßÊÑü',
        'ÂéüÂàõ|Ëá™Âà∂|ÂàõÂª∫':'üé® ÂéüÂàõÂ≠ó‰ΩìÊäÄÂ∑ßÔºöÂÖàÂÜ≥ÂÆöÈü≥ÁªÑÔºåÂêåÁªÑÁî®Áõ∏‰ººÂΩ¢Áä∂Ôºå‰øùÊåÅÁÆÄÂçïÔºÅ',
        'Á¨¶Âè∑|Unicode':'üî° ÂèØÁî®Á¨¶Âè∑ÔºöÂ¶ÇÂ∞ºÔºö·ö† ·ö¢ ·ö¶ ·ö® / Â∏åËÖäÔºöŒ± Œ≤ Œ≥ Œ¥',
        'Ê∑∑Âêà|ÁªìÂêà':'‚úÖ Ê∑∑Âêà‰π¶ÂÜô‰ΩìÁ≥ª‰πüÂèØ‰ª•ÔºÅ‰øùÊåÅ‰∏ÄËá¥ÁöÑËßÑÂàôÂ∞±Â•Ω„ÄÇ',
        default:'‚úçÔ∏è ‰ªÄ‰πà‰π¶ÂÜôÈóÆÈ¢òÈÉΩÂèØ‰ª•ÈóÆÔºÅ'
      }
    }
  },
  es:{
    vibe:{
      greeting:'‚ú¶ ¬°IA de Est√©tica! Dime qu√© tipo de idioma quieres crear.',
      suggestions:['Quiero un idioma del bosque √©lfico','Quiero una civilizaci√≥n mec√°nica fr√≠a','Quiero algo cute y pop','Quiero un sonido m√≠tico antiguo'],
      responses:{
        'elfo|bosque|hada':'üåø Para ambiente √©lfico, usa **vocales a, e, i, √´** con consonantes **l, r, n, m, th**. Terminaciones -el, -iel, -ar son cl√°sicas.',
        'oscuro|imperio|sombra':'‚öîÔ∏è Para ambiente oscuro: **vocales oscuras u, √§** con **consonantes duras k, g, d, r, z**.',
        'cute|pop|brillante':'üå∏ Para vibe cute: **vocales brillantes i, a** con **consonantes suaves m, n, p**.',
        'sci.fi|m√°quina|futuro':'‚öôÔ∏è Para sci-fi: **vocales agudas e, i** con **consonantes mec√°nicas x, z, k**.',
        'oc√©ano|agua|esp√≠ritu':'üåä Para ambiente marino: **vocales amplias a, e** con **consonantes fluidas m, n, l**.',
        'antiguo|mito|dios':'üèîÔ∏è Para lo antiguo: **vocales profundas a, u** con **consonantes simples k, t, r, v**.',
        default:'¬°Idea interesante! üìù ¬øQu√© ambiente buscas?\n‚Ä¢ ¬øQu√© idiomas te inspiran?\n‚Ä¢ ¬øSuave/duro? ¬øClaro/oscuro?'
      }
    },
    phoneme:{
      greeting:'üîä ¬°IA de Fonolog√≠a! Preg√∫ntame sobre los sonidos que quieres.',
      suggestions:['Quiero un sonido tipo japon√©s','Quiero muchas R','Quiero un idioma con muchas vocales','Quiero un sonido fuerte y potente'],
      responses:{
        'japon√©s|suave':'üéå Para sonido japon√©s: **5 vocales a i u e o**, consonantes **k s t n m r**, estructura **CV**.',
        'r.sound|vibrante':'üîÑ Para R: elige entre **…æ (percusiva),  Ä (uvular), r (vibrante)**.',
        'vocal.rica|muchas vocales':'üå∫ Estilo hawaiano: patr√≥n **CV** con vocales al final.',
        'duro|potente|fuerte':'üí™ Para sonido duro: **r, k, g, t, d, z**. Estructura CVC o CCVC.',
        'suave|franc√©s':'ü•ê Para sonido suave: **vocales redondeadas √∏, y, ≈ì** con ** í, v, w**.',
        default:'üîä ¬°Preg√∫ntame sobre fonolog√≠a!'
      }
    },
    grammar:{
      greeting:'‚öôÔ∏è ¬°IA de Gram√°tica! Preg√∫ntame sobre casos, orden de palabras, etc.',
      suggestions:['Los casos son dif√≠ciles... consejos para principiantes','¬øQu√© orden de palabras es mejor?','Quiero simplificar el tiempo verbal','¬øPuedo hacer un idioma sin casos?'],
      responses:{
        'caso|casos|principiante':'üìö C√≥mo empezar con casos:\n1Ô∏è‚É£ Solo **nominativo y acusativo**\n2Ô∏è‚É£ "kali" ‚Üí nominativo=kali, acusativo=kali-el\n3Ô∏è‚É£ A√±ade dativo despu√©s',
        'orden|sov|svo':'üìù Orden de palabras:\nüáØüáµ **SOV**: Natural para roleplay\nüá∫üá∏ **SVO**: Familiar\nüîÄ **Libre**: Avanzado',
        'tiempo|verbal|tense':'‚è±Ô∏è Simplificar tiempo verbal:\n‚Ä¢ Sin tiempo ‚Äî usa adverbios\n‚Ä¢ Solo presente y pasado\n‚Ä¢ Sufijos -vel (presente), -ran (pasado)',
        'sin.caso|no.caso':'‚úÖ ¬°Claro! El chino y el ingl√©s usan el orden de palabras.',
        default:'‚öôÔ∏è ¬°Preg√∫ntame sobre gram√°tica!'
      }
    },
    vocab:{
      greeting:'üìñ ¬°IA de Vocabulario! Te ayudo a crear palabras.',
      suggestions:['¬øQu√© palabras debo crear primero?','Consejos para expandir significados','¬øC√≥mo crear prefijos/sufijos?','Mi palabra viola las reglas fonol√≥gicas'],
      responses:{
        'primero|empezar':'üå± Las 10 primeras palabras m√°s √∫tiles:\n1.yo 2.t√∫ 3.ser 4.ir 5.comer 6.agua 7.fuego 8.grande 9.peque√±o 10.y',
        'expandir|derivar':'üîó ¬°Prefijos y sufijos!\nEj: sol ‚Üí sol-vel (brillar), sol-ael (solar), al-sol (oscuridad)',
        'prefijo|sufijo|terminaci√≥n':'‚ö° Sistema de afijos:\n-el=adjetivizar, -vel=verbalizar, -i=plural',
        'fonolog√≠a|regla|violaci√≥n':'üîç Violaci√≥n fonol√≥gica: verifica tu tab de fonolog√≠a.',
        default:'üìñ ¬°Preg√∫ntame sobre vocabulario!'
      }
    },
    corpus:{
      greeting:'üí¨ ¬°IA de Corpus! Te ayudo a crear oraciones de ejemplo.',
      suggestions:['¬øC√≥mo creo oraciones?','¬øC√≥mo escribo glosas?','Quiero oraciones para redes sociales','¬øPuedo escribir con pocas palabras?'],
      responses:{
        'c√≥mo|crear|empezar':'‚úçÔ∏è Pasos:\n1. Registra 3-5 sustantivos/verbos\n2. Clic en "Construir desde diccionario"\n3. Ordena y guarda!',
        'glosa|interlineal':'üìã Glosas (Leipzig):\nkali-el kaelo = agua-NOM cielo-ACC\nAbreviaturas: NOM, ACC, GEN, PL, PST',
        'redes|compartir':'‚ú® Tips: Cortas (3-6 palabras), con glosas para autenticidad.',
        'pocas.palabras':'üå± ¬°Empieza con 5 (2 sust., 2 verbos, 1 adj.)!',
        default:'üí¨ ¬°Preg√∫ntame sobre oraciones!'
      }
    },
    script:{
      greeting:'‚úçÔ∏è ¬°IA de Escritura! Te ayudo a elegir letras y s√≠mbolos.',
      suggestions:['¬øQu√© sistema de escritura uso?','Consejos para caracteres originales','¬øQu√© s√≠mbolos recomiendas?','¬øPuedo combinar escrituras?'],
      responses:{
        'cu√°l|recomendar|principiante':'‚úçÔ∏è Sistemas de escritura:\nüî§ **Latino**: M√°s flexible\nüî∫ **R√∫nico**: Misterioso\nüîµ **Griego**: Intelectual',
        'original|propio|crear':'üé® Script propio: Define grupos de sonidos, formas similares, ¬°simplicidad!',
        's√≠mbolo|unicode':'üî° S√≠mbolos: R√∫nico ·ö† ·ö¢ ·ö¶ / Griego Œ± Œ≤ Œ≥',
        'combinar|mezclar':'‚úÖ ¬°Mezclar est√° bien! Solo mant√©n reglas consistentes.',
        default:'‚úçÔ∏è ¬°Preg√∫ntame sobre escritura!'
      }
    }
  }
};
return ctx[lang]||ctx.en;
}

// Conversation history per editor
const AI_HISTORY = {};

function getAIContext(type){const c=getAI_CONTEXTS();return c[type]||c.vocab}

function aiMatchResponse(type, text){
  const ctx=getAIContext(type);
  const t=text.toLowerCase();
  for(const [pat,res] of Object.entries(ctx.responses)){
    if(pat==='default')continue;
    if(pat.split('|').some(p=>t.includes(p)))return res;
  }
  return ctx.responses.default;
}

function sendAIMessage(type){
  const inp=document.getElementById(`ai-inp-${type}`);
  if(!inp||!inp.value.trim())return;
  const msg=inp.value.trim();
  inp.value='';
  appendAIBubble(type,'user',msg);
  appendAIBubble(type,'bot',`<span class="spinning">‚ü≥</span> ${t('ai_thinking')}`,true);
  setTimeout(()=>{
    const res=aiMatchResponse(type,msg);
    replaceLastBotBubble(type,res);
    // Store history
    if(!AI_HISTORY[type])AI_HISTORY[type]=[];
    AI_HISTORY[type].push({u:msg,b:res});
  },700+Math.random()*500);
}

function sendAISuggestion(type,text){
  const inp=document.getElementById(`ai-inp-${type}`);
  if(inp)inp.value=text;
  sendAIMessage(type);
}

function appendAIBubble(type,role,html,thinking=false){
  const wrap=document.getElementById(`ai-chat-${type}`);
  if(!wrap)return;
  const div=document.createElement('div');
  div.className=`ai-bubble ${role}${thinking?' thinking':''}`;
  div.innerHTML=html.replace(/\n/g,'<br>').replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  if(thinking)div.dataset.thinking='1';
  wrap.appendChild(div);
  wrap.scrollTop=wrap.scrollHeight;
}

function replaceLastBotBubble(type,html){
  const wrap=document.getElementById(`ai-chat-${type}`);
  if(!wrap)return;
  const bubbles=[...wrap.querySelectorAll('.ai-bubble.bot')];
  const last=bubbles.find(b=>b.dataset.thinking==='1');
  if(last){
    delete last.dataset.thinking;
    last.classList.remove('thinking');
    last.innerHTML=html.replace(/\n/g,'<br>').replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
    wrap.scrollTop=wrap.scrollHeight;
  }
}

function buildAssistPanel(type){
  const ctx=getAIContext(type);
  const history=AI_HISTORY[type]||[];
  const histHtml=history.length
    ?history.map(h=>`<div class="ai-bubble user">${h.u}</div><div class="ai-bubble bot">${h.b.replace(/\n/g,'<br>').replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')}</div>`).join('')
    :`<div class="ai-bubble bot">${ctx.greeting}</div>`;
  const chips=ctx.suggestions.map(s=>`<div class="ai-suggest-chip" onclick="sendAISuggestion('${type}','${s.replace(/'/g,"\\'")}')">üí¨ ${s}</div>`).join('');
  return`
  <div class="assist-panel open" id="assist-panel-${type}">
    <div class="assist-panel-header" onclick="toggleAssist('${type}')">
      <div class="assist-dot"></div>
      <span class="assist-title">${t("ai_assist_title")}</span>
      <span class="assist-panel-toggle">‚ñæ</span>
    </div>
    <div class="assist-panel-body">
      <div class="ai-chat-wrap" id="ai-chat-${type}">${histHtml}</div>
      <div class="ai-suggest-chips" style="margin-bottom:8px">${chips}</div>
      <div class="ai-assist-bar" style="position:static;margin:0;padding:0;background:transparent;border:none">
        <div class="ai-assist-input-wrap">
          <span class="ai-assist-icon">‚ú¶</span>
          <input class="ai-assist-input" id="ai-inp-${type}" placeholder="${t('ai_assist_placeholder')}"
            onkeydown="if(event.key==='Enter')sendAIMessage('${type}')">
          <button class="ai-assist-send" onclick="sendAIMessage('${type}')">‚Üí</button>
        </div>
      </div>
    </div>
  </div>`;
}

function toggleAssist(type){
  const panel=document.getElementById(`assist-panel-${type}`);
  if(panel)panel.classList.toggle('open');
}

// ===== V6: EXTENDED CHARACTER PICKER =====
const CHAR_SETS = {
  '„É©„ÉÜ„É≥Êã°Âºµ': {
    'Áô∫Èü≥Ë®òÂè∑‰ªò„Åç': '√† √° √¢ √£ √§ √• √¶ √ß √® √© √™ √´ √¨ √≠ √Æ √Ø √∞ √± √≤ √≥ √¥ √µ √∂ √∏ √π √∫ √ª √º √Ω √æ √ø ƒÅ ƒÉ ƒÖ ƒá ƒâ ƒã ƒç ƒè ƒë ƒì ƒï ƒó ƒô ƒõ ƒù ƒü ƒ° ƒ£ ƒ• ƒß ƒ´ ƒ≠ ƒØ ƒ≥ ƒµ ƒ∑ ƒ∫ ƒº ƒæ ≈Ä ≈Ç ≈Ñ ≈Ü ≈à ≈ã ≈ç ≈è ≈ë ≈ì ≈ï ≈ó ≈ô ≈õ ≈ù ≈ü ≈° ≈£ ≈• ≈ß ≈´ ≈≠ ≈Ø ≈± ≈≥ ≈µ ≈∑ ≈∫ ≈º ≈æ'.split(' '),
    'Â£∞Ë™ø‰ªò„Åç': 'ƒÅ √° «é √† ƒÅÃå ƒì √© ƒõ √® ƒ´ √≠ «ê √¨ ≈ç √≥ «í √≤ ≈´ √∫ «î √π «ñ «ò «ö «ú'.split(' '),
    'ÁâπÊÆä„É©„ÉÜ„É≥': '…ê …ë …í …ì …î …ï …ñ …ó …ò …ô …ö …õ …ú …ù …û …ü …† …° …¢ …£ …§ …• …¶ …ß …® …© …™ …´ …¨ …≠ …Æ …Ø …∞ …± …≤ …≥ …¥ …µ …∂ …∑ …∏ …π …∫ …ª …º …Ω …æ …ø'.split(' '),
  },
  '„ÇÆ„É™„Ç∑„É£„Éª„Ç≥„Éó„Éà': {
    'Â§ßÊñáÂ≠ó': 'Œë Œí Œì Œî Œï Œñ Œó Œò Œô Œö Œõ Œú Œù Œû Œü Œ† Œ° Œ£ Œ§ Œ• Œ¶ Œß Œ® Œ©'.split(' '),
    'Â∞èÊñáÂ≠ó': 'Œ± Œ≤ Œ≥ Œ¥ Œµ Œ∂ Œ∑ Œ∏ Œπ Œ∫ Œª Œº ŒΩ Œæ Œø œÄ œÅ œÉ œÑ œÖ œÜ œá œà œâ œÇ œê œë œí œï œñ'.split(' '),
    '„Ç≥„Éó„Éà„ÉªÂè§‰ª£': 'œó œò œô œö œõ œú œù œû œü œ† œ° œ∞ œ± œ≤ œ≥ œ¥ œµ œ∂'.split(' '),
  },
  '„Ç≠„É™„É´„ÉªÊù±Ê¨ß': {
    'Âü∫Êú¨': '–ê –ë –í –ì –î –ï –ñ –ó –ò –ô –ö –õ –ú –ù –û –ü –† –° –¢ –£ –§ –• –¶ –ß –® –© –™ –´ –¨ –≠ –Æ –Ø'.split(' '),
    'Â∞èÊñáÂ≠ó': '–∞ –± –≤ –≥ –¥ –µ –∂ –∑ –∏ –π –∫ –ª –º –Ω –æ –ø —Ä —Å —Ç —É —Ñ —Ö —Ü —á —à —â —ä —ã —å —ç —é —è'.split(' '),
    'Êã°Âºµ': '–Ä –Å –Ç –É –Ñ –Ö –Ü –á –à –â –ä –ã –å –ç –é –è —ê —ë —í —ì —î —ï —ñ —ó —ò —ô —ö —õ —ú —ù —û —ü —† —° —¢ —£ —§ —•'.split(' '),
  },
  '„É´„Éº„É≥„ÉªÂè§‰ª£': {
    'Âè§„Éï„Çµ„É´„ÇØ': '·ö† ·ö° ·ö¢ ·ö£ ·ö§ ·ö• ·ö¶ ·öß ·ö® ·ö© ·ö™ ·ö´ ·ö¨ ·ö≠ ·öÆ ·öØ ·ö∞ ·ö± ·ö≤ ·ö≥ ·ö¥ ·öµ ·ö∂ ·ö∑ ·ö∏ ·öπ ·ö∫ ·öª ·öº ·öΩ ·öæ ·öø ·õÄ'.split(' '),
    'Êñ∞„Éï„Çµ„É´„ÇØ': '·õÅ ·õÇ ·õÉ ·õÑ ·õÖ ·õÜ ·õá ·õà ·õâ ·õä ·õã ·õå ·õç ·õé ·õè ·õê ·õë ·õí ·õì ·õî ·õï ·õñ ·õó ·õò ·õô ·õö ·õõ ·õú ·õù ·õû ·õü ·õ† ·õ° ·õ¢ ·õ£ ·õ§ ·õ• ·õ¶ ·õß ·õ® ·õ© ·õ™'.split(' '),
    '„Ç¥„Éº„ÉàÊñáÂ≠ó': 'êå∞ êå± êå≤ êå≥ êå¥ êåµ êå∂ êå∑ êå∏ êåπ êå∫ êåª êåº êåΩ êåæ êåø êçÄ êçÅ êçÇ êçÉ êçÑ êçÖ êçÜ êçá êçà êçâ'.split(' '),
  },
  '„Ç¢„É©„Éì„Ç¢„Éª„Éò„Éñ„É©„Ç§': {
    '„Ç¢„É©„Éì„Ç¢': 'ÿß ÿ® ÿ™ ÿ´ ÿ¨ ÿ≠ ÿÆ ÿØ ÿ∞ ÿ± ÿ≤ ÿ≥ ÿ¥ ÿµ ÿ∂ ÿ∑ ÿ∏ ÿπ ÿ∫ ŸÅ ŸÇ ŸÉ ŸÑ ŸÖ ŸÜ Ÿá Ÿà Ÿä'.split(' '),
    '„Éò„Éñ„É©„Ç§': '◊ê ◊ë ◊í ◊ì ◊î ◊ï ◊ñ ◊ó ◊ò ◊ô ◊õ ◊ú ◊û ◊† ◊° ◊¢ ◊§ ◊¶ ◊ß ◊® ◊© ◊™'.split(' '),
    '„Ç®„ÉÅ„Ç™„Éî„Ç¢Ôºà„Ç≤„Ç®„Ç∫Ôºâ': '·àÄ ·àÅ ·àÇ ·àÉ ·àÑ ·àÖ ·àÜ ·àà ·àâ ·àä ·àã ·àå ·àç ·àé ·àê ·àë ·àí ·àì ·àî ·àï ·àñ ·àò ·àô ·àö ·àõ ·àú ·àù ·àû ·à† ·à° ·à¢ ·à£ ·à§ ·à• ·à¶ ·à® ·à© ·à™ ·à´ ·à¨ ·à≠ ·àÆ'.split(' '),
  },
  '„Ç¢„Ç∏„Ç¢ÊñáÂ≠ó': {
    '„Éá„Éº„É¥„Ç°„Éä„Éº„Ç¨„É™„Éº': '‡§Ö ‡§Ü ‡§á ‡§à ‡§â ‡§ä ‡§è ‡§ê ‡§ì ‡§î ‡§ï ‡§ñ ‡§ó ‡§ò ‡§ô ‡§ö ‡§õ ‡§ú ‡§ù ‡§û ‡§ü ‡§† ‡§° ‡§¢ ‡§£ ‡§§ ‡§• ‡§¶ ‡§ß ‡§® ‡§™ ‡§´ ‡§¨ ‡§≠ ‡§Æ ‡§Ø ‡§∞ ‡§≤ ‡§µ ‡§∂ ‡§∑ ‡§∏ ‡§π'.split(' '),
    '„Çø„Ç§': '‡∏Å ‡∏Ç ‡∏É ‡∏Ñ ‡∏Ö ‡∏Ü ‡∏á ‡∏à ‡∏â ‡∏ä ‡∏ã ‡∏å ‡∏ç ‡∏é ‡∏è ‡∏ê ‡∏ë ‡∏í ‡∏ì ‡∏î ‡∏ï ‡∏ñ ‡∏ó ‡∏ò ‡∏ô ‡∏ö ‡∏õ ‡∏ú ‡∏ù ‡∏û ‡∏ü ‡∏† ‡∏° ‡∏¢ ‡∏£ ‡∏• ‡∏ß ‡∏® ‡∏© ‡∏™ ‡∏´ ‡∏¨ ‡∏≠ ‡∏Æ'.split(' '),
    '„Ç´„Çø„Ç´„ÉäÔºàË®òÂè∑ÁöÑ„Å´Ôºâ': '„Ç¢ „Ç§ „Ç¶ „Ç® „Ç™ „Ç´ „Ç≠ „ÇØ „Ç± „Ç≥ „Çµ „Ç∑ „Çπ „Çª „ÇΩ „Çø „ÉÅ „ÉÑ „ÉÜ „Éà „Éä „Éã „Éå „Éç „Éé „Éè „Éí „Éï „Éò „Éõ „Éû „Éü „É† „É° „É¢ „É§ „É¶ „É® „É© „É™ „É´ „É¨ „É≠ „ÉØ „É≤ „É≥'.split(' '),
  },
  'Ë®òÂè∑„ÉªÂπæ‰ΩïÂ≠¶': {
    'Âπæ‰ΩïÂ≠¶ÂΩ¢Áä∂': '‚óè ‚óã ‚óâ ‚óé ‚ñ≤ ‚ñ≥ ‚ñº ‚ñΩ ‚ñ† ‚ñ° ‚óÜ ‚óá ‚òÖ ‚òÜ ‚ú¶ ‚úß ‚ú™ ‚ú´ ‚ú¨ ‚ú≠ ‚úÆ ‚úØ ‚ú∞ ‚ú± ‚ú≤ ‚ú≥ ‚ú¥ ‚úµ ‚ú∂ ‚ú∑ ‚ú∏ ‚úπ ‚ú∫ ‚úª ‚úº ‚úΩ ‚úæ ‚úø'.split(' '),
    'Áü¢Âç∞„ÉªË®òÂè∑': '‚Üê ‚Üí ‚Üë ‚Üì ‚Üî ‚Üï ‚Üñ ‚Üó ‚Üò ‚Üô ‚áê ‚áí ‚áë ‚áì ‚áî ‚áï ‚üµ ‚ü∂ ‚ü∑ ‚§¥ ‚§µ ‚àû ‚àë ‚àè ‚àö ‚àÇ ‚àÜ ‚àá ‚àà ‚àâ ‚àä ‚àã ‚àå ‚àç'.split(' '),
    'Ë£ÖÈ£æË®òÂè∑': '‚òØ ‚òÆ ‚òº ‚òΩ ‚òæ ‚ô¶ ‚ô• ‚ô† ‚ô£ ‚öú ‚öù ‚ö° ‚ö´ ‚ö¨ ‚ö≠ ‚öÆ ‚öØ ‚ö∞ ‚ö± ‚õÜ ‚õá ‚õà ‚ú† ‚ú° ‚ú¢ ‚ú£ ‚ú§ ‚ú•'.split(' '),
    'Êï∞Â≠¶„ÉªË´ñÁêÜ': '‚àÄ ‚àÉ ‚àÑ ‚àÖ ‚àá ‚àà ‚àâ ‚àã ‚àå ‚àò ‚àô ‚àù ‚àû ‚àü ‚à† ‚à° ‚à¢ ‚à£ ‚à§ ‚à• ‚à¶ ‚àß ‚à® ‚à© ‚à™ ‚à´ ‚à¨ ‚à≠ ‚àÆ ‚àØ ‚à∞'.split(' '),
  },
  '‰∏≠‰∏ñ„ÉªÁ•ûÁßò': {
    'Èå¨ÈáëË°ìË®òÂè∑': 'üúÄ üúÅ üúÇ üúÉ üúÑ üúÖ üúÜ üúá üúà üúâ üúä üúã üúå üúç üúé üúè üúê üúë üúí üúì üúî üúï üúñ üúó üúò üúô üúö üúõ üúú üúù üúû üúü'.split(' '),
    'Âç†ÊòüË°ìË®òÂè∑': '‚òâ ‚òΩ ‚òø ‚ôÄ ‚ôÅ ‚ôÇ ‚ôÉ ‚ôÑ ‚ôÖ ‚ôÜ ‚ôá ‚õ¢ ‚ö≥ ‚ö¥ ‚öµ ‚ö∂ ‚ö∑ ‚ö∏ ‚öπ ‚ö∫ ‚öª ‚öº ‚òä ‚òã ‚òå ‚òç'.split(' '),
    'Âè§‰ª£ÊñáÂ≠óÈ¢®': 'Íú∞ Íú± Íú≥ Íúµ Íú∑ Íúπ Íúª ÍúΩ Íúø ÍùÅ ÍùÉ ÍùÖ Íùá Íùâ Íùã Íùç Íùè Íùë Íùì Íùï Íùó Íùô Íùõ Íùù Íùü Íù° Íù£ Íù• Íùß Íù© Íù´ Íù≠ ÍùØ'.split(' '),
  },
  'Êù±„Ç¢„Ç∏„Ç¢Ë®òÂè∑': {
    'ÈÉ®È¶ñÔºàÊº¢Â≠óÈÉ®ÂìÅÔºâ': '‰∏Ä ‰∏® ‰∏∂ ‰∏ø ‰πô ‰∫Ö ‰∫å ‰∫† ‰∫∫ ÂÑø ÂÖ• ÂÖ´ ÂÜÇ ÂÜñ ÂÜ´ Âá† Âáµ ÂàÄ Âäõ Âã§ Âãã Âãå Âãç Âãé Âãè Âãê Âãë'.split(' '),
    'Êº¢Â≠óÊï∞Â≠ó„ÉªË®òÂè∑': '„Äá ‰∏Ä ‰∫å ‰∏â Âõõ ‰∫î ÂÖ≠ ‰∏É ÂÖ´ ‰πù ÂçÅ Áôæ ÂçÉ ‰∏á ÂÑÑ ÂÖÜ ‰∫¨ Â£± Âºê ÂèÇ Êãæ Èôå ‰ªü Ëê¨'.split(' '),
    'ÂíåÈ¢®Ë®òÂè∑': '„ÄÜ „Äí „Äì „Äî „Äï „Äñ „Äó „Äò „Äô „Äö „Äõ „Äú „Äù „Äû „Äü „Ä† „Ä° „Ä¢ „Ä£ „Ä§ „Ä• „Ä¶ „Äß „Ä® „Ä© „Ä™ „Ä´ „Ä¨ „Ä≠ „ÄÆ „ÄØ „Ä∞ „Ä± „Ä≤ „Ä≥ „Ä¥ „Äµ „Ä∂ „Ä∑ „Ä∏ „Äπ „Ä∫ „Äª „Äº „ÄΩ „Äæ „Äø'.split(' '),
  },
  '„Éï„Ç©„Éã„ÉÉ„ÇØ„ÇπÊã°Âºµ': {
    'ËøΩÂä†ÊØçÈü≥': '…ê …ë …í …î …ï …ò …ô …ö …õ …ú …ù …û …§ …® …© …™ …´ …µ …∂ …∑'.split(' '),
    'ËøΩÂä†Â≠êÈü≥': '…ì …ñ …ó …† …° …¢ …£ …• …¶ …ß …¨ …≠ …Æ …Ø …∞ …± …≤ …≥ …¥ …∏ …π …∫ …ª …º …Ω …æ …ø  Ä  Å  Ç  É  Ñ  Ö  Ü  á  à  â  ä  ã  å  ç  é  è  ê  ë  í  ì  î  ï  ñ  ó  ò  ô  ö  õ  ú  ù  û  ü  †'.split(' '),
    '„ÇØ„É™„ÉÉ„ÇØ„ÉªÁâπÊÆä': '«Ä «Å «Ç «É  ò «Ü «á «à «â «ä «ã «å «ç «é «è «ê «ë «í «ì «î «ï «ñ «ó «ò «ô «ö «õ «ú «ù «û «ü «† «° «¢ «£'.split(' '),
  }
};

function buildCharPicker(targetId){
  const cats=Object.keys(CHAR_SETS);
  const tabsHtml=cats.map((c,i)=>`<div class="char-tab ${i===0?'active':''}" onclick="switchCharTab(this,'ctab-${i}-${targetId}')">${c}</div>`).join('');
  const contentsHtml=cats.map((cat,i)=>{
    const groups=CHAR_SETS[cat];
    const groupsHtml=Object.entries(groups).map(([label,chars])=>`
      <div class="char-category">
        <span class="char-cat-label">${label}</span>
        <div class="char-grid">${chars.map(c=>`<button class="char-btn" onclick="insertCharAt(document.getElementById('${targetId}'),'${c.replace(/'/g,"\\'")}');event.preventDefault()" title="${c}">${c}</button>`).join('')}</div>
      </div>`).join('');
    return`<div class="char-tab-content ${i===0?'active':''}" id="ctab-${i}-${targetId}">${groupsHtml}</div>`;
  }).join('');
  return`<div style="border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-top:8px">
    <div style="padding:8px 12px;background:var(--surface-3);border-bottom:1px solid var(--border)">
      <span style="font-size:0.68rem;color:var(--accent);font-weight:700;letter-spacing:0.1em;text-transform:uppercase">üåê ‰∏ñÁïå„ÅÆÊñáÂ≠ó„ÉªË®òÂè∑„Éî„ÉÉ„Ç´„Éº</span>
    </div>
    <div style="padding:10px 12px;max-height:280px;overflow-y:auto">
      <div class="char-picker-tabs">${tabsHtml}</div>
      ${contentsHtml}
    </div>
  </div>`;
}

function switchCharTab(el,id){
  const wrap=el.closest('div');
  wrap.querySelectorAll('.char-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  // find container
  const container=el.closest('[style]');
  if(container){container.querySelectorAll('.char-tab-content').forEach(t=>t.classList.remove('active'));const t=document.getElementById(id);if(t)t.classList.add('active')}
}

// ==== V7: WELCOME SCREEN ====
let _wSelectedVibes = [];
function toggleWVibe(el, label) {
  if (_wSelectedVibes.includes(label)) {
    _wSelectedVibes = _wSelectedVibes.filter(v => v !== label);
    el.classList.remove('selected');
  } else {
    _wSelectedVibes.push(label);
    el.classList.add('selected');
  }
}
function wCheckReady() {
  const btn = document.getElementById('w-start-btn');
  const val = (document.getElementById('w-langname')?.value || '').trim();
  if (btn) btn.style.opacity = val ? '1' : '0.7';
}
function toggleGuestForm() {
  const form = document.getElementById('guest-form');
  const loginBtn = document.getElementById('google-login-btn');
  const guestBtn = document.querySelector('.login-guest-btn');
  const features = document.querySelector('.login-features');
  const divider = document.querySelector('.login-divider');
  
  if (form.style.display === 'none') {
    form.style.display = 'block';
    if(loginBtn) loginBtn.style.display = 'none';
    if(guestBtn) guestBtn.textContent = '‚Üê Google„É≠„Ç∞„Ç§„É≥„Å´Êàª„Çã';
    if(features) features.style.display = 'none';
    if(divider) divider.style.display = 'none';
  } else {
    form.style.display = 'none';
    if(loginBtn) loginBtn.style.display = 'flex';
    if(guestBtn) guestBtn.setAttribute('data-i18n', 'w_guest_start');
    if(features) features.style.display = 'flex';
    if(divider) divider.style.display = 'flex';
    applyI18n();
  }
}
function wStart(skip = false) {
  const nameEl = document.getElementById('w-langname');
  const name = skip ? '' : (nameEl?.value.trim() || '');
  S.langName = name || t('w_unnamed');
  S.vibe = [..._wSelectedVibes];
  enterDashboard();
}
function wRestore() {
  loadState();
  enterDashboard();
}

// ==== V7: AUTO-SAVE ====
const SAVE_KEY = 'lingua_v13_state';
let _saveTimer = null;
let _lastSaved = 0;

// ===== V10: Storage helpers =====
// NOTE: localStorage limit ~5MB. If data grows large (1000+ words, many corpus entries),
// consider migrating to IndexedDB (see indexedDB API). For now we warn the user at 80% capacity.
const STORAGE_WARN_BYTES = 4 * 1024 * 1024; // 4MB warning threshold

function saveState() {
  try {
    const snap = JSON.stringify(S);
    // Size check
    const bytes = new Blob([snap]).size;
    console.log('üíæ Saving state:', (bytes/1024).toFixed(1) + 'KB');
    if (bytes > STORAGE_WARN_BYTES) {
      showAutosave(`${t('storage_warn')} (${(bytes/1024).toFixed(0)}KB)`);
    }
    localStorage.setItem(SAVE_KEY, snap);
    _lastSaved = Date.now();
    console.log('‚úÖ State saved successfully');
    if (bytes <= STORAGE_WARN_BYTES) showAutosave(t('storage_ok'));
  } catch(e) {
    console.error('‚ùå Save failed:', e);
    if (e.name === 'QuotaExceededError') {
      showAutosave(t('storage_full'));
    } else {
      console.error('saveState error:', e);
    }
  }
}
function loadState() {
  try {
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw) return false;
    const parsed = JSON.parse(raw);
    // Merge into S (keep structure safe)
    Object.keys(parsed).forEach(k => { if (k in S) S[k] = parsed[k]; });
    return true;
  } catch(e) { return false; }
}
function showAutosave(msg) {
  const el = document.getElementById('autosave-indicator');
  const txt = document.getElementById('autosave-text');
  if (!el) return;
  txt.textContent = msg || t('autosave_saved');
  el.classList.add('show');
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(() => el.classList.remove('show'), 2500);
}
function scheduleSave() {
  // Debounce: only save 500ms after the last change ‚Äî prevents expensive
  // JSON.stringify on every keystroke
  clearTimeout(window._debounceSave);
  window._debounceSave = setTimeout(() => {
    saveState();
    // üîí Pro „É¶„Éº„Ç∂„Éº„ÅÆ„Åø„ÇØ„É©„Ç¶„ÉâÂêåÊúü
    if(_authUser?.uid && _isPro) {
      scheduleFirestoreSave();
    }
  }, 500);
}
// Proxy S to auto-save on change (lightweight)
function wrapStateProxy() {
  const handler = {
    set(obj, prop, val) {
      obj[prop] = val;
      scheduleSave();
      return true;
    },
    get(obj, prop) {
      const val = obj[prop];
      if (val && typeof val === 'object' && !Array.isArray(val) && prop !== '__proto__') {
        return new Proxy(val, handler);
      }
      return val;
    }
  };
  // We patch the save hook into key mutating functions instead (Proxy has edge cases)
}

// ==== NAV ====
function goTo(id){
  window.scrollTo(0, 0); // Always scroll to top when changing pages
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const page=document.getElementById('page-'+id);
  if(page)page.classList.add('active');
  if(id==='dashboard')setNav('nav-dash');
  if(id==='library'){setNav('nav-library');renderLibrary();}
  if(id==='vocab'){setNav('nav-vocab');renderVocabPage();}
  if(id==='aichat'){
    setNav('nav-aichat');
    const nameEl=document.getElementById('aichat-lang-name');
    if(nameEl)nameEl.textContent=S.langName||'‚Äî';
  }
  if(id==='contact'){
    setNav('');
    // Pre-fill email if logged in
    const emailField = document.getElementById('contact-email');
    if(emailField && _authUser?.email) emailField.value = _authUser.email;
  }
  if(id==='memo'){
    setNav('');
    loadMemosFromDB(); // Load memos when entering memo page
  }
  // Show/hide vis indicator
  const visInd=document.getElementById('vis-indicator');
  if(visInd)visInd.style.display=(id==='dashboard'||id==='library'||id==='aichat'||id==='vocab')?'flex':'none';
  updateVisIndicator();
}
function setNav(id){document.querySelectorAll('.topbar-navbtn').forEach(b=>b.classList.remove('active'));const el=document.getElementById(id);if(el)el.classList.add('active')}
function setBNav(id){document.querySelectorAll('.bnav-btn').forEach(b=>b.classList.remove('active'));const el=document.getElementById(id);if(el)el.classList.add('active')}
// V10: mobile more menu
let _moreOpen=false;
function toggleMobileMore(){
  _moreOpen=!_moreOpen;
  const m=document.getElementById('mobile-more-menu');
  if(m)m.style.display=_moreOpen?'block':'none';
}
// close more menu when tapping outside
document.addEventListener('click',function(e){
  if(_moreOpen&&!e.target.closest('#mobile-more-menu')&&!e.target.closest('#bnav-more')){
    _moreOpen=false;
    const m=document.getElementById('mobile-more-menu');
    if(m)m.style.display='none';
  }
},{passive:true});
// doLogin kept for backward compat (no longer used)
function doLogin(){ wStart(); }

// ==== SETUP (kept for compat, no longer shown) ====
let setupStep=0;
function setupNext(n){if(n===1){const name=document.getElementById('setup-langname')?.value.trim();if(name)S.langName=name}}
function setupBack(n){}
function selectScript(el,key){document.querySelectorAll('.script-card').forEach(c=>c.classList.remove('selected'));el.classList.add('selected');S.script=key;scheduleSave()}
function selectRoute(el,key){S.route=key;if(key==='image'){enterDashboard();openEditor('vibe')}else enterDashboard()}
function enterDashboard(){
  // „Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„Çí„Éà„ÉÉ„Éó„Å´Âº∑Âà∂
  window.scrollTo(0, 0);
  
  document.getElementById('topbar-nav').style.display='flex';
  document.getElementById('topbar-user-area').style.display='flex';
  document.getElementById('topbar-login-btns').style.display='none';
  
  // „Éú„Éà„É†„Éä„Éì„ÇíË°®Á§∫
  const bottomNav = document.getElementById('bottom-nav');
  if(bottomNav) bottomNav.style.display='block';
  
  const langCur=document.getElementById('lang-cur');
  const LANG_SHORT_INIT={ja:'JA',en:'EN',zh:'‰∏≠Êñá',es:'ES'};
  if(langCur)langCur.textContent=LANG_SHORT_INIT[S.lang]||S.lang.toUpperCase();
  const visInd=document.getElementById('vis-indicator');
  if(visInd)visInd.style.display='flex';
  updateVisIndicator();
  
  // Á¢∫ÂÆü„Å´„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Éö„Éº„Ç∏„Å´ÁßªÂãï
  goTo('dashboard');
  setNav('nav-dash');
  setBNav('bnav-dash');
  updateDashboard();
  
  // 1Êó•1Êñá„Å®Êó•‰ªò„ÇíÁ¢∫ÂÆü„Å´Ë®≠ÂÆö
  setTimeout(()=>{
    const today=new Date();
    const dateEl=document.getElementById('daily-date');
    const sentEl=document.getElementById('daily-sentence');
    if(dateEl){
      try{dateEl.textContent=today.toLocaleDateString('ja-JP',{month:'long',day:'numeric'});}catch(e){}
    }
    if(sentEl){
      // S.lang„ÅåÊú™ÂàùÊúüÂåñ„ÅÆÂ†¥Âêà„ÅØja„Çí„Éá„Éï„Ç©„É´„Éà„Å´
      const lang = S.lang || 'ja';
      const sentences=DAILY_SENTENCES_MAP[lang]||DAILY_SENTENCES_MAP.ja;
      if(sentences&&sentences.length){
        sentEl.textContent=sentences[today.getDate()%sentences.length];
        console.log('‚úÖ Daily sentence set:', sentEl.textContent);
      } else {
        console.warn('‚ö†Ô∏è No daily sentences found for language:', lang);
        sentEl.textContent='‰ªäÊó•„ÅØÁ©∫„ÅåÈùí„ÅÑ'; // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
      }
    } else {
      console.error('‚ùå daily-sentence element not found');
    }
  },100);
  
  saveState();
  
  setTimeout(()=>{
    if(typeof initQuests==='function')initQuests();
  },500);
}
function editLangName(){const name=prompt(t('prompt_rename'),S.langName);if(name&&name.trim()){S.langName=name.trim();updateDashboard();scheduleSave();}}
function resetConfirm(){if(!confirm(t('confirm_reset')))return;try{localStorage.removeItem('lingua_v13_state');}catch(e){}location.reload();}

// ==== DAILY ====
function initDaily(){
  const today=new Date();
  const el=document.getElementById('daily-sentence');
  const dateEl=document.getElementById('daily-date');
  
  if(dateEl) {
    try {
      dateEl.textContent=today.toLocaleDateString(t('daily_date_locale'),{month:'long',day:'numeric'});
    } catch(e) {
      dateEl.textContent=today.toLocaleDateString('ja-JP',{month:'long',day:'numeric'});
    }
  }
  
  if(el){
    const sentences=getDailySentences();
    if(sentences&&sentences.length) {
      el.textContent=sentences[today.getDate()%sentences.length];
    } else {
      el.textContent='‚Äî';
    }
  }
}
function submitDaily(){const val=document.getElementById('daily-input').value.trim();if(!val)return;S.sentences.push(val);S.done.sentence=true;updateDashboard();checkGrammar(val)}
function checkGrammar(text){if(!text||!text.trim())return;const fb=document.getElementById('daily-feedback');if(!fb)return;fb.innerHTML=`<div class="ai-box"><div class="ai-label">‚ú¶ ${t('gc_checking')}</div><div class="ai-content"><span class="spinning">‚ü≥</span></div></div>`;setTimeout(()=>{const issues=[];text.toLowerCase().split(/\s+/).forEach(w=>{if(!S.dictionary.find(d=>d.conlang.toLowerCase()===w)&&w.length>2)issues.push(`"${w}" ${t('gc_unknown')}`)});if(!issues.length)fb.innerHTML=`<div class="ai-box" style="border-color:var(--success-border);background:var(--success-dim)"><div class="ai-label" style="color:var(--success)">${t('gc_ok')}</div><div class="ai-content">${t('gc_ok_msg')}</div></div>`;else fb.innerHTML=`<div class="correction-box"><div class="correction-label">${t('gc_warn')}</div>${issues.map(i=>`<div class="correction-item">„Éª${i}</div>`).join('')}</div>`;},900)}

// ==== DASHBOARD UPDATE ====
function updateDashboard(){
  document.getElementById('dash-langname').textContent=S.langName;
  document.getElementById('topbar-langname').textContent=S.langName;
  
  // 1Êó•1Êñá„ÇíÁõ¥Êé•Ë®≠ÂÆöÔºàÁ¢∫ÂÆü„Å´Âãï‰Ωú„Åô„Çã„Çà„ÅÜ„Å´Ôºâ
  const dailyEl=document.getElementById('daily-sentence');
  if(dailyEl){
    const today=new Date();
    const lang = S.lang || 'ja';
    const sentences=DAILY_SENTENCES_MAP[lang]||DAILY_SENTENCES_MAP.en||DAILY_SENTENCES_MAP.ja;
    if(sentences&&sentences.length){
      dailyEl.textContent=sentences[today.getDate()%sentences.length];
    } else {
      dailyEl.textContent='‰ªäÊó•„ÅØÁ©∫„ÅåÈùí„ÅÑ'; // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
    }
  }
  
  document.getElementById('meta-script').textContent=t('script_label')+': '+(scriptLabels[S.script]||S.script);
  document.getElementById('meta-route').textContent=S.route==='image'?t('route_image'):t('route_custom');
  document.getElementById('stat-words').textContent=S.dictionary.length;
  document.getElementById('stat-patterns').textContent=S.grammar.patterns.length;
  document.getElementById('stat-corpus').textContent=S.corpus.length;
  const doneCount=Object.values(S.done).filter(Boolean).length,total=6;
  document.getElementById('stat-done').textContent=doneCount+'/'+total;
  const pct=Math.round(doneCount/total*100);
  document.getElementById('dash-pct').textContent=pct+'%';
  const circ=2*Math.PI*36;
  document.getElementById('progress-arc').style.strokeDashoffset=circ-(pct/100)*circ;
  updateCardState('vibe',S.done.vibe,S.vibe.length?S.vibe.map(v=>`<span class="preview-chip accent">${v}</span>`).join(''):null);
  updateCardState('script',S.done.script,Object.keys(S.scriptMap).length?Object.entries(S.scriptMap).slice(0,6).map(([k,v])=>`<span class="preview-chip accent">${k}‚Üí${v}</span>`).join(''):null);
  updateCardState('phoneme',S.done.phoneme,S.phoneme.vowels.length?[...S.phoneme.vowels.slice(0,5),...S.phoneme.consonants.slice(0,4)].map(p=>`<span class="preview-chip accent">${p}</span>`).join(''):null);
  updateCardState('grammar',S.done.grammar,S.grammar.order?`<span class="preview-chip accent">${S.grammar.order}</span><span class="preview-chip">${S.grammar.cases}</span><span class="preview-chip">${S.grammar.patterns.length} ${t('dash_patterns')}</span>`:null);
  updateCardState('vocab',S.done.vocab,S.dictionary.length?S.dictionary.slice(0,4).map(w=>`<span class="preview-chip">${w.conlang}</span>`).join('')+(S.dictionary.length>4?`<span class="preview-chip">+${S.dictionary.length-4}</span>`:''):null);
  updateCardState('corpus',S.done.corpus,S.corpus.length?`<span class="preview-chip">${S.corpus[S.corpus.length-1].conlang.slice(0,18)}‚Ä¶</span>`:null);
  // V9: update vis chip in dash
  const visChip=document.getElementById('dash-vis-chip');
  if(visChip){
    const icons={private:'üîí',unlisted:'üîó',public:'üåø'};
    const labels={private:'ÈùûÂÖ¨Èñã',unlisted:'ÈôêÂÆöÂÖ¨Èñã',public:'ÂÖ¨Èñã‰∏≠'};
    visChip.textContent=(icons[S.visibility]||'üîí')+' '+(labels[S.visibility]||labels.private);
    visChip.style.color=S.visibility==='public'?'var(--success)':S.visibility==='unlisted'?'var(--gold)':'var(--text-muted)';
  }
  updateVisIndicator();
  
  // V21: „ÇØ„Ç®„Çπ„ÉàÊõ¥Êñ∞
  if(typeof updateQuestDisplay==='function')updateQuestDisplay();
}
function updateCardState(key,isDone,html){const card=document.getElementById('card-'+key),prev=document.getElementById('preview-'+key);card.querySelectorAll('.module-badge').forEach(b=>b.remove());card.classList.remove('done','in-progress');if(isDone){card.classList.add('done');const b=document.createElement('div');b.className='module-badge badge-done';b.textContent='‚úì '+t('rm_done').replace('‚úÖ ','');card.appendChild(b)}else if(html){card.classList.add('in-progress');const b=document.createElement('div');b.className='module-badge badge-progress';b.textContent=t('card_editing')||'‚Ä¶';card.appendChild(b)}if(html)prev.innerHTML=html}

// ==== EDITOR ====
let currentEditor=null;
function getEditorTitles(){return {
  vibe:['‚ú¶ '+t('card_vibe_title'), S.lang==='ja'?'Ë®ÄË™û„ÅÆÈõ∞Âõ≤Ê∞ó„Çí‰ºù„Åà„Å¶Èü≥„ÉªÊñáÊ≥ï„ÅÆÊñπÂêëÊÄß„ÇíÊèêÊ°à„Åó„Å¶„ÇÇ„Çâ„ÅÑ„Åæ„Åô':S.lang==='zh'?'ÊèèËø∞ËØ≠Ë®ÄÊ∞õÂõ¥ÔºåËé∑ÂæóÈü≥ÈüµÂíåËØ≠Ê≥ïÊñπÂêëÁöÑÂª∫ËÆÆ':S.lang==='es'?'Describe el ambiente para obtener sugerencias de fonolog√≠a y gram√°tica':'Describe your language vibe to get sound and grammar suggestions'],
  script:['‚úç '+t('card_script_title'), S.lang==='ja'?'„Ç¢„É´„Éï„Ç°„Éô„ÉÉ„Éà„Å®Áã¨Ëá™ÊñáÂ≠ó„ÇíÂØæÂøú‰ªò„Åë„Å¶„É™„Ç¢„É´„Çø„Ç§„É†„Éó„É¨„Éì„É•„Éº':S.lang==='zh'?'Â∞ÜÂ≠óÊØç‰∏éËá™ÂÆö‰πâÂ≠óÁ¨¶ÂØπÂ∫îÔºåÂÆûÊó∂È¢ÑËßà':S.lang==='es'?'Asigna caracteres a letras con vista previa en tiempo real':'Map alphabets to custom characters with real-time preview'],
  phoneme:['üîä '+t('nav_phoneme'), S.lang==='ja'?'ÊØçÈü≥„ÉªÂ≠êÈü≥„ÉªÈü≥ÁØÄÊßãÈÄ†„ÇíË®≠ÂÆö„ÄÇ„Éï„É´IPA„ÉÅ„É£„Éº„Éà„Å®„Ç´„Çπ„Çø„É†„ÉÑ„Éº„É´„Éê„Éº‰ªò„Åç':S.lang==='zh'?'ËÆæÁΩÆÂÖÉÈü≥„ÄÅËæÖÈü≥ÂíåÈü≥ËäÇÁªìÊûÑÔºåÂê´ÂÆåÊï¥IPAÂõæË°®':S.lang==='es'?'Configura vocales, consonantes y s√≠labas. Incluye carta IPA completa':'Set vowels, consonants, and syllable structure. Full IPA chart included'],
  grammar:['‚öôÔ∏è '+t('card_grammar_title'), S.lang==='ja'?'Ë™ûÈ†Ü„ÉªÊ†º„ÉªÊôÇÂà∂„ÉªÊ¥ªÁî®„ÇíË®≠ÂÆö„ÄÇÊ†ºÂ§âÂåñË°®„ÇíËá™ÂãïÁîüÊàê„Åó„Åæ„Åô':S.lang==='zh'?'ËÆæÁΩÆËØ≠Â∫è„ÄÅÊ†º„ÄÅÊó∂ÊÄÅÂíåÂèò‰Ωç„ÄÇËá™Âä®ÁîüÊàêÂèòÊ†ºË°®':S.lang==='es'?'Configura orden, casos, tiempo y conjugaci√≥n. Genera tablas autom√°ticamente':'Set word order, cases, tense and conjugation. Auto-generates inflection tables'],
  vocab:['üìñ '+t('card_vocab_title'), S.lang==='ja'?'„Çø„Ç∞ÁÆ°ÁêÜ„ÉªÈü≥Èüª„Éê„É™„Éá„Éº„Ç∑„Éß„É≥„ÉªÈÄÜÂºï„ÅçÊ§úÁ¥¢„Éª„Ç¨„ÉÅ„É£ÁîüÊàê':S.lang==='zh'?'Ê†áÁ≠æÁÆ°ÁêÜ„ÄÅÈü≥Á≥ªÈ™åËØÅ„ÄÅÈÄÜÂêëÊü•Êâæ„ÄÅÈöèÊú∫ÁîüÊàê':S.lang==='es'?'Gesti√≥n de etiquetas, validaci√≥n fonol√≥gica, b√∫squeda inversa, generaci√≥n aleatoria':'Tag management, phonology validation, reverse lookup, gacha generation'],
  corpus:['üí¨ '+t('card_corpus_title'), S.lang==='ja'?'‰æãÊñá„Ç´„Éº„ÉâÔºà„Ç≥„É≥„É©„É≥„Ç∞„ÉªË™≠„Åø„ÉªÊó•Êú¨Ë™ûË®≥Ôºâ„ÇíËìÑÁ©ç„Åó„Å¶ÁîªÂÉè„Åß„Ç∑„Çß„Ç¢':S.lang==='zh'?'ÁßØÁ¥Ø‰æãÂè•Âç°ÁâáÔºàÂàõÈÄ†ËØ≠¬∑ËØªÈü≥¬∑ËØëÊñáÔºâÂπ∂ÁîüÊàêÂõæÁâáÂàÜ‰∫´':S.lang==='es'?'Acumula tarjetas de ejemplo y comp√°rtelas como imagen':'Build example sentence cards and share them as images'],
  daily:['‚ú¶ '+t('daily_label'), S.lang==='ja'?'ÊØéÊó•„É©„É≥„ÉÄ„É†„Å™Êñá„Çí„ÅÇ„Å™„Åü„ÅÆË®ÄË™û„ÅßÊõ∏„ÅÑ„Å¶„Åø„Çà„ÅÜ':S.lang==='zh'?'ÊØèÂ§©Áî®ÊÇ®ÁöÑËØ≠Ë®ÄÂÜô‰∏Ä‰∏™ÈöèÊú∫Âè•Â≠ê':S.lang==='es'?'Escribe una frase aleatoria cada d√≠a en tu conlang':'Write a random sentence in your language every day'],
};}
function openEditor(type){currentEditor=type;const[title,desc]=getEditorTitles()[type]||[type,''];document.getElementById('editor-title').textContent=title;document.getElementById('editor-desc').textContent=desc;const st=document.getElementById('editor-sticky-title-m');if(st)st.textContent=title;document.getElementById('editor-body').innerHTML=buildBody(type);document.getElementById('editor-overlay').classList.add('open');document.body.style.overflow='hidden';setTimeout(()=>initAutoResize(),50);setNav('nav-'+type)}
function closeEditor(){document.getElementById('editor-overlay').classList.remove('open');document.body.style.overflow='';currentEditor=null;setNav('nav-dash')}
function overlayClick(e){if(e.target===document.getElementById('editor-overlay'))closeEditor()}
function saveEditor(){if(currentEditor==='phoneme')savePhoneme();else if(currentEditor==='grammar')saveGrammar();else if(currentEditor==='vocab'){S.done.vocab=S.dictionary.length>0}else if(currentEditor==='vibe')saveVibe();else if(currentEditor==='script')saveScriptMap();else if(currentEditor==='corpus'){S.done.corpus=S.corpus.length>0}updateDashboard();closeEditor()}
function buildBody(type){if(type==='vibe')return buildVibe();if(type==='script')return buildScript();if(type==='phoneme')return buildPhoneme();if(type==='grammar')return buildGrammar();if(type==='vocab')return buildVocab();if(type==='corpus')return buildCorpus();if(type==='daily')return buildDailyEditor();return ''}

// ==== AUTO-RESIZE ====
function autoResize(el){el.style.height='auto';el.style.height=el.scrollHeight+'px'}
function initAutoResize(){
  document.querySelectorAll('.textarea-field,.md-textarea').forEach(el=>{
    el.addEventListener('input',()=>autoResize(el));
    autoResize(el);
  });
}

// ===== V11: BLUR AUTO-SAVE + IPA TAP FEEDBACK =====
// Single delegated listener attached once at startup for the editor panel
let _blurSaveInited = false;
function initBlurSave(){
  if(_blurSaveInited) return;
  _blurSaveInited = true;

  // 1. Save on any input/textarea blur (catches phone-call / app-switch)
  document.addEventListener('blur', function(e){
    if(e.target.matches('input,textarea,select')){
      saveState(); // immediate save, no debounce
    }
  }, true); // capture phase so it fires even in shadow DOM / dynamic els

  // 2. Visual tap flash for .ipa-btn (ipa-table row buttons)
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.ipa-btn');
    if(!btn) return;
    btn.classList.add('tapped');
    setTimeout(()=>btn.classList.remove('tapped'), 180);
  }, {passive:true});
}

// ===== IPA HELPERS =====
// Pinbar render
function renderPinbar(){
  const bar=document.getElementById('ipa-pinbar');if(!bar)return;
  if(!S.pinnedIPA.length){bar.innerHTML='<span class="ipa-pinbar-label">üìå PIN</span><span style="font-size:0.68rem;color:var(--text-muted);font-style:italic">Long-press/double-click IPA to pin</span>';return}
  bar.innerHTML='<span class="ipa-pinbar-label">üìå PIN</span>'+S.pinnedIPA.map(c=>`<span class="ipa-pin-btn" onclick="insertToActiveIPA('${c}')">${c}<span class="unpin" onclick="event.stopPropagation();unpinIPA('${c}')">‚úï</span></span>`).join('');
}
function pinIPA(c){if(!S.pinnedIPA.includes(c))S.pinnedIPA.push(c);renderPinbar()}
function unpinIPA(c){S.pinnedIPA=S.pinnedIPA.filter(x=>x!==c);renderPinbar()}
let activeIPATarget='';
function setActiveIPATarget(id){activeIPATarget=id;document.querySelectorAll('[data-ipa-target]').forEach(e=>{e.style.borderColor=e.dataset.ipaTarget===id?'var(--accent-border)':'var(--border)'})}
function insertToActiveIPA(c){if(!activeIPATarget)return;const el=document.getElementById(activeIPATarget);if(!el)return;insertCharAt(el,c)}
function insertCharAt(el,c){const s=el.selectionStart||0,e2=el.selectionEnd||0;el.value=el.value.slice(0,s)+c+el.value.slice(e2);el.selectionStart=el.selectionEnd=s+c.length;el.focus();if(el.tagName==='TEXTAREA')autoResize(el);// trigger events
el.dispatchEvent(new Event('input'))}

// Full IPA Table builder (V5 expanded)
function buildFullIPATable(targetId){
  const ins=(c)=>`insertCharAt(document.getElementById('${targetId}'),'${c}');event.preventDefault()`;
  const pin=(c)=>`pinIPA('${c}')`;
  let h=`<div class="ipa-float-toolbar" id="ipa-float-toolbar-${targetId}">`;
  h+=`<div id="ipa-pinbar" class="ipa-pinbar"></div>`;
  h+=`<div class="ipa-float-inner">`;
  h+=`<div class="ipa-float-row"><span class="ipa-float-label">Á†¥Êì¶Èü≥</span>${IPA_AFFRICATES.map(c=>`<button class="ipa-float-btn" onclick="${ins(c)}" ondblclick="${pin(c)}" title="„ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„Åß„Éî„É≥Áïô„ÇÅ">${c}</button>`).join('')}</div>`;
  h+=`<div class="ipa-float-row"><span class="ipa-float-label">Ë£úÂä©Ë®òÂè∑</span>${IPA_DIACRITICS.map(c=>`<button class="ipa-float-btn" onclick="${ins(c)}" ondblclick="${pin(c)}" title="„ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„Åß„Éî„É≥Áïô„ÇÅ">${c}</button>`).join('')}</div>`;
  h+=`<div class="ipa-float-row"><span class="ipa-float-label">„ÇØ„É™„ÉÉ„ÇØÈü≥üåç</span>${IPA_CLICKS.map(c=>`<button class="ipa-float-btn" onclick="${ins(c)}" ondblclick="${pin(c)}" title="${c} „ÇØ„É™„ÉÉ„ÇØÈü≥Ôºà„Ç≥„Ç§„Çµ„É≥Ë™ûÊóè„Éª„Ç∫„Éº„É´„ÉºË™û„Å™„Å©Ôºâ">${c}</button>`).join('')}<span style="font-size:0.6rem;color:var(--text-muted);margin-left:4px">„Ç≥„Ç§„Çµ„É≥„Éª„Ç∫„Éº„É´„Éº„Éª„Ç≥„ÇµË™û</span></div>`;
  h+=`<div class="ipa-float-row"><span class="ipa-float-label">ÂÜÖÁ†¥Èü≥üåç</span>${IPA_IMPLOSIVES.map(c=>`<button class="ipa-float-btn" onclick="${ins(c)}" ondblclick="${pin(c)}" title="${c} ÂÜÖÁ†¥Èü≥Ôºà„Ç¢„Éï„É™„Ç´„ÉªÂçó„Ç¢„Ç∏„Ç¢„ÅÆË®ÄË™ûÔºâ">${c}</button>`).join('')}<span style="font-size:0.6rem;color:var(--text-muted);margin-left:4px">„Éè„Ç¶„ÇµË™û„Éª„Ç¶„É´„Éâ„Ç•„ÉºË™û</span></div>`;
  h+=`<div class="ipa-float-row"><span class="ipa-float-label">ÊîæÂá∫Èü≥üèîÔ∏è</span>${IPA_EJECTIVES.map(c=>`<button class="ipa-float-btn" onclick="${ins(c)}" ondblclick="${pin(c)}" title="${c} ÊîæÂá∫Èü≥Ôºà„Ç∏„Éß„Éº„Ç∏„Ç¢Ë™û„Éª„Ç¢„É†„Éè„É©Ë™û„Å™„Å©Ôºâ">${c}</button>`).join('')}<span style="font-size:0.6rem;color:var(--text-muted);margin-left:4px">„Ç∏„Éß„Éº„Ç∏„Ç¢Ë™û„Éª„Ç¢„É†„Éè„É©Ë™û</span></div>`;
  h+=`<div class="ipa-float-row"><span class="ipa-float-label">Â£∞Ë™øüéµ</span>${IPA_TONES.map(c=>`<button class="ipa-float-btn" onclick="${ins(c)}" ondblclick="${pin(c)}" title="${c} Â£∞Ë™øË®òÂè∑Ôºà‰∏≠ÂõΩË™û„Éª„Çø„Ç§Ë™û„Éª„É®„É´„ÉêË™û„Å™„Å©Ôºâ">${c}</button>`).join('')}<span style="font-size:0.6rem;color:var(--text-muted);margin-left:4px">‰∏≠ÂõΩË™û„Éª„Çø„Ç§Ë™û„Éª„É®„É´„ÉêË™û</span></div>`;
  h+=`<div class="ipa-float-row"><span class="ipa-float-label">Â∏åÂ∞ëÊØçÈü≥</span>${IPA_EXTRA_VOWELS.map(c=>`<button class="ipa-float-btn" onclick="${ins(c)}" ondblclick="${pin(c)}">${c}</button>`).join('')}</div>`;
  h+='</div></div>';
  // Vowel table
  h+='<div class="ipa-section-label" style="margin-top:14px">ÊØçÈü≥„ÉÅ„É£„Éº„ÉàÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÂÖ•Âäõ / ÁôªÈå≤„É¢„Éº„ÉâONÊôÇ„ÅØ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈü≥Èüª„É™„Çπ„Éà„Å´ÁôªÈå≤Ôºâ</div>';
  h+='<div class="ipa-table-wrap"><table class="ipa-table"><thead><tr><th></th>'+IPA_VOWELS.cols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead><tbody>';
  IPA_VOWELS.rows.forEach(r=>{
    h+=`<tr><th>${r}</th>`;
    IPA_VOWELS.cols.forEach(c=>{
      const key=`${r}${c}`;const val=IPA_VOWELS.cells[key]||'';
      const isReg = S.phoneme.vowels.includes(val);
      h+=`<td>${val?`<button class="ipa-cell-btn vd${isReg?' registered':''}" onclick="ipaChartClick('${val}',true,this);event.preventDefault()" ondblclick="${pin(val)}" title="${val}ÔºàÊØçÈü≥Ôºâ„ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ=„Éî„É≥Áïô„ÇÅ">${val}</button>`:''}</td>`;
    });
    h+='</tr>';
  });
  h+='</tbody></table></div>';
  // Consonant table
  h+='<div class="ipa-section-label" style="margin-top:16px">Â≠êÈü≥„ÉÅ„É£„Éº„ÉàÔºàÂ∑¶=ÁÑ°Â£∞„ÄÅÂè≥=ÊúâÂ£∞ / ÁôªÈå≤„É¢„Éº„ÉâONÊôÇ„ÅØ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈü≥ÈüªÁôªÈå≤Ôºâ</div>';
  h+='<div class="ipa-table-wrap"><table class="ipa-table"><thead><tr><th>Ë™øÈü≥ÈÉ®‰Ωç</th>'+IPA_CONSONANTS.cols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead><tbody>';
  IPA_CONSONANTS.rows.forEach(r=>{
    h+=`<tr><th>${r}</th>`;
    IPA_CONSONANTS.cols.forEach(c=>{
      const key=`${r}${c}`;const pair=IPA_CONSONANTS.cells[key]||['',''];
      const [vl,vd]=pair;
      const isRegVl = S.phoneme.consonants.includes(vl);
      const isRegVd = S.phoneme.consonants.includes(vd);
      if(vl||vd){h+=`<td><div class="ipa-cell">${vl?`<button class="ipa-cell-btn vl${isRegVl?' registered':''}" onclick="ipaChartClick('${vl}',false,this);event.preventDefault()" ondblclick="${pin(vl)}" title="${vl}ÔºàÁÑ°Â£∞Ôºâ">${vl}</button>`:''} ${vd?`<button class="ipa-cell-btn vd${isRegVd?' registered':''}" onclick="ipaChartClick('${vd}',false,this);event.preventDefault()" ondblclick="${pin(vd)}" title="${vd}ÔºàÊúâÂ£∞Ôºâ">${vd}</button>`:''}</div></td>`}else h+=`<td style="background:var(--surface-3)"></td>`;
    });
    h+='</tr>';
  });
  h+='</tbody></table></div>';
  return h;
}

// ===== VIBE =====
function buildVibe(){const vibes=[['üåø','„Ç®„É´„Éï„ÉªËá™ÁÑ∂','elvish'],['‚öîÔ∏è','„ÉÄ„Éº„ÇØ„ÉªÂ∏ùÂõΩ','dark'],['üå∏','„Åã„Çè„ÅÑ„ÅÑ„ÉªÂ¶ñÁ≤æ','cute'],['‚öôÔ∏è','Ê©üÊ¢∞„ÉªSF','scifi'],['üåä','Êµ∑Ê¥ã„ÉªÁ≤æÈúä','ocean'],['üèîÔ∏è','Âè§‰ª£„ÉªÁ•ûË©±','ancient']];return`
${buildAssistPanel('vibe')}
<div class="field-block"><span class="field-label">Èõ∞Âõ≤Ê∞óÔºàË§áÊï∞OKÔºâ‚Äî üîä„ÅßËÅ¥„Åë„Çã</span><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">${vibes.map(([icon,label,sample])=>`<div style="padding:14px 12px;border:1px solid ${S.vibe.includes(label)?'var(--accent-border)':'var(--border)'};border-radius:10px;background:${S.vibe.includes(label)?'var(--accent-dim)':'var(--surface-2)'};cursor:pointer;text-align:center;transition:all 0.15s" onclick="toggleVibeEl(this,'${label}')"><div style="font-size:1.3rem;margin-bottom:6px">${icon}</div><div style="font-size:0.76rem;font-weight:600;color:var(--text-primary);margin-bottom:6px">${label}</div><div class="voice-chip" style="display:inline-flex;font-size:0.68rem" onclick="event.stopPropagation();playVoice(this,'${sample}')"><span>‚ñ∂</span> ËÅ¥„Åè</div></div>`).join('')}</div></div><div class="field-block"><span class="field-label">Ëá™Áî±„Å´Ë™¨Êòé„Åô„ÇãÔºà‰ªªÊÑèÔºâ</span><textarea class="textarea-field" placeholder="‰æãÔºö„Ç®„É´„Éï„ÅåÊ£Æ„Å´‰Ωè„ÇÄÂè§‰ª£ÊñáÊòé„ÅÆË®ÄË™û„ÄÇÊØçÈü≥„ÅåÂ§ö„Åè„ÄÅË™ûÂ∞æ„Å´-el„Åå„Çà„ÅèÊù•„Çã‚Ä¶" id="vibe-text">${S.vibeText}</textarea></div><div class="ai-box"><div class="ai-label">‚ú¶ „ÇØ„Ç§„ÉÉ„ÇØÊèêÊ°à</div><div class="ai-content" id="ai-vibe-content">${S.aiVibeResult||'Èõ∞Âõ≤Ê∞ó„ÇíÈÅ∏„Çì„Åß„ÄåÊèêÊ°à„ÇíÁîüÊàê„Äç„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ'}</div><div class="ai-chips"><div class="ai-chip" onclick="generateVibeAI()">ÊèêÊ°à„ÇíÁîüÊàê„Åô„Çã</div></div></div>`}
function toggleVibeEl(el,label){if(S.vibe.includes(label)){S.vibe=S.vibe.filter(v=>v!==label);el.style.borderColor='var(--border)';el.style.background='var(--surface-2)'}else{S.vibe.push(label);el.style.borderColor='var(--accent-border)';el.style.background='var(--accent-dim)'}}
function generateVibeAI(){const el=document.getElementById('ai-vibe-content');el.innerHTML=`<span class="spinning">‚ü≥</span> ${t('gc_checking')}`;setTimeout(()=>{const m={};m[t('w_vibe_elf')]='a,e,i (sonorants) ¬∑ l,r,n,m ¬∑ CV syllables';m[t('w_vibe_dark')]='a,u (dark) ¬∑ k,g,d,r ¬∑ CVC syllables';m[t('w_vibe_cute')]='i,a (bright) ¬∑ m,n,p ¬∑ CV syllables';m[t('w_vibe_scifi')]='e,i ¬∑ x,z,k ¬∑ CCVC syllables';m[t('w_vibe_ocean')]='a,e ¬∑ m,n,l ¬∑ CVN syllables';m[t('w_vibe_ancient')]='a,u ¬∑ k,t,r,v ¬∑ CVC syllables';const r=S.vibe.map(v=>m[v]).filter(Boolean);S.aiVibeResult=r.length?`<strong style="color:var(--text-primary)">Recommended sounds:</strong><br>${r.join('<br>')}`:t('w_vibe_label');el.innerHTML=S.aiVibeResult},1000)}
function saveVibe(){const t=document.getElementById('vibe-text');if(t)S.vibeText=t.value;S.done.vibe=S.vibe.length>0;scheduleSave()}

// ===== SCRIPT MAPPING =====
function buildScript(){
  const alpha='abcdefghijklmnopqrstuvwxyz'.split('');
  const presets={latin:alpha,rune:['·ö†','·ö¢','·ö¶','·ö®','·ö±','·ö≤','·ö∑','·öπ','·ö∫','·õÉ','·õá','·õö','·õó','·öæ','·õü','·õà','·õ©','·ö±','·õä','·õè','·ö¢','·ö¢','·öπ','·ö∑','·õÉ','·õâ'],greek:['Œ±','Œ≤','Œ≥','Œ¥','Œµ','Œ∂','Œ∑','Œ∏','Œπ','Œ∫','Œª','Œº','ŒΩ','Œæ','Œø','œÄ','œÅ','œÉ','œÑ','œÖ','œÜ','œá','œà','œâ','·æ≥','Œ∂'],cyrillic:['–∞','–±','–≤','–≥','–¥','–µ','–∂','–∑','–∏','–π','–∫','–ª','–º','–Ω','–æ','–ø','—Ä','—Å','—Ç','—É','—Ñ','—Ö','—Ü','—á','—à','—â']};
  const cur=S.scriptMap;
  if(Object.keys(cur).length===0&&presets[S.script]&&S.script!=='latin'){presets[S.script].forEach((c,i)=>cur[alpha[i]]=c)}
  const rows=alpha.map(c=>`<div class="script-map-row"><span class="script-map-from">${c}</span><span class="script-map-arrow">‚Üí</span><input class="script-map-to" maxlength="4" id="sm-${c}" value="${cur[c]||''}" placeholder="?" oninput="livePreview()" onfocus="this.select();scriptCellFocus(this)"></div>`).join('');
  return`
  ${buildAssistPanel('script')}
  <div class="field-block">
    <span class="field-label">„É™„Ç¢„É´„Çø„Ç§„É†„Éó„É¨„Éì„É•„Éº ${helpBtn('ÊñáÂ≠ó‰ΩìÁ≥ª')}</span>
    <div class="script-preview-wrap">
      <div class="script-preview-input-row">
        <input class="preview-source" id="preview-source" placeholder="„Åì„Åì„Å´„É≠„Éº„ÉûÂ≠ó„ÇíÂÖ•Âäõ‚Ä¶" oninput="livePreview()">
        <span class="preview-arrow">‚ú¶</span>
        <div class="preview-target" id="preview-target">‚Ä¶</div>
      </div>
    </div>
  </div>
  <div class="field-block">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:6px">
      <span class="field-label" style="margin:0">ÊñáÂ≠ó„Éû„ÉÉ„Éî„É≥„Ç∞Ôºàa„ÄúzÔºâ‚Äî „Çª„É´„Çí„Çø„ÉÉ„Éó„Åó„Å¶Ë®òÂè∑„ÇíÂÖ•Âäõ</span>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        ${Object.keys(presets).map(k=>`<button class="btn btn-sm" onclick="applyPreset('${k}')">${scriptLabels[k]||k}</button>`).join('')}
        <button class="btn btn-sm" style="color:var(--rose);border-color:var(--rose-border)" onclick="clearScriptMap()" data-i18n="btn_clear">„ÇØ„É™„Ç¢</button>
      </div>
    </div>
    <div style="margin-bottom:10px;padding:10px 12px;background:var(--surface-3);border:1px solid var(--border);border-radius:8px;font-size:0.76rem;color:var(--text-secondary);line-height:1.7">
      üí° <strong style="color:var(--text-primary)">‰Ωø„ÅÑÊñπÔºö</strong>Âè≥„ÅÆÂÖ•ÂäõÊ¨Ñ„Å´Â•Ω„Åç„Å™Ë®òÂè∑„ÇíÂÖ•Âäõ„Åô„Çã„Åã„ÄÅ‰∏ã„ÅÆ„Äå‰∏ñÁïå„ÅÆÊñáÂ≠ó„Éî„ÉÉ„Ç´„Éº„Äç„Åã„ÇâÊñáÂ≠ó„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈÅ∏Êäû„Åó„ÅüÁä∂ÊÖã„ÅßÊñáÂ≠ó„Éî„ÉÉ„Ç´„Éº„ÅÆ„Éú„Çø„É≥„ÇíÊäº„Åô„Å®Ëá™ÂãïÂÖ•Âäõ„Åï„Çå„Åæ„Åô„ÄÇ
    </div>
    <div id="script-active-cell-info" style="font-size:0.72rem;color:var(--accent);margin-bottom:8px;min-height:18px"></div>
    <div class="script-map-grid">${rows}</div>
  </div>
  <div class="field-block">
    <span class="field-label">üåê ‰∏ñÁïå„ÅÆÊñáÂ≠ó„Éî„ÉÉ„Ç´„Éº ‚Äî „ÇØ„É™„ÉÉ„ÇØ„ÅßÂÖ•Âäõ</span>
    <p style="font-size:0.72rem;color:var(--text-muted);margin-bottom:6px">‰∏ä„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞Ê¨Ñ„ÅÆÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Çí„ÇØ„É™„ÉÉ„ÇØ„ÅßÈÅ∏Êäû ‚Üí ‰∏ã„ÅÆ„Éú„Çø„É≥„ÅßÊñáÂ≠ó„ÇíÂÖ•Âäõ</p>
    ${buildCharPicker('script-char-target')}
    <input id="script-char-target" style="position:absolute;opacity:0;pointer-events:none;left:-9999px" onfocus="scriptCharFocus()">
  </div>`
}
function livePreview(){const src=document.getElementById('preview-source'),tgt=document.getElementById('preview-target');if(!src||!tgt)return;const map={};'abcdefghijklmnopqrstuvwxyz'.split('').forEach(c=>{const el=document.getElementById('sm-'+c);if(el&&el.value)map[c]=el.value});const result=src.value.toLowerCase().split('').map(c=>map[c]||c).join('');tgt.textContent=result||'‚Ä¶'}
function scriptCellFocus(el){
  const char = el.id.replace('sm-','');
  const info = document.getElementById('script-active-cell-info');
  if(info) {
    info.textContent = `‚úì ÈÅ∏Êäû‰∏≠: "${char.toUpperCase()}" ‚Üí ÊñáÂ≠ó„ÇíÂÖ•Âäõ„Åæ„Åü„ÅØ„Éî„ÉÉ„Ç´„Éº„Åã„ÇâÈÅ∏Êäû`;
    info.style.fontWeight = '600';
  }
  window._activeScriptCell = el;
}
function scriptCharFocus(){
  // Triggered when char picker target receives focus
  const info = document.getElementById('script-active-cell-info');
  if(info) info.textContent = 'ÊñáÂ≠ó„Éî„ÉÉ„Ç´„Éº„Çí‰ΩøÁî®„Åô„ÇãÂ†¥Âêà„ÅØ„ÄÅ„Åæ„Åö‰∏ä„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞Ê¨Ñ„ÅÆ„Çª„É´„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
}
function applyPreset(key){const alpha='abcdefghijklmnopqrstuvwxyz'.split('');const presets={rune:['·ö†','·ö¢','·ö¶','·ö®','·ö±','·ö≤','·ö∑','·öπ','·ö∫','·õÉ','·õá','·õö','·õó','·öæ','·õü','·õà','·õ©','·ö±','·õä','·õè','·ö¢','·ö¢','·öπ','·ö∑','·õÉ','·õâ'],latin:alpha,greek:['Œ±','Œ≤','Œ≥','Œ¥','Œµ','Œ∂','Œ∑','Œ∏','Œπ','Œ∫','Œª','Œº','ŒΩ','Œæ','Œø','œÄ','œÅ','œÉ','œÑ','œÖ','œÜ','œá','œà','œâ','·æ≥','Œ∂']};if(!presets[key])return;presets[key].forEach((c,i)=>{const el=document.getElementById('sm-'+alpha[i]);if(el)el.value=c});livePreview()}
function clearScriptMap(){'abcdefghijklmnopqrstuvwxyz'.split('').forEach(c=>{const el=document.getElementById('sm-'+c);if(el)el.value=''});livePreview()}
function saveScriptMap(){const alpha='abcdefghijklmnopqrstuvwxyz'.split('');alpha.forEach(c=>{const el=document.getElementById('sm-'+c);if(el&&el.value)S.scriptMap[c]=el.value;else delete S.scriptMap[c]});S.done.script=Object.keys(S.scriptMap).length>0;scheduleSave()}
function applyScriptMap(text){return text.toLowerCase().split('').map(c=>S.scriptMap[c]||c).join('')}

// ===== PHONEME =====
function buildPhoneme(){
  const vowels=['a','i','u','e','o','…ô','…õ','…î','y','√∏','√¶','…Ø','…™',' ä','…ë','≈ì','…í','…®','…§',' å'];
  const cons=['k','s','t','n','h','m','r','l','p','b','d','g','f','v','z','w','j','Œ∏','√∞',' É',' í','x','…£','≈ã','t É','d í','ts','q',' î','ƒß',' ï','…≤','…æ',' Ä','√ß',' ù','…π',' é','…¨','…Æ',' à','…ñ','…ì','…ó','…†'];
  const sylls=[['CVÂûã','ka,si,me','Êó•Êú¨Ë™û„Éª„Éè„ÉØ„Ç§Ë™ûÈ¢®'],['CVCÂûã','kal,sim','Ëã±Ë™û„ÉªÈüìÂõΩË™ûÈ¢®'],['VÂûã„ÇÇÂèØ','ÊØçÈü≥„ÅßÂßã„Åæ„Çå„Çã','Êüî„Çâ„Åã„ÅÑÈü≥'],['CCVCÂûã','Ë§áÈõë„Å™Â≠êÈü≥ÈÄ£Á∂ö','„Çπ„É©„ÉñË™ûÈ¢®'],['CVNÂûã','ÊØçÈü≥+ÈºªÈü≥„ÅßÁµÇ„Çè„Çã','Â∫ÉÊù±Ë™ûÈ¢®']];
  const accents=[['„Å™„Åó','Ë¶èÂâá„Å™„Åó'],['Âõ∫ÂÆö','Á¨¨1Èü≥ÁØÄÂº∑'],['„Éî„ÉÉ„ÉÅ','Êó•„Éª„Çπ„Ç¶„Çß„Éº„Éá„É≥Ë™ûÈ¢®'],['Â£∞Ë™ø','‰∏≠„Éª„Çø„Ç§Ë™ûÈ¢®'],['È†≠È´òÂûã','ÂÖàÈ†≠„ÅÆ„ÅøÈ´ò„ÅÑ'],['Âπ≥ÊùøÂûã','ÂÖ®„Å¶Âπ≥Âù¶']];
  const slotsHtml=buildSyllSlots();
  return`
  ${buildAssistPanel('phoneme')}
  <div class="editor-tabs">
    <div class="editor-tab active" onclick="switchTab(this,'ptab-v')">ÊØçÈü≥ ${helpBtn('Èü≥Èüª')}</div>
    <div class="editor-tab" onclick="switchTab(this,'ptab-c')">Â≠êÈü≥</div>
    <div class="editor-tab" onclick="switchTab(this,'ptab-s')">„Ç¢„ÇØ„Çª„É≥„Éà</div>
    <div class="editor-tab" onclick="switchTab(this,'ptab-pt')">Èü≥ÁØÄÊßãÈÄ†„Çπ„É≠„ÉÉ„Éà ${helpBtn('Èü≥ÁØÄÊßãÈÄ†')}</div>
    <div class="editor-tab" onclick="switchTab(this,'ptab-gen')">‚ú¶ Êñ∞ÂçòË™ûÁîüÊàê</div>
    <div class="editor-tab" onclick="switchTab(this,'ptab-ipa')">„Éï„É´IPA„ÉÅ„É£„Éº„Éà ${helpBtn('IPA')}</div>
    <div class="editor-tab" onclick="switchTab(this,'ptab-chart');setTimeout(renderPhonologyCharts,50)">üìä Èü≥ÈüªÂõ≥</div>
  </div>
  <div class="tab-content active" id="ptab-v">
    <div class="field-block"><span class="field-label">ÊØçÈü≥ ‚Äî „Çø„ÉÉ„Éó„ÅßÁô∫Èü≥Á¢∫Ë™ç üîä</span>
    <p style="font-size:0.72rem;color:var(--text-muted);margin-bottom:8px;font-style:italic">üí° „Åì„Åì„ÅßÈÅ∏„Çì„Å†Èü≥„Åå„ÄÅËæûÊõ∏ÂÖ•ÂäõÁîªÈù¢„ÅÆ„Éü„Éã„Ç≠„Éº„Éú„Éº„Éâ„Å´Ë°®Á§∫„Åï„Çå„Åæ„ÅôÔºÅ</p>
    <div class="phoneme-grid">${vowels.map(v=>`<div class="phoneme-btn ${S.phoneme.vowels.includes(v)?'selected':''}" onclick="tapPhoneme(this,'${v}','v')">${v}</div>`).join('')}</div><p class="field-hint">ÈÅ∏Êäû„Åó„ÅüÈü≥„Åå„Åì„ÅÆË®ÄË™û„Åß‰Ωø„Çè„Çå„Åæ„Åô„ÄÇËæûÊõ∏ÂÖ•ÂäõÊôÇ„Å´„ÇÇÁ¥†Êó©„ÅèÂÖ•Âäõ„Åß„Åç„Åæ„Åô„ÄÇ</p></div>
    <div class="field-block"><span class="field-label">üîä Èõ∞Âõ≤Ê∞ó„Çµ„É≥„Éó„É´</span><div class="voice-row"><div class="voice-chip" onclick="playVoice(this,'elvish')"><span>‚ñ∂</span>„Ç®„É´„ÉïÁ≥ª</div><div class="voice-chip" onclick="playVoice(this,'cute')"><span>‚ñ∂</span>„Åã„Çè„ÅÑ„ÅÑÁ≥ª</div><div class="voice-chip" onclick="playVoice(this,'ancient')"><span>‚ñ∂</span>Âè§‰ª£Á≥ª</div></div></div>
  </div>
  <div class="tab-content" id="ptab-c">
    <div class="field-block"><span class="field-label">Â≠êÈü≥ ‚Äî „Çø„ÉÉ„Éó„ÅßÁô∫Èü≥Á¢∫Ë™ç üîä</span>
    <p style="font-size:0.72rem;color:var(--text-muted);margin-bottom:8px;font-style:italic">üí° „Åì„Åì„ÅßÈÅ∏„Çì„Å†Èü≥„ÇÇ„ÄÅËæûÊõ∏ÂÖ•Âäõ„ÅÆ„Éü„Éã„Ç≠„Éº„Éú„Éº„Éâ„Å´Ë°®Á§∫„Åï„Çå„Åæ„ÅôÔºÅ</p>
    <div class="phoneme-grid">${cons.map(c=>`<div class="phoneme-btn ${S.phoneme.consonants.includes(c)?'selected':''}" onclick="tapPhoneme(this,'${c}','c')">${c}</div>`).join('')}</div></div>
    <div class="field-block"><span class="field-label">üîä Â≠êÈü≥„ÅÆÈõ∞Âõ≤Ê∞ó</span><div class="voice-row"><div class="voice-chip" onclick="playVoice(this,'elvish')"><span>‚ñ∂</span>Êüî„Çâ„Åã„ÅÑÁ≥ª</div><div class="voice-chip" onclick="playVoice(this,'dark')"><span>‚ñ∂</span>Á°¨„ÅÑÁ≥ª</div><div class="voice-chip" onclick="playVoice(this,'scifi')"><span>‚ñ∂</span>SFÁ≥ª</div></div></div>
  </div>
  <div class="tab-content" id="ptab-s">
    <div class="field-block"><span class="field-label">„Ç¢„ÇØ„Çª„É≥„Éà„ÉªÂ£∞Ë™ø</span><div class="select-grid">${accents.map(([l,d])=>`<div class="select-option ${S.phoneme.accent===l?'selected':''}" onclick="selOne(this,'pacc','${l}')"><div class="opt-label">${l}</div><div class="opt-sub">${d}</div></div>`).join('')}</div></div>
  </div>
  <div class="tab-content" id="ptab-pt">
    <p style="font-size:0.82rem;color:var(--text-secondary);margin-bottom:14px;line-height:1.7;font-style:italic">Èü≥ÁØÄ„ÅÆ„ÄåÂûã„Äç„Çí„Çπ„É≠„ÉÉ„Éà„ÅßË¶ñË¶öÁöÑ„Å´Ë®≠ÂÆö„Åß„Åç„Åæ„Åô„ÄÇ<strong style="color:var(--text-primary)">C</strong>=Â≠êÈü≥„ÄÅ<strong style="color:var(--accent2)">V</strong>=ÊØçÈü≥„ÄÅ<strong style="color:var(--gold)">N</strong>=ÈºªÈü≥</p>
    <div id="syll-slot-display">${slotsHtml}</div>
    <div class="syll-slot-controls">
      <button class="slot-add-btn C" onclick="addSlot('C')">+ CÔºàÂ≠êÈü≥Ôºâ</button>
      <button class="slot-add-btn V" onclick="addSlot('V')">+ VÔºàÊØçÈü≥Ôºâ</button>
      <button class="slot-add-btn N" onclick="addSlot('N')">+ NÔºàÈºªÈü≥Ôºâ</button>
      <button class="slot-add-btn" onclick="addSlot('?')" style="color:var(--text-muted);font-style:italic">+ ?ÔºàÁúÅÁï•ÂèØÔºâ</button>
      <button class="btn btn-sm" style="margin-left:auto" onclick="clearSlots()" data-i18n="btn_clear_slots">üóë „ÇØ„É™„Ç¢</button>
    </div>
    <div style="margin-top:10px;padding:10px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:8px">
      <span style="font-size:0.68rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em">ÁèæÂú®„ÅÆÈü≥ÁØÄÂûãÔºö</span>
      <span style="font-family:monospace;font-size:0.9rem;color:var(--accent);margin-left:8px" id="slot-display-text">${S.syllableSlots.length?S.syllableSlots.join(''):t('card_not_set')}</span>
    </div>
    <div class="ai-box" style="margin-top:12px">
      <div class="ai-label">üí° „Éó„É™„Çª„ÉÉ„Éà</div>
      <div class="ai-content">„Çà„Åè‰Ωø„Çè„Çå„ÇãÈü≥ÁØÄÂûã„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åô</div>
      <div class="ai-chips">
        <div class="ai-chip" onclick="loadSlotPreset('CV')">CVÔºàÊó•Êú¨Ë™ûÈ¢®Ôºâ</div>
        <div class="ai-chip" onclick="loadSlotPreset('CVC')">CVCÔºàËã±Ë™ûÈ¢®Ôºâ</div>
        <div class="ai-chip" onclick="loadSlotPreset('CVN')">CVNÔºàÂ∫ÉÊù±Ë™ûÈ¢®Ôºâ</div>
        <div class="ai-chip" onclick="loadSlotPreset('CCVC')">CCVCÔºà„Çπ„É©„ÉñË™ûÈ¢®Ôºâ</div>
      </div>
    </div>
  </div>
  <div class="tab-content" id="ptab-gen">
    <p style="font-size:0.82rem;color:var(--text-secondary);margin-bottom:16px;line-height:1.7;font-style:italic">Ë®≠ÂÆö„Åó„ÅüÈü≥Èüª„É´„Éº„É´„Å´Âü∫„Å•„ÅÑ„Å¶Êñ∞ÂçòË™ûÂÄôË£ú„ÇíÁîüÊàê„Åó„Åæ„Åô„ÄÇ</p>
    <button class="insp-btn" onclick="generateSyllables()"><span id="gen-spin">‚ú¶</span> „Ç§„É≥„Çπ„Éî„É¨„Éº„Ç∑„Éß„É≥ÁîüÊàêÔºà10Ë™ûÔºâ</button>
    <div class="generated-words" id="generated-words"></div>
    <div class="field-block" style="margin-top:16px">
      <span class="field-label">Èü≥ÁØÄ„Éó„É¨„Éì„É•„Éº</span>
      <div class="script-preview-wrap" style="padding:14px">
        <div style="display:flex;gap:8px;align-items:center">
          <input class="input-field" id="syl-test" placeholder="„ÉÜ„Çπ„Éà„Åô„ÇãÈü≥ÁØÄ„ÇíÂÖ•ÂäõÔºà‰æãÔºöka-li-venÔºâ" style="flex:1">
          <button class="btn btn-sm" onclick="speakDirect(document.getElementById('syl-test').value,'en-US',0.75,1)">üîä</button>
          <button class="btn btn-sm btn-gold" onclick="previewSylInScript()">‚úç Â§âÊèõ</button>
        </div>
        <div id="syl-script-result" style="margin-top:10px;font-size:1.4rem;color:var(--accent);font-family:monospace;letter-spacing:0.1em;text-align:center;min-height:30px"></div>
      </div>
    </div>
  </div>
  <div class="tab-content" id="ptab-ipa">
    <!-- V8: ÁôªÈå≤„É¢„Éº„Éâ„Éê„Éº -->
    <div class="ipa-reg-mode-bar">
      <div class="assist-dot"></div>
      <span style="font-size:0.72rem;color:var(--accent);font-weight:700">IPA„ÉÅ„É£„Éº„Éà</span>
      <button class="ipa-reg-toggle" id="ipa-reg-toggle-btn" onclick="toggleIPARegMode()">‚¨§ ÁôªÈå≤„É¢„Éº„Éâ OFF</button>
      <span class="ipa-reg-badge" id="ipa-reg-hint">„ÇØ„É™„ÉÉ„ÇØ=„ÉÜ„Ç≠„Çπ„ÉàÂÖ•Âäõ / ÁôªÈå≤„É¢„Éº„ÉâON=Èü≥Èüª„É™„Çπ„Éà„Å´‰øùÂ≠ò</span>
    </div>
    <div style="margin-bottom:10px;padding:10px 12px;background:var(--surface-3);border:1px solid var(--border);border-radius:8px;font-size:0.75rem;color:var(--text-secondary);line-height:1.7">
      üí° <strong style="color:var(--accent)">ÁôªÈå≤„É¢„Éº„ÉâON</strong> „Å´„Åô„Çã„Å®„ÉÅ„É£„Éº„Éà„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Åü„Å≥„Å´„Äå„Åì„ÅÆË®ÄË™û„ÅÆÈü≥„Äç„Å®„Åó„Å¶ÁôªÈå≤„Åï„Çå„Åæ„ÅôÔºàÈùí„ÅèÂÖâ„Çä„Åæ„ÅôÔºâ„ÄÇ<br>
      „ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÇØ„É™„ÉÉ„ÇØ„ÅßËß£Èô§„ÄÇÁôªÈå≤„Åó„ÅüÈü≥„ÅØÊØçÈü≥„Çø„Éñ„ÉªÂ≠êÈü≥„Çø„Éñ„ÅÆ„É™„Çπ„Éà„Å´„ÇÇÂèçÊò†„Åï„Çå„Åæ„Åô„ÄÇ
    </div>
    <div class="field-block">
      <span class="field-label">„ÉÜ„Ç≠„Çπ„ÉàÂÖ•ÂäõÂÖàÔºàÁôªÈå≤„É¢„Éº„ÉâOFFÊôÇÔºâ</span>
      <input class="input-field" id="ipa-main-target" data-ipa-target="ipa-main-target" placeholder="„Åì„Åì„Å´ÂÖ•ÂäõÔºàÂêÑ„Éï„Ç£„Éº„É´„Éâ„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑÔºâ" style="font-family:monospace;font-size:0.9rem" onfocus="setActiveIPATarget('ipa-main-target')">
    </div>
    ${buildFullIPATable('ipa-main-target')}
  </div>
  <div class="tab-content" id="ptab-chart">
    <p style="font-size:0.78rem;color:var(--text-secondary);margin-bottom:14px;line-height:1.6;font-style:italic">
      ÁôªÈå≤„Åó„ÅüÈü≥Èüª„Çí„ÇÇ„Å®„Å´<strong style="color:var(--text-primary)">ÊØçÈü≥‰∏âËßíÂΩ¢</strong>„Å®<strong style="color:var(--text-primary)">Â≠êÈü≥‰ΩìÁ≥ªË°®</strong>„ÇíËá™ÂãïÁîüÊàê„Åó„Åæ„Åô„ÄÇ<br>
      Èü≥„ÇíÁôªÈå≤„Åô„Çã„Å´„ÅØ„Äå„Éï„É´IPA„ÉÅ„É£„Éº„Éà„Äç„Çø„Éñ„ÅßÁôªÈå≤„É¢„Éº„Éâ„ÇíON„Å´„Åô„Çã„Åã„ÄÅ„ÄåÊØçÈü≥„Äç„ÄåÂ≠êÈü≥„Äç„Çø„Éñ„ÅßÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
    </p>
    <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
      <span style="font-size:0.72rem;color:var(--text-muted)">ÊØçÈü≥: <strong style="color:var(--accent);font-family:monospace">${S.phoneme.vowels.join(' ')||'ÔºàÊú™Ë®≠ÂÆöÔºâ'}</strong></span>
      <span style="font-size:0.72rem;color:var(--text-muted)">Â≠êÈü≥: <strong style="color:var(--accent);font-family:monospace">${S.phoneme.consonants.slice(0,12).join(' ')+(S.phoneme.consonants.length>12?'‚Ä¶':'')||'ÔºàÊú™Ë®≠ÂÆöÔºâ'}</strong></span>
    </div>
    <div id="phonology-charts-wrap">${(() => {
      // „Ç§„É≥„É©„Ç§„É≥ÊèèÁîªÔºàÂàùÂõûÔºâ
      const vowels = S.phoneme.vowels;
      const cons = S.phoneme.consonants;
      if(!vowels.length && !cons.length) return '<p style="font-size:0.78rem;color:var(--text-muted);text-align:center;padding:30px 0;font-style:italic">Èü≥Èüª„ÇíÁôªÈå≤„Åô„Çã„Å®Âõ≥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô<br><small>„ÄåÊØçÈü≥„Äç„ÄåÂ≠êÈü≥„Äç„Çø„Éñ„ÅßÈÅ∏Êäû„Åô„Çã„Åã„ÄÅ„Äå„Éï„É´IPA„ÉÅ„É£„Éº„Éà„Äç„ÅßÁôªÈå≤„É¢„Éº„Éâ„ÇíON„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small></p>';
      return '<p style="font-size:0.72rem;color:var(--text-muted);text-align:center;padding:10px 0;font-style:italic">Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶</p>';
    })()}</div>
    <button class="btn btn-sm btn-gold" style="margin-top:12px" onclick="renderPhonologyCharts()">üîÑ Âõ≥„ÇíÊõ¥Êñ∞</button>
  </div>`
}
// ptab-chart„Çø„Éñ„ÇíÂãïÁöÑ„Å´ÊåøÂÖ•ÔºàbuildPhonemeÂÜÖ„Åß„Çø„Éñ„Å´ËøΩÂä†Ôºâ
function buildPhoneme_tabs_patch(){
  // called after buildPhoneme innerHTML is set
  const tabs = document.querySelector('#editor-body .editor-tabs');
  if(tabs && !tabs.querySelector('[onclick*="ptab-chart"]')){
    const el = document.createElement('div');
    el.className = 'editor-tab';
    el.setAttribute('onclick', "switchTab(this,'ptab-chart');renderPhonologyCharts()");
    el.textContent = t('ph_chart_tab')||'üìä Èü≥ÈüªÂõ≥';
    tabs.appendChild(el);
  }
}

// V5: Syllable slot functions
function buildSyllSlots(){
  if(!S.syllableSlots.length)return`<div class="syll-slot-row"><span style="font-size:0.78rem;color:var(--text-muted);font-style:italic">‰∏ã„ÅÆ„Éú„Çø„É≥„Åß„Çπ„É≠„ÉÉ„Éà„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„ÇØ„É™„ÉÉ„ÇØ„ÅßÂâäÈô§„Åß„Åç„Åæ„Åô„ÄÇ</span></div>`;
  const slotHtml=S.syllableSlots.map((s,i)=>{
    const cls=s==='C'?'slot-C':s==='V'?'slot-V':s==='N'?'slot-N':s==='?'?'slot-empty':'slot-empty';
    return`<div class="syll-slot" onclick="removeSlot(${i})"><div class="syll-slot-box ${cls}">${s}</div><div class="syll-slot-label">„Çø„ÉÉ„ÉóÂâäÈô§</div></div>`;
  }).join('');
  return`<div class="syll-slot-row">${slotHtml}</div>`;
}
function addSlot(type){S.syllableSlots.push(type);refreshSlots()}
function removeSlot(i){S.syllableSlots.splice(i,1);refreshSlots()}
function clearSlots(){S.syllableSlots=[];refreshSlots()}
function refreshSlots(){const d=document.getElementById('syll-slot-display');if(d)d.innerHTML=buildSyllSlots();const t=document.getElementById('slot-display-text');if(t)t.textContent=S.syllableSlots.length?S.syllableSlots.join(''):(t('ph_not_set')||'ÔºàÊú™Ë®≠ÂÆöÔºâ')}
function loadSlotPreset(preset){const presets={CV:['C','V'],CVC:['C','V','C'],CVN:['C','V','N'],CCVC:['C','C','V','C']};S.syllableSlots=[...(presets[preset]||[])];refreshSlots()}

// V5: Syllable violation checker
function checkSyllableViolation(word){
  const el=document.getElementById('syll-violation');if(!el)return;
  if(!S.syllableSlots.length||!word){el.classList.remove('show');return}
  // Simple heuristic: check if word length roughly matches syllable pattern
  const slots=S.syllableSlots;
  const vowelCount=(word.match(/[aeiou…ô…õ…îy√∏√¶…Ø…™ ä…ë≈ì…í…®…§ å]/gi)||[]).length;
  const expectedVowels=slots.filter(s=>s==='V').length;
  if(expectedVowels>0&&Math.abs(vowelCount-expectedVowels)>1){
    el.textContent=`${t('v_syll_violation')} ‚Äî "${slots.join('')}": ${expectedVowels} vowels needed, "${word}" has ${vowelCount}`;
    el.classList.add('show');
  } else {el.classList.remove('show')}
}
function buildMiniIPAKeyboard(targetId){
  const vowels=S.phoneme.vowels;const cons=S.phoneme.consonants;
  if(!vowels.length&&!cons.length)return`<div class="mini-ipa-keyboard show"><span class="mini-kb-label">‚å®Ô∏è „Éü„Éã„Ç≠„Éº„Éú„Éº„Éâ ‚Äî ÂÖà„Å´Èü≥Èüª„Çø„Éñ„ÅßÈü≥„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span></div>`;
  let h=`<div class="mini-ipa-keyboard show"><span class="mini-kb-label">‚å®Ô∏è „ÅÇ„Å™„Åü„ÅÆË®ÄË™û„ÅÆÈü≥ <span style="font-size:0.55rem;color:var(--text-muted)">ÔºàÈü≥ÈüªË®≠ÂÆö„Åã„ÇâÔºâ</span></span>`;
  if(vowels.length){h+=`<div style="font-size:0.58rem;color:var(--accent2);letter-spacing:0.08em;margin-bottom:3px">ÊØçÈü≥</div><div class="mini-kb-row">`;vowels.forEach(v=>{h+=`<button class="mini-kb-btn vowel" onclick="insertCharAt(document.getElementById('${targetId}'),'${v}')" title="${v}">${v}</button>`});h+='</div>'}
  if(cons.length){h+=`<div style="font-size:0.58rem;color:var(--accent);letter-spacing:0.08em;margin:4px 0 3px">Â≠êÈü≥</div><div class="mini-kb-row">`;cons.forEach(c=>{h+=`<button class="mini-kb-btn cons" onclick="insertCharAt(document.getElementById('${targetId}'),'${c}')" title="${c}">${c}</button>`});h+='</div>'}
  if(S.pinnedIPA.length){h+=`<div style="font-size:0.58rem;color:var(--gold);letter-spacing:0.08em;margin:4px 0 3px">üìå „Éî„É≥Áïô„ÇÅ</div><div class="mini-kb-row">`;S.pinnedIPA.forEach(c=>{h+=`<button class="mini-kb-btn" style="border-color:var(--gold-border);color:var(--gold)" onclick="insertCharAt(document.getElementById('${targetId}'),'${c}')" title="${c}">${c}</button>`});h+='</div>'}
  h+='</div>';return h;
}
function tapPhoneme(el,p,type){el.classList.toggle('selected');const map=phonemeMap[p];if(map)speakDirect(map[0],map[1],1.0,1.0);el.classList.add('playing');setTimeout(()=>el.classList.remove('playing'),600)}

// ===== V8: IPA REGISTER MODE =====
let _ipaRegMode = false; // false=ÂÖ•Âäõ„É¢„Éº„Éâ, true=ÁôªÈå≤„É¢„Éº„Éâ

function toggleIPARegMode(){
  _ipaRegMode = !_ipaRegMode;
  const btn = document.getElementById('ipa-reg-toggle-btn');
  const hint = document.getElementById('ipa-reg-hint');
  if(btn) btn.className = 'ipa-reg-toggle' + (_ipaRegMode ? ' on' : '');
  if(hint) hint.textContent = _ipaRegMode ? (t('ph_reg_on')||'üî¥ ÁôªÈå≤„É¢„Éº„Éâ ON') : (t('ph_reg_off')||'‚¨§ ÁôªÈå≤„É¢„Éº„Éâ OFF');
  // re-highlight registered cells
  refreshIPARegisteredHighlight();
}

function refreshIPARegisteredHighlight(){
  const allV = new Set(S.phoneme.vowels);
  const allC = new Set(S.phoneme.consonants);
  document.querySelectorAll('.ipa-cell-btn, .ipa-float-btn').forEach(btn=>{
    const t = btn.textContent.trim();
    if(allV.has(t)||allC.has(t)) btn.classList.add('registered');
    else btn.classList.remove('registered');
  });
}

function ipaChartClick(c, isVowel, btnEl){
  // V11: visual tap flash
  if(btnEl){
    btnEl.classList.add('tapped');
    setTimeout(()=>btnEl.classList.remove('tapped'), 180);
  }
  if(_ipaRegMode){
    // ÁôªÈå≤/Ëß£Èô§„Éà„Ç∞„É´
    const arr = isVowel ? S.phoneme.vowels : S.phoneme.consonants;
    const idx = arr.indexOf(c);
    if(idx >= 0){
      arr.splice(idx, 1);
      showAutosave(`üóë ${c} „ÇíËß£Èô§`);
    } else {
      arr.push(c);
      showAutosave(`‚úì ${c} „ÇíÈü≥Èüª„Å´ÁôªÈå≤`);
    }
    scheduleSave();
    refreshIPARegisteredHighlight();
    renderPhonologyCharts();
  } else {
    // ÂæìÊù•„ÅÆÂÖ•Âäõ„É¢„Éº„Éâ
    if(activeIPATarget){
      const el = document.getElementById(activeIPATarget);
      if(el) insertCharAt(el, c);
    }
  }
}

// ===== V8: PHONOLOGY CHARTS =====
// ÊØçÈü≥„ÅÆËøë‰ººÂ∫ßÊ®ô (ÂâçËàå‚Üê‚ÜíÂæåËàå x, È´ò‚Üê‚Üí‰Ωé y) Ê≠£Ë¶èÂåñ0-100
const VOWEL_POSITIONS = {
  'i':{x:5,y:5},'y':{x:18,y:5},'…®':{x:45,y:5},'…Ø':{x:85,y:5},'u':{x:92,y:5},
  '…™':{x:12,y:18},' è':{x:22,y:18},' ä':{x:80,y:18},
  'e':{x:15,y:38},'√∏':{x:28,y:38},'…ô':{x:50,y:40},'…§':{x:78,y:38},'o':{x:88,y:38},
  '…õ':{x:20,y:60},'≈ì':{x:32,y:60},' å':{x:72,y:60},'…î':{x:85,y:60},
  'a':{x:25,y:88},'√¶':{x:18,y:80},'…ë':{x:80,y:88},'…í':{x:88,y:88},
  '…ê':{x:55,y:80},'…∂':{x:10,y:92},'…µ':{x:50,y:38},'…ò':{x:50,y:25},
  '…û':{x:55,y:62},' â':{x:50,y:12},'…ú':{x:30,y:65},'…ö':{x:55,y:68},
};

function renderPhonologyCharts(){
  const wrap = document.getElementById('phonology-charts-wrap');
  if(!wrap) return;
  const vowels = S.phoneme.vowels;
  const cons = S.phoneme.consonants;
  if(!vowels.length && !cons.length){
    wrap.innerHTML = `<p style="font-size:0.78rem;color:var(--text-muted);text-align:center;padding:20px 0;font-style:italic">${t('ph_chart_empty')||'Èü≥Èüª„ÇíÁôªÈå≤„Åô„Çã„Å®Âõ≥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô'}</p>`;
    return;
  }
  wrap.innerHTML = `<div class="phonology-charts">
    ${vowels.length ? buildVowelTriangle(vowels) : ''}
    ${cons.length ? buildConsonantChart(cons) : ''}
  </div>`;
}

function buildVowelTriangle(vowels){
  const W=260, H=160;
  // Triangle vertices: ÂâçËàåÈ´ò (Â∑¶‰∏ä), ÂæåËàåÈ´ò (Âè≥‰∏ä), ‰Ωé (‰∏≠‰∏ã)
  const pts = [{x:30,y:18},{x:W-30,y:18},{x:W/2,y:H-12}];
  let svgDots='';
  vowels.forEach(v=>{
    const pos = VOWEL_POSITIONS[v];
    if(!pos) return;
    // Map 0-100 to triangle interior
    const tx = pts[0].x + (pts[1].x-pts[0].x)*(pos.x/100);
    const ty = pts[0].y + (pts[2].y-pts[0].y)*(pos.y/100);
    // Slight x-shift based on height (triangle narrowing at bottom)
    const narrowFactor = pos.y/100;
    const cx = tx + (W/2 - tx)*narrowFactor*0.35;
    const cy = ty;
    svgDots+=`<circle class="vt-phoneme-circle" cx="${cx}" cy="${cy}" r="12"/>
      <text class="vt-phoneme" x="${cx}" y="${cy+5}" text-anchor="middle">${v}</text>`;
  });
  return `<div class="phon-chart-card">
    <div class="phon-chart-header">ÊØçÈü≥‰∏âËßíÂΩ¢ (${vowels.length}Èü≥)</div>
    <div class="phon-chart-body">
      <svg class="vt-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <style>.vt-phoneme{font-size:13px;font-family:monospace;font-weight:700;fill:#8c7eff}.vt-phoneme-circle{fill:rgba(140,126,255,0.12);stroke:rgba(140,126,255,0.4);stroke-width:1.5}.vt-label{font-size:9px;fill:#44404e;font-family:sans-serif}.vt-axis{stroke:rgba(140,120,255,0.2);stroke-width:1;fill:none}</style>
        </defs>
        <!-- Triangle -->
        <polygon points="${pts.map(p=>p.x+','+p.y).join(' ')}" fill="none" stroke="rgba(140,120,255,0.18)" stroke-width="1.5" stroke-dasharray="4,3"/>
        <!-- Axis labels -->
        <text class="vt-label" x="${pts[0].x-2}" y="${pts[0].y-5}" text-anchor="middle">ÂâçËàå„ÉªÈ´ò</text>
        <text class="vt-label" x="${pts[1].x+2}" y="${pts[1].y-5}" text-anchor="middle">ÂæåËàå„ÉªÈ´ò</text>
        <text class="vt-label" x="${pts[2].x}" y="${pts[2].y+10}" text-anchor="middle">‰Ωé</text>
        <!-- Mid lines -->
        <line class="vt-axis" x1="${(pts[0].x+pts[1].x)/2}" y1="${(pts[0].y+pts[1].y)/2}" x2="${pts[2].x}" y2="${pts[2].y}" stroke-dasharray="3,4"/>
        ${svgDots}
      </svg>
    </div>
  </div>`;
}

function buildConsonantChart(cons){
  // Ë°®Á§∫„Åô„ÇãË™øÈü≥ÈÉ®‰Ωç„ÉªË™øÈü≥ÊßòÂºèÔºàÁ∞°Áï•ÁâàÔºâ
  const places=['‰∏°Âîá','ÂîáÊ≠Ø','Ê≠ØÈñì','Ê≠ØËåé','ÂæåÈÉ®Ê≠ØËåé','Á°¨Âè£Ëìã','ËªüÂè£Ëìã','Âè£ËìãÂûÇ','Â£∞ÈñÄ'];
  const manners=['Á†¥Ë£Ç','ÈºªÈü≥','„Åµ„Çã„Åà','„ÅØ„Åò„Åç','Êë©Êì¶','Êé•Ëøë','ÂÅ¥Èù¢Êé•Ëøë'];
  // cons„Åå„Å©„ÅÆ„Çª„É´„Å´Â±û„Åô„Çã„ÅãÈÄÜÂºï„Åç
  const cellOf = {};
  Object.entries(IPA_CONSONANTS.cells).forEach(([key,pair])=>{
    const [pl,mn] = [key.slice(0, key.length - mn_len(key)), key.slice(key.length - mn_len(key))];
    // simpler: iterate known
  });
  // Build quick lookup: phoneme -> {place, manner, voiced}
  const lookup = {};
  IPA_CONSONANTS.rows.forEach(r=>{
    IPA_CONSONANTS.cols.forEach(c=>{
      const key=r+c;
      const pair=IPA_CONSONANTS.cells[key]||['',''];
      if(pair[0]) lookup[pair[0]]={place:r,manner:c,voiced:false};
      if(pair[1]) lookup[pair[1]]={place:r,manner:c,voiced:true};
    });
  });

  const usedPlaces = [...new Set(cons.map(c=>lookup[c]?.place).filter(Boolean))];
  const usedManners = [...new Set(cons.map(c=>lookup[c]?.manner).filter(Boolean))];
  const unknownCons = cons.filter(c=>!lookup[c]);

  if(!usedPlaces.length && !unknownCons.length){
    return `<div class="phon-chart-card"><div class="phon-chart-header">Â≠êÈü≥‰ΩìÁ≥ª (${cons.length}Èü≥)</div><div class="phon-chart-body"><p style="font-size:0.75rem;color:var(--text-muted);padding:10px 0">„ÉÅ„É£„Éº„Éà„Å´Ë©≤ÂΩìÈü≥„Å™„Åó</p></div></div>`;
  }

  let rows='';
  usedManners.forEach(m=>{
    let cells='';
    usedPlaces.forEach(p=>{
      const vl=cons.find(c=>lookup[c]?.place===p&&lookup[c]?.manner===m&&!lookup[c]?.voiced);
      const vd=cons.find(c=>lookup[c]?.place===p&&lookup[c]?.manner===m&&lookup[c]?.voiced);
      if(vl||vd){
        cells+=`<td style="border:1px solid var(--border);padding:4px 6px;text-align:center">
          ${vl?`<span style="font-family:monospace;color:var(--accent);font-size:0.85rem;font-weight:700">${vl}</span>`:''}
          ${vl&&vd?'&thinsp;':''} 
          ${vd?`<span style="font-family:monospace;color:var(--accent2);font-size:0.85rem;font-weight:700">${vd}</span>`:''}
        </td>`;
      } else {
        cells+=`<td style="border:1px solid var(--border);padding:4px 6px;background:var(--surface-3)"></td>`;
      }
    });
    rows+=`<tr><th style="border:1px solid var(--border);padding:4px 8px;text-align:left;font-size:0.62rem;color:var(--text-muted);background:var(--surface-3);white-space:nowrap">${m}</th>${cells}</tr>`;
  });

  const placeHeaders = usedPlaces.map(p=>`<th style="border:1px solid var(--border);padding:4px 6px;font-size:0.6rem;color:var(--text-muted);background:var(--surface-3);text-align:center;white-space:nowrap">${p}</th>`).join('');

  const unknownHtml = unknownCons.length
    ? `<div style="margin-top:8px;font-size:0.7rem;color:var(--text-muted)">„Åù„ÅÆ‰ªñ: <span style="font-family:monospace;color:var(--accent)">${unknownCons.join(' ')}</span></div>`
    : '';

  return `<div class="phon-chart-card">
    <div class="phon-chart-header">Â≠êÈü≥‰ΩìÁ≥ª (${cons.length}Èü≥) ‚Äî <span style="color:var(--accent)">ÁÑ°Â£∞</span> / <span style="color:var(--accent2)">ÊúâÂ£∞</span></div>
    <div class="phon-chart-body" style="overflow-x:auto">
      <table style="border-collapse:collapse;font-size:0.78rem;width:100%">
        <thead><tr><th style="border:1px solid var(--border);padding:4px 8px;background:var(--surface-3)"></th>${placeHeaders}</tr></thead>
        <tbody>${rows}</tbody>
      </table>
      ${unknownHtml}
      <div style="margin-top:8px;font-size:0.6rem;color:var(--text-muted)">‚Äª ÁÑ°Â£∞=Â∑¶„ÄÅÊúâÂ£∞=Âè≥</div>
    </div>
  </div>`;
}

// Helper: get manner string length from IPA_CONSONANTS key
function mn_len(key){
  const manners=IPA_CONSONANTS.cols;
  for(const m of manners.slice().sort((a,b)=>b.length-a.length)){if(key.endsWith(m))return m.length}
  return 0;
}
function savePhoneme(){const vB=document.querySelectorAll('#ptab-v .phoneme-btn.selected'),cB=document.querySelectorAll('#ptab-c .phoneme-btn.selected');S.phoneme.vowels=[...vB].map(b=>b.textContent.trim());S.phoneme.consonants=[...cB].map(b=>b.textContent.trim());const as=document.querySelector('[onclick*="pacc"].selected .opt-label');if(as)S.phoneme.accent=as.textContent;// Derive syllable type from slots if set
if(S.syllableSlots.length){S.phoneme.syllable=S.syllableSlots.join('')}else{const ss=document.querySelector('[onclick*="psyll"].selected .opt-label');if(ss)S.phoneme.syllable=ss.textContent}S.done.phoneme=S.phoneme.vowels.length>0;// refresh mini keyboard in vocab if open
const mkb=document.getElementById('word-mini-kb');if(mkb)mkb.innerHTML=buildMiniIPAKeyboard('word-cl');scheduleSave()}

function generateSyllables(){
  const icon=document.getElementById('gen-spin');if(icon){icon.textContent='‚ü≥';icon.classList.add('spinning')}
  setTimeout(()=>{
    if(icon){icon.classList.remove('spinning');icon.textContent='‚ú¶'}
    const V=S.phoneme.vowels.length?S.phoneme.vowels:['a','e','i'];
    const C=S.phoneme.consonants.length?S.phoneme.consonants:['k','n','r','s','l'];
    const patterns={'CVÂûã':(n)=>{let w='';for(let i=0;i<n;i++)w+=C[Math.floor(Math.random()*C.length)]+V[Math.floor(Math.random()*V.length)];return w},'CVCÂûã':(n)=>{let w='';for(let i=0;i<n;i++){w+=C[Math.floor(Math.random()*C.length)]+V[Math.floor(Math.random()*V.length)];if(Math.random()>.4)w+=C[Math.floor(Math.random()*C.length)];}return w},'VÂûã„ÇÇÂèØ':(n)=>{let w='';for(let i=0;i<n;i++){if(Math.random()>.5)w+=C[Math.floor(Math.random()*C.length)];w+=V[Math.floor(Math.random()*V.length)];}return w},'CCVCÂûã':(n)=>{let w='';for(let i=0;i<n;i++)w+=C[Math.floor(Math.random()*C.length)]+C[Math.floor(Math.random()*C.length)]+V[Math.floor(Math.random()*V.length)]+C[Math.floor(Math.random()*C.length)];return w}};
    const fn=patterns[S.phoneme.syllable]||patterns['CVÂûã'];
    const words=Array.from({length:10},()=>fn(1+Math.floor(Math.random()*2)));
    const el=document.getElementById('generated-words');
    if(el)el.innerHTML=words.map(w=>`<div class="gen-word-chip" onclick="promptAddWord('${w}')"><span>${w}</span><span>+</span></div>`).join('');
  },800);
}
function previewSylInScript(){const v=document.getElementById('syl-test')?.value;const r=document.getElementById('syl-script-result');if(r&&v)r.textContent=applyScriptMap(v)||v}
function promptAddWord(w){const meaning=prompt(t('v_word_jp_label')+' "'+w+'"','');if(meaning&&meaning.trim()){addDict(w,meaning.trim(),t('v_pos_noun'));updateDashboard();alert(`"${w} = ${meaning}" ‚Üí ${t('v_add_dict_btn').replace(' +','')}`)}}

// ===== GRAMMAR =====
function buildGrammar(){
  const orders=[
    ['SOV','ÁßÅ„Åå „Çä„Çì„Åî„Çí È£ü„Åπ„Çã','üáØüáµüá∞üá∑'],
    ['SVO','I eat apple','üá¨üáßüá®üá≥'],
    ['VSO','Eat I apple','üá∏üá¶üáÆüá™'],
    ['Ëá™Áî±Ë™ûÈ†Ü','Ê†ºÂ§âÂåñ„ÅßÁ§∫„Åô','üèõ']
  ];
  const cases=[['„Å™„Åó','Ë™ûÈ†Ü„ÅßÁ§∫„Åô'],['2Ê†º','‰∏ª„ÉªÂØæÊ†º'],['4Ê†º','‰∏ª„ÉªÂØæ„Éª‰∏é„ÉªÂ±û'],['6Ê†º+','‰∏äÁ¥ö']];
  const verbs=[['„Å™„ÅóÔºà‰∏çÂ§âÔºâ','Âä©Ë©û„ÅßÂ§â„Åà„Çã'],['‰∫∫Áß∞Â§âÂåñ','‰∏ªË™û„ÅßÂ§âÂåñ'],['ÊôÇÂà∂Â§âÂåñ','ÊôÇÈñì„ÅßÂ§âÂåñ'],['‰∏°Êñπ„ÅÇ„Çä','‰∫∫Áß∞√óÊôÇÂà∂']];
  const tenses=['ÁèæÂú®','ÈÅéÂéª','Êú™Êù•','ÂÆå‰∫ÜÂΩ¢','ÊôÇÂà∂„Å™„Åó'];
  const patternCats=['ÊôÇÈñì','ÈÄ≤Ë°å','Â∏åÊúõ','ÊÑèÂøó','Áæ©Âãô','Êé®Ê∏¨','Êú™Êù•','Âê¶ÂÆö','ÁñëÂïè','„Ç¢„Çπ„Éö„ÇØ„Éà'];
  const patternsHtml=renderPatternsHtml();
  return`
  ${buildAssistPanel('grammar')}
  <div class="editor-tabs" style="overflow-x:auto;white-space:nowrap;scrollbar-width:none">
    <div class="editor-tab active" onclick="switchTab(this,'gtab-o')">${t('g_tab_order')} ${helpBtn('Ë™ûÈ†Ü')} ${helpBtn('Ê†ºÔºà„Åã„ÅèÔºâ')}</div>
    <div class="editor-tab" onclick="switchTab(this,'gtab-v')">${t('g_tab_verb')}</div>
    <div class="editor-tab" onclick="switchTab(this,'gtab-p')">${t('g_tab_pattern')} ${helpBtn('Êé•È†≠Ëæû„ÉªÊé•Â∞æËæû')}</div>
    <div class="editor-tab" onclick="switchTab(this,'gtab-mx')">${t('g_tab_matrix')} ${helpBtn('Ê†ºÂ§âÂåñ„Éû„Éà„É™„ÉÉ„ÇØ„Çπ')}</div>
    <div class="editor-tab" onclick="switchTab(this,'gtab-roadmap')" style="color:var(--gold)">${t('g_tab_roadmap')}</div>
    <div class="editor-tab" onclick="switchTab(this,'gtab-notes')">${t('g_tab_notes')}</div>
  </div>

  <!-- ORDER & CASES -->
  <div class="tab-content active" id="gtab-o">
    <div class="field-block"><span class="field-label">${t('g_word_order')} ${helpBtn('Ë™ûÈ†Ü')}</span>
      <div class="select-grid">${orders.map(([o,ex,flag])=>`<div class="select-option ${S.grammar.order===o?'selected':''}" onclick="selOne(this,'go','${o}');saveGrammar()"><div class="opt-label">${o}</div><div class="opt-sub">${ex}<br><span style="font-size:0.7rem">${flag}</span></div></div>`).join('')}</div>
    </div>
    <div class="field-block"><span class="field-label">${t('g_cases')} ${helpBtn('Ê†ºÔºà„Åã„ÅèÔºâ')}</span>
      <div class="select-grid select-grid-2">${cases.map(([l,d])=>`<div class="select-option ${S.grammar.cases===l?'selected':''}" onclick="selOne(this,'gc','${l}');rebuildMatrix()"><div class="opt-label">${l}</div><div class="opt-sub">${d}</div></div>`).join('')}</div>
    </div>
    <div class="field-block"><span class="field-label">${t('g_gender')} ${helpBtn('Â•≥ÊÄßË©û')}</span>
      <div class="toggle-grid">${['Áî∑Â•≥ÊÄß','‰∏≠ÊÄß','ÂçòË§áÊï∞','ÂèåÊï∞','„Å™„Åó'].map(tg=>`<div class="toggle-chip ${(S.grammar.gender||[]).includes(tg)?'selected':''}" onclick="toggleChip(this)">${tg}</div>`).join('')}</div>
    </div>
  </div>

  <!-- VERB & TENSE -->
  <div class="tab-content" id="gtab-v">
    <div class="field-block"><span class="field-label">${t('g_verb_conj')}</span>
      <div class="select-grid select-grid-2">${verbs.map(([l,d])=>`<div class="select-option ${S.grammar.verbConj===l?'selected':''}" onclick="selOne(this,'gv','${l}');saveGrammar()"><div class="opt-label">${l}</div><div class="opt-sub">${d}</div></div>`).join('')}</div>
    </div>
    <div class="field-block"><span class="field-label">${t('g_tense')}</span>
      <div class="toggle-grid">${tenses.map(tg=>`<div class="toggle-chip ${(S.grammar.tense||[]).includes(tg)?'selected':''}" onclick="toggleChip(this)">${tg}</div>`).join('')}</div>
      <p class="field-hint">${t('g_tense_hint')}</p>
    </div>
  </div>

  <!-- PATTERNS -->
  <div class="tab-content" id="gtab-p">
    <div class="tip-card">
      <div class="tip-card-title">üí° ${t('g_pattern_what')}</div>
      <div class="tip-card-body">${t('g_pattern_desc')} ${helpBtn('Êé•È†≠Ëæû„ÉªÊé•Â∞æËæû')} ${helpBtn('Êé•Ëæû„Ç∑„Çπ„ÉÜ„É†')}</div>
    </div>
    <div id="patterns-list">${patternsHtml}</div>
    <div style="background:var(--surface-2);border:1px solid var(--border);border-radius:12px;padding:18px;margin-top:12px">
      <span class="field-label" style="margin-bottom:12px;display:block">‚ú¶ ${t('g_pattern_add')}</span>
      <div style="margin-bottom:14px">
        <span style="font-size:0.68rem;color:var(--text-muted);display:block;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.06em">${t('g_pattern_type_label')}</span>
        <div class="select-grid select-grid-4" id="pat-type-grid" style="gap:6px">
          <div class="select-option selected" id="ptype-suffix" onclick="selectPatType('suffix',this)" style="padding:8px"><div class="opt-label" style="font-size:0.75rem">Êé•Â∞æËæû</div><div class="opt-sub" style="font-size:0.6rem">Ë™ûÂ∞æ„Å´ËøΩÂä†<br>-vel, -ael</div></div>
          <div class="select-option" id="ptype-prefix" onclick="selectPatType('prefix',this)" style="padding:8px"><div class="opt-label" style="font-size:0.75rem">Êé•È†≠Ëæû</div><div class="opt-sub" style="font-size:0.6rem">Ë™ûÈ†≠„Å´ËøΩÂä†<br>al-, un-</div></div>
          <div class="select-option" id="ptype-infix" onclick="selectPatType('infix',this)" style="padding:8px"><div class="opt-label" style="font-size:0.75rem">Êé•‰∏≠Ëæû</div><div class="opt-sub" style="font-size:0.6rem">Ë™û‰∏≠„Å´ÊåøÂÖ•<br>-um-</div></div>
          <div class="select-option" id="ptype-mutation" onclick="selectPatType('mutation',this)" style="padding:8px"><div class="opt-label" style="font-size:0.75rem">Ë™ûÊ†πÂ§âÂåñ</div><div class="opt-sub" style="font-size:0.6rem">ÊØçÈü≥Â§âÂåñ<br>a‚Üíe</div></div>
          <div class="select-option" id="ptype-tone" onclick="selectPatType('tone',this)" style="padding:8px"><div class="opt-label" style="font-size:0.75rem">Èü≥Ë™øÂ§âÂåñ</div><div class="opt-sub" style="font-size:0.6rem">È´ò‰Ωé„ÅßÂå∫Âà•<br>È´òÂ£∞=ÁñëÂïè</div></div>
          <div class="select-option" id="ptype-circumfix" onclick="selectPatType('circumfix',this)" style="padding:8px"><div class="opt-label" style="font-size:0.75rem">Áí∞Â¢ÉÊé•Ëæû</div><div class="opt-sub" style="font-size:0.6rem">ÂâçÂæåÂêåÊôÇ<br>ge-„Äú-t</div></div>
          <div class="select-option" id="ptype-reduplication" onclick="selectPatType('reduplication',this)" style="padding:8px"><div class="opt-label" style="font-size:0.75rem">ÈáçË§áÂΩ¢</div><div class="opt-sub" style="font-size:0.6rem">Áπ∞„ÇäËøî„Åó<br>sol-sol</div></div>
          <div class="select-option" id="ptype-particle" onclick="selectPatType('particle',this)" style="padding:8px"><div class="opt-label" style="font-size:0.75rem">Âä©Ë©û„ÉªÂä©ÂãïË©û</div><div class="opt-sub" style="font-size:0.6rem">Âà•Ë™û„ÇíÊ∑ª„Åà„Çã<br>li, ka</div></div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
        <div><span style="font-size:0.68rem;color:var(--text-muted);display:block;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.06em" id="pat-form-label">${t('g_form')}ÔºàÊé•Â∞æËæûÔºâ</span><input class="input-field" placeholder="-ael  -van" id="pat-form" style="font-family:monospace"></div>
        <div><span style="font-size:0.68rem;color:var(--text-muted);display:block;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.06em">${t('g_meaning_fn')}</span><input class="input-field" placeholder="„Äú„Åó„Åü„ÅÑ" id="pat-meaning"></div>
      </div>
      <div style="margin-bottom:10px"><span style="font-size:0.68rem;color:var(--text-muted);display:block;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.06em">${t('g_example_opt')}</span><input class="input-field" placeholder="‰æãÔºösol ‚Üí solaelÔºàÂ§™ÈôΩ„ÅÆÔºâ" id="pat-example"></div>
      <div style="margin-bottom:12px"><span style="font-size:0.68rem;color:var(--text-muted);display:block;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.06em">${t('g_category')}</span><div class="toggle-grid">${patternCats.map(cat=>`<div class="toggle-chip" onclick="selPatCat(this)">${cat}</div>`).join('')}</div></div>
      <button class="btn btn-primary btn-sm" onclick="addPattern()" style="width:100%;justify-content:center">${t('btn_add')}</button>
    </div>
    <div class="ai-box" style="margin-top:12px">
      <div class="ai-label">‚ú¶ AIÊèêÊ°à</div><div class="ai-content">Èü≥Èüª„Éª‰∏ñÁïåË¶≥„Å´Âêà„Å£„Åü„Éë„Çø„Éº„É≥„ÇíËá™ÂãïÁîüÊàê</div>
      <div class="ai-chips">
        <div class="ai-chip" onclick="suggestPatterns()">${t('g_suggest_suffix')}</div>
        <div class="ai-chip" onclick="suggestPrefixPatterns()">${t('g_suggest_prefix')}</div>
        <div class="ai-chip" onclick="suggestParticlePatterns()">${t('g_suggest_particle')}</div>
      </div>
    </div>
  </div>

  <!-- INFLECTION MATRIX -->
  <div class="tab-content" id="gtab-mx">
    <p style="font-size:0.82rem;color:var(--text-secondary);margin-bottom:12px;line-height:1.7;font-style:italic">${t('g_mat_hint')}</p>
    <div class="ai-box" style="margin-bottom:14px;border-color:var(--accent-border)"><div class="ai-label">üí° „Ç¨„Ç§„Éâ</div><div class="ai-content">„Åæ„ÅöÊ†º„Å®Êï∞„ÉªÊÄß„ÇíÈÅ∏„Çì„Åß„ÄåüîÑ Ë°®„ÇíÂÜçÁîüÊàê„Äç„ÄÇË™ûÊ†π„ÇíÂÖ•Âäõ„Åó„Å¶„Äå‚ú¶ Ë™ûÂ∞æËá™ÂãïË£úÂÆå„Äç„ÇíÊäº„Åô„Å®Ëá™ÂãïÂÖ•Âäõ„Åï„Çå„Åæ„Åô„ÄÇ</div></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px">
      <div style="flex:1;min-width:200px"><div class="field-label">${t('g_add_row')}</div><div class="matrix-add" id="matrix-rows-sel">${['‰∏ªÊ†º','ÂØæÊ†º','‰∏éÊ†º','Â±ûÊ†º','ÂÖ∑Ê†º','Â•™Ê†º','Âá¶Ê†º','ÂëºÊ†º'].map(r=>`<div class="matrix-chip-sel ${(S.grammar.matrix.rows||[]).includes(r)?'active':''}" onclick="toggleMatrixRow(this,'${r}')">${r}</div>`).join('')}</div></div>
      <div style="flex:1;min-width:200px"><div class="field-label">${t('g_add_col')}</div><div class="matrix-add" id="matrix-cols-sel">${['ÂçòÊï∞','Ë§áÊï∞','ÂèåÊï∞','Áî∑ÊÄß','Â•≥ÊÄß','‰∏≠ÊÄß'].map(col=>`<div class="matrix-chip-sel ${(S.grammar.matrix.cols||[]).includes(col)?'active':''}" onclick="toggleMatrixCol(this,'${col}')">${col}</div>`).join('')}</div></div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center">
      <div style="flex:1;min-width:160px"><span style="font-size:0.68rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:5px">${t('g_root_label')}</span>
        <div style="display:flex;gap:6px"><input class="input-field" id="matrix-root" placeholder="‰æãÔºökali-" style="flex:1;font-family:monospace"><button class="btn btn-sm btn-gold" onclick="autoFillMatrix()">${t('g_auto_fill')}</button></div>
      </div>
    </div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">
      <button class="btn btn-primary btn-sm" onclick="rebuildMatrix()">${t('g_regen')}</button>
      <button class="btn btn-sm" onclick="fillMatrixSample()">${t('g_sample')}</button>
      <button class="btn btn-sm" style="color:var(--rose)" onclick="clearMatrix()">${t('g_clear_mat')}</button>
    </div>
    <div class="matrix-wrap" id="matrix-wrap"></div>
    <div class="matrix-preview-wrap" id="matrix-preview-wrap" style="display:none"></div>
  </div>

  <!-- ROADMAP (NEW V13) -->
  <div class="tab-content" id="gtab-roadmap">
    ${buildGrammarRoadmap()}
  </div>

  <!-- NOTES -->
  <div class="tab-content" id="gtab-notes">
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">
      <button class="btn btn-sm" onclick="mdInsert('**','**','gtab-md-area')"><b>B</b></button>
      <button class="btn btn-sm" onclick="mdInsert('*','*','gtab-md-area')"><i>I</i></button>
      <button class="btn btn-sm" onclick="mdInsertLine('## ','gtab-md-area')">H2</button>
      <button class="btn btn-sm" onclick="mdInsertLine('### ','gtab-md-area')">H3</button>
      <button class="btn btn-sm" onclick="mdInsertLine('- ','gtab-md-area')">„É™„Çπ„Éà</button>
      <button class="btn btn-sm" onclick="mdInsertLine('> ','gtab-md-area')">ÂºïÁî®</button>
    </div>
    <div class="md-editor-wrap">
      <div class="md-tabs">
        <div class="md-tab active" onclick="switchMdTab(this,'gtab-md-area','gtab-md-preview',false)">Á∑®ÈõÜ</div>
        <div class="md-tab" onclick="switchMdTab(this,'gtab-md-area','gtab-md-preview',true)">„Éó„É¨„Éì„É•„Éº</div>
      </div>
      <textarea class="md-textarea textarea-field" id="gtab-md-area" placeholder="${t('g_notes_placeholder')||'# ÊñáÊ≥ïÊõ∏'}" oninput="saveGrammar()">${S.grammarNotes||''}</textarea>
      <div class="md-preview" id="gtab-md-preview"></div>
    </div>
    <button class="btn btn-primary btn-sm" onclick="saveGrammar()" style="margin-top:10px">${t('btn_save')}</button>
  </div>
  `;
}

// ‚îÄ‚îÄ‚îÄ Grammar Roadmap ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPatternsHtml(){
  const typeColor={suffix:'var(--accent)',prefix:'var(--accent2)',infix:'var(--gold)',mutation:'var(--success)',tone:'var(--rose)',circumfix:'var(--accent)',reduplication:'var(--gold)',particle:'var(--accent2)'};
  const typeLabel={suffix:'Êé•Â∞æËæû',prefix:'Êé•È†≠Ëæû',infix:'Êé•‰∏≠Ëæû',mutation:'Ë™ûÊ†πÂ§âÂåñ',tone:'Èü≥Ë™ø',circumfix:'Áí∞Â¢ÉÊé•Ëæû',reduplication:'ÈáçË§áÂΩ¢',particle:'Âä©Ë©û'};
  return S.grammar.patterns.map((p,i)=>{
    const tc=typeColor[p.type||'suffix']||'var(--accent)';
    const tl=typeLabel[p.type||'suffix']||p.type||'Êé•Â∞æËæû';
    return`<div class="pattern-card">
      <span class="pattern-form" style="color:${tc}">${p.suffix}</span>
      <span style="font-size:0.58rem;background:${tc}20;color:${tc};border:1px solid ${tc}44;border-radius:4px;padding:1px 6px">${tl}</span>
      <span class="pattern-meaning">${p.meaning}</span>
      ${p.example?`<span style="font-size:0.68rem;color:var(--text-muted);font-style:italic">${p.example}</span>`:''}
      <span class="pattern-category">${p.category}</span>
      <button class="pattern-delete" onclick="deletePattern(${i})">‚úï</button>
    </div>`;
  }).join('')||`<p style="font-size:0.78rem;color:var(--text-muted);padding:12px 0;font-style:italic">„Åæ„Å†„Éë„Çø„Éº„É≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ‰∏ã„ÅÆ„Éï„Ç©„Éº„É†„ÅßËøΩÂä†„Åó„Å¶„Åø„Çà„ÅÜÔºÅ</p>`;
}

// ‚îÄ‚îÄ‚îÄ Pattern CRUD (V13) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _currentPatType='suffix';
function selectPatType(type,el){
  _currentPatType=type;
  document.querySelectorAll('#pat-type-grid .select-option').forEach(e=>e.classList.remove('selected'));
  el.classList.add('selected');
  const labels={suffix:t('gp_form_suffix')||'ÂΩ¢ÔºàÊé•Â∞æËæûÔºâ',prefix:t('gp_form_prefix')||'ÂΩ¢ÔºàÊé•È†≠ËæûÔºâ',infix:t('gp_form_infix')||'ÂΩ¢ÔºàÊé•‰∏≠ËæûÔºâ',mutation:t('gp_form_mutation')||'ÊØçÈü≥„ÅÆÂ§âÂåñ',tone:t('gp_form_tone')||'Èü≥Ë™ø„É´„Éº„É´',circumfix:t('gp_form_circumfix')||'ÂâçÈÉ®„ÉªÂæåÈÉ®',reduplication:t('gp_form_reduplication')||'Áπ∞„ÇäËøî„ÅóÊñπ',particle:t('gp_form_particle')||'Âä©Ë©û„ÅÆÂΩ¢'};
  const ph={suffix:'-ael  -van',prefix:'al-  un-',infix:'-um-',mutation:'a‚Üíe',tone:'‚Üëhigh ‚Üìlow',circumfix:'ge-~-t',reduplication:'word+word',particle:'li  ka  el'};
  const lbl=document.getElementById('pat-form-label');
  const frm=document.getElementById('pat-form');
  if(lbl)lbl.textContent=labels[type]||(t('gp_form_label')||'ÂΩ¢');
  if(frm)frm.placeholder=ph[type]||(t('gp_enter_hint')||'Enter‚Ä¶');
}
function addPattern(){
  const form=(document.getElementById('pat-form')?.value||'').trim();
  const m=(document.getElementById('pat-meaning')?.value||'').trim();
  const ex=(document.getElementById('pat-example')?.value||'').trim();
  const ce=document.querySelector('#gtab-p .toggle-chip.selected');
  const cat=ce?.textContent||(t('gp_category_default')||'ÊñáÊ≥ï');
  if(!form||!m)return;
  S.grammar.patterns.push({suffix:form,type:_currentPatType,meaning:m,category:cat,example:ex});
  ['pat-form','pat-meaning','pat-example'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  if(ce)ce.classList.remove('selected');
  // Re-render the list in-place
  const listEl=document.getElementById('patterns-list');
  if(listEl)listEl.innerHTML=renderPatternsHtml();
  scheduleSave();
}
function deletePattern(i){
  S.grammar.patterns.splice(i,1);
  const listEl=document.getElementById('patterns-list');
  if(listEl)listEl.innerHTML=renderPatternsHtml();
  scheduleSave();
}
function selPatCat(el){el.closest('.toggle-grid').querySelectorAll('.toggle-chip').forEach(c=>c.classList.remove('selected'));el.classList.add('selected')}

function suggestPatterns(){
  const v0=S.phoneme.vowels[0]||'a';const v1=S.phoneme.vowels[1]||'i';const v2=S.phoneme.vowels[2]||'u';const c0=S.phoneme.consonants[0]||'l';
  const s=[
    {suffix:`-${v0}${c0}`,type:'suffix',meaning:'„Äú„Åó„Å¶„ÅÑ„ÇãÔºàÈÄ≤Ë°åÔºâ',category:'ÈÄ≤Ë°å',example:''},
    {suffix:`-${v1}r${v0}n`,type:'suffix',meaning:'„Äú„Åó„Åü„ÅÑÔºàÂ∏åÊúõÔºâ',category:'Â∏åÊúõ',example:''},
    {suffix:`-${v0}s${v1}l`,type:'suffix',meaning:'„Äú„Åô„ÇãÂâç„Å´ÔºàÊôÇÈñìÔºâ',category:'ÊôÇÈñì',example:''},
    {suffix:`-${v2}n${v0}r`,type:'suffix',meaning:'„Äú„Åó„Å™„Åë„Çå„Å∞ÔºàÁæ©ÂãôÔºâ',category:'Áæ©Âãô',example:''},
  ];
  s.forEach(p=>{if(!S.grammar.patterns.find(x=>x.suffix===p.suffix))S.grammar.patterns.push(p)});
  const listEl=document.getElementById('patterns-list');
  if(listEl)listEl.innerHTML=renderPatternsHtml();
  scheduleSave();
}
function suggestPrefixPatterns(){
  const v0=S.phoneme.vowels[0]||'a';const c0=S.phoneme.consonants[0]||'l';const c1=S.phoneme.consonants[1]||'n';
  const s=[
    {suffix:`${c0}${v0}-`,type:'prefix',meaning:'‰∏ç„Äú„ÉªÂèç„ÄúÔºàÂê¶ÂÆöÔºâ',category:'Âê¶ÂÆö',example:''},
    {suffix:`s${v0}${c1}-`,type:'prefix',meaning:'ÂÜç„ÄúÔºàÁπ∞„ÇäËøî„ÅóÔºâ',category:'ÂèçÂæ©',example:''},
    {suffix:`${c1}${v0}l-`,type:'prefix',meaning:'Ë∂Ö„Äú„Éª„Å®„Å¶„ÇÇÔºàÂº∑Ë™øÔºâ',category:'Á®ãÂ∫¶',example:''},
    {suffix:`${c0}${v0}${c0}-`,type:'prefix',meaning:'Âè§„ÅÑ„ÄúÔºàÊôÇÈñìÔºâ',category:'ÊôÇÈñì',example:''},
  ];
  s.forEach(p=>{if(!S.grammar.patterns.find(x=>x.suffix===p.suffix))S.grammar.patterns.push(p)});
  const listEl=document.getElementById('patterns-list');
  if(listEl)listEl.innerHTML=renderPatternsHtml();
  scheduleSave();
}
function suggestParticlePatterns(){
  const v=S.phoneme.vowels[0]||'a';const c=S.phoneme.consonants[0]||'l';
  const s=[
    {suffix:`${c}${v}`,type:'particle',meaning:t('sp_topic'),category:t('sp_cat_gram'),example:''},
    {suffix:`${c}i`,type:'particle',meaning:t('sp_acc'),category:t('sp_cat_gram'),example:''},
    {suffix:`${c}en`,type:'particle',meaning:t('sp_conj'),category:t('sp_cat_gram'),example:''},
    {suffix:`${c}${v}${c}`,type:'particle',meaning:t('sp_q'),category:t('sp_cat_q'),example:''},
  ];
  s.forEach(p=>{if(!S.grammar.patterns.find(x=>x.suffix===p.suffix))S.grammar.patterns.push(p)});
  const listEl=document.getElementById('patterns-list');
  if(listEl)listEl.innerHTML=renderPatternsHtml();
  scheduleSave();
}

function buildGrammarRoadmap(){
  const L=S.lang||'ja';
  // Each step: icon, titles[4langs], desc[4langs], example[4langs], doneCheck, tab
  const steps=[
    // STEP 1
    {s:1,icon:'üìê',
     title:{ja:'Ë™ûÈ†Ü„ÇíÊ±∫„ÇÅ„Çã',en:'Set word order',zh:'Á°ÆÂÆöËØ≠Â∫è',es:'Definir orden de palabras'},
     desc:{ja:'SOVÔºàÊó•Êú¨Ë™ûÔºâ„ÉªSVOÔºàËã±Ë™ûÔºâ„ÉªVSOÔºà„Ç¢„É©„Éì„Ç¢Ë™ûÔºâ„Åã„ÇâÈÅ∏„Åº„ÅÜ„ÄÇ„Åì„Çå„ÅåË®ÄË™û„ÅÆÈ™®Ê†ºÔºÅ',
           en:'Pick SOV (Japanese), SVO (English), or VSO (Arabic). This is your language\'s skeleton!',
           zh:'ÈÄâÊã©SOVÔºàÊó•ËØ≠Ôºâ„ÄÅSVOÔºàËã±ËØ≠ÔºâÊàñVSOÔºàÈòøÊãâ‰ºØËØ≠Ôºâ„ÄÇËøôÊòØËØ≠Ë®ÄÁöÑÈ™®Êû∂ÔºÅ',
           es:'Elige SOV (japon√©s), SVO (ingl√©s) o VSO (√°rabe). ¬°Es el esqueleto de tu lengua!'},
     ex:{ja:'ÁßÅ„ÅåÔºàSÔºâÊ∞¥„ÇíÔºàOÔºâÈ£≤„ÇÄÔºàVÔºâ‚Üí SOV\nIÔºàSÔºâdrinkÔºàVÔºâwaterÔºàOÔºâ‚Üí SVO',
         en:'ÁßÅ„Åå(S)Ê∞¥„Çí(O)È£≤„ÇÄ(V) ‚Üí SOV\nI(S) drink(V) water(O) ‚Üí SVO',
         zh:'ÊàëÔºàSÔºâÂñùÔºàVÔºâÊ∞¥ÔºàOÔºâ‚Üí SVO\nÁßÅ„ÅåÔºàSÔºâÊ∞¥„ÇíÔºàOÔºâÈ£≤„ÇÄÔºàVÔºâ‚Üí SOV',
         es:'Yo(S) bebo(V) agua(O) ‚Üí SVO\nÁßÅ„Åå(S)Ê∞¥„Çí(O)È£≤„ÇÄ(V) ‚Üí SOV'},
     done:!!S.grammar.order, tab:'gtab-o'},
    {s:1,icon:'üìñ',
     title:{ja:'Âü∫Êú¨Ë™ûÂΩô10Ë™û„Çí‰Ωú„Çã',en:'Create 10 basic words',zh:'ÂàõÂª∫10‰∏™Âü∫Êú¨ËØçÊ±á',es:'Crear 10 palabras b√°sicas'},
     desc:{ja:'ÁßÅ„ÉªÊ∞¥„ÉªÁ©∫„ÉªÂÖâ„ÉªÈ£ü„Åπ„Çã„ÉªÊ≠©„Åè„ÉªÁæé„Åó„ÅÑ„ÉªÂèãÈÅî‚Ä¶ „Çà„Åè‰Ωø„ÅÜË®ÄËëâ„Åã„ÇâÔºÅ',
           en:'I, water, sky, light, eat, walk, beautiful, friend‚Ä¶ start with the most common words!',
           zh:'Êàë„ÄÅÊ∞¥„ÄÅÂ§©Á©∫„ÄÅÂÖâ„ÄÅÂêÉ„ÄÅËµ∞„ÄÅÁæé‰∏Ω„ÄÅÊúãÂèã‚Ä¶‰ªéÊúÄÂ∏∏Áî®ÁöÑËØçÂºÄÂßãÔºÅ',
           es:'Yo, agua, cielo, luz, comer, caminar, hermoso, amigo‚Ä¶ ¬°empieza con las m√°s comunes!'},
     ex:{ja:'silvara=Ê∞¥  solen=Ê≠©„Åè  lumael=ÂÖâ\nimal√´=ÁßÅ  kaelo=Á©∫  mir√´=Áæé„Åó„ÅÑ',
         en:'silvara=water  solen=walk  lumael=light\nimal√´=I  kaelo=sky  mir√´=beautiful',
         zh:'silvara=Ê∞¥  solen=Ëµ∞  lumael=ÂÖâ\nimal√´=Êàë  kaelo=Â§©Á©∫  mir√´=Áæé‰∏Ω',
         es:'silvara=agua  solen=caminar  lumael=luz\nimal√´=yo  kaelo=cielo  mir√´=hermoso'},
     done:S.dictionary.length>=10, tab:'vocab'},
    {s:1,icon:'‚úç',
     title:{ja:'ÊúÄÂàù„ÅÆÊñá„ÇíÊõ∏„Åè',en:'Write your first sentence',zh:'ÂÜô‰∏ãÁ¨¨‰∏Ä‰∏™Âè•Â≠ê',es:'Escribir la primera oraci√≥n'},
     desc:{ja:'ÂçòË™û„Çí‰∏¶„Åπ„Å¶1Êñá‰Ωú„Å£„Å¶„Åø„Çà„ÅÜ„ÄÇ„Åù„Çå„Åå„ÅÇ„Å™„Åü„ÅÆË®ÄË™û„ÅÆË™ïÁîü„ÅÆÁû¨ÈñìÔºÅ',
           en:'Combine your words into one sentence. That\'s the birth of your language!',
           zh:'Â∞ÜÂçïËØçÁªÑÂêàÊàê‰∏Ä‰∏™Âè•Â≠ê„ÄÇÈÇ£Â∞±ÊòØ‰Ω†ËØ≠Ë®ÄËØûÁîüÁöÑÁû¨Èó¥ÔºÅ',
           es:'Combina palabras en una oraci√≥n. ¬°Ese es el nacimiento de tu lengua!'},
     ex:{ja:'"imal√´ silvara solen" ‚Üí ÁßÅ„ÅØÊ∞¥Ëæ∫„ÇíÊ≠©„Åè',
         en:'"imal√´ silvara solen" ‚Üí I walk along the water',
         zh:'"imal√´ silvara solen" ‚Üí ÊàëÂú®Ê∞¥ËæπË°åËµ∞',
         es:'"imal√´ silvara solen" ‚Üí Yo camino junto al agua'},
     done:S.corpus.length>=1, tab:'corpus'},
    // STEP 2
    {s:2,icon:'‚ûï',
     title:{ja:'Êé•Â∞æËæû„Çí1„Å§‰Ωú„Çã',en:'Create one suffix',zh:'ÂàõÂª∫‰∏Ä‰∏™ÂêéÁºÄ',es:'Crear un sufijo'},
     desc:{ja:'‰æãÔºö-el „ÅßÂΩ¢ÂÆπË©ûÂåñ„ÄÇsolÔºàÂ§™ÈôΩÔºâ‚Üí solelÔºàÂ§™ÈôΩ„ÅÆÔºâ„ÄÇË™ûÂΩô„Åå‰∏ÄÊ∞ó„Å´ÂÄçÂ¢óÔºÅ',
           en:'e.g. -el makes adjectives: sol(sun)‚Üísolel(sunny). Your vocab instantly doubles!',
           zh:'‰æãÂ¶Ç -el ÂΩ¢ÂÆπËØçÂåñÔºösolÔºàÂ§™Èò≥Ôºâ‚Üí solelÔºàÈò≥ÂÖâÁöÑÔºâ„ÄÇËØçÊ±áÈáèÁ´ãÂàªÁøªÂÄçÔºÅ',
           es:'Ej. -el hace adjetivos: sol‚Üísolel(solar). ¬°Tu vocabulario se duplica al instante!'},
     ex:{ja:'Êé•Â∞æËæû -el ‚Üí ÂΩ¢ÂÆπË©û\nËã±Ë™û: -ful -ness -ly\nÊó•Êú¨Ë™û: -ÁöÑ -„Çâ„Åó„ÅÑ\nÈüìÂõΩË™û: -Ï†Å',
         en:'Suffix -el ‚Üí adjective\nEN: -ful -ness -ly\nJP: -ÁöÑ -„Çâ„Åó„ÅÑ\nKR: -Ï†Å',
         zh:'ÂêéÁºÄ -el ‚Üí ÂΩ¢ÂÆπËØç\nËã±ËØ≠: -ful -ness -ly\nÊó•ËØ≠: -ÁöÑ -„Çâ„Åó„ÅÑ\nÈü©ËØ≠: -Ï†Å',
         es:'Sufijo -el ‚Üí adjetivo\nES: -oso -mente\nEN: -ful -ness -ly\nJP: -ÁöÑ'},
     done:S.grammar.patterns.filter(p=>p.type==='suffix').length>=1, tab:'gtab-p'},
    {s:2,icon:'üîä',
     title:{ja:'Èü≥Èüª„Çí3„Å§‰ª•‰∏äË®≠ÂÆö',en:'Set 3+ phonemes',zh:'ËÆæÁΩÆ3‰∏™‰ª•‰∏äÈü≥‰Ωç',es:'Configurar 3+ fonemas'},
     desc:{ja:'‰Ωø„ÅÜÈü≥„ÇíÊ±∫„ÇÅ„Çã„Å®„ÄÅÂçòË™ûÁîüÊàê„Åå„É™„Ç¢„É´„Å™Èüø„Åç„Å´„Å™„ÇãÔºÅË®ÄË™û„ÅÆ„ÄåÂ£∞„Äç„ÅåÊ±∫„Åæ„ÇãÁû¨Èñì„ÄÇ',
           en:'Defining your sounds makes words feel real and consistent! This is your language\'s "voice".',
           zh:'Á°ÆÂÆö‰ΩøÁî®ÁöÑÈü≥ËÆ©ÂçïËØçÂê¨Ëµ∑Êù•Êõ¥ÁúüÂÆûÔºÅËøôÊòØËØ≠Ë®ÄÁöÑ"Â£∞Èü≥"„ÄÇ',
           es:'Definir sonidos hace que las palabras suenen reales. ¬°Esta es la "voz" de tu lengua!'},
     ex:{ja:'Êó•Êú¨Ë™û: a i u e oÔºàÊØçÈü≥5„Å§Ôºâ\n„Éè„ÉØ„Ç§Ë™û: a e i o u + h k l m n p wÔºàÂ≠êÈü≥8„Å§„ÅÆ„ÅøÔºâ\n„Ç®„É´„ÉïË™ûÈ¢®: l n r s vÔºàÊüî„Çâ„Åã„ÅèÊµÅ„Çå„ÇãÈü≥Ôºâ',
         en:'Japanese: a i u e o (5 vowels)\nHawaiian: a e i o u + only 8 consonants\nElven style: l n r s v (soft, flowing)',
         zh:'Êó•ËØ≠: a i u e oÔºà5‰∏™ÂÖÉÈü≥Ôºâ\nÂ§èÂ®ÅÂ§∑ËØ≠: a e i o u + Âè™Êúâ8‰∏™ËæÖÈü≥\nÁ≤æÁÅµËØ≠È£éÊ†º: l n r s vÔºàÊüîÂíåÊµÅÁïÖÔºâ',
         es:'Japon√©s: a i u e o (5 vocales)\nHawayano: a e i o u + solo 8 consonantes\nEstilo √©lfico: l n r s v (suave, fluido)'},
     done:S.phoneme.vowels.length>=3, tab:'phoneme'},
    {s:2,icon:'üö´',
     title:{ja:'Âê¶ÂÆö„ÅÆÊé•È†≠Ëæû„Çí‰Ωú„Çã',en:'Create a negation prefix',zh:'ÂàõÂª∫Âê¶ÂÆöÂâçÁºÄ',es:'Crear prefijo de negaci√≥n'},
     desc:{ja:'„Äå„Äú„Åß„Å™„ÅÑ„Äç„ÇíË°®„ÅôÊé•È†≠Ëæû„ÄÇË™ûÂΩô„Åå‰∏ÄÊ∞ó„Å´2ÂÄç„Å´ÔºÅËã±Ë™û„ÅÆ un-/in-/dis- „ÅÆ„Çà„ÅÜ„Å´„ÄÇ',
           en:'A "not" prefix instantly doubles your vocabulary! Like un-/in-/dis- in English.',
           zh:'"‰∏ç"ÂâçÁºÄÁ´ãÂàªËÆ©ËØçÊ±áÈáèÁøªÂÄçÔºÅÂ∞±ÂÉèËã±ËØ≠ÁöÑ un-/in-/dis-„ÄÇ',
           es:'¬°Un prefijo "no" duplica tu vocabulario! Como in-/des- en espa√±ol.'},
     ex:{ja:'Ëã±Ë™û: un-happy ‚Üí ‰∏çÂπ∏\nÊó•Êú¨Ë™û: ‰∏ç-ÂèØËÉΩ ‚Üí ‰∏çÂèØËÉΩ\n„Éï„É©„É≥„ÇπË™û: im-possible\n„Çπ„ÉØ„Éí„É™Ë™û: si- ‚Üí Âê¶ÂÆö',
         en:'EN: un-happy, im-possible\nJP: ‰∏ç-ÂèØËÉΩ (impossible)\nFR: im-possible\nSW: si- (negation)',
         zh:'Ëã±ËØ≠: un-happy, im-possible\nÊó•ËØ≠: ‰∏ç-ÂèØËÉΩÔºà‰∏çÂèØËÉΩÔºâ\nÊ≥ïËØ≠: im-possible\nÊñØÁì¶Â∏åÈáå: si-ÔºàÂê¶ÂÆöÔºâ',
         es:'ES: in-feliz, im-posible, des-hacer\nEN: un-happy\nJP: ‰∏ç-ÂèØËÉΩ\nFR: im-possible'},
     done:S.grammar.patterns.filter(p=>p.type==='prefix'&&(p.category==='Âê¶ÂÆö'||p.meaning.includes('Âê¶ÂÆö')||p.meaning.includes('not'))).length>=1, tab:'gtab-p'},
    // STEP 3
    {s:3,icon:'üí≠',
     title:{ja:'„Äå„Äú„Åó„Åü„ÅÑ„Äç„Çí‰Ωú„Çã',en:'"Want to do" expression',zh:'Ë°®Ëææ"ÊÉ≥Ë¶Å‚Ä¶‚Ä¶"',es:'Expresar "querer hacer"'},
     desc:{ja:'Â§öË®ÄË™ûÂ≠¶Áøí„ÅßÊúÄÂàù„Å´Ë¶ö„Åà„ÇãË°®Áèæ„ÅÆ‰∏Ä„Å§ÔºÅÊó•Êú¨Ë™û„ÅÆ„Äå„Äú„Åü„ÅÑ„Äç„ÄÅËã±Ë™û„ÅÆ„Äåwant to„Äç„Å´„ÅÇ„Åü„Çã„ÇÇ„ÅÆ„ÄÇ',
           en:'One of the first expressions in any language course! Japanese „Åü„ÅÑ, English "want to", Spanish querer.',
           zh:'Âú®‰ªª‰ΩïËØ≠Ë®ÄËØæÁ®ã‰∏≠ÊúÄÂÖàÂ≠¶Âà∞ÁöÑË°®Ëææ‰πã‰∏ÄÔºÅÊó•ËØ≠„Åü„ÅÑ„ÄÅËã±ËØ≠want to„ÄÅË•øÁè≠ÁâôËØ≠querer„ÄÇ',
           es:'¬°Una de las primeras expresiones en cualquier curso! Japon√©s „Åü„ÅÑ, ingl√©s "want to", espa√±ol querer.'},
     ex:{ja:'Êó•Êú¨Ë™û: È£ü„Åπ-„Åü„ÅÑÔºàÈ£ü„Åπ„ÇãÔºã„Åü„ÅÑÔºâ\nËã±Ë™û: I want to eat\nÈüìÂõΩË™û: Î®π-Í≥† Ïã∂Ïñ¥\n„Éà„É´„Ç≥Ë™û: ye-mek istiyor',
         en:'JP: È£ü„Åπ-„Åü„ÅÑ (eat + want)\nEN: I want to eat\nKR: Î®π-Í≥† Ïã∂Ïñ¥\nTR: ye-mek istiyor',
         zh:'Êó•ËØ≠: È£ü„Åπ-„Åü„ÅÑÔºàÂêÉ+ÊÉ≥Ôºâ\nËã±ËØ≠: I want to eat\nÈü©ËØ≠: Î®π-Í≥† Ïã∂Ïñ¥\nÂúüËÄ≥ÂÖ∂ËØ≠: ye-mek istiyor',
         es:'JP: È£ü„Åπ-„Åü„ÅÑ (comer + querer)\nES: quiero comer\nKR: Î®π-Í≥† Ïã∂Ïñ¥\nTR: ye-mek istiyor'},
     done:S.grammar.patterns.filter(p=>p.meaning.includes('„Åó„Åü„ÅÑ')||p.meaning.includes('want')||p.meaning.includes('Â∏åÊúõ')||p.meaning.includes('querer')||p.meaning.includes('ÊÉ≥Ë¶Å')).length>=1, tab:'gtab-p'},
    {s:3,icon:'‚è±',
     title:{ja:'ÊôÇÂà∂„ÇíÊ±∫„ÇÅ„Çã',en:'Define tense',zh:'Á°ÆÂÆöÊó∂ÊÄÅ',es:'Definir tiempos verbales'},
     desc:{ja:'ÈÅéÂéª„ÉªÁèæÂú®„ÉªÊú™Êù•„Çí„Å©„ÅÜË°®„ÅôÔºüÊé•Â∞æËæûÂûã„ÉªÂä©Ë©ûÂûã„ÉªÂ§âÂåñÂûã‚Ä¶ Ëá™Áî±„Å´Ê±∫„ÇÅ„Çà„ÅÜÔºÅ',
           en:'How to express past/present/future? Suffix, particle, or mutation ‚Äî your choice!',
           zh:'Â¶Ç‰ΩïË°®ËææËøáÂéª„ÄÅÁé∞Âú®„ÄÅÊú™Êù•ÔºüÂêéÁºÄ„ÄÅÂä©ËØçËøòÊòØÂèòÂΩ¢‚Äî‚ÄîËá™Áî±ÂÜ≥ÂÆöÔºÅ',
           es:'¬øPasado/presente/futuro con sufijo, part√≠cula o mutaci√≥n? ¬°T√∫ decides!'},
     ex:{ja:'Êé•Â∞æËæûÂûã: solen-ranÔºàÊ≠©„ÅÑ„ÅüÔºâ/ solen-velÔºàÊ≠©„ÅèÔºâ\nÂä©Ë©ûÂûã: Êò®Êó• + ÂãïË©ûÔºàÊó•Êú¨Ë™ûÔºâ\n„Çπ„Éö„Ç§„É≥Ë™û: habl√©/hablo/hablar√©',
         en:'Suffix: solen-ran(walked)/solen-vel(walk)\nParticle: yesterday + verb (Japanese)\nES: habl√©/hablo/hablar√©',
         zh:'ÂêéÁºÄÂûã: solen-ranÔºàËµ∞‰∫ÜÔºâ/solen-velÔºàËµ∞Ôºâ\nÂä©ËØçÂûã: Êò®Â§© + Âä®ËØçÔºàÊó•ËØ≠Ôºâ\nË•øÁè≠ÁâôËØ≠: habl√©/hablo/hablar√©',
         es:'Sufijo: solen-ran(camin√©)/solen-vel(camino)\nPart√≠cula: ayer + verbo (japon√©s)\nES: habl√©/hablo/hablar√©'},
     done:(S.grammar.tense||[]).length>=1, tab:'gtab-v'},
    {s:3,icon:'‚ùì',
     title:{ja:'ÁñëÂïèÊñá„Çí‰Ωú„Çã',en:'Form questions',zh:'ÊûÑÂª∫ÁñëÈóÆÂè•',es:'Formar preguntas'},
     desc:{ja:'ÁñëÂïè„ÅÆ‰Ωú„ÇäÊñπ„ÅØË®ÄË™û„Å´„Çà„Å£„Å¶ÂÖ®ÁÑ∂ÈÅï„ÅÜ„ÄÇÂä©Ë©û„ÉªË™ûÈ†ÜÂèçËª¢„Éª„Ç§„É≥„Éà„Éç„Éº„Ç∑„Éß„É≥„Å™„Å©ÔºÅ',
           en:'Questions work very differently across languages ‚Äî particles, inversion, or just intonation!',
           zh:'ÂêÑËØ≠Ë®ÄÁöÑÁñëÈóÆÂè•ÊûÑÈÄ†ÊñπÂºèÂ∑ÆÂºÇÂæàÂ§ß‚Äî‚ÄîÂä©ËØç„ÄÅËØ≠Â∫èÈ¢†ÂÄíÊàñ‰ªÖÈù†ËØ≠Ë∞ÉÔºÅ',
           es:'Las preguntas var√≠an mucho entre idiomas: part√≠culas, inversi√≥n o solo entonaci√≥n.'},
     ex:{ja:'Êó•Êú¨Ë™û: „Äú„ÅãÔºüÔºàÂä©Ë©ûÔºâ\nËã±Ë™û: Is it? / Do you?ÔºàË™ûÈ†ÜÂèçËª¢Ôºâ\n‰∏≠ÂõΩË™û: ‰Ω†Â•ΩÂêóÔºüÔºàÂêóÔºâ\n„Éï„É©„É≥„ÇπË™û: Est-ce que...?',
         en:'JP: „Äú„ÅãÔºü (particle)\nEN: Is it? / Do you? (inversion)\nZH: ‰Ω†Â•ΩÂêóÔºü(Âêó)\nFR: Est-ce que...?',
         zh:'Êó•ËØ≠: „Äú„ÅãÔºüÔºàÂä©ËØçÔºâ\nËã±ËØ≠: Is it? / Do you?ÔºàËØ≠Â∫èÈ¢†ÂÄíÔºâ\nÊ±âËØ≠: ‰Ω†Â•ΩÂêóÔºüÔºàÂêóÔºâ\nÊ≥ïËØ≠: Est-ce que...?',
         es:'JP: „Äú„ÅãÔºü (part√≠cula)\nEN: Is it? / Do you?\nZH: ‰Ω†Â•ΩÂêóÔºü(Âêó)\nES: ¬øEs? / ¬øTienes?'},
     done:S.grammar.patterns.filter(p=>p.category==='ÁñëÂïè'||p.meaning.includes('ÁñëÂïè')||p.meaning.includes('?')||p.meaning.includes('question')).length>=1, tab:'gtab-p'},
    // STEP 4
    {s:4,icon:'üîÄ',
     title:{ja:'Ê†ºÂ§âÂåñË°®„Çí‰Ωú„Çã',en:'Build declension table',zh:'ÂàõÂª∫ÂèòÊ†ºË°®',es:'Tabla de declinaci√≥n'},
     desc:{ja:'‰∏ªÊ†º„ÉªÂØæÊ†º„Éª‰∏éÊ†º‚Ä¶ ÂêçË©û„ÅåÂ§âÂåñ„Åô„ÇãË°®„ÄÇ„É©„ÉÜ„É≥Ë™û„Éª„É≠„Ç∑„Ç¢Ë™û„Éª„Éï„Ç£„É≥„É©„É≥„ÉâË™û„Çπ„Çø„Ç§„É´ÔºÅ',
           en:'Nominative, accusative, dative‚Ä¶ like Latin, Russian, or Finnish!',
           zh:'‰∏ªÊ†º„ÄÅÂÆæÊ†º„ÄÅ‰∏éÊ†º‚Ä¶‚Ä¶ÂÉèÊãâ‰∏ÅËØ≠„ÄÅ‰øÑËØ≠ÊàñËä¨ÂÖ∞ËØ≠ÔºÅ',
           es:'Nominativo, acusativo, dativo‚Ä¶ ¬°como lat√≠n, ruso o finland√©s!'},
     ex:{ja:'„É©„ÉÜ„É≥Ë™û rosaÔºà„Éê„É©Ôºâ\n‰∏ªÊ†º:rosa / ÂØæÊ†º:rosam / Â±ûÊ†º:rosae\n„É≠„Ç∑„Ç¢Ë™û: 6Ê†º + 2Êï∞',
         en:'Latin rosa: NOM:rosa ACC:rosam GEN:rosae\nRussian: 6 cases √ó 2 numbers\nFinnish: 15 cases!',
         zh:'Êãâ‰∏ÅËØ≠ rosaÔºàÁé´Áë∞Ôºâ\n‰∏ªÊ†º:rosa / ÂÆæÊ†º:rosam / Â±ûÊ†º:rosae\n‰øÑËØ≠: 6Ê†º √ó 2Êï∞',
         es:'Lat√≠n rosa: NOM:rosa ACC:rosam GEN:rosae\nRuso: 6 casos √ó 2 n√∫meros\nFinland√©s: ¬°15 casos!'},
     done:(S.grammar.matrix.rows||[]).length>=2, tab:'gtab-mx'},
    {s:4,icon:'‚öß',
     title:{ja:'ÊÄß„ÉªÊï∞„ÅÆÂå∫Âà•„ÇíÂä†„Åà„Çã',en:'Add gender & number',zh:'Ê∑ªÂä†ÊÄßÂà´‰∏éÊï∞',es:'A√±adir g√©nero y n√∫mero'},
     desc:{ja:'„Éï„É©„É≥„ÇπË™û„ÅÆ le/la„ÄÅ„Éâ„Ç§„ÉÑË™û„ÅÆ der/die/das „ÅÆ„Çà„ÅÜ„Å™ÊñáÊ≥ïÁöÑÊÄßÂà•„ÄÇ‰∏äÁ¥ö„ÅÆË©¶„ÅøÔºÅ',
           en:'Like French le/la or German der/die/das ‚Äî an advanced touch!',
           zh:'ÂÉèÊ≥ïËØ≠ÁöÑ le/la ÊàñÂæ∑ËØ≠ÁöÑ der/die/das„ÄÇÈ´òÁ∫ßÂäüËÉΩÔºÅ',
           es:'Como le/la del franc√©s o der/die/das del alem√°n. ¬°Un toque avanzado!'},
     ex:{ja:'„Éï„É©„É≥„ÇπË™û: le soleilÔºàÁî∑Ôºâ/ la luneÔºàÂ•≥Ôºâ\n„Éâ„Ç§„ÉÑË™û: der Mann / die Frau / das Kind\n„Ç¢„É©„Éì„Ç¢Ë™û: ÂãïË©û„ÇÇÊÄßÂà•Â§âÂåñ',
         en:'FR: le soleil(m)/la lune(f)\nDE: der Mann/die Frau/das Kind\nAR: verbs also change for gender',
         zh:'Ê≥ïËØ≠: le soleilÔºàÈò≥ÊÄßÔºâ/ la luneÔºàÈò¥ÊÄßÔºâ\nÂæ∑ËØ≠: der Mann / die Frau / das Kind\nÈòøÊãâ‰ºØËØ≠: Âä®ËØç‰πüÈöèÊÄßÂà´ÂèòÂåñ',
         es:'FR: le soleil(m)/la lune(f)\nDE: der Mann/die Frau/das Kind\nAR: los verbos tambi√©n cambian'},
     done:(S.grammar.gender||[]).length>=1&&!(S.grammar.gender||[]).includes('„Å™„Åó'), tab:'gtab-o'},
    {s:4,icon:'üìö',
     title:{ja:'ÊñáÊ≥ïÊõ∏„ÇíÊõ∏„Åè',en:'Write a grammar book',zh:'ÁºñÂÜôËØ≠Ê≥ï‰π¶',es:'Escribir una gram√°tica'},
     desc:{ja:'ÊñáÊ≥ïÊõ∏„É°„É¢„Å´Ë¶èÂâá„Çí„Åæ„Å®„ÇÅ„Çã„Å®„ÄÅË®ÄË™û„Åå„ÄåÊú¨Áâ©„Äç„Å´„Å™„Å£„Å¶„Åè„ÇãÔºÅ',
           en:'Documenting your grammar makes your language feel truly real and complete!',
           zh:'Âú®ËØ≠Ê≥ïÁ¨îËÆ∞‰∏≠Êï¥ÁêÜËßÑÂàôÔºåËÆ©‰Ω†ÁöÑËØ≠Ë®ÄÊÑüËßâÁúüÂÆûÂÆåÊï¥ÔºÅ',
           es:'¬°Documentar tu gram√°tica hace que tu lengua se sienta verdaderamente real!'},
     ex:{ja:'## ÂêçË©ûÊ†º\n### ‰∏ªÊ†ºÔºà-elÔºâÂãïË©û„ÅÆ‰∏ªË™û„ÇíÁ§∫„Åô\n‰æã: kali-el solen = Ê∞¥„ÅåÊ≠©„Åè',
         en:'## Noun Cases\n### Nominative (-el) Marks subject\nEx: kali-el solen = water walks',
         zh:'## ÂêçËØçÊ†º\n### ‰∏ªÊ†ºÔºà-elÔºâÊ†áËÆ∞‰∏ªËØ≠\n‰æãÔºökali-el solen = Ê∞¥Ë°åËµ∞',
         es:'## Casos nominales\n### Nominativo (-el) Marca el sujeto\nEj: kali-el solen = el agua camina'},
     done:(S.grammarNotes||'').length>=50, tab:'gtab-notes'},
  ];

  const stageColors=['var(--accent)','var(--success)','var(--accent2)','var(--gold)'];
  const stageNums=[1,2,3,4];
  const stageKeys=['rm_s1','rm_s2','rm_s3','rm_s4'];
  const allDone=steps.filter(s=>s.done).length;
  const pct=Math.round(allDone/steps.length*100);

  let html=`<div>
    <div style="font-family:'Cinzel',serif;font-size:1rem;font-weight:600;margin-bottom:4px">${t('rm_title')}</div>
    <p style="font-size:0.76rem;color:var(--text-secondary);margin-bottom:16px;font-style:italic">${t('rm_subtitle')}</p>
    <div style="margin-bottom:20px;padding:12px;background:var(--surface-2);border-radius:10px;border:1px solid var(--border)">
      <div style="display:flex;justify-content:space-between;font-size:0.72rem;color:var(--text-muted);margin-bottom:6px"><span>üìä ${t('rm_progress')}</span><span>${allDone} / ${steps.length}</span></div>
      <div style="height:8px;background:var(--surface-3);border-radius:4px;overflow:hidden"><div style="height:100%;width:${pct}%;background:linear-gradient(90deg,var(--accent),var(--accent2),var(--gold));border-radius:4px;transition:width 0.6s ease"></div></div>
    </div>`;

  stageNums.forEach(sNum=>{
    const sc=stageColors[sNum-1];
    const sk=stageKeys[sNum-1];
    const stSteps=steps.filter(s=>s.s===sNum);
    const stDone=stSteps.filter(s=>s.done).length;
    html+=`<div style="margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
        <div style="height:2px;background:${sc};opacity:0.4;flex:none;width:16px;border-radius:1px"></div>
        <span style="font-size:0.62rem;font-weight:700;letter-spacing:0.1em;color:${sc};text-transform:uppercase;white-space:nowrap">${t(sk)}</span>
        <span style="font-size:0.6rem;color:var(--text-muted)">${stDone}/${stSteps.length}</span>
        <div style="height:2px;background:${sc};opacity:0.3;flex:1;border-radius:1px"></div>
      </div>`;
    stSteps.forEach(step=>{
      const title=step.title[L]||step.title.ja;
      const desc=step.desc[L]||step.desc.ja;
      const ex=step.ex[L]||step.ex.ja;
      html+=`<div style="display:flex;gap:12px;margin-bottom:12px;padding:14px;border-radius:12px;border:1px solid ${step.done?sc+'44':'var(--border)'};background:${step.done?sc+'0a':'var(--surface-2)'}">
        <div style="font-size:1.4rem;flex-shrink:0;line-height:1">${step.done?'‚úÖ':step.icon}</div>
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;flex-wrap:wrap">
            <span style="font-weight:700;font-size:0.88rem;color:${step.done?sc:'var(--text-primary)'}">${title}</span>
            ${step.done?`<span style="font-size:0.6rem;background:${sc}22;color:${sc};border:1px solid ${sc}44;border-radius:10px;padding:1px 8px">${t('rm_done')}</span>`:''}
          </div>
          <div style="font-size:0.76rem;color:var(--text-secondary);line-height:1.75;margin-bottom:8px">${desc}</div>
          <div style="font-size:0.68rem;font-family:monospace;background:var(--surface-3);border:1px solid var(--border);border-radius:8px;padding:8px 10px;color:${sc};white-space:pre-wrap;line-height:1.6">${ex}</div>
          ${!step.done?`<button onclick="jumpToGrammarTab('${step.tab}')" style="margin-top:10px;padding:5px 14px;border:1px solid ${sc}66;border-radius:8px;background:${sc}12;color:${sc};font-size:0.72rem;cursor:pointer;font-family:inherit;transition:all 0.15s">${t('rm_goto')}</button>`:''}
        </div>
      </div>`;
    });
    html+='</div>';
  });
  html+='</div>';
  return html;
}

function jumpToGrammarTab(tab){
  const specialTabs={vocab:true,phoneme:true,corpus:true};
  if(specialTabs[tab]){
    document.getElementById('editor-overlay').classList.remove('open');
    document.body.style.overflow='';
    setTimeout(()=>openEditor(tab),200);
  } else {
    const el=document.getElementById(tab);
    const parentTabs=document.querySelectorAll('#editor-body .tab-content');
    const parentTabBtns=document.querySelectorAll('#editor-body .editor-tab');
    parentTabs.forEach(e=>e.classList.remove('active'));
    parentTabBtns.forEach(e=>e.classList.remove('active'));
    if(el)el.classList.add('active');
    const btn=document.querySelector(`[onclick*="'${tab}'"]`);
    if(btn)btn.classList.add('active');
    el?.scrollIntoView({behavior:'smooth',block:'start'});
  }
}
function buildVocab(){
  const allPos=[t('v_pos_filter_all'),t('v_pos_noun'),t('v_pos_verb'),t('v_pos_adj'),t('v_pos_adv'),t('v_pos_pron'),t('v_pos_part')];
  return`
  ${buildAssistPanel('vocab')}
  <div class="editor-tabs">
    <div class="editor-tab active" onclick="switchTab(this,'vtab-g')">${t('v_tab_gacha')}</div>
    <div class="editor-tab" onclick="switchTab(this,'vtab-m')">${t('v_tab_manual')}</div>
    <div class="editor-tab" onclick="switchTab(this,'vtab-d')">${t('v_tab_dict')}</div>
    <div class="editor-tab" onclick="switchTab(this,'vtab-r')">${t('v_tab_rev')}</div>
    <div class="editor-tab" onclick="switchTab(this,'vtab-sound')">${t('v_tab_sound')}</div>
  </div>
  <div class="tab-content active" id="vtab-g">
    <div class="field-block"><span class="field-label">${t('v_gacha_hint')}</span>
      <div style="display:flex;gap:8px;margin-bottom:10px">
        <input class="input-field" placeholder="${t('v_gacha_placeholder')}" id="gacha-input" style="flex:1">
        <button class="btn btn-primary btn-sm" onclick="runGacha()">${t('v_gacha_gen')}</button>
      </div></div>
    <button class="gacha-btn" onclick="runRandGacha()"><span id="gacha-icon">‚ú¶</span> ${t('v_gacha_rand')}</button>
    <div id="gacha-result"></div>
  </div>
  <div class="tab-content" id="vtab-m">
    <div class="field-block">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
        <div>
          <span class="field-label">${t('v_word_cl')}</span>
          <input class="input-field" placeholder="e.g. silvara" id="word-cl" oninput="validateWordInput(this)" onfocus="_activeScriptCell=this">
          <div class="validation-msg" id="word-cl-validation"></div>
        </div>
        <div><span class="field-label">${t('v_word_jp_label')}</span><input class="input-field" placeholder="e.g. water" id="word-jp"></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
        <div><span class="field-label">${t('v_word_ipa_label')}</span><input class="input-field" placeholder="e.g. /silvara/" id="word-read" style="font-family:monospace" oninput="checkSyllableViolation(this.value)"></div>
        <div></div>
      </div>
      <div id="word-mini-kb">${buildMiniIPAKeyboard('word-cl')}</div>
      <div style="margin-top:8px">
        <details style="cursor:pointer">
          <summary style="font-size:0.72rem;color:var(--accent);letter-spacing:0.06em;text-transform:uppercase;font-weight:700;padding:6px 0;list-style:none;display:flex;align-items:center;gap:6px"><span>üåê</span> ${t('v_script_picker_open')}</summary>
          <div style="margin-top:8px;font-size:0.7rem;color:var(--text-muted);margin-bottom:4px">${t('v_script_picker_hint')}</div>
          ${buildCharPicker('word-cl')}
        </details>
      </div>
      <div class="slot-violation" id="syll-violation">${t('v_syll_violation')}</div>
      <span class="field-label">${t('v_word_pos_label')}</span>
      <div class="toggle-grid">${[t('v_pos_noun'),t('v_pos_verb'),t('v_pos_adj'),t('v_pos_adv'),t('v_pos_pron'),t('v_pos_part')].map(p=>`<div class="toggle-chip ${p===t('v_pos_noun')?'selected':''}" onclick="selPos(this)">${p}</div>`).join('')}</div>
      <div style="margin-top:12px"><span class="field-label">${t('v_word_tags_label')}</span>
        <div class="toggle-grid">${allTags.map(t=>`<div class="toggle-chip" onclick="toggleChip(this)" data-tag="${t}">${t}</div>`).join('')}</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn btn-primary btn-sm" onclick="addManual()">${t('v_add_dict_btn')}</button>
      <button class="btn btn-sm" onclick="speakDirect(document.getElementById('word-cl').value,'en-US',0.75,1)">${t('v_speak_btn')}</button>
      <button class="btn btn-sm btn-gold" onclick="previewWordInScript()">${t('v_script_preview_btn')}</button>
    </div>
    <div id="word-script-preview" style="font-size:1.3rem;color:var(--accent);font-family:monospace;text-align:center;padding:12px 0;min-height:30px;letter-spacing:0.1em"></div>
    <div class="ai-box" style="margin-top:4px">
      <div class="ai-label">${t('v_ipa_title')}</div>
      <div class="ai-content" style="font-size:0.75rem">${t('v_ipa_desc')}</div>
      <div id="ipa-quick-pinbar" style="display:flex;gap:5px;flex-wrap:wrap;margin-top:8px">
        ${['Àê','Àà','Àå','…õ','…î','√¶','…ô','≈ã','Œ∏','√∞',' É',' í','…æ',' Ä'].map(c=>`<button class="ipa-float-btn" style="padding:4px 8px" onclick="insertCharAt(document.getElementById('word-read'),'${c}')">${c}</button>`).join('')}
        ${S.pinnedIPA.map(c=>`<button class="ipa-float-btn pinned" onclick="insertCharAt(document.getElementById('word-read'),'${c}')">${c}</button>`).join('')}
      </div>
    </div>
  </div>
  <div class="tab-content" id="vtab-d">
    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px">
      <span class="field-label" style="margin:0">${t('v_dict_header')} <span id="dict-count-badge" style="font-size:0.8em;color:var(--accent);font-weight:700">${S.dictionary.length}Ë™û</span></span>
      <div style="display:flex;gap:6px">
        <button class="btn btn-sm" style="font-size:0.68rem" onclick="sortDict('alpha')">${t('v_dict_alpha')}</button>
        <button class="btn btn-sm" style="font-size:0.68rem" onclick="sortDict('pos')">${t('v_dict_pos_sort')}</button>
      </div>
    </div>
    <!-- „Éè„Ç§„Éñ„É™„ÉÉ„ÉâÊ§úÁ¥¢ -->
    <div style="position:relative;margin-bottom:8px">
      <input class="input-field" placeholder="${t('v_search_placeholder')}" id="dict-search" oninput="filterDict()" style="padding-right:80px;font-size:0.88rem">
      <div style="position:absolute;right:8px;top:50%;transform:translateY(-50%);display:flex;gap:2px">
        <button class="dhm-btn active" id="sm-both" onclick="setDictSearchMode('both');this.classList.add('active');document.getElementById('sm-conlang').classList.remove('active');document.getElementById('sm-japanese').classList.remove('active')">${t('v_search_both')}</button>
        <button class="dhm-btn" id="sm-conlang" onclick="setDictSearchMode('conlang');this.classList.add('active');document.getElementById('sm-both').classList.remove('active');document.getElementById('sm-japanese').classList.remove('active')">${t('v_search_conlang')}</button>
        <button class="dhm-btn" id="sm-japanese" onclick="setDictSearchMode('japanese');this.classList.add('active');document.getElementById('sm-both').classList.remove('active');document.getElementById('sm-conlang').classList.remove('active')">${t('v_search_jp')}</button>
      </div>
    </div>
    <!-- ÂìÅË©û„Éï„Ç£„É´„Çø„Éº -->
    <div class="pos-filter-bar" style="margin-bottom:6px">${allPos.map(p=>`<button class="pos-filter-btn ${p===(dictPosFilter||t('v_pos_filter_all'))?'active':''}" onclick="setPosFilter(this,'${p}')">${p}</button>`).join('')}</div>
    <!-- „Çø„Ç∞„Éï„Ç£„É´„Çø„Éº -->
    <div class="tag-filter-wrap" id="tag-filter-wrap" style="margin-bottom:10px">${[t('v_pos_filter_all'),...allTags].map(tg=>`<div class="tag-filter-chip ${(tg===t('v_pos_filter_all')&&!dictTagFilter)||dictTagFilter===tg?'active':''}" onclick="setTagFilter(this,'${tg===t('v_pos_filter_all')?'':tg}')">${tg}</div>`).join('')}</div>
    <!-- ‰ª∂Êï∞Ë°®Á§∫ -->
    <div id="dict-result-info" style="font-size:0.68rem;color:var(--text-muted);margin-bottom:6px"></div>
    <!-- ‰∏ÄË¶ß -->
    <div id="dict-list">${renderDictHtml()}</div>
  </div>
  <div class="tab-content" id="vtab-r">
    <div class="field-block">
      <span class="field-label">${t('v_rev_title')}</span>
      <p style="font-size:0.72rem;color:var(--text-muted);margin-bottom:10px">${t('v_rev_desc')}</p>
      <div style="position:relative;margin-bottom:14px">
        <input class="input-field" placeholder="${t('v_rev_placeholder')}" id="rev-search" oninput="reverseSearch()" style="padding-left:36px;font-size:0.9rem">
        <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:1rem;pointer-events:none">üîç</span>
      </div>
      <div id="rev-result">${renderRevSearch('')}</div>
    </div>
    <!-- ÂìÅË©ûÂà•‰∏ÄË¶ß -->
    <div class="field-block" style="margin-top:8px">
      <span class="field-label">${t('v_rev_pos_snap')}</span>
      <div id="pos-snapshot">${renderPosSnapshot()}</div>
    </div>
    <div class="field-block">
      <span class="field-label">„Çø„Ç∞„ÅßË™ûÂΩô„ÅÆÂÅè„Çä„Çí„ÉÅ„Çß„ÉÉ„ÇØ</span>
      <div id="tag-stats">${renderTagStats()}</div>
    </div>
  </div>
  <div class="tab-content" id="vtab-sound">
    <p style="font-size:0.82rem;color:var(--text-secondary);margin-bottom:16px;line-height:1.7;font-style:italic">Èü≥Èüª„É´„Éº„É´„Å®ÈÄ£Âãï„Åó„Å¶„ÅÇ„Å™„Åü„ÅÆË®ÄË™û„Çâ„Åó„ÅÑÈüø„Åç„ÅÆÂçòË™û„ÇíÁîüÊàê„Åó„Åæ„Åô„ÄÇÊñáÂ≠ó‰ΩìÁ≥ª„Éû„ÉÉ„Éî„É≥„Ç∞„ÇÇÈÅ©Áî®„Åï„Çå„Åæ„Åô„ÄÇ</p>
    <div class="ai-box" style="margin-bottom:12px">
      <div class="ai-label">‚ö† Èü≥Èüª„Éê„É™„Éá„Éº„Ç∑„Éß„É≥</div>
      <div class="ai-content" style="font-size:0.75rem">ÂçòË™ûÁôªÈå≤ÊôÇ„ÄÅË®≠ÂÆö„Åó„ÅüÈü≥Èüª„É´„Éº„É´Â§ñ„ÅÆÊñáÂ≠ó„ÅåÂê´„Åæ„Çå„Çã„Å®Ë≠¶Âëä„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇÈü≥Èüª„Çø„Éñ„ÅßÊØçÈü≥„ÉªÂ≠êÈü≥„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>
    </div>
    <button class="insp-btn" onclick="generateSoundLinked()"><span id="sl-spin">‚ú¶</span> Èü≥Èüª+ÊñáÂ≠óÈÄ£Âãï„Åß10Ë™ûÁîüÊàê</button>
    <div id="sl-result" style="margin-top:14px"></div>
  </div>`
}

// Word validation with phonemes
function validateWordInput(inputEl){
  const word=inputEl.value.trim();
  const msgEl=document.getElementById('word-cl-validation');
  if(!word||(!S.phoneme.vowels.length&&!S.phoneme.consonants.length)){
    inputEl.classList.remove('valid','invalid');if(msgEl){msgEl.className='validation-msg';msgEl.textContent=''}return;
  }
  const {ok,issues}=validateWordPhonemes(word);
  if(ok){
    inputEl.classList.remove('invalid');inputEl.classList.add('valid');
    if(msgEl){msgEl.className='validation-msg ok show';msgEl.textContent=t('gc_ok')}
  }else{
    inputEl.classList.remove('valid');inputEl.classList.add('invalid');
    if(msgEl){msgEl.className='validation-msg error show';msgEl.textContent=`‚ö† ${issues.join(', ')} ‚Äî ${t('v_syll_violation').replace('‚ö† ','')}`}
  }
}

function setDictSearchMode(mode){
  dictSearchMode=mode;
  filterDict();
}

let _dictSortMode = 'default'; // default/alpha/pos
function sortDict(mode){
  _dictSortMode = mode;
  filterDict();
}

function previewWordInScript(){const v=document.getElementById('word-cl')?.value;const r=document.getElementById('word-script-preview');if(r&&v)r.textContent=applyScriptMap(v)||v}

function renderDictHtml(filter='',pos='',tag=''){
  const allFilter=t('v_pos_filter_all');
  if(!pos)pos=allFilter;
  let words=[...S.dictionary];
  if(filter){
    const fl=filter.toLowerCase();
    words=words.filter(w=>{
      if(dictSearchMode==='conlang')return w.conlang.toLowerCase().includes(fl);
      if(dictSearchMode==='japanese')return w.meaning.includes(filter);
      return w.conlang.toLowerCase().includes(fl)||w.meaning.includes(filter);
    });
  }
  if(pos&&pos!==allFilter)words=words.filter(w=>w.pos===pos);
  if(tag)words=words.filter(w=>(w.tags||[]).includes(tag));

  if(_dictSortMode==='alpha') words.sort((a,b)=>a.conlang.localeCompare(b.conlang));
  else if(_dictSortMode==='pos') words.sort((a,b)=>a.pos.localeCompare(b.pos));

  const info=document.getElementById('dict-result-info');
  if(info){
    const all=S.dictionary.length;
    info.textContent=(filter||pos!==allFilter||tag)?`${words.length}/${all}`:`${all}`;
  }
  const badge=document.getElementById('dict-count-badge');
  if(badge) badge.textContent=S.dictionary.length;

  if(!words.length)return`<p style="font-size:0.78rem;color:var(--text-muted);text-align:center;padding:20px 0;font-style:italic">${t('v_dict_empty')}</p>`;

  const hl=(text,q)=>{
    if(!q) return text;
    const re=new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi');
    return text.replace(re,'<mark style="background:rgba(140,126,255,0.3);color:var(--accent);border-radius:2px;padding:0 1px">$1</mark>');
  };

  return words.map((w,idx)=>{
    const scriptForm=Object.keys(S.scriptMap).length?applyScriptMap(w.conlang):'';
    const q=filter.toLowerCase();
    const clHl=hl(w.conlang,q);
    const jpHl=hl(w.meaning,filter);
    return`<div class="word-card" style="animation:fadeIn 0.15s ease both;animation-delay:${Math.min(idx*0.02,0.2)}s">
      <div style="flex:1">
        <div class="word-main">
          ${clHl}
          ${w.read?`<span style="font-size:0.68rem;color:var(--text-muted);margin-left:6px;font-family:monospace">${w.read}</span>`:''}
          ${scriptForm?`<span style="font-size:0.78rem;color:var(--accent2);margin-left:8px;font-family:monospace">${scriptForm}</span>`:''}
        </div>
        <div class="word-meaning">${jpHl}</div>
        ${w.tags&&w.tags.length?`<div class="word-tags">${w.tags.map(t=>`<span class="word-tag">${t}</span>`).join('')}</div>`:''}
      </div>
      <span class="word-pos">${w.pos}</span>
      <div style="display:flex;gap:4px;align-items:center">
        <div class="word-play" onclick="speakDirect('${w.conlang}','en-US',0.75,1)" title="Áô∫Èü≥">üîä</div>
        <button class="btn btn-sm" style="padding:3px 7px;font-size:0.65rem;color:var(--rose);border-color:var(--rose-border);background:var(--rose-dim)" onclick="deleteWord(${S.dictionary.indexOf(w)})" title="ÂâäÈô§">‚úï</button>
      </div>
    </div>`;
  }).join('');
}

function deleteWord(idx){
  if(!confirm(`"${S.dictionary[idx]?.conlang}" ‚Äî ${t('c_del_btn')}?`))return;
  S.dictionary.splice(idx,1);scheduleSave();
  const el=document.getElementById('dict-list');if(el)el.innerHTML=renderDictHtml(document.getElementById('dict-search')?.value||'',dictPosFilter,dictTagFilter);
  updateDashboard();
}

function renderRevSearch(q){
  if(!q)return`<div style="text-align:center;padding:20px 0">
    <div style="font-size:1.5rem;margin-bottom:8px">üîç</div>
    <p style="font-size:0.78rem;color:var(--text-muted);font-style:italic">${t('v_rev_desc')}</p>
  </div>`;
  const words=S.dictionary.filter(w=>w.meaning.includes(q));
  if(!words.length)return`<div style="text-align:center;padding:16px 0">
    <p style="font-size:0.85rem;color:var(--text-muted)">"${q}" ‚Äî ${t('v_dict_empty').split('„ÄÇ')[0]}</p>
    <button class="btn btn-sm btn-primary" style="margin-top:8px;font-size:0.72rem" onclick="document.getElementById('word-jp').value='${q}';document.querySelector('[onclick*=\\'vtab-m\\']').click()">"${q}" ‚Üí ${t('v_add_dict_btn')}</button>
  </div>`;
  return`<div style="margin-bottom:8px;font-size:0.7rem;color:var(--text-muted)">${words.length}</div>`+
    words.map(w=>`<div class="word-card">
      <div style="flex:1">
        <div class="word-main" style="font-size:1.1rem">${w.conlang}${Object.keys(S.scriptMap).length?`<span style="font-size:0.78rem;color:var(--accent2);margin-left:8px;font-family:monospace">${applyScriptMap(w.conlang)}</span>`:''}</div>
        <div class="word-meaning" style="color:var(--accent)">${w.meaning}</div>
        ${w.read?`<div style="font-size:0.68rem;color:var(--text-muted);font-family:monospace">${w.read}</div>`:''}
      </div>
      <span class="word-pos">${w.pos}</span>
      <div class="word-play" onclick="speakDirect('${w.conlang}','en-US',0.75,1)">üîä</div>
    </div>`).join('');
}

function renderPosSnapshot(){
  const POS=['ÂêçË©û','ÂãïË©û','ÂΩ¢ÂÆπË©û','ÂâØË©û','‰ª£ÂêçË©û','Âä©Ë©û'];
  const stats={};POS.forEach(p=>stats[p]=S.dictionary.filter(w=>w.pos===p).length);
  const total=S.dictionary.length||1;
  return `<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:6px">
    ${POS.map(p=>`<div style="background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:10px 12px;text-align:center;cursor:pointer;transition:all 0.15s" onclick="document.querySelector('[onclick*=\\'vtab-d\\']').click();setPosFilter(document.querySelector('.pos-filter-btn'),\\'${p}\\')">
      <div style="font-size:1.2rem;font-weight:700;color:var(--accent)">${stats[p]}</div>
      <div style="font-size:0.62rem;color:var(--text-secondary);margin-top:2px">${p}</div>
      <div style="height:3px;border-radius:2px;background:linear-gradient(90deg,var(--accent),var(--accent2));margin-top:6px;width:${Math.round(stats[p]/total*100)}%"></div>
    </div>`).join('')}
  </div>`;
}

function renderTagStats(){
  const stats={};allTags.forEach(t=>stats[t]=0);S.dictionary.forEach(w=>(w.tags||[]).forEach(t=>{if(stats[t]!==undefined)stats[t]++}));
  const max=Math.max(...Object.values(stats),1);
  return`<div style="display:flex;flex-direction:column;gap:6px">${allTags.map(t=>`<div style="display:flex;align-items:center;gap:10px"><span style="font-size:0.72rem;color:var(--text-secondary);width:40px;flex-shrink:0">${t}</span><div style="flex:1;background:var(--surface-2);border-radius:4px;height:8px;overflow:hidden"><div style="height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:4px;width:${Math.round(stats[t]/max*100)}%;transition:width 0.5s ease"></div></div><span style="font-size:0.7rem;color:var(--text-muted);width:20px;text-align:right">${stats[t]}</span></div>`).join('')}</div>`;
}
function reverseSearch(){const q=document.getElementById('rev-search')?.value||'';const el=document.getElementById('rev-result');if(el)el.innerHTML=renderRevSearch(q)}
function setPosFilter(el,pos){dictPosFilter=pos;document.querySelectorAll('.pos-filter-btn').forEach(b=>b.classList.remove('active'));el?.classList.add('active');const el2=document.getElementById('dict-list');if(el2)el2.innerHTML=renderDictHtml(document.getElementById('dict-search')?.value||'',pos,dictTagFilter)}
function setTagFilter(el,tag){dictTagFilter=tag;document.querySelectorAll('.tag-filter-chip').forEach(b=>b.classList.remove('active'));el?.classList.add('active');const el2=document.getElementById('dict-list');if(el2)el2.innerHTML=renderDictHtml(document.getElementById('dict-search')?.value||'',dictPosFilter,tag)}
function filterDict(){const v=document.getElementById('dict-search')?.value||'';const el=document.getElementById('dict-list');if(el)el.innerHTML=renderDictHtml(v,dictPosFilter,dictTagFilter)}
function runGacha(){
  const inp=document.getElementById('gacha-input');
  if(!inp?.value.trim())return;
  const words=inp.value.trim().split(/[„ÄÅ,Ôºå\s]+/).filter(Boolean);
  let html='';
  words.forEach(w=>{
    // V12: Èü≥Èüª„É´„Éº„É´„Åã„ÇâÁîüÊàêÔºàÂõ∫ÂÆö„Éû„ÉÉ„Éó„ÅØÂªÉÊ≠¢Ôºâ
    const c=generateWordFromPhonology(w);
    addDict(c,w,'ÂêçË©û',[]);
    html+=wordCardHtml({conlang:c,meaning:w,pos:'ÂêçË©û',tags:[]});
    // Èñ¢ÈÄ£Ë™ûÊèêÊ°àÔºàÊúÄÂæå„ÅÆÂçòË™û„Å´ÂØæ„Åó„Å¶Ôºâ
    setTimeout(()=>suggestRelatedWords(w,c),300);
  });
  const r=document.getElementById('gacha-result');
  if(r)r.innerHTML=html;
  inp.value='';
}
function runRandGacha(){
  const icon=document.getElementById('gacha-icon');
  if(icon)icon.classList.add('spinning');
  setTimeout(()=>{
    if(icon)icon.classList.remove('spinning');
    const result=randWordMeanings.map(w=>({conlang:generateWordFromPhonology(w.m),meaning:w.m,pos:w.p,tags:w.tags}));
    result.forEach(w=>addDict(w.conlang,w.meaning,w.pos,w.tags));
    const r=document.getElementById('gacha-result');
    if(r)r.innerHTML=result.map(w=>wordCardHtml({conlang:w.conlang,meaning:w.meaning,pos:w.pos,tags:w.tags})).join('');
  },900);
}
function addManual(){const c=document.getElementById('word-cl')?.value.trim(),m=document.getElementById('word-jp')?.value.trim(),read=document.getElementById('word-read')?.value.trim()||'',p=document.querySelector('#vtab-m .toggle-chip.selected')?.textContent||t('v_pos_noun');const tags=[...document.querySelectorAll('#vtab-m [data-tag].selected')].map(el=>el.dataset.tag);if(!c||!m)return;
  // warn if phoneme violation
  const {ok,issues}=validateWordPhonemes(c);
  if(!ok&&S.phoneme.vowels.length){const go=confirm(`‚ö† Èü≥Èüª„É´„Éº„É´Â§ñ„ÅÆÊñáÂ≠ó„Äå${issues.join(', ')}„Äç„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Åù„Çå„Åß„ÇÇËøΩÂä†„Åó„Åæ„Åô„ÅãÔºü`);if(!go)return}
  addDict(c,m,p,tags,read);document.getElementById('word-cl').value='';document.getElementById('word-jp').value='';document.getElementById('word-read').value='';document.getElementById('word-script-preview').textContent='';const v2=document.getElementById('word-cl-validation');if(v2){v2.className='validation-msg';v2.textContent=''}document.getElementById('word-cl')?.classList.remove('valid','invalid');const tab=document.querySelector('[onclick*="vtab-d"]');if(tab)switchTab(tab,'vtab-d');const el2=document.getElementById('dict-list');if(el2)el2.innerHTML=renderDictHtml('',dictPosFilter,dictTagFilter)}
function addDict(conlang,meaning,pos,tags=[],read=''){if(S.dictionary.find(w=>w.conlang===conlang))return;S.dictionary.push({conlang,meaning,pos,tags,read});scheduleSave()}
function wordCardHtml(w){return`<div class="word-card"><div style="flex:1"><div class="word-main">${w.conlang}${Object.keys(S.scriptMap).length?`<span style="font-size:0.75rem;color:var(--accent2);margin-left:8px;font-family:monospace">${applyScriptMap(w.conlang)}</span>`:''}</div><div class="word-meaning">${w.meaning}</div></div><span class="word-pos">${w.pos}</span><div class="word-play" onclick="speakDirect('${w.conlang}','en-US',0.75,1)">üîä</div></div>`}

// ‚îÄ‚îÄ‚îÄ Phonology-based word generation (V12+) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SEMANTIC_FAMILIES = {
  'Ê∞¥': {related:['Â∑ù','Êµ∑','Èõ®','Êπñ','Ê≥â','Ê∞∑','Ê≥¢','Êπø„ÇäÊ∞ó'], tags:['Ëá™ÁÑ∂','Ê∞¥']},
  'Â∑ù': {related:['Ê∞¥','ÊµÅ„Çå','Ê©ã','È≠ö','Â≤∏','Â≤©'], tags:['Ëá™ÁÑ∂','Ê∞¥']},
  'Êµ∑': {related:['Ê∞¥','Ê≥¢','Ëàπ','È≠ö','Âµê','Á†ÇÊµú','Â°©'], tags:['Ëá™ÁÑ∂','Ê∞¥']},
  'Á©∫': {related:['Èõ≤','Êòü','Â§™ÈôΩ','Êúà','È¢®','È≥•','Èõ®'], tags:['Ëá™ÁÑ∂']},
  'Êòü': {related:['Á©∫','Â§ú','ÂÖâ','Êúà','ÂÆáÂÆô','Â§¢'], tags:['Ëá™ÁÑ∂','Â§ú']},
  'ÁÅ´': {related:['ÁáÉ„Åà„Çã','ÁÅ∞','ÁÖô','ÂÖâ','ÁÜ±','ÁÇé'], tags:['Ëá™ÁÑ∂','Âäõ']},
  'ÂÖâ': {related:['Â§™ÈôΩ','Êòü','ÁõÆ','Ë¶ã„Åà„Çã','Êòé„Çã„ÅÑ'], tags:['Ëá™ÁÑ∂']},
  'È¢®': {related:['Á©∫','Èõ≤','Ëëâ','Èü≥','Âµê','ÊÅØ'], tags:['Ëá™ÁÑ∂']},
  'Êú®': {related:['Ëëâ','Ê†π','Ê£Æ','ÂÆü','Á®Æ','Êûù'], tags:['Ëá™ÁÑ∂','Ê§çÁâ©']},
  'Ê£Æ': {related:['Êú®','Ëëâ','ÂãïÁâ©','ÈÅì','ÂΩ±','Á≤æÈúä'], tags:['Ëá™ÁÑ∂','Â†¥ÊâÄ']},
  'Â±±': {related:['Â≤©','ÈÅì','Ë∞∑','Èõ™','È†Ç‰∏ä','È∑π'], tags:['Ëá™ÁÑ∂','Â†¥ÊâÄ']},
  'ÊÑõ': {related:['ÂøÉ','ÊÄù„ÅÜ','ÂèãÈÅî','ÂÆ∂Êóè','Áæé„Åó„ÅÑ','Êúõ„ÇÄ'], tags:['ÊÑüÊÉÖ']},
  'ÂøÉ': {related:['ÊÑõ','ÊÑü„Åò„Çã','ÊÄù„ÅÜ','Â§¢','Áóõ„Åø'], tags:['ÊÑüÊÉÖ','‰Ωì']},
  'Â§¢': {related:['Áú†„Çã','Â§ú','Â∏åÊúõ','Êú™Êù•','ÂøÉ'], tags:['ÊÑüÊÉÖ','ÊôÇÈñì']},
  '‰∫∫': {related:['ÂèãÈÅî','ÂÆ∂Êóè','ÂêçÂâç','Ë®ÄËëâ','Ê≠å„ÅÜ'], tags:['‰∫∫Áß∞']},
  'ÂèãÈÅî': {related:['‰∫∫','‰∏ÄÁ∑í','Á¨ë„ÅÜ','Ë©±„Åô','‰ø°È†º'], tags:['‰∫∫Áß∞','ÊÑüÊÉÖ']},
  'Ââ£': {related:['Êà¶„ÅÜ','ÂãáËÄÖ','ÈâÑ','Âäõ','ÂÆà„Çã'], tags:['ÈÅìÂÖ∑','Âäõ']},
  'Ê≠å': {related:['Èü≥Ê•Ω','Â£∞','ÂøÉ','Âñú„Å≥','Ë∏ä„Çã'], tags:['Ë°åÂãï','ÊÑüÊÉÖ']},
  'Â§ú': {related:['Êòü','Êúà','Áú†„Çã','Â§¢','Êöó„ÅÑ'], tags:['ÊôÇÈñì','Ëá™ÁÑ∂']},
  'Â§™ÈôΩ': {related:['ÂÖâ','ÁÜ±','Á©∫','Êòº','ËÇ≤„Å§'], tags:['Ëá™ÁÑ∂']},
  'Êúà': {related:['Â§ú','Êòü','Êµ∑','ÊΩÆ','ÂÖâ'], tags:['Ëá™ÁÑ∂','Â§ú']},
};

function generateWordFromPhonology(meaning){
  const V=S.phoneme.vowels.length>0?S.phoneme.vowels:['a','e','i','o','u'];
  const C=S.phoneme.consonants.length>0?S.phoneme.consonants:['k','r','n','s','l','m','t','v'];
  const syllable=S.phoneme.syllable||'CVÂûã';
  let seed=0; for(let ch of meaning)seed=(seed*31+ch.charCodeAt(0))%997;
  const pick=(arr,offset=0)=>arr[Math.abs(seed+offset)%arr.length];
  const syllableCount=[1,2,2,2,3][Math.abs(seed)%5];
  let word='';
  for(let i=0;i<syllableCount;i++){
    const hasFinalC=syllable.includes('CVC')||(syllable.includes('C)')&&seed%2===0);
    word+=pick(C,i*3)+pick(V,i*7);
    if(hasFinalC&&i===syllableCount-1)word+=pick(C,i*11+5);
  }
  return word;
}

function suggestRelatedWords(meaning, conlangWord){
  const family=SEMANTIC_FAMILIES[meaning];
  if(!family||!family.related.length)return;
  const unregistered=family.related.filter(r=>!S.dictionary.find(d=>d.meaning===r));
  if(!unregistered.length)return;
  const suggestions=unregistered.slice(0,3).map(rel=>({jp:rel,conlang:generateWordFromPhonology(rel),tags:family.tags}));
  const r=document.getElementById('gacha-result');
  if(!r)return;
  const existing=document.getElementById('related-suggest-alert');
  if(existing)existing.remove();
  const div=document.createElement('div');
  div.id='related-suggest-alert';
  div.style.cssText='margin-top:12px;padding:14px;background:rgba(140,126,255,0.08);border:1px solid var(--accent-border);border-radius:12px';
  div.innerHTML=`<div style="font-size:0.72rem;font-weight:700;color:var(--accent);letter-spacing:0.06em;margin-bottom:8px">üí° „Äå${meaning}„Äç„Å´Èñ¢ÈÄ£„Åô„ÇãÂçòË™û„ÇÇ‰Ωú„Çä„Åæ„Åô„ÅãÔºü</div>
    <div style="display:flex;flex-wrap:wrap;gap:6px">${suggestions.map(s=>`<button onclick="addRelatedWord('${s.jp}','${s.conlang}',this)" style="padding:6px 12px;border:1px solid var(--border-hover);border-radius:8px;background:var(--surface-2);font-size:0.78rem;cursor:pointer;color:var(--text-secondary)"><span style="font-family:monospace;color:var(--accent)">${s.conlang}</span> <span style="color:var(--text-muted)">Ôºù</span> ${s.jp}</button>`).join('')}</div>
    <div style="font-size:0.68rem;color:var(--text-muted);margin-top:6px;font-style:italic">${t('v_add_dict_btn').replace(' +','')}</div>`;
  r.after(div);
}
function addRelatedWord(jp,conlang,btn){
  addDict(conlang,jp,'ÂêçË©û',[]);
  btn.style.cssText='background:var(--success-dim);border-color:var(--success-border);color:var(--success);padding:6px 12px;border:1px solid;border-radius:8px;font-size:0.78rem;cursor:default';
  btn.innerHTML=t('gc_ok').replace('‚úì ','‚úì ');btn.disabled=true;
}

function randSyl(){ return generateWordFromPhonology(String(Math.random())); }
function selPos(el){el.closest('.toggle-grid').querySelectorAll('.toggle-chip').forEach(c=>c.classList.remove('selected'));el.classList.add('selected')}
function generateSoundLinked(){
  const icon=document.getElementById('sl-spin');if(icon){icon.textContent='‚ü≥';icon.classList.add('spinning')}
  setTimeout(()=>{
    if(icon){icon.classList.remove('spinning');icon.textContent='‚ú¶'}
    const V=S.phoneme.vowels.length?S.phoneme.vowels:['a','e','i'];
    const C=S.phoneme.consonants.length?S.phoneme.consonants:['k','n','r','s','l'];
    const fn=(n)=>{let w='';for(let i=0;i<n;i++)w+=C[Math.floor(Math.random()*C.length)]+V[Math.floor(Math.random()*V.length)];return w};
    const words=Array.from({length:10},()=>fn(1+Math.floor(Math.random()*2)));
    const el=document.getElementById('sl-result');
    if(el)el.innerHTML=words.map(w=>`<div class="gen-word-chip" onclick="promptAddWord('${w}')"><span>${w}</span>${Object.keys(S.scriptMap).length?`<span style="color:var(--accent2);font-family:monospace">${applyScriptMap(w)}</span>`:''}<span>+</span></div>`).join('');
  },800);
}

// ===== CORPUS =====
function buildCorpus(){
  const saved=S.corpus.length?S.corpus.map((c,i)=>corpusCardHtml(c,i)).join(''):`<p style="font-size:0.78rem;color:var(--text-muted);text-align:center;padding:30px 0;font-style:italic">${t('c_empty')}</p>`;
  return`
  ${buildAssistPanel('corpus')}
  <div class="editor-tabs">
    <div class="editor-tab active" onclick="switchTab(this,'ctab-add')">${t('c_tab_add')}</div>
    <div class="editor-tab" onclick="switchTab(this,'ctab-list')">${t('c_tab_list')} (${S.corpus.length})</div>
    <div class="editor-tab" onclick="switchTab(this,'ctab-share')">${t('c_tab_share')}</div>
  </div>
  <div class="tab-content active" id="ctab-add">
    <div class="field-block">
      <div style="display:grid;grid-template-columns:1fr;gap:10px">
        <div><span class="field-label">${t('c_lang_label')}</span>
          <div style="display:flex;gap:8px"><input class="input-field" placeholder="e.g. Silvara kaelo lumael‚Ä¶" id="corpus-cl" oninput="corpusPreviewScript()" style="flex:1;font-family:monospace" onfocus="_activeScriptCell=this"><button class="btn btn-sm" onclick="speakDirect(document.getElementById('corpus-cl').value,'en-US',0.75,1)">üîä</button></div>
          <div id="corpus-script-preview" style="font-size:0.9rem;color:var(--accent2);font-family:monospace;padding:6px 0;letter-spacing:0.05em;min-height:20px"></div>
          <details style="margin-top:4px;cursor:pointer">
            <summary style="font-size:0.68rem;color:var(--accent);letter-spacing:0.06em;text-transform:uppercase;font-weight:700;list-style:none;display:flex;align-items:center;gap:5px"><span>üåê</span> ${t('sc_world_picker')}</summary>
            <div style="margin-top:6px">${buildCharPicker('corpus-cl')}</div>
          </details>
        </div>
        <div><span class="field-label">${t('c_read_label')}</span><input class="input-field" placeholder="e.g. /silvara kaelo lumael/" id="corpus-read" style="font-family:monospace"></div>
        <div><span class="field-label">${t('c_gloss_label')} <small style="font-weight:normal;text-transform:none;letter-spacing:0">${helpBtn('ÈÄêË™ûË®≥')}</small></span><input class="input-field" placeholder="e.g. water-NOM sky-ACC light" id="corpus-gloss" style="font-family:monospace;font-size:0.82rem"><p class="field-hint">${t('c_gloss_hint')}</p></div>
        <div><span class="field-label">${t('c_jp_label')}</span><input class="input-field" placeholder="e.g. water and sky and light" id="corpus-jp"></div>
      </div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-primary btn-sm" onclick="addCorpus()">${t('c_save_btn')}</button>
      <button class="btn btn-sm" onclick="addFromDict()">${t('c_build_btn')}</button>
    </div>
    <div class="ai-box" style="margin-top:14px">
      <div class="ai-label">${t('c_auto_title')}</div>
      <div class="ai-content">${t('c_auto_body')}</div>
      <div class="ai-chips"><div class="ai-chip" onclick="autoComposeSentence()">${t('c_auto_chip')}</div></div>
    </div>
  </div>
  <div class="tab-content" id="ctab-list">
    <div id="corpus-list">${saved}</div>
  </div>
  <div class="tab-content" id="ctab-share">
    <p style="font-size:0.82rem;color:var(--text-secondary);margin-bottom:16px;line-height:1.7;font-style:italic">${t('c_share_desc')}</p>
    <div class="field-block">
      <span class="field-label">${t('c_share_sel_label')}</span>
      <select class="input-field" id="share-sel" onchange="updateSharePreview()" style="cursor:pointer">
        <option value="">${t('c_share_sel_placeholder')}</option>
        ${S.corpus.map((c,i)=>`<option value="${i}">${c.conlang.slice(0,30)}‚Ä¶ ‚Äî ${c.jp}</option>`).join('')}
      </select>
    </div>
    <div class="share-card-preview">
      <canvas id="share-canvas" width="600" height="314"></canvas>
    </div>
    <div class="share-btns">
      <button class="btn btn-primary" onclick="downloadShareCard()">${t('c_dl_btn')}</button>
      <button class="btn btn-gold" onclick="copyShareCard()">${t('c_copy_btn')}</button>
      <button class="btn btn-sm" onclick="updateSharePreview()">${t('c_preview_btn')}</button>
    </div>
  </div>`
}
function corpusCardHtml(c,i){return`<div class="corpus-card"><div class="corpus-conlang">${c.conlang}${Object.keys(S.scriptMap).length?`<span style="color:var(--accent2);font-family:monospace;font-size:0.85rem;margin-left:10px">${applyScriptMap(c.conlang)}</span>`:''}</div>${c.read?`<div class="corpus-kana">${c.read}</div>`:''} ${c.gloss?`<div class="corpus-gloss">${c.gloss}</div>`:''}<div class="corpus-jp">${c.jp}</div><div class="corpus-actions"><button class="btn btn-sm" onclick="speakDirect('${c.conlang}','en-US',0.75,1)">üîä</button><button class="btn btn-sm btn-gold" onclick="setupShareFrom(${i})">‚ú¶ ${t('c_share_btn').replace('‚ú¶ ','')}</button><button class="btn btn-sm" style="color:var(--rose);border-color:var(--rose-border)" onclick="deleteCorpus(${i})">${t('c_del_btn')}</button></div></div>`}
function addCorpus(){const cl=document.getElementById('corpus-cl')?.value.trim(),read=document.getElementById('corpus-read')?.value.trim()||'',gloss=document.getElementById('corpus-gloss')?.value.trim()||'',jp=document.getElementById('corpus-jp')?.value.trim();if(!cl||!jp)return;S.corpus.push({conlang:cl,read,gloss,jp});S.done.corpus=true;updateDashboard();scheduleSave();document.getElementById('corpus-cl').value='';document.getElementById('corpus-read').value='';if(document.getElementById('corpus-gloss'))document.getElementById('corpus-gloss').value='';document.getElementById('corpus-jp').value='';document.getElementById('corpus-script-preview').textContent='';const el=document.getElementById('corpus-list');if(el)el.innerHTML=S.corpus.map((c,i)=>corpusCardHtml(c,i)).join('');const tab=document.querySelector('[onclick*="ctab-list"]');if(tab)switchTab(tab,'ctab-list')}
function deleteCorpus(i){S.corpus.splice(i,1);S.done.corpus=S.corpus.length>0;updateDashboard();scheduleSave();const el=document.getElementById('corpus-list');if(el)el.innerHTML=S.corpus.length?S.corpus.map((c,i)=>corpusCardHtml(c,i)).join(''):`<p style="font-size:0.78rem;color:var(--text-muted);text-align:center;padding:30px 0;font-style:italic">${t('c_empty')}</p>`}
function corpusPreviewScript(){const v=document.getElementById('corpus-cl')?.value;const r=document.getElementById('corpus-script-preview');if(r&&v)r.textContent=Object.keys(S.scriptMap).length?applyScriptMap(v):''}
function addFromDict(){const words=S.dictionary.slice(0,8);const txt=words.map(w=>w.conlang).join(' ');const inp=document.getElementById('corpus-cl');if(inp){inp.value=txt;corpusPreviewScript()}}
function autoComposeSentence(){if(!S.dictionary.length){alert(t('ed_no_words'));return}const nouns=S.dictionary.filter(w=>w.pos==='ÂêçË©û'),verbs=S.dictionary.filter(w=>w.pos==='ÂãïË©û'),adjs=S.dictionary.filter(w=>w.pos==='ÂΩ¢ÂÆπË©û');const n=nouns[Math.floor(Math.random()*nouns.length)],v=verbs[Math.floor(Math.random()*verbs.length)],a=adjs[Math.floor(Math.random()*adjs.length)];let sent='',jp='';if(n&&v){if(S.grammar.order==='SOV'){sent=`${n?.conlang||''} ${a?.conlang||''} ${v?.conlang||''}`.trim();jp=`${n?.meaning||''}„ÅØ${a?.meaning?a.meaning+'„Åß':''}${v?.meaning||''}`;} else {sent=`${n?.conlang||''} ${v?.conlang||''} ${a?.conlang||''}`.trim();jp=`${n?.meaning||''}„Åå${v?.meaning||''}${a?.meaning?'Ôºà'+a.meaning+'Ôºâ':''}`;};}const inp=document.getElementById('corpus-cl'),jpInp=document.getElementById('corpus-jp');if(inp)inp.value=sent;if(jpInp)jpInp.value=jp;corpusPreviewScript()}

// SHARE CARD
function drawShareCard(canvas,corpus){
  if(!corpus||!canvas)return;
  const ctx=canvas.getContext('2d');const W=canvas.width,H=canvas.height;
  const bg=ctx.createLinearGradient(0,0,W,H);bg.addColorStop(0,'#0a0a1e');bg.addColorStop(0.5,'#100a1e');bg.addColorStop(1,'#0a0e1e');ctx.fillStyle=bg;ctx.fillRect(0,0,W,H);
  ctx.fillStyle='rgba(255,255,255,0.4)';for(let i=0;i<40;i++){ctx.beginPath();ctx.arc(Math.random()*W,Math.random()*H,Math.random()*1.2,0,Math.PI*2);ctx.fill()}
  ctx.strokeStyle='rgba(140,126,255,0.35)';ctx.lineWidth=1.5;ctx.strokeRect(12,12,W-24,H-24);
  const gl=ctx.createLinearGradient(0,0,W,0);gl.addColorStop(0,'#8c7eff');gl.addColorStop(0.5,'#c07bff');gl.addColorStop(1,'transparent');ctx.strokeStyle=gl;ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(12,12);ctx.lineTo(W-12,12);ctx.stroke();
  ctx.fillStyle='rgba(140,126,255,0.6)';ctx.font='500 11px sans-serif';ctx.fillText('‚ú¶ LINGUA',26,34);
  const scriptResult=Object.keys(S.scriptMap).length?applyScriptMap(corpus.conlang):corpus.conlang;
  ctx.fillStyle='#e8e4f0';ctx.font='bold 22px serif';const mainText=corpus.conlang.length>28?corpus.conlang.slice(0,28)+'‚Ä¶':corpus.conlang;ctx.fillText(mainText,30,90);
  if(Object.keys(S.scriptMap).length){ctx.fillStyle='rgba(192,123,255,0.85)';ctx.font='18px monospace';ctx.fillText(scriptResult.slice(0,36),30,120)}
  if(corpus.read){ctx.fillStyle='rgba(140,126,255,0.8)';ctx.font='14px monospace';ctx.fillText(corpus.read.slice(0,50),30,Object.keys(S.scriptMap).length?148:120)}
  ctx.strokeStyle='rgba(255,255,255,0.1)';ctx.lineWidth=1;const sepY=Object.keys(S.scriptMap).length?170:145;ctx.beginPath();ctx.moveTo(30,sepY);ctx.lineTo(W-30,sepY);ctx.stroke();
  ctx.fillStyle='rgba(232,228,240,0.65)';ctx.font='500 16px serif';ctx.fillText(corpus.jp.length>40?corpus.jp.slice(0,40)+'‚Ä¶':corpus.jp,30,sepY+26);
  ctx.fillStyle='rgba(255,255,255,0.3)';ctx.font='12px sans-serif';ctx.textAlign='right';ctx.fillText(S.langName,W-26,H-20);ctx.textAlign='left';
}
function updateSharePreview(){const sel=document.getElementById('share-sel'),canvas=document.getElementById('share-canvas');if(!sel||!canvas)return;const idx=parseInt(sel.value);const corpus=S.corpus[idx];if(!corpus)return;drawShareCard(canvas,corpus)}
function setupShareFrom(i){const tab=document.querySelector('[onclick*="ctab-share"]');if(tab)switchTab(tab,'ctab-share');setTimeout(()=>{const sel=document.getElementById('share-sel');if(sel){sel.value=i;updateSharePreview()}},100)}
function downloadShareCard(){const canvas=document.getElementById('share-canvas');if(!canvas)return;const a=document.createElement('a');a.download=`${S.langName}_corpus.png`;a.href=canvas.toDataURL('image/png');a.click()}
function copyShareCard(){const canvas=document.getElementById('share-canvas');if(!canvas)return;canvas.toBlob(b=>{try{navigator.clipboard.write([new ClipboardItem({'image/png':b})]).then(()=>alert(t('ed_clipboard_ok'))).catch(()=>alert(t('ed_clipboard_fail')))}catch(e){alert(t('ed_clipboard_nosupport'))}})}

// ===== DAILY EDITOR =====
function buildDailyEditor(){const today=new Date();const sentence=getDailySentences()[today.getDate()%getDailySentences().length];return`<div class="field-block"><span class="field-label">${t('de_today')}</span><div style="font-family:'Cinzel',serif;font-size:1.2rem;font-weight:600;padding:16px;background:var(--surface-2);border:1px solid var(--gold-border);border-radius:10px;margin-bottom:14px;letter-spacing:0.04em">${sentence}</div><span class="field-label">${t('de_write')}</span><div style="display:flex;gap:8px;margin-bottom:8px"><input class="input-field" placeholder="${t('de_input_placeholder')}" id="daily-editor-input" style="flex:1;font-family:monospace"><button class="btn btn-sm" onclick="speakDirect(document.getElementById('daily-editor-input').value,'en-US',0.75,1)">üîä</button></div><div style="display:flex;gap:8px"><button class="btn btn-primary btn-sm" onclick="submitDailyEditor()">${t('de_submit')}</button><button class="btn btn-sm" onclick="checkDailyGrammar()">${t('de_check')}</button><button class="btn btn-sm btn-gold" onclick="saveDailyAsCorpus()">${t('de_save_corpus')}</button></div></div><div id="daily-editor-feedback"></div><div class="field-block" style="margin-top:8px"><span class="field-label">${t('de_past')}</span>${S.sentences.length?S.sentences.slice(-5).reverse().map(s=>`<div class="word-card"><div style="flex:1"><div class="word-main">${s}</div></div><div class="word-play" onclick="speakDirect('${s}','en-US',0.75,1)">üîä</div></div>`).join(''):`<p style="font-size:0.78rem;color:var(--text-muted);font-style:italic">${t('de_empty')}</p>`}</div>`}
function submitDailyEditor(){const i=document.getElementById('daily-editor-input');if(!i||!i.value.trim())return;S.sentences.push(i.value.trim());S.done.sentence=true;updateDashboard();checkDailyGrammar()}
function saveDailyAsCorpus(){const inp=document.getElementById('daily-editor-input');if(!inp?.value.trim())return;const today=new Date();const jp=getDailySentences()[today.getDate()%getDailySentences().length];S.corpus.push({conlang:inp.value.trim(),read:'',jp});S.done.corpus=true;updateDashboard();alert(t('ed_saved_corpus'))}
function checkDailyGrammar(){const i=document.getElementById('daily-editor-input'),el=document.getElementById('daily-editor-feedback');if(!i||!el)return;el.innerHTML=`<div class="ai-box"><div class="ai-label">${t('gc_checking')}</div><div class="ai-content"><span class="spinning">‚ü≥</span></div></div>`;setTimeout(()=>{const words=i.value.toLowerCase().split(/\s+/),issues=[];words.forEach(w=>{if(!S.dictionary.find(d=>d.conlang.toLowerCase()===w)&&w.length>2)issues.push(`"${w}" ${t('gc_unknown')}`)});if(!issues.length)el.innerHTML=`<div class="ai-box" style="border-color:var(--success-border);background:var(--success-dim)"><div class="ai-label" style="color:var(--success)">${t('gc_ok')}</div><div class="ai-content">${t('gc_ok_msg')}</div></div>`;else el.innerHTML=`<div class="correction-box"><div class="correction-label">${t('gc_warn')}</div>${issues.map(x=>`<div class="correction-item">„Éª${x}</div>`).join('')}</div>`;},900)}

// ==== UI HELPERS ====
function switchTab(el,id){const body=el.closest('.editor-panel')||document.getElementById('editor-body');body.querySelectorAll('.editor-tab').forEach(t=>t.classList.remove('active'));body.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));el.classList.add('active');const t=document.getElementById(id);if(t)t.classList.add('active');setTimeout(()=>initAutoResize(),30)}
function selOne(el,key,val){el.closest('.select-grid').querySelectorAll('.select-option').forEach(o=>o.classList.remove('selected'));el.classList.add('selected')}
function toggleChip(el){el.classList.toggle('selected')}

// ==== VOICE ====
let currentVoiceEl=null;
function playVoice(el,key){if(currentVoiceEl){currentVoiceEl.classList.remove('playing');const sp=currentVoiceEl.querySelector('span');if(sp)sp.textContent='‚ñ∂'}if(window.speechSynthesis)window.speechSynthesis.cancel();if(currentVoiceEl===el){currentVoiceEl=null;return}const s=voiceSamples[key];if(!s)return;el.classList.add('playing');const sp=el.querySelector('span');if(sp)sp.textContent='‚ñ†';currentVoiceEl=el;const u=new SpeechSynthesisUtterance(s.text);u.lang=s.lang;u.rate=s.rate;u.pitch=s.pitch;u.volume=0.9;u.onend=()=>{el.classList.remove('playing');if(sp)sp.textContent='‚ñ∂';if(currentVoiceEl===el)currentVoiceEl=null};window.speechSynthesis.speak(u)}
function speakDirect(text,lang,rate,pitch){if(!text)return;if(window.speechSynthesis)window.speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(text);u.lang=lang;u.rate=rate;u.pitch=pitch;u.volume=0.9;window.speechSynthesis.speak(u)}

// ===== V13: i18n ‚Äî 4Ë®ÄË™ûÂÆåÂÖ®ÂØæÂøú =====
const I18N = {
  ja:{
    nav_home:'„Éõ„Éº„É†',nav_script:'ÊñáÂ≠ó‰ΩìÁ≥ª',nav_phoneme:'Èü≥Èüª',nav_grammar:'ÊñáÊ≥ï',
    nav_vocab:'Ë™ûÂΩô',nav_corpus:'‰æãÊñá',nav_daily:'1Êó•1Êñá',
    nav_library:'üåø „É©„Ç§„Éñ„É©„É™',nav_aichat:'ü§ñ AI‰ºöË©±',nav_faq:'‚ùì FAQ',
    vis_private:'ÈùûÂÖ¨Èñã',vis_unlisted:'ÈôêÂÆöÂÖ¨Èñã',vis_public:'ÂÖ¨Èñã',
    vis_popup_title:'üåç ÂÖ¨ÈñãË®≠ÂÆö',
    vis_private_desc:'Ëá™ÂàÜ„Å†„Åë„ÅåË¶ã„Çâ„Çå„Åæ„Åô„ÄÇ‰∏ãÊõ∏„ÅçÁä∂ÊÖã„ÄÇ',
    vis_unlisted_desc:'URL„ÇíÁü•„Å£„Å¶„ÅÑ„Çã‰∫∫„Å†„Åë„ÅåË¶ã„Çâ„Çå„Åæ„Åô„ÄÇ',
    vis_public_desc:'„É©„Ç§„Éñ„É©„É™„Å´Êé≤Ëºâ„ÄÇË™∞„Åß„ÇÇÈñ≤Ë¶ß„Åß„Åç„Åæ„Åô„ÄÇ',
    vis_importable:'„Ç§„É≥„Éù„Éº„ÉàË®±ÂèØ',
    lib_title:'üåø Ë®ÄË™û„É©„Ç§„Éñ„É©„É™',lib_sub:'‰∏ñÁïå„ÅÆ„Ç≥„É≥„É©„É≥„Ç¨„Éº„Åå‰Ωú„Å£„ÅüË®ÄË™û„ÇíÁú∫„ÇÅ„Çà„ÅÜ',
    lib_community:'„Ç≥„Éü„É•„Éã„ÉÜ„Ç£„ÅÆË®ÄË™û',lib_search:'Ë®ÄË™ûÂêç„Éª„Ç∏„É£„É≥„É´„ÅßÊ§úÁ¥¢‚Ä¶',
    lib_empty:'Ë®ÄË™û„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì',lib_see_detail:'„Çø„ÉÉ„Éó„ÅßË©≥Á¥∞ ‚Üí',lib_author:'‰ΩúËÄÖ',
    btn_import_json:'üì• JSON„Ç§„É≥„Éù„Éº„Éà',btn_export_json:'üì§ JSON„Ç®„ÇØ„Çπ„Éù„Éº„Éà',
    btn_close:'Èñâ„Åò„Çã',btn_cancel:'„Ç≠„É£„É≥„Çª„É´',btn_import:'„Ç§„É≥„Éù„Éº„ÉàÂÆüË°å',btn_send:'ÈÄÅ‰ø°',
    btn_clear_chat:'üóë „ÇØ„É™„Ç¢',btn_export_vocab:'üìñ Êñ∞Ë™û„ÇíËæûÊõ∏„Å∏',
    btn_login:'„É≠„Ç∞„Ç§„É≥',btn_start:'ÁÑ°Êñô„ÅßÂßã„ÇÅ„Çã',btn_save:'‰øùÂ≠ò',btn_add:'ËøΩÂä† +',
    btn_back_home:'‚Üê „Éõ„Éº„É†„Å´Êàª„Çã',btn_clear:'„ÇØ„É™„Ç¢',btn_clear_slots:'üóë „ÇØ„É™„Ç¢',btn_logout:'„É≠„Ç∞„Ç¢„Ç¶„Éà',
    btn_contact:'üí¨ „ÅäÂïè„ÅÑÂêà„Çè„Åõ',btn_send_contact:'ÈÄÅ‰ø°',
    contact_title:'üí¨ „ÅäÂïè„ÅÑÂêà„Çè„Åõ',contact_subtitle:'„ÅîÊÑèË¶ã„Éª„ÅîË¶ÅÊúõ„Éª„Éê„Ç∞Â†±Âëä„Çí„ÅäÂæÖ„Å°„Åó„Å¶„Åä„Çä„Åæ„Åô',
    contact_category:'„Ç´„ÉÜ„Ç¥„É™„Éº',contact_email:'„É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÔºà‰ªªÊÑèÔºâ',contact_message:'„É°„ÉÉ„Çª„Éº„Ç∏',
    contact_message_placeholder:'Ë©≥„Åó„ÅèÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ...',
    contact_cat_bug:'üêõ „Éê„Ç∞Â†±Âëä',contact_cat_feature:'‚ú® Ê©üËÉΩ„É™„ÇØ„Ç®„Çπ„Éà',
    contact_cat_feedback:'üí≠ „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ',contact_cat_other:'„Åù„ÅÆ‰ªñ',
    contact_success:'„ÅäÂïè„ÅÑÂêà„Çè„Åõ„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ',
    contact_error:'ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ',
    contact_error_empty:'„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
    contact_email_label:'„Åæ„Åü„ÅØÁõ¥Êé•„É°„Éº„É´„ÅßÔºö',
    // FAQ
    faq_title:'‚ùì „Çà„Åè„ÅÇ„ÇãË≥™Âïè',faq_subtitle:'Lingua„ÅÆ‰Ωø„ÅÑÊñπ„ÉªÊ©üËÉΩ„ÉªÊñôÈáë„Å´„Å§„ÅÑ„Å¶',
    faq_cat_basic:'üåü Âü∫Êú¨Ê©üËÉΩ',faq_cat_features:'‚ö° Ê©üËÉΩ„Å´„Å§„ÅÑ„Å¶',
    faq_cat_pricing:'üíé ÊñôÈáë„Éó„É©„É≥',faq_cat_support:'üí¨ „Çµ„Éù„Éº„Éà',
    faq_q1:'Lingua„Å£„Å¶‰Ωï„Åå„Åß„Åç„Çã„ÅÆÔºü',
    faq_a1:'Lingua„ÅØ‰∫∫Â∑•Ë®ÄË™ûÔºà„Ç≥„É≥„É©„É≥„Ç∞Ôºâ„Çí‰ΩúÊàê„ÉªÁÆ°ÁêÜ„Åß„Åç„ÇãWeb„Ç¢„Éó„É™„Åß„Åô„ÄÇÊñáÂ≠ó‰ΩìÁ≥ª„ÄÅÈü≥Èüª„ÄÅÊñáÊ≥ï„ÄÅËæûÊõ∏„ÄÅ‰æãÊñá„Ç≥„Éº„Éë„Çπ„Çí‰∏ÄÂÖÉÁÆ°ÁêÜ„ÄÇAIÊ©üËÉΩ„ÅßÊñ∞Ë™ûÁîüÊàê„ÇÑÊñáÊ≥ï„ÉÅ„Çß„ÉÉ„ÇØ„ÇÇÂèØËÉΩ„Åß„Åô„ÄÇ',
    faq_q2:'ÁÑ°Êñô„Åß‰Ωø„Åà„ÇãÔºü',
    faq_a2:'„ÅØ„ÅÑÔºÅÂü∫Êú¨Ê©üËÉΩ„ÅØÂÆåÂÖ®ÁÑ°Êñô„Åß„Åô„ÄÇËæûÊõ∏„ÉªÊñáÊ≥ï„Éª‰æãÊñá„ÅÆ‰ΩúÊàê„ÄÅJSON„Ç®„ÇØ„Çπ„Éù„Éº„Éà„ÄÅ„É©„Ç§„Éñ„É©„É™Èñ≤Ë¶ß„Åå„Åô„Åπ„Å¶ÁÑ°Êñô„ÄÇPro„Éó„É©„É≥„Åß„ÅØAIÊ©üËÉΩÁÑ°Âà∂Èôê„ÄÅ„ÇØ„É©„Ç¶„ÉâÂêåÊúü„ÄÅË§áÊï∞Ë®ÄË™û‰ΩúÊàê„ÅåÂèØËÉΩ„Å´„Å™„Çä„Åæ„Åô„ÄÇ',
    faq_q3:'„Éá„Éº„Çø„ÅØ‰øùÂ≠ò„Åï„Çå„ÇãÔºü',
    faq_a3:'„Éñ„É©„Ç¶„Ç∂„ÅÆ„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´Ëá™Âãï‰øùÂ≠ò„Åï„Çå„Åæ„Åô„ÄÇPro„É¶„Éº„Ç∂„Éº„ÅØ„ÇØ„É©„Ç¶„ÉâÂêåÊúüÊ©üËÉΩ„ÅßË§áÊï∞„Éá„Éê„Ç§„ÇπÈñì„Åß„Éá„Éº„Çø„ÇíÂÖ±Êúâ„Åß„Åç„Åæ„Åô„ÄÇ',
    faq_q4:'AIÊ©üËÉΩ„ÅØ„Å©„ÅÜ‰Ωø„ÅÜ„ÅÆÔºü',
    faq_a4:'ËæûÊõ∏„Çø„Éñ„ÅÆ„Äå„Ç¨„ÉÅ„É£ÁîüÊàê„Äç„ÅßÈü≥Èüª„É´„Éº„É´„Å´Âü∫„Å•„ÅÑ„ÅüÊñ∞Ë™û„ÇíËá™ÂãïÁîüÊàê„ÄÇAI‰ºöË©±Ê©üËÉΩ„Åß„ÅØ„ÄÅ„ÅÇ„Å™„Åü„ÅÆË®ÄË™û„É´„Éº„É´„Åß‰ºöË©±Á∑¥Áøí„ÇÑÊñáÊ≥ï„ÉÅ„Çß„ÉÉ„ÇØ„Åå„Åß„Åç„Åæ„Åô„ÄÇ',
    faq_q5:'Ë§áÊï∞„ÅÆË®ÄË™û„Çí‰Ωú„Çå„ÇãÔºü',
    faq_a5:'Free„Éó„É©„É≥„ÅØ1Ë®ÄË™û„ÅÆ„Åø„ÄÇLite„Éó„É©„É≥„Å®Premium„Éó„É©„É≥„Åß„ÅØÁÑ°Âà∂Èôê„Å´‰ΩúÊàê„Åß„Åç„Åæ„Åô„ÄÇ',
    faq_q6:'‰ªñ„ÅÆ‰∫∫„ÅÆË®ÄË™û„ÇíË¶ã„Çå„ÇãÔºü',
    faq_a6:'„ÅØ„ÅÑÔºÅ„Äåüåø „É©„Ç§„Éñ„É©„É™„Äç„Åã„ÇâÂÖ¨Èñã„Åï„Çå„Å¶„ÅÑ„ÇãË®ÄË™û„ÇíÈñ≤Ë¶ß„Éª„Ç§„É≥„Éù„Éº„Éà„Åß„Åç„Åæ„Åô„ÄÇËá™ÂàÜ„ÅÆË®ÄË™û„ÇÇÂÖ¨ÈñãË®≠ÂÆö„ÅßÂÖ±ÊúâÂèØËÉΩ„Åß„Åô„ÄÇ',
    faq_q7:'Pro„Éó„É©„É≥„ÅÆÊñôÈáë„ÅØÔºü',
    faq_a7:'Lite: $4.99/Êúà„ÄÅPremium: $9.99/Êúà„ÄÇ14Êó•ÈñìÁÑ°Êñô„Éà„É©„Ç§„Ç¢„É´„ÅÇ„Çä„ÄÇ„ÅÑ„Å§„Åß„ÇÇ„Ç≠„É£„É≥„Çª„É´ÂèØËÉΩ„Åß„Åô„ÄÇ',
    faq_q8:'ÁÑ°ÊñôÁâà„Å®„ÅÆÈÅï„ÅÑ„ÅØÔºü',
    faq_a8:'<strong>Free:</strong> 1Ë®ÄË™û„ÄÅAI‰ºöË©±10Âõû/Êó•„ÄÅ„É≠„Éº„Ç´„É´‰øùÂ≠ò„ÅÆ„Åø<br><strong>Lite:</strong> ÁÑ°Âà∂Èôê„ÅÆË®ÄË™û„ÄÅAI‰ºöË©±50Âõû/Êó•„ÄÅ„ÇØ„É©„Ç¶„ÉâÂêåÊúü<br><strong>Premium:</strong> „Åô„Åπ„Å¶ÁÑ°Âà∂Èôê„ÄÅÂÑ™ÂÖà„Çµ„Éù„Éº„Éà„ÄÅÊñ∞Ê©üËÉΩÂÖàË°å„Ç¢„ÇØ„Çª„Çπ',
    faq_q9:'„Éê„Ç∞„ÇíË¶ã„Å§„Åë„ÅüÂ†¥Âêà„ÅØÔºü',
    faq_a9:'ÁîªÈù¢Âè≥‰∏ä„ÅÆ„Äåüí¨ „ÅäÂïè„ÅÑÂêà„Çè„Åõ„Äç„Åã„Çâ„ÅîÂ†±Âëä„Åè„Å†„Åï„ÅÑ„ÄÇ„Åæ„Åü„ÅØÁõ¥Êé•',
    faq_a9_2:'„Åæ„Åß„É°„Éº„É´„Çí„ÅäÈÄÅ„Çä„Åè„Å†„Åï„ÅÑ„ÄÇ',
    faq_q10:'Ê©üËÉΩ„É™„ÇØ„Ç®„Çπ„Éà„ÅØÂèó„Åë‰ªò„Åë„Å¶„ÇãÔºü',
    faq_a10:'Â§ßÊ≠ìËøé„Åß„ÅôÔºÅ„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Éï„Ç©„Éº„É†„Åã„Çâ„Äå‚ú® Ê©üËÉΩ„É™„ÇØ„Ç®„Çπ„Éà„Äç„ÇíÈÅ∏Êäû„Åó„Å¶„ÅäÈÄÅ„Çä„Åè„Å†„Åï„ÅÑ„ÄÇ„É¶„Éº„Ç∂„Éº„ÅÆÂ£∞„ÇíÂ§ßÂàá„Å´„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ',
    faq_more:'‰ªñ„Å´Ë≥™Âïè„Åå„ÅÇ„ÇãÂ†¥Âêà',faq_more_desc:'„ÅäÊ∞óËªΩ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ',
    aichat_sub:'„ÅÇ„Å™„Åü„ÅÆË®ÄË™û„É´„Éº„É´„Åß‰ºöË©±„Åô„Çã',aichat_badge:'Conlang-AI',
    aichat_welcome_title:'‚ú¶ Conlang-AI „Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ',
    aichat_welcome_body:'ËæûÊõ∏„ÉªÊñáÊ≥ï„ÉªÈü≥Èüª„É´„Éº„É´„ÇíÂÖ®ÈÉ®Ë™≠„ÅøËæº„Çì„Åß‰ºöË©±„Åó„Åæ„Åô„ÄÇËá™ÂàÜ„ÅÆË®ÄË™û„ÅßË©±„Åó„Åã„Åë„Å¶„Åø„Çà„ÅÜÔºÅ',
    aichat_placeholder:'„ÅÇ„Å™„Åü„ÅÆË®ÄË™û„ÅßÂÖ•Âäõ‚Ä¶ „Åæ„Åü„ÅØÊó•Êú¨Ë™û„Åß„ÇÇOK',
    aichat_quick_hi:'„Åì„Çì„Å´„Å°„ÅØ',aichat_quick_name:'ÁßÅ„ÅÆÂêçÂâç„ÅØ‚Ä¶',
    aichat_quick_date:'‰ªäÊó•„ÅØ‰ΩïÊó•Ôºü',aichat_quick_word:'‚ú¶ Êñ∞Ë™û„ÇíÊèêÊ°à„Åó„Å¶',
    import_title:'üì• Ë®ÄË™û„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà',
    import_desc:'Lingua„ÅÆJSON„Éï„Ç°„Ç§„É´„ÇíË≤º„Çä‰ªò„Åë„Å¶„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åô„ÄÇÁèæÂú®„ÅÆ„Éá„Éº„Çø„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇ',
    storage_ok:'üíæ ‰øùÂ≠ò„Åó„Åæ„Åó„Åü',storage_warn:'‚ö† „Éá„Éº„ÇøÂÆπÈáè„ÅåÂ¢ó„Åà„Å¶„ÅÑ„Åæ„Åô',storage_full:'‚ùå ‰øùÂ≠òÈ†òÂüü„Åå‰∏çË∂≥ÔºÅ',
    dash_complete:'ÂÆåÊàêÂ∫¶',dash_words:'Ë™ûÂΩôÊï∞',dash_patterns:'ÊñáÊ≥ï„Éë„Çø„Éº„É≥',
    dash_corpus:'‰æãÊñáÊï∞',dash_done:'Ë®≠ÂÆöÊ∏à„Åø',
    chat_cleared:'„ÉÅ„É£„ÉÉ„Éà„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü„ÄÇ„Åæ„Åü„ÅÑ„Å§„Åß„ÇÇË©±„Åó„Åã„Åë„Å¶„Å≠ÔºÅ',ai_assist_title:'‚ú¶ AI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà ‚Äî ‰Ωï„Åß„ÇÇËÅû„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ',ai_assist_placeholder:'Ë≥™Âïè„ÇíÂÖ•Âäõ‚Ä¶ Ôºà‰æãÔºöÂàùÂøÉËÄÖÂêë„Åë„Å´Êïô„Åà„Å¶Ôºâ',ai_thinking:'ËÄÉ„Åà‰∏≠‚Ä¶',ph_chart_tab:'üìä Èü≥ÈüªÂõ≥',ph_not_set:'ÔºàÊú™Ë®≠ÂÆöÔºâ',ph_reg_on:'üî¥ ÁôªÈå≤„É¢„Éº„Éâ ON',ph_reg_off:'‚¨§ ÁôªÈå≤„É¢„Éº„Éâ OFF',ph_chart_empty:'Èü≥Èüª„ÇíÁôªÈå≤„Åô„Çã„Å®Âõ≥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô',gp_form_suffix:'ÂΩ¢ÔºàÊé•Â∞æËæûÔºâ',gp_form_prefix:'ÂΩ¢ÔºàÊé•È†≠ËæûÔºâ',gp_form_infix:'ÂΩ¢ÔºàÊé•‰∏≠ËæûÔºâ',gp_form_mutation:'ÊØçÈü≥„ÅÆÂ§âÂåñ',gp_form_tone:'Èü≥Ë™ø„É´„Éº„É´',gp_form_circumfix:'ÂâçÈÉ®„ÉªÂæåÈÉ®',gp_form_reduplication:'Áπ∞„ÇäËøî„ÅóÊñπ',gp_form_particle:'Âä©Ë©û„ÅÆÂΩ¢',gp_form_label:'ÂΩ¢',gp_category_default:'ÊñáÊ≥ï',gp_enter_hint:'ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
    settings_label:'Ë®ÄË™û„ÅÆË®≠ÂÆö',
    dash_rename:'‚úé ÂêçÂâç„ÇíÂ§â„Åà„Çã',
    card_vibe_desc:'Ë®ÄË™û„ÅÆÈõ∞Âõ≤Ê∞ó„ÇíAI„Å´‰ºù„Åà„Å¶„ÄÅÈü≥„ÉªÊñáÊ≥ï„ÅÆÊñπÂêëÊÄß„ÇíÊèêÊ°à„Åó„Å¶„ÇÇ„Çâ„ÅÑ„Åæ„Åô„ÄÇ',
    card_script_desc:'„Ç¢„É´„Éï„Ç°„Éô„ÉÉ„Éà„Å´Áã¨Ëá™„ÅÆÊñáÂ≠ó„ÇíÂØæÂøú‰ªò„Åë„ÄÇ„É™„Ç¢„É´„Çø„Ç§„É†„Éó„É¨„Éì„É•„Éº„ÅßÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ',
    card_phoneme_desc:'ÊØçÈü≥„ÉªÂ≠êÈü≥„ÉªÈü≥ÁØÄÊßãÈÄ†„ÇíË®≠ÂÆö„ÄÇ„Ç§„É≥„Çπ„Éî„É¨„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅßÊñ∞ÂçòË™û„ÅÆÈüø„Åç„ÇíÁîüÊàê„ÄÇ',
    card_grammar_desc:'Ë™ûÈ†Ü„ÉªÊ†º„ÉªÊôÇÂà∂„ÉªÊ¥ªÁî®„ÄÇÊ†ºÂ§âÂåñË°®„Çí„Éù„ÉÅ„Éù„ÉÅÈÅ∏„Å∂„Å†„Åë„ÅßËá™ÂãïÁîüÊàê„ÄÇ',
    card_vocab_desc:'„Çø„Ç∞ÁÆ°ÁêÜ„ÉªÈÄÜÂºï„Åç„Éª„Ç¨„ÉÅ„É£ÁîüÊàê„ÄÇ‰∏°ÊñπÂêë„Ç§„É≥„ÇØ„É™„É°„É≥„Çø„É´„Çµ„Éº„ÉÅ‰ªò„Åç„ÄÇ',
    card_corpus_desc:'‰æãÊñá„Ç´„Éº„ÉâÔºà„Ç≥„É≥„É©„É≥„Ç∞„ÉªË™≠„Åø„ÉªÁøªË®≥Ôºâ„ÇíËìÑÁ©ç„ÄÇÁîªÂÉè„ÅßSNS„Ç∑„Çß„Ç¢„ÄÇ',
    card_not_set:'„Åæ„Å†Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì',
    card_vocab_empty:'„Åæ„Å†ÂçòË™û„Åå„ÅÇ„Çä„Åæ„Åõ„Çì',
    card_corpus_empty:'„Åæ„Å†‰æãÊñá„Åå„ÅÇ„Çä„Åæ„Åõ„Çì',
    card_vibe_title:'‰∏ñÁïåË¶≥„Éª„Ç§„É°„Éº„Ç∏',
    card_script_title:'ÊñáÂ≠ó‰ΩìÁ≥ª„Éª„Éï„Ç©„É≥„Éà„Éû„ÉÉ„Éî„É≥„Ç∞',
    card_grammar_title:'ÊñáÊ≥ï + Ê†ºÂ§âÂåñ„Éû„Éà„É™„ÉÉ„ÇØ„Çπ',
    card_vocab_title:'Ë™ûÂΩô„ÉªËæûÊõ∏ÔºàÈÄÜÂºï„ÅçÂØæÂøúÔºâ',
    card_corpus_title:'‰æãÊñá„Ç≥„Éº„Éë„Çπ + „Ç∑„Çß„Ç¢',
    dash_reset:'‚Ü∫ „É™„Çª„ÉÉ„Éà',
    dash_export:'üì§ „Ç®„ÇØ„Çπ„Éù„Éº„Éà',
    dash_complete:'ÂÆåÊàêÂ∫¶',
    daily_input_hint:'„Åì„ÅÆÊñá„Çí„ÅÇ„Å™„Åü„ÅÆË®ÄË™û„ÅßÊõ∏„ÅÑ„Å¶„Åø„Çà„ÅÜ',
    dash_daily_subtitle:'‰ªäÊó•„ÅÆ1Êñá ‚Äî',daily_label:'‰ªäÊó•„ÅÆ1Êñá„ÉÅ„É£„É¨„É≥„Ç∏',
    daily_submit:'ÈÄÅ‰ø° & ‰øùÂ≠ò',daily_check:'‚úì Ê∑ªÂâä',daily_save:'‰æãÊñá„Å®„Åó„Å¶‰øùÂ≠ò',
    daily_past:'ÈÅéÂéª„ÅÆÂõûÁ≠î',daily_empty:'„Åæ„Å†ÂõûÁ≠î„Åå„ÅÇ„Çä„Åæ„Åõ„Çì',
    // Grammar tabs
    g_tab_order:'Ë™ûÈ†Ü„ÉªÊ†º',g_tab_verb:'ÂãïË©û„ÉªÊôÇÂà∂',g_tab_pattern:'ÊñáÊ≥ï„Éë„Çø„Éº„É≥',
    g_tab_matrix:'Ê†ºÂ§âÂåñ„Éû„Éà„É™„ÉÉ„ÇØ„Çπ',g_tab_notes:'ÊñáÊ≥ïÊõ∏„É°„É¢',g_tab_roadmap:'üó∫ „É≠„Éº„Éâ„Éû„ÉÉ„Éó',
    g_word_order:'Âü∫Êú¨Ë™ûÈ†Ü',g_cases:'ÂêçË©û„ÅÆÊ†º',g_gender:'ÊÄß„ÉªÊï∞„ÅÆÂå∫Âà•',
    g_verb_conj:'ÂãïË©û„ÅÆÊ¥ªÁî®',g_tense:'ÊôÇÂà∂',g_tense_hint:'„ÄåÊôÇÂà∂„Å™„Åó„Äç„ÇíÈÅ∏„Å∂„Å®ÂâØË©û„ÅßÊôÇÈñì„ÇíË°®„Åó„Åæ„Åô',
    g_pattern_what:'ÊñáÊ≥ï„Éë„Çø„Éº„É≥„Å£„Å¶„Å™„Å´Ôºü',
    g_pattern_desc:'ÂçòË™û„ÅÆÂâç„ÉªÂæå„Éª‰∏≠„Å´ÈÉ®ÂìÅ„Çí„Åè„Å£„Å§„Åë„Å¶ÊÑèÂë≥„ÇíÂ§â„Åà„Çã„É´„Éº„É´„Åß„Åô„ÄÇËã±Ë™û„ÅÆ un-happy „ÇÑÊó•Êú¨Ë™û„ÅÆ È£ü„Åπ-„Åü„ÅÑ „ÅÆ„Çà„ÅÜ„Å™„ÇÇ„ÅÆ„ÄÇ',
    g_pattern_type_label:'„Éë„Çø„Éº„É≥„ÅÆÁ®ÆÈ°û',g_pattern_add:'Êñ∞„Åó„ÅÑ„Éë„Çø„Éº„É≥„ÇíËøΩÂä†',
    g_form:'ÂΩ¢',g_meaning_fn:'ÊÑèÂë≥„ÉªÊ©üËÉΩ',g_example_opt:'‰ΩøÁî®‰æãÔºà‰ªªÊÑèÔºâ',g_category:'„Ç´„ÉÜ„Ç¥„É™',
    g_suggest_suffix:'Êé•Â∞æËæû„ÇíÊèêÊ°à',g_suggest_prefix:'Êé•È†≠Ëæû„ÇíÊèêÊ°à',g_suggest_particle:'Âä©Ë©û„ÇíÊèêÊ°à',
    g_mat_hint:'Ê†ºÔºàË°åÔºâ„Å®Êï∞„ÉªÊÄßÔºàÂàóÔºâ„ÇíÈÅ∏„Çì„ÅßÊ†ºÂ§âÂåñË°®„ÇíÁîüÊàê„ÄÇÂêÑ„Çª„É´„Å´Â§âÂåñÂΩ¢„ÇíÁõ¥Êé•ÂÖ•Âäõ„Åß„Åç„Åæ„Åô„ÄÇ',
    g_add_row:'Ê†ºÔºàË°åÔºâ„ÇíËøΩÂä†',g_add_col:'Êï∞„ÉªÊÄßÔºàÂàóÔºâ„ÇíËøΩÂä†',
    g_root_label:'Ë™ûÊ†πÔºàËæûÊõ∏„Åã„ÇâÈÅ∏„Å∂Ôºâ',g_auto_fill:'‚ú¶ Ë™ûÂ∞æËá™ÂãïË£úÂÆå',
    g_regen:'üîÑ Ë°®„ÇíÂÜçÁîüÊàê',g_sample:'„Çµ„É≥„Éó„É´Ë™ûÂ∞æ„ÇíÂÖ•Âäõ',g_clear_mat:'üóë „ÇØ„É™„Ç¢',
    g_notes_placeholder:'# ÊñáÊ≥ïÊõ∏„Çø„Ç§„Éà„É´\n## „Çª„ÇØ„Ç∑„Éß„É≥\nÊñáÊ≥ï„ÅÆË™¨Êòé„Çí„Åì„Åì„Å´Êõ∏„Åì„ÅÜ„ÄÇMarkdown„Åå‰Ωø„Åà„Åæ„Åô„ÄÇ',
    // Vocab
    v_tab_gacha:'„Ç¨„ÉÅ„É£ÁîüÊàê',v_tab_manual:'ÊâãÂãïÁôªÈå≤',v_tab_dict:'ËæûÊõ∏ÔºàÈ†ÜÂºï„ÅçÔºâ',v_tab_rev:'ÈÄÜÂºï„Åç',v_tab_sound:'Èü≥ÈüªÈÄ£ÂãïÁîüÊàê',
    v_gacha_gen:'ÁîüÊàê ‚ú¶',v_dict_header:'üìñ ËæûÊõ∏',v_dict_alpha:'„ÅÇ‚Üë',v_dict_pos_sort:'ÂìÅË©ûÈ†Ü',
    v_search_placeholder:'üîç „Ç≥„É≥„É©„É≥„Ç∞Ë™û„ÉªÊó•Êú¨Ë™û„Å©„Å°„Çâ„Åß„ÇÇÊ§úÁ¥¢‚Ä¶',
    v_search_both:'‰∏°Êñπ',v_search_conlang:'Ë™û',v_search_jp:'Ë®≥',
    v_pos_filter_all:'„Åô„Åπ„Å¶',
    v_rev_title:'üîé ÈÄÜÂºï„ÅçÔºàÊÑèÂë≥ ‚Üí „Ç≥„É≥„É©„É≥„Ç∞Ë™ûÔºâ',v_rev_desc:'ÊÑèÂë≥„Åã„ÇâÂçòË™û„ÇíÊé¢„Åô„ÄÇÊÑèÂë≥„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
    v_rev_placeholder:'‰æãÔºöÊ∞¥„ÄÅÊÑõ„ÄÅÁæé„Åó„ÅÑ„ÄÅËµ∞„Çã‚Ä¶',v_rev_pos_snap:'ÂìÅË©ûÂà•„Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„Éà',
    v_add_dict_btn:'ËæûÊõ∏„Å´ËøΩÂä† +',v_speak_btn:'üîä Áô∫Èü≥',v_script_preview_btn:'‚úç ÊñáÂ≠óÂ§âÊèõ',
    v_ipa_title:'üìã IPAÂÖ•Âäõ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà',v_ipa_desc:'„ÄåË™≠„Åø„Äç„Éï„Ç£„Éº„É´„Éâ„Å´IPAË®òÂè∑„ÇíÁ¥†Êó©„ÅèÂÖ•Âäõ„Åß„Åç„Åæ„Åô',
    v_word_jp_label:'ÊÑèÂë≥ÔºàÊó•Êú¨Ë™ûÔºâ',v_word_ipa_label:'Ë™≠„ÅøÔºàIPA„Éª„Ç´„ÉäÔºâ',v_word_pos_label:'ÂìÅË©û',v_word_tags_label:'„Çø„Ç∞',
    v_script_picker_open:'‰∏ñÁïå„ÅÆÊñáÂ≠ó„Éî„ÉÉ„Ç´„Éº„ÇíÈñã„ÅèÔºàÊñáÂ≠ó‰ΩìÁ≥ª„Åã„ÇâÂÖ•ÂäõÔºâ',
    v_script_picker_hint:'‚ñº „Äå„Ç≥„É≥„É©„É≥„Ç∞Ë™û„ÄçÂÖ•ÂäõÊ¨Ñ„Çí„ÇØ„É™„ÉÉ„ÇØ„ÅßÈÅ∏ÊäûÂæå„ÄÅ‰∏ã„ÅÆ„Éú„Çø„É≥„ÅßÊñáÂ≠ó„ÇíÂÖ•ÂäõÔºö',
    v_syll_violation:'‚ö† Èü≥ÁØÄÊßãÈÄ†„ÅÆÈÅïÂèç„Åå„ÅÇ„Çä„Åæ„Åô',
    v_pos_noun:'ÂêçË©û',v_pos_verb:'ÂãïË©û',v_pos_adj:'ÂΩ¢ÂÆπË©û',v_pos_adv:'ÂâØË©û',v_pos_pron:'‰ª£ÂêçË©û',v_pos_part:'Âä©Ë©û',
    v_gacha_hint:'ÊÑèÂë≥„ÇíÂÖ•Âäõ„Åó„Å¶„Ç≥„É≥„É©„É≥„Ç∞Ë™û„ÇíËá™ÂãïÁîüÊàê',v_gacha_placeholder:'‰æãÔºöÊ∞¥„ÄÅÁ©∫„ÄÅÊÑõ„ÄÅÂâ£‚Ä¶',
    v_gacha_rand:'Âü∫Êú¨Ë™ûÂΩô„Çí„É©„É≥„ÉÄ„É†ÁîüÊàêÔºà10Ë™ûÔºâ',v_dict_empty:'„Åæ„Å†ÂçòË™û„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Ç¨„ÉÅ„É£„ÇÑÊâãÂãïÂÖ•Âäõ„ÅßËøΩÂä†„Åó„Å¶„Åø„Çà„ÅÜÔºÅ',
    v_add_manual:'ÂçòË™û„ÇíÊâãÂãïËøΩÂä†',v_word_cl:'„Ç≥„É≥„É©„É≥„Ç∞Ë™û',v_word_jp:'ÊÑèÂë≥ÔºàÊØçË™ûÔºâ',
    v_word_read:'Ë™≠„ÅøÔºàIPAÔºâ',v_word_pos:'ÂìÅË©û',v_word_tags:'„Çø„Ç∞Ôºà„Ç´„É≥„ÉûÂå∫Âàá„ÇäÔºâ',
    // Phoneme
    ph_vowels:'ÊØçÈü≥',ph_consonants:'Â≠êÈü≥',ph_syllable:'Èü≥ÁØÄÂûã',ph_accent:'„Ç¢„ÇØ„Çª„É≥„Éà„ÉªÂ£∞Ë™ø',
    ph_chart:'IPA „ÉÅ„É£„Éº„ÉàÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÁôªÈå≤Ôºâ',ph_reg_on:'ÁôªÈå≤„É¢„Éº„Éâ ON',ph_reg_off:'ÁôªÈå≤„É¢„Éº„Éâ OFF',
    // Roadmap
    rm_title:'üó∫ ÊñáÊ≥ï„É≠„Éº„Éâ„Éû„ÉÉ„Éó',rm_subtitle:'Â§öË®ÄË™ûÂ≠¶Áøí„ÅÆË¶ñÁÇπ„ÅßÊÆµÈöéÁöÑ„Å´ÊñáÊ≥ï„ÇíÊßãÁØâ„Åó„Çà„ÅÜ',
    rm_done:'‚úÖ ÂÆå‰∫Ü',rm_goto:'„ÇÑ„Å£„Å¶„Åø„Çã ‚Üí',rm_progress:'ÂÖ®‰ΩìÈÄ≤Êçó',
    rm_s1:'STEP 1 ‚Äî „Åæ„ÅöË©±„Åõ„Çã„Çà„ÅÜ„Å´',rm_s2:'STEP 2 ‚Äî Ë°®Áèæ„ÇíÂ∫É„Åí„Çã',
    rm_s3:'STEP 3 ‚Äî ÊÑüÊÉÖ„Å®ÊÑèÊÄù„Çí‰ºù„Åà„Çã',rm_s4:'STEP 4 ‚Äî Êú¨Ê†ºÁöÑ„Å™ÊñáÊ≥ï„Å∏',
    // Welcome page
    w_sub:'„ÅÇ„Å™„Åü„Å†„Åë„ÅÆË®ÄË™û„Çí„ÄÅ‰ªä„Åô„Åê‰Ωú„Çä„ÅØ„Åò„ÇÅ„Çà„ÅÜ',
    w_name_label:'Ë®ÄË™û„ÅÆÂêçÂâç',w_name_placeholder:'‰æãÔºöSilv√°ri„ÄÅKaelon„ÄÅDrathun‚Ä¶',
    w_name_hint:'„ÅÇ„Å®„Åß„ÅÑ„Å§„Åß„ÇÇÂ§â„Åà„Çâ„Çå„Åæ„Åô',
    w_vibe_label:'„Å©„Çì„Å™Èõ∞Âõ≤Ê∞óÔºüÔºàË§áÊï∞OK„Éª„Çπ„Ç≠„ÉÉ„ÉóÂèØÔºâ',
    w_vibe_elf:'„Ç®„É´„Éï„ÉªËá™ÁÑ∂',w_vibe_dark:'„ÉÄ„Éº„ÇØ„ÉªÂ∏ùÂõΩ',w_vibe_cute:'„Åã„Çè„ÅÑ„ÅÑ„ÉªÂ¶ñÁ≤æ',
    w_vibe_scifi:'Ê©üÊ¢∞„ÉªSF',w_vibe_ocean:'Êµ∑Ê¥ã„ÉªÁ≤æÈúä',w_vibe_ancient:'Âè§‰ª£„ÉªÁ•ûË©±',
    w_start:'„ÅØ„Åò„ÇÅ„Çã',w_skip:'ÂêçÂâç„Å™„Åó„Åß„Å®„Çä„ÅÇ„Åà„ÅöÂßã„ÇÅ„Çã',
    w_restore_label:'üíæ ÂâçÂõû„ÅÆÁ∂ö„Åç„Åå„ÅÇ„Çä„Åæ„Åô',w_restore_btn:'Á∂ö„Åç„Åã„ÇâÂÜçÈñã„Åô„Çã',
    w_unnamed:'ÁÑ°Âêç„ÅÆË®ÄË™û',
    w_google_login:'Google„Åß„É≠„Ç∞„Ç§„É≥',
    w_or_guest:'„Åæ„Åü„ÅØ',
    w_guest_start:'„Ç≤„Çπ„Éà„Å®„Åó„Å¶Âßã„ÇÅ„ÇãÔºà„É≠„Ç∞„Ç§„É≥„Å™„ÅóÔºâ',
    w_feat_sync:'„Çπ„Éû„Éõ„ÉªPC„Å©„Åì„Åß„ÇÇÂêåÊúü„Åó„Å¶Á∂ö„Åë„Çâ„Çå„Çã',
    w_feat_ai:'AI‰ºöË©±„ÅßË®ÄË™û„Çí„Å©„Çì„Å©„ÇìËÇ≤„Å¶„Çâ„Çå„Çã',
    w_feat_trial:'„Éó„É¨„Éü„Ç¢„É†„ÅØ‰ªä„Å™„Çâ14Êó•ÈñìÁÑ°Êñô„Åß„ÅäË©¶„Åó',
    w_logged_in:'„É≠„Ç∞„Ç§„É≥‰∏≠„Åß„Åô',
    w_continue:'‚òëÔ∏è „Åì„ÅÆ„Åæ„ÅæÁ∂ö„Åë„Çã ‚Üí',
    // AIÂà∂Èôê„ÉªË™≤Èáë
    ai_limit_label:'AIÊÆã„ÇäÂõûÊï∞',
    ai_limit_upgrade:'„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ',
    ai_limit_reached:'Êú¨Êó•„ÅÆAI‰∏äÈôê„Å´ÈÅî„Åó„Åæ„Åó„Åü',
    ai_limit_prompt:'„Éó„É¨„Éü„Ç¢„É†„Éó„É©„É≥„ÅßAIÊ©üËÉΩ„ÅåÁÑ°Âà∂Èôê„Å´„Å™„Çä„Åæ„Åô',
    pro_cta:'‚ú¶ ‰ªä„Å™„Çâ2ÈÄ±ÈñìÁÑ°Êñô„Åß„ÅØ„Åò„ÇÅ„Çã',
    upgrade_sub:'14Êó•ÈñìÁÑ°Êñô„Éà„É©„Ç§„Ç¢„É´„Åß„ÅäË©¶„Åó„ÅÑ„Åü„Å†„Åë„Åæ„Åô',
    // AI‰ºöË©±„Éö„Ç§„Ç¶„Ç©„Éº„É´
    chat_paywall_title:'Êú¨Êó•„ÅÆAI‰ºöË©±„ÅåÁµÇ‰∫Ü„Åó„Åæ„Åó„Åü',
    chat_paywall_body:'‰ªä„Å™„Çâ14Êó•ÈñìÁÑ°Êñô„Åß„Éó„É¨„Éü„Ç¢„É†„Çí„ÅäË©¶„Åó„ÅÑ„Åü„Å†„Åë„Åæ„Åô„ÄÇAI‰ºöË©±„ÅåÁÑ°Âà∂Èôê„Å´‰Ωø„Åà„Åæ„Åô„ÄÇ',
    chat_paywall_btn:'‚ú¶ ‰ªä„Å™„Çâ2ÈÄ±ÈñìÁÑ°Êñô„Åß„ÅØ„Åò„ÇÅ„Çã',
    chat_paywall_reset:'ÊòéÊó•„Åæ„Åü10Âõû‰Ωø„Åà„Åæ„Åô',
    chat_remaining:'AI‰ºöË©±„ÅÆÊÆã„ÇäÂõûÊï∞: %nÂõûÔºàÊú¨Êó•Ôºâ',
    modal_plan_select:'„Éó„É©„É≥„ÇíÈÅ∏Êäû',
    vp_count:'%nË™ûÁôªÈå≤Ê∏à„Åø',
    vp_sort_alpha:'A‚Üë',vp_sort_pos:'ÂìÅË©û‚Üë',
    fc_front_conlang:'„Ç≥„É≥„É©„É≥„Ç∞',fc_front_meaning:'ÊÑèÂë≥',
    fc_flip_hint:'„Çø„ÉÉ„Éó„Åó„Å¶„ÇÅ„Åè„Çã',
    fc_correct:'Ê≠£Ëß£ÔºÅ',fc_wrong:'„ÇÇ„ÅÜ‰∏ÄÂ∫¶',
    fc_result_perfect:'ÂÆåÁíßÔºÅ',fc_result_good:'„Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ',fc_result_ok:'„ÇÇ„ÅÜÂ∞ë„ÅóÔºÅ',fc_result_try:'Âæ©Áøí„Åó„Çà„ÅÜÔºÅ',
    fc_retry_wrong:'‚úó ‰∏çÊ≠£Ëß£„Å†„ÅëÂæ©Áøí',fc_back_to_dict:'ËæûÊõ∏„Å´Êàª„Çã',fc_again:'„ÇÇ„ÅÜ‰∏ÄÂ∫¶',
    fc_setup_direction:'Âá∫È°åÊñπÂêë',fc_dir_cl2jp:'„Ç≥„É≥„É©„É≥„Ç∞ ‚Üí ÊÑèÂë≥',fc_dir_jp2cl:'ÊÑèÂë≥ ‚Üí „Ç≥„É≥„É©„É≥„Ç∞',fc_dir_random:'„É©„É≥„ÉÄ„É†',
    fc_range:'Âá∫È°åÁØÑÂõ≤',fc_range_all:'ÂÖ®ÂçòË™û',fc_range_starred:'‚≠ê „Çπ„Çø„ÉºÊ∏à„Åø„ÅÆ„Åø',fc_range_wrong:'‚úó ‰∏çÊ≠£Ëß£„ÅÆ„Åø',
    fc_start:'üÉè „Çπ„Çø„Éº„Éà',
    // Bottom nav
    bnav_home:'„Éõ„Éº„É†',bnav_phoneme:'Èü≥Èüª',bnav_vocab:'Ë™ûÂΩô',bnav_grammar:'ÊñáÊ≥ï',bnav_more:'„Åù„ÅÆ‰ªñ',
    // Mobile more menu
    mm_corpus:'‰æãÊñá',mm_daily:'1Êó•1Êñá',mm_script:'ÊñáÂ≠ó‰ΩìÁ≥ª',mm_vibe:'‰∏ñÁïåË¶≥',mm_library:'„É©„Ç§„Éñ„É©„É™',mm_aichat:'AI‰ºöË©±',
    // Autosave
    autosave_saved:'‰øùÂ≠òÊ∏à„Åø',
    // Prompt dialogs
    prompt_rename:'Ë®ÄË™ûÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
    confirm_reset_title:'ÊúÄÂàù„Åã„Çâ„ÇÑ„ÇäÁõ¥„Åô',
    confirm_reset:'ÂÖ®„Å¶„ÅÆ„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà„Åó„Å¶ÊúÄÂàù„ÅÆÁîªÈù¢„Å´Êàª„Çä„Åæ„Åô„ÅãÔºü\nÔºà„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„ÇìÔºâ',
    // Dashboard dynamic
    script_label:'ÊñáÂ≠ó',route_image:'‚ú¶ „Ç§„É°„Éº„Ç∏„É´„Éº„Éà',route_custom:'‚äû Ëá™‰Ωú„É´„Éº„Éà',
    // Daily
    daily_date_locale:'ja-JP',
    // AI chat
    ai_tutor_lang:'Êó•Êú¨Ë™û',
    // Editor labels (for dynamically built editors)
    ed_no_words:'ÂÖà„Å´Ë™ûÂΩô„ÇíÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
    ed_no_new_words:'„Åæ„Å†Êñ∞Ë™ûÊèêÊ°à„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇAI‰ºöË©±„Åß„Äå‚ú¶ Êñ∞Ë™û„ÇíÊèêÊ°à„Åó„Å¶„Äç„ÇíË©¶„Åó„Å¶„Åø„Çà„ÅÜÔºÅ',
    ed_added_words:'Ë™û„ÇíËæûÊõ∏„Å´ËøΩÂä†„Åó„Åæ„Åó„ÅüÔºÅ',
    ed_saved_corpus:'‰æãÊñá„Ç≥„Éº„Éë„Çπ„Å´‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ',
    ed_clipboard_ok:'ÁîªÂÉè„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ',
    ed_clipboard_fail:'„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Çí„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ',
    ed_clipboard_nosupport:'„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„Åß„ÅØ„Ç≥„Éî„Éº„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Çí„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ',
    // Grammar check
    gc_checking:'Ê∑ªÂâä‰∏≠‚Ä¶',gc_ok:'‚úì ÂïèÈ°å„Å™„Åó',gc_ok_msg:'„É´„Éº„É´„Å®„ÅÆÁüõÁõæ„ÅØË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„ÅüÔºÅ',
    gc_warn:'‚ö† Ê∑ªÂâä',gc_unknown:'„ÅØËæûÊõ∏„Å´„Å™„ÅÑÂçòË™û„Åß„Åô',
    // Corpus editor tabs & labels
    c_tab_add:'‰æãÊñá„ÇíËøΩÂä†',c_tab_list:'„Ç≥„Éº„Éë„Çπ‰∏ÄË¶ß',c_tab_share:'‚ú¶ SNS„Ç∑„Çß„Ç¢',
    c_lang_label:'„Ç≥„É≥„É©„É≥„Ç∞Ë™û',c_read_label:'Ë™≠„ÅøÔºà„Ç´„Éä„ÉªIPAÔºâ',
    c_gloss_label:'ÈÄêË™ûË®≥„Éª„Ç∞„É≠„Çπ',c_gloss_hint:'ÁúÅÁï•ÂèØ„ÄÇ„ÄåÂçòË™û-Ê†º„Äç„ÅÆ„Çà„ÅÜ„Å´Êõ∏„Åè„Å®Ë®ÄË™ûÂ≠¶ÁöÑ„Å´Ê≠£Á¢∫„Å™Ë®òÈå≤„Å´„Å™„Çä„Åæ„Åô„ÄÇ',
    c_jp_label:'Êó•Êú¨Ë™ûË®≥',c_save_btn:'‰æãÊñá„Çí‰øùÂ≠ò +',c_build_btn:'ËæûÊõ∏„Åã„ÇâÁµÑ„ÅøÁ´ã„Å¶',
    c_auto_title:'‚ú¶ ÂçòË™û„Åã„Çâ‰æãÊñá„ÇíËá™ÂãïÁµÑ„ÅøÁ´ã„Å¶',c_auto_body:'ËæûÊõ∏„Å´ÁôªÈå≤„Åï„Çå„ÅüÂçòË™û„Çí‰Ωø„Å£„Å¶Êñá„ÇíÁµÑ„ÅøÁ´ã„Å¶„Åæ„Åô',
    c_auto_chip:'‰æãÊñá„ÇíÁîüÊàê',c_share_desc:'‰æãÊñá„ÇíÈÅ∏„Çì„Åß„ÄÅSNS„Å´ÊäïÁ®ø„Åß„Åç„ÇãÁîªÂÉè„Ç´„Éº„Éâ„ÇíÁîüÊàê„Åó„Åæ„Åô„ÄÇ',
    c_share_sel_label:'„Ç∑„Çß„Ç¢„Åô„Çã‰æãÊñá„ÇíÈÅ∏Êäû',c_share_sel_placeholder:'‰æãÊñá„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ‚Ä¶',
    c_dl_btn:'‚¨á ÁîªÂÉè„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ',c_copy_btn:'üìã „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº',c_preview_btn:'üîÑ „Éó„É¨„Éì„É•„ÉºÊõ¥Êñ∞',
    c_del_btn:'ÂâäÈô§',c_speak_btn:'üîä',c_share_btn:'‚ú¶ „Ç∑„Çß„Ç¢',
    c_empty:'„Åæ„Å†‰æãÊñá„Åå„ÅÇ„Çä„Åæ„Åõ„Çì',
    // Daily editor
    de_today:'‰ªäÊó•„ÅÆÊñá',de_write:'„ÅÇ„Å™„Åü„ÅÆË®ÄË™û„ÅßÊõ∏„ÅÑ„Å¶„Åø„Çà„ÅÜ',de_input_placeholder:'ÁøªË®≥„ÇíÂÖ•Âäõ‚Ä¶',
    de_submit:'ÈÄÅ‰ø° & ‰øùÂ≠ò',de_check:'‚úì Ê∑ªÂâä',de_save_corpus:'‰æãÊñá„Å®„Åó„Å¶‰øùÂ≠ò',
    de_past:'ÈÅéÂéª„ÅÆÂõûÁ≠î',de_empty:'„Åæ„Å†ÂõûÁ≠î„Åå„ÅÇ„Çä„Åæ„Åõ„Çì',
    // Script editor
    sc_active_cell:'ÂÖ•Âäõ‰∏≠Ôºö„Äå%s„Äç„ÅÆÊñáÂ≠ó',
    sc_world_picker:'‰∏ñÁïå„ÅÆÊñáÂ≠ó„Éî„ÉÉ„Ç´„Éº',
    // AI system prompt
    ai_prompt_respond_format:'%s„ÅÆË™ûÂΩô„ÉªÈü≥Èüª„É´„Éº„É´„Å´Âæì„Å£„Å¶Êñá„ÇíÁµÑ„ÅøÁ´ã„Å¶„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
    // Suggest patterns
    sp_topic:'„Äú„ÅØ„Éª„Äú„ÅåÔºà‰∏ªÈ°åÔºâ',sp_acc:'„Äú„ÇíÔºàÂØæÊ†ºÔºâ',sp_conj:'„Äú„Å®ÔºàÊé•Á∂öÔºâ',sp_q:'„ÄúÔºüÔºàÁñëÂïèÔºâ',
    sp_cat_gram:'ÊñáÊ≥ï',sp_cat_q:'ÁñëÂïè',
    // Word suggestion
    ws_convo:'‰ºöË©±',ws_noun:'ÂêçË©û',ws_tag_daily:'Êó•Â∏∏',ws_tag_emotion:'ÊÑüÊÉÖ',
    ws_new:'Êñ∞Ë™û„ÇíÊèêÊ°à„Åó„Åæ„ÅôÔºö„Äå%w„Äç(%m) „ÅØ„ÅÑ„Åã„Åå„Åß„Åó„Çá„ÅÜ„ÅãÔºü„Äåüìñ Êñ∞Ë™û„ÇíËæûÊõ∏„Å∏„Äç„Éú„Çø„É≥„Åß‰øùÂ≠ò„Åß„Åç„Åæ„Åô„ÄÇ',
  },
  en:{
    nav_home:'Home',nav_script:'Writing',nav_phoneme:'Phonology',nav_grammar:'Grammar',
    nav_vocab:'Vocab',nav_corpus:'Corpus',nav_daily:'Daily',
    nav_library:'üåø Library',nav_aichat:'ü§ñ AI Chat',nav_faq:'‚ùì FAQ',
    vis_private:'Private',vis_unlisted:'Unlisted',vis_public:'Public',
    vis_popup_title:'üåç Visibility',
    vis_private_desc:'Only you can see it. Draft mode.',
    vis_unlisted_desc:'Only people with the link can view it.',
    vis_public_desc:'Listed in the Library. Anyone can browse.',
    vis_importable:'Allow importing',
    lib_title:'üåø Language Library',lib_sub:'Browse conlangs from the community',
    lib_community:'Community Languages',lib_search:'Search by name or genre‚Ä¶',
    lib_empty:'No languages found',lib_see_detail:'Tap for details ‚Üí',lib_author:'Author',
    btn_import_json:'üì• Import JSON',btn_export_json:'üì§ Export JSON',
    btn_close:'Close',btn_cancel:'Cancel',btn_import:'Import',btn_send:'Send',
    btn_clear_chat:'üóë Clear',btn_export_vocab:'üìñ Add new words to dict',
    btn_login:'Log In',btn_start:'Start Free',btn_save:'Save',btn_add:'Add +',
    btn_back_home:'‚Üê Back to Home',btn_clear:'Clear',btn_clear_slots:'üóë Clear',btn_logout:'Log Out',
    btn_contact:'üí¨ Contact',btn_send_contact:'Send',
    contact_title:'üí¨ Contact Us',contact_subtitle:'We welcome your feedback, feature requests, and bug reports',
    contact_category:'Category',contact_email:'Email (optional)',contact_message:'Message',
    contact_message_placeholder:'Tell us more...',
    contact_cat_bug:'üêõ Bug Report',contact_cat_feature:'‚ú® Feature Request',
    contact_cat_feedback:'üí≠ Feedback',contact_cat_other:'Other',
    contact_success:'Your message has been sent. Thank you!',
    contact_error:'Failed to send. Please try again.',
    contact_error_empty:'Please enter a message',
    contact_email_label:'Or email directly:',
    // FAQ
    faq_title:'‚ùì Frequently Asked Questions',faq_subtitle:'About Lingua features, usage, and pricing',
    faq_cat_basic:'üåü Basic Features',faq_cat_features:'‚ö° Features',
    faq_cat_pricing:'üíé Pricing',faq_cat_support:'üí¨ Support',
    faq_q1:'What is Lingua?',
    faq_a1:'Lingua is a web app for creating and managing constructed languages (conlangs). Manage writing systems, phonology, grammar, dictionary, and example corpus in one place. AI features include word generation and grammar checking.',
    faq_q2:'Is it free?',
    faq_a2:'Yes! Basic features are completely free. Dictionary, grammar, examples, JSON export, and library browsing are all free. Pro plans unlock unlimited AI, cloud sync, and multiple languages.',
    faq_q3:'Is my data saved?',
    faq_a3:'Data is automatically saved to browser localStorage. Pro users get cloud sync to share data across multiple devices.',
    faq_q4:'How do I use AI features?',
    faq_a4:'Use "Gacha generation" in the dictionary tab to auto-generate words based on phonology rules. AI chat lets you practice conversation and check grammar in your language.',
    faq_q5:'Can I create multiple languages?',
    faq_a5:'Free plan allows 1 language. Lite and Premium plans allow unlimited languages.',
    faq_q6:'Can I view others\' languages?',
    faq_a6:'Yes! Browse and import public languages from the "üåø Library". You can also share your own by changing visibility settings.',
    faq_q7:'How much is Pro?',
    faq_a7:'Lite: $4.99/month, Premium: $9.99/month. 14-day free trial available. Cancel anytime.',
    faq_q8:'What\'s the difference from Free?',
    faq_a8:'<strong>Free:</strong> 1 language, 10 AI chats/day, local storage only<br><strong>Lite:</strong> Unlimited languages, 50 AI chats/day, cloud sync<br><strong>Premium:</strong> Everything unlimited, priority support, early access to new features',
    faq_q9:'Found a bug?',
    faq_a9:'Report it via "üí¨ Contact" in the top right, or email directly to',
    faq_a9_2:'.',
    faq_q10:'Do you accept feature requests?',
    faq_a10:'Absolutely! Select "‚ú® Feature Request" in the contact form. We value user feedback.',
    faq_more:'Have more questions?',faq_more_desc:'Feel free to contact us',
    aichat_sub:'Chat using your conlang rules',aichat_badge:'Conlang-AI',
    aichat_welcome_title:'‚ú¶ Welcome to Conlang-AI!',
    aichat_welcome_body:'Your dictionary, grammar & phonology are fully loaded. Try talking in your conlang!',
    aichat_placeholder:'Type in your conlang‚Ä¶ or English',
    aichat_quick_hi:'Hello',aichat_quick_name:'My name is‚Ä¶',
    aichat_quick_date:'What day is it?',aichat_quick_word:'‚ú¶ Suggest a word',
    import_title:'üì• Import Language Data',
    import_desc:'Paste a Lingua JSON file. Current data will be overwritten.',
    storage_ok:'üíæ Saved',storage_warn:'‚ö† Data size growing',storage_full:'‚ùå Storage quota exceeded!',
    dash_complete:'Progress',dash_words:'Words',dash_patterns:'Grammar',
    dash_corpus:'Corpus',dash_done:'Done',
    chat_cleared:'Chat cleared. Come back anytime!',ai_assist_title:'‚ú¶ AI Assistant ‚Äî Ask me anything',ai_assist_placeholder:'Type your question‚Ä¶ (e.g. tips for beginners)',ai_thinking:'Thinking‚Ä¶',ph_chart_tab:'üìä Phoneme Chart',ph_not_set:'(not set)',ph_reg_on:'üî¥ Register mode ON',ph_reg_off:'‚¨§ Register mode OFF',ph_chart_empty:'Register phonemes to view the chart',gp_form_suffix:'Form (suffix)',gp_form_prefix:'Form (prefix)',gp_form_infix:'Form (infix)',gp_form_mutation:'Vowel mutation',gp_form_tone:'Tone rule',gp_form_circumfix:'Prefix¬∑Suffix',gp_form_reduplication:'Reduplication',gp_form_particle:'Particle form',gp_form_label:'Form',gp_category_default:'Grammar',gp_enter_hint:'Enter‚Ä¶',
    settings_label:'Language Settings',
    dash_rename:'‚úé Rename',
    card_vibe_desc:'Describe your language vibe to get sound and grammar suggestions.',
    card_script_desc:'Map alphabets to custom characters with real-time preview.',
    card_phoneme_desc:'Set vowels, consonants and syllable structure. Generate new word sounds with one click.',
    card_grammar_desc:'Word order, cases, tense, conjugation. Auto-generate inflection tables.',
    card_vocab_desc:'Tag management, reverse lookup, gacha generation. Bidirectional search.',
    card_corpus_desc:'Build example sentence cards. Share as images on social media.',
    card_not_set:'Not configured yet',
    card_vocab_empty:'No words yet',
    card_corpus_empty:'No sentences yet',
    card_vibe_title:'World & Vibe',
    card_script_title:'Writing System & Font Mapping',
    card_grammar_title:'Grammar + Inflection Matrix',
    card_vocab_title:'Vocabulary & Dictionary',
    card_corpus_title:'Corpus + Share',
    dash_reset:'‚Ü∫ Reset',
    dash_export:'üì§ Export',
    dash_complete:'Completion',
    daily_input_hint:'Write this sentence in your conlang',
    dash_daily_subtitle:"Today's sentence ‚Äî",daily_label:'Daily Sentence Challenge',
    daily_submit:'Submit & Save',daily_check:'‚úì Check',daily_save:'Save as corpus',
    daily_past:'Past answers',daily_empty:'No answers yet.',
    g_tab_order:'Order & Cases',g_tab_verb:'Verbs & Tense',g_tab_pattern:'Grammar Patterns',
    g_tab_matrix:'Inflection Matrix',g_tab_notes:'Grammar Notes',g_tab_roadmap:'üó∫ Roadmap',
    g_word_order:'Word Order',g_cases:'Noun Cases',g_gender:'Gender & Number',
    g_verb_conj:'Verb Conjugation',g_tense:'Tense',g_tense_hint:'Choosing "No tense" means using adverbs for time.',
    g_pattern_what:"What's a Grammar Pattern?",
    g_pattern_desc:'Rules for adding prefixes, suffixes or particles to change meaning. Like "un-happy" or "happi-ness" in English.',
    g_pattern_type_label:'Pattern Type',g_pattern_add:'Add New Pattern',
    g_form:'Form',g_meaning_fn:'Meaning / Function',g_example_opt:'Example (optional)',g_category:'Category',
    g_suggest_suffix:'Suggest suffixes',g_suggest_prefix:'Suggest prefixes',g_suggest_particle:'Suggest particles',
    g_mat_hint:'Select cases (rows) and number/gender (cols) to build a declension table. Edit each cell directly.',
    g_add_row:'Add cases (rows)',g_add_col:'Add number/gender (cols)',
    g_root_label:'Root word',g_auto_fill:'‚ú¶ Auto-fill endings',
    g_regen:'üîÑ Regenerate table',g_sample:'Fill with sample endings',g_clear_mat:'üóë Clear',
    g_notes_placeholder:'# Grammar Title\n## Section\nWrite your grammar rules here. Markdown supported.',
    v_tab_gacha:'Gacha Generator',v_tab_manual:'Add Manually',v_tab_dict:'Dictionary',v_tab_rev:'Reverse Lookup',v_tab_sound:'Phonology-Linked',
    v_gacha_gen:'Generate ‚ú¶',v_dict_header:'üìñ Dictionary',v_dict_alpha:'A‚Üë',v_dict_pos_sort:'By POS',
    v_search_placeholder:'üîç Search by conlang word or meaning‚Ä¶',
    v_search_both:'Both',v_search_conlang:'Word',v_search_jp:'Meaning',
    v_pos_filter_all:'All',
    v_rev_title:'üîé Reverse Lookup (Meaning ‚Üí Conlang)',v_rev_desc:'Find words by meaning. Enter a meaning below.',
    v_rev_placeholder:'e.g. water, love, beautiful, run‚Ä¶',v_rev_pos_snap:'Snapshot by Part of Speech',
    v_add_dict_btn:'Add to Dictionary +',v_speak_btn:'üîä Speak',v_script_preview_btn:'‚úç Script Preview',
    v_ipa_title:'üìã IPA Input Shortcuts',v_ipa_desc:'Quickly insert IPA symbols into the reading field',
    v_word_jp_label:'Meaning',v_word_ipa_label:'Reading (IPA / Kana)',v_word_pos_label:'Part of speech',v_word_tags_label:'Tags',
    v_script_picker_open:'Open World Script Picker',
    v_script_picker_hint:'‚ñº Click the "Conlang word" field first, then tap a character:',
    v_syll_violation:'‚ö† Syllable structure violation',
    v_pos_noun:'noun',v_pos_verb:'verb',v_pos_adj:'adjective',v_pos_adv:'adverb',v_pos_pron:'pronoun',v_pos_part:'particle',
    v_gacha_hint:'Enter meanings to auto-generate conlang words',v_gacha_placeholder:'e.g. water, sky, love, sword‚Ä¶',
    v_gacha_rand:'Random generate 10 basic words',v_dict_empty:"No words yet. Use the generator or add manually!",
    v_add_manual:'Add word manually',v_word_cl:'Conlang word',v_word_jp:'Meaning',
    v_word_read:'Reading (IPA)',v_word_pos:'Part of speech',v_word_tags:'Tags (comma separated)',
    ph_vowels:'Vowels',ph_consonants:'Consonants',ph_syllable:'Syllable structure',ph_accent:'Accent / Tone',
    ph_chart:'IPA Chart (click to register)',ph_reg_on:'Register Mode ON',ph_reg_off:'Register Mode OFF',
    rm_title:'üó∫ Grammar Roadmap',rm_subtitle:'Build your grammar step by step ‚Äî inspired by real language learning',
    rm_done:'‚úÖ Done',rm_goto:'Try it ‚Üí',rm_progress:'Overall progress',
    rm_s1:'STEP 1 ‚Äî Start Speaking',rm_s2:'STEP 2 ‚Äî Expand Expression',
    rm_s3:'STEP 3 ‚Äî Feelings & Intent',rm_s4:'STEP 4 ‚Äî Full Grammar',
    // Welcome page
    w_sub:'Start building your own language, right now',
    w_name_label:'Language name',w_name_placeholder:'e.g. Silv√°ri, Kaelon, Drathun‚Ä¶',
    w_name_hint:'You can change this at any time',
    w_vibe_label:'What vibe? (Multiple OK ¬∑ can skip)',
    w_vibe_elf:'Elven ¬∑ Nature',w_vibe_dark:'Dark ¬∑ Empire',w_vibe_cute:'Cute ¬∑ Fairy',
    w_vibe_scifi:'Machine ¬∑ Sci-Fi',w_vibe_ocean:'Ocean ¬∑ Spirit',w_vibe_ancient:'Ancient ¬∑ Myth',
    w_start:'Start',w_skip:'Start without a name',
    w_restore_label:'üíæ Previous session found',w_restore_btn:'Resume',
    w_unnamed:'Unnamed Language',
    w_google_login:'Sign in with Google',
    w_or_guest:'or',
    w_guest_start:'Continue as Guest (no login)',
    w_feat_sync:'Sync across smartphone & PC anytime',
    w_feat_ai:'Grow your language with AI conversations',
    w_feat_trial:'Premium ‚Äî try free for 14 days',
    w_logged_in:'You are signed in',
    w_continue:'‚òëÔ∏è Continue ‚Üí',
    // AI limits & plans
    ai_limit_label:'AI uses left',
    ai_limit_upgrade:'Upgrade',
    ai_limit_reached:'Daily AI limit reached',
    ai_limit_prompt:'Go Premium for unlimited AI features',
    pro_cta:'‚ú¶ Start free for 2 weeks',
    upgrade_sub:'Try free for 14 days ‚Äî cancel anytime',
    // AI chat paywall
    chat_paywall_title:"Today's AI chat limit reached",
    chat_paywall_body:'Try Premium free for 14 days ‚Äî unlimited AI conversations.',
    chat_paywall_btn:'‚ú¶ Start free for 2 weeks',
    chat_paywall_reset:'10 more chats available tomorrow',
    chat_remaining:'AI chat remaining: %n today',
    modal_plan_select:'Choose your plan',
    vp_count:'%n words',
    vp_sort_alpha:'A‚Üë',vp_sort_pos:'POS‚Üë',
    fc_front_conlang:'Conlang',fc_front_meaning:'Meaning',
    fc_flip_hint:'Tap to flip',
    fc_correct:'Correct!',fc_wrong:'Try again',
    fc_result_perfect:'Perfect!',fc_result_good:'Well done!',fc_result_ok:'Almost there!',fc_result_try:'Keep practicing!',
    fc_retry_wrong:'‚úó Review wrong answers',fc_back_to_dict:'Back to dictionary',fc_again:'Again',
    fc_setup_direction:'Direction',fc_dir_cl2jp:'Conlang ‚Üí Meaning',fc_dir_jp2cl:'Meaning ‚Üí Conlang',fc_dir_random:'Random',
    fc_range:'Range',fc_range_all:'All words',fc_range_starred:'‚≠ê Starred only',fc_range_wrong:'‚úó Wrong only',
    fc_start:'üÉè Start',
    // Bottom nav
    bnav_home:'Home',bnav_phoneme:'Phonemes',bnav_vocab:'Vocab',bnav_grammar:'Grammar',bnav_more:'More',
    // Mobile more menu
    mm_corpus:'Corpus',mm_daily:'Daily',mm_script:'Script',mm_vibe:'Vibe',mm_library:'Library',mm_aichat:'AI Chat',
    // Autosave
    autosave_saved:'Saved',
    // Prompt dialogs
    prompt_rename:'Enter language name',
    confirm_reset_title:'Start over',
    confirm_reset:'Reset all data and return to the start screen?\n(This cannot be undone)',
    // Dashboard dynamic
    script_label:'Script',route_image:'‚ú¶ Image route',route_custom:'‚äû Custom route',
    // Daily
    daily_date_locale:'en-US',
    // AI chat
    ai_tutor_lang:'English',
    // Editor labels
    ed_no_words:'Please add vocabulary first',
    ed_no_new_words:'No word suggestions yet. Try "‚ú¶ Suggest new word" in AI Chat!',
    ed_added_words:'words added to dictionary!',
    ed_saved_corpus:'Saved to corpus!',
    ed_clipboard_ok:'Image copied to clipboard!',
    ed_clipboard_fail:'Copy failed. Please try downloading.',
    ed_clipboard_nosupport:'Copy not supported in this browser. Please download.',
    // Grammar check
    gc_checking:'Checking‚Ä¶',gc_ok:'‚úì No issues',gc_ok_msg:'No conflicts with your rules found!',
    gc_warn:'‚ö† Feedback',gc_unknown:'is not in the dictionary',
    // Corpus editor tabs & labels
    c_tab_add:'Add sentence',c_tab_list:'Corpus list',c_tab_share:'‚ú¶ Share',
    c_lang_label:'Conlang',c_read_label:'Reading (Kana ¬∑ IPA)',
    c_gloss_label:'Gloss / Morpheme breakdown',c_gloss_hint:'Optional. Write "word-CASE" for linguistic accuracy.',
    c_jp_label:'Translation',c_save_btn:'Save sentence +',c_build_btn:'Build from dictionary',
    c_auto_title:'‚ú¶ Auto-compose from vocabulary',c_auto_body:'Build a sentence using words already in your dictionary',
    c_auto_chip:'Generate sentence',c_share_desc:'Select a sentence to generate a shareable image card.',
    c_share_sel_label:'Select sentence to share',c_share_sel_placeholder:'Choose a sentence‚Ä¶',
    c_dl_btn:'‚¨á Download image',c_copy_btn:'üìã Copy to clipboard',c_preview_btn:'üîÑ Refresh preview',
    c_del_btn:'Delete',c_speak_btn:'üîä',c_share_btn:'‚ú¶ Share',
    c_empty:'No sentences yet',
    // Daily editor
    de_today:"Today's sentence",de_write:'Write it in your conlang',de_input_placeholder:'Enter translation‚Ä¶',
    de_submit:'Submit & Save',de_check:'‚úì Check',de_save_corpus:'Save as corpus',
    de_past:'Past answers',de_empty:'No answers yet',
    // Script editor
    sc_active_cell:'Editing: "%s"',
    sc_world_picker:'World Script Picker',
    // Suggest patterns
    sp_topic:'topic marker („ÅØ/„Åå)',sp_acc:'accusative marker („Çí)',sp_conj:'conjunction („Å®)',sp_q:'question marker (?)',
    sp_cat_gram:'Grammar',sp_cat_q:'Question',
    // Word suggestion
    ws_convo:'conversation',ws_noun:'noun',ws_tag_daily:'daily',ws_tag_emotion:'emotion',
    ws_new:'New word suggestion: "%w" (%m) ‚Äî save it with the "üìñ Add to Dictionary" button.',
  },
  zh:{
    nav_home:'‰∏ªÈ°µ',nav_script:'‰π¶ÂÜôÁ≥ªÁªü',nav_phoneme:'Èü≥Á≥ª',nav_grammar:'ËØ≠Ê≥ï',
    nav_vocab:'ËØçÊ±á',nav_corpus:'‰æãÂè•Â∫ì',nav_daily:'ÊØèÊó•‰∏ÄÂè•',
    nav_library:'üåø ËØ≠Ë®ÄÂ∫ì',nav_aichat:'ü§ñ AIÂØπËØù',nav_faq:'‚ùì Â∏∏ËßÅÈóÆÈ¢ò',
    vis_private:'ÁßÅÂØÜ',vis_unlisted:'‰∏çÂÖ¨ÂºÄ',vis_public:'ÂÖ¨ÂºÄ',
    vis_popup_title:'üåç ÂÖ¨ÂºÄËÆæÁΩÆ',
    vis_private_desc:'Âè™ÊúâÊÇ®ÂèØ‰ª•Êü•Áúã„ÄÇËçâÁ®øÁä∂ÊÄÅ„ÄÇ',
    vis_unlisted_desc:'Âè™ÊúâÁü•ÈÅìÈìæÊé•ÁöÑ‰∫∫ÊâçËÉΩÊü•Áúã„ÄÇ',
    vis_public_desc:'Âú®ËØ≠Ë®ÄÂ∫ì‰∏≠Â±ïÁ§∫Ôºå‰ªª‰Ωï‰∫∫ÈÉΩÂèØ‰ª•ÊµèËßà„ÄÇ',
    vis_importable:'ÂÖÅËÆ∏ÂØºÂÖ•',
    lib_title:'üåø ËØ≠Ë®ÄÂ∫ì',lib_sub:'ÊµèËßàÊù•Ëá™Á§æÂå∫ÁöÑ‰∫∫Â∑•ËØ≠Ë®Ä',
    lib_community:'Á§æÂå∫ËØ≠Ë®Ä',lib_search:'ÊåâÂêçÁß∞ÊàñÁ±ªÂûãÊêúÁ¥¢‚Ä¶',
    lib_empty:'Êú™ÊâæÂà∞ËØ≠Ë®Ä',lib_see_detail:'ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ ‚Üí',lib_author:'‰ΩúËÄÖ',
    btn_import_json:'üì• ÂØºÂÖ•JSON',btn_export_json:'üì§ ÂØºÂá∫JSON',
    btn_close:'ÂÖ≥Èó≠',btn_cancel:'ÂèñÊ∂à',btn_import:'ÊâßË°åÂØºÂÖ•',btn_send:'ÂèëÈÄÅ',
    btn_clear_chat:'üóë Ê∏ÖÈô§',btn_export_vocab:'üìñ Ê∑ªÂä†Êñ∞ËØçÂà∞ËØçÂÖ∏',
    btn_login:'ÁôªÂΩï',btn_start:'ÂÖçË¥πÂºÄÂßã',btn_save:'‰øùÂ≠ò',btn_add:'Ê∑ªÂä† +',
    btn_back_home:'‚Üê ËøîÂõû‰∏ªÈ°µ',btn_clear:'Ê∏ÖÈô§',btn_clear_slots:'üóë Ê∏ÖÈô§',btn_logout:'ÁôªÂá∫',
    btn_contact:'üí¨ ËÅîÁ≥ªÊàë‰ª¨',btn_send_contact:'ÂèëÈÄÅ',
    contact_title:'üí¨ ËÅîÁ≥ªÊàë‰ª¨',contact_subtitle:'Ê¨¢ËøéÊÇ®ÁöÑÊÑèËßÅ„ÄÅÂäüËÉΩËØ∑Ê±ÇÂíåÈîôËØØÊä•Âëä',
    contact_category:'Á±ªÂà´',contact_email:'ÁîµÂ≠êÈÇÆ‰ª∂ÔºàÂèØÈÄâÔºâ',contact_message:'Ê∂àÊÅØ',
    contact_message_placeholder:'ËØ∑ÂëäËØâÊàë‰ª¨Êõ¥Â§ö...',
    contact_cat_bug:'üêõ ÈîôËØØÊä•Âëä',contact_cat_feature:'‚ú® ÂäüËÉΩËØ∑Ê±Ç',
    contact_cat_feedback:'üí≠ ÂèçÈ¶à',contact_cat_other:'ÂÖ∂‰ªñ',
    contact_success:'ÊÇ®ÁöÑÊ∂àÊÅØÂ∑≤ÂèëÈÄÅ„ÄÇË∞¢Ë∞¢ÔºÅ',
    contact_error:'ÂèëÈÄÅÂ§±Ë¥•„ÄÇËØ∑ÈáçËØï„ÄÇ',
    contact_error_empty:'ËØ∑ËæìÂÖ•Ê∂àÊÅØ',
    contact_email_label:'ÊàñÁõ¥Êé•ÂèëÈÄÅÁîµÂ≠êÈÇÆ‰ª∂Ôºö',
    // FAQ
    faq_title:'‚ùì Â∏∏ËßÅÈóÆÈ¢ò',faq_subtitle:'ÂÖ≥‰∫éLinguaÁöÑÂäüËÉΩ„ÄÅ‰ΩøÁî®ÂíåÂÆö‰ª∑',
    faq_cat_basic:'üåü Âü∫Êú¨ÂäüËÉΩ',faq_cat_features:'‚ö° ÂäüËÉΩ',
    faq_cat_pricing:'üíé ÂÆö‰ª∑',faq_cat_support:'üí¨ ÊîØÊåÅ',
    faq_q1:'LinguaÊòØ‰ªÄ‰πàÔºü',
    faq_a1:'LinguaÊòØ‰∏Ä‰∏™Áî®‰∫éÂàõÂª∫ÂíåÁÆ°ÁêÜ‰∫∫ÈÄ†ËØ≠Ë®ÄÁöÑWebÂ∫îÁî®„ÄÇÁªü‰∏ÄÁÆ°ÁêÜÊñáÂ≠óÁ≥ªÁªü„ÄÅÈü≥Á≥ª„ÄÅËØ≠Ê≥ï„ÄÅËØçÂÖ∏Âíå‰æãÂè•ËØ≠ÊñôÂ∫ì„ÄÇAIÂäüËÉΩÂåÖÊã¨ÁîüÊàêÊñ∞ËØçÂíåËØ≠Ê≥ïÊ£ÄÊü•„ÄÇ',
    faq_q2:'ÂÖçË¥πÂêóÔºü',
    faq_a2:'ÊòØÁöÑÔºÅÂü∫Êú¨ÂäüËÉΩÂÆåÂÖ®ÂÖçË¥π„ÄÇËØçÂÖ∏„ÄÅËØ≠Ê≥ï„ÄÅ‰æãÂè•ÂàõÂª∫„ÄÅJSONÂØºÂá∫„ÄÅÂ∫ìÊµèËßàÈÉΩÊòØÂÖçË¥πÁöÑ„ÄÇProËÆ°ÂàíËß£ÈîÅÊó†ÈôêAI„ÄÅ‰∫ëÂêåÊ≠•ÂíåÂ§öËØ≠Ë®ÄÂàõÂª∫„ÄÇ',
    faq_q3:'Êï∞ÊçÆ‰ºö‰øùÂ≠òÂêóÔºü',
    faq_a3:'Êï∞ÊçÆ‰ºöËá™Âä®‰øùÂ≠òÂà∞ÊµèËßàÂô®ÁöÑÊú¨Âú∞Â≠òÂÇ®„ÄÇProÁî®Êà∑ÂèØ‰ΩøÁî®‰∫ëÂêåÊ≠•ÂäüËÉΩÂú®Â§ö‰∏™ËÆæÂ§áÈó¥ÂÖ±‰∫´Êï∞ÊçÆ„ÄÇ',
    faq_q4:'Â¶Ç‰Ωï‰ΩøÁî®AIÂäüËÉΩÔºü',
    faq_a4:'Âú®ËØçÂÖ∏Ê†áÁ≠æ‰∏≠‰ΩøÁî®"ÈöèÊú∫ÁîüÊàê"Ê†πÊçÆÈü≥Á≥ªËßÑÂàôËá™Âä®ÁîüÊàêÊñ∞ËØç„ÄÇAIÂØπËØùÂäüËÉΩÂèØ‰ª•ËÆ©‰Ω†Áî®‰Ω†ÁöÑËØ≠Ë®ÄËøõË°åÂØπËØùÁªÉ‰π†ÂíåËØ≠Ê≥ïÊ£ÄÊü•„ÄÇ',
    faq_q5:'ÂèØ‰ª•ÂàõÂª∫Â§ö‰∏™ËØ≠Ë®ÄÂêóÔºü',
    faq_a5:'ÂÖçË¥πËÆ°ÂàíÂè™ËÉΩÂàõÂª∫1‰∏™ËØ≠Ë®Ä„ÄÇLiteÂíåPremiumËÆ°ÂàíÂèØ‰ª•ÂàõÂª∫Êó†Èôê‰∏™ËØ≠Ë®Ä„ÄÇ',
    faq_q6:'ÂèØ‰ª•Êü•ÁúãÂÖ∂‰ªñ‰∫∫ÁöÑËØ≠Ë®ÄÂêóÔºü',
    faq_a6:'ÂèØ‰ª•ÔºÅ‰ªé"üåø Â∫ì"ÊµèËßàÂíåÂØºÂÖ•ÂÖ¨ÂºÄÁöÑËØ≠Ë®Ä„ÄÇÊÇ®‰πüÂèØ‰ª•ÈÄöËøáÂÖ¨ÂºÄËÆæÁΩÆÂàÜ‰∫´Ëá™Â∑±ÁöÑËØ≠Ë®Ä„ÄÇ',
    faq_q7:'ProËÆ°ÂàíÂ§öÂ∞ëÈí±Ôºü',
    faq_a7:'Lite: $4.99/ÊúàÔºåPremium: $9.99/Êúà„ÄÇÊèê‰æõ14Â§©ÂÖçË¥πËØïÁî®„ÄÇÈöèÊó∂ÂèØÂèñÊ∂à„ÄÇ',
    faq_q8:'‰∏éÂÖçË¥πÁâàÊúâ‰ªÄ‰πàÂå∫Âà´Ôºü',
    faq_a8:'<strong>Free:</strong> 1‰∏™ËØ≠Ë®ÄÔºåÊØèÂ§©10Ê¨°AIÂØπËØùÔºå‰ªÖÊú¨Âú∞Â≠òÂÇ®<br><strong>Lite:</strong> Êó†ÈôêËØ≠Ë®ÄÔºåÊØèÂ§©50Ê¨°AIÂØπËØùÔºå‰∫ëÂêåÊ≠•<br><strong>Premium:</strong> ‰∏ÄÂàáÊó†ÈôêÂà∂Ôºå‰ºòÂÖàÊîØÊåÅÔºåÊèêÂâçËÆøÈóÆÊñ∞ÂäüËÉΩ',
    faq_q9:'ÂèëÁé∞ÈîôËØØÊÄé‰πàÂäûÔºü',
    faq_a9:'ÈÄöËøáÂè≥‰∏äËßíÁöÑ"üí¨ ËÅîÁ≥ªÊàë‰ª¨"Êä•ÂëäÔºåÊàñÁõ¥Êé•ÂèëÈÄÅÁîµÂ≠êÈÇÆ‰ª∂Ëá≥',
    faq_a9_2:'„ÄÇ',
    faq_q10:'Êé•ÂèóÂäüËÉΩËØ∑Ê±ÇÂêóÔºü',
    faq_a10:'ÂΩìÁÑ∂ÔºÅÂú®ËÅîÁ≥ªË°®Âçï‰∏≠ÈÄâÊã©"‚ú® ÂäüËÉΩËØ∑Ê±Ç"ÂèëÈÄÅ„ÄÇÊàë‰ª¨ÈáçËßÜÁî®Êà∑ÂèçÈ¶à„ÄÇ',
    faq_more:'ËøòÊúâÂÖ∂‰ªñÈóÆÈ¢òÔºü',faq_more_desc:'ÈöèÊó∂ËÅîÁ≥ªÊàë‰ª¨',
    aichat_sub:'Áî®ÊÇ®ÁöÑËØ≠Ë®ÄËßÑÂàôÂØπËØù',aichat_badge:'Conlang-AI',
    aichat_welcome_title:'‚ú¶ Ê¨¢ËøéÊù•Âà∞ Conlang-AIÔºÅ',
    aichat_welcome_body:'Â∑≤Âä†ËΩΩÊÇ®ÁöÑËØçÂÖ∏„ÄÅËØ≠Ê≥ïÂíåÈü≥Á≥ªËßÑÂàô„ÄÇÁî®ÊÇ®ÁöÑÂàõÈÄ†ËØ≠ÂíåÊàëËØ¥ËØùÂêßÔºÅ',
    aichat_placeholder:'Áî®ÊÇ®ÁöÑÂàõÈÄ†ËØ≠ËæìÂÖ•‚Ä¶ Êàñ‰∏≠Êñá‰πüÂèØ‰ª•',
    aichat_quick_hi:'‰Ω†Â•Ω',aichat_quick_name:'ÊàëÁöÑÂêçÂ≠óÊòØ‚Ä¶',
    aichat_quick_date:'‰ªäÂ§©ÊòØÂá†Âè∑Ôºü',aichat_quick_word:'‚ú¶ Âª∫ËÆÆÊñ∞ËØç',
    import_title:'üì• ÂØºÂÖ•ËØ≠Ë®ÄÊï∞ÊçÆ',
    import_desc:'Á≤òË¥¥Lingua JSONÊñá‰ª∂ËøõË°åÂØºÂÖ•„ÄÇÂΩìÂâçÊï∞ÊçÆÂ∞ÜË¢´Ë¶ÜÁõñ„ÄÇ',
    storage_ok:'üíæ Â∑≤‰øùÂ≠ò',storage_warn:'‚ö† Êï∞ÊçÆÈáèÂ¢ûÂä†‰∏≠',storage_full:'‚ùå Â≠òÂÇ®Á©∫Èó¥‰∏çË∂≥ÔºÅ',
    dash_complete:'ÂÆåÊàêÂ∫¶',dash_words:'ËØçÊ±áÈáè',dash_patterns:'ËØ≠Ê≥ïËßÑÂæã',
    dash_corpus:'‰æãÂè•Êï∞',dash_done:'Â∑≤ÂÆåÊàê',
    chat_cleared:'ËÅäÂ§©Â∑≤Ê∏ÖÈô§„ÄÇÈöèÊó∂ÂõûÊù•ÔºÅ',ai_assist_title:'‚ú¶ AIÂä©Êâã ‚Äî ÂèØ‰ª•ÈóÆÊàë‰ªª‰ΩïÈóÆÈ¢ò',ai_assist_placeholder:'ËæìÂÖ•ÊÇ®ÁöÑÈóÆÈ¢ò‚Ä¶Ôºà‰æãÂ¶ÇÔºöÂàùÂ≠¶ËÄÖÊäÄÂ∑ßÔºâ',ai_thinking:'ÊÄùËÄÉ‰∏≠‚Ä¶',ph_chart_tab:'üìä Èü≥Á≥ªÂõæ',ph_not_set:'ÔºàÊú™ËÆæÁΩÆÔºâ',ph_reg_on:'üî¥ Ê≥®ÂÜåÊ®°Âºè ON',ph_reg_off:'‚¨§ Ê≥®ÂÜåÊ®°Âºè OFF',ph_chart_empty:'Ê≥®ÂÜåÈü≥Á¥†ÂêéÂ∞ÜÊòæÁ§∫ÂõæË°®',gp_form_suffix:'ÂΩ¢ÂºèÔºàÂêéÁºÄÔºâ',gp_form_prefix:'ÂΩ¢ÂºèÔºàÂâçÁºÄÔºâ',gp_form_infix:'ÂΩ¢ÂºèÔºà‰∏≠ÁºÄÔºâ',gp_form_mutation:'ÂÖÉÈü≥ÂèòÂåñ',gp_form_tone:'Â£∞Ë∞ÉËßÑÂàô',gp_form_circumfix:'ÂâçÈÉ®¬∑ÂêéÈÉ®',gp_form_reduplication:'ÈáçÂè†ÊñπÂºè',gp_form_particle:'Âä©ËØçÂΩ¢Âºè',gp_form_label:'ÂΩ¢Âºè',gp_category_default:'ËØ≠Ê≥ï',gp_enter_hint:'ËØ∑ËæìÂÖ•',
    settings_label:'ËØ≠Ë®ÄËÆæÁΩÆ',
    dash_rename:'‚úé ÈáçÂëΩÂêç',
    card_vibe_desc:'ÊèèËø∞ËØ≠Ë®ÄÊ∞õÂõ¥ÔºåËé∑ÂæóÈü≥ÈüµÂíåËØ≠Ê≥ïÊñπÂêëÁöÑÂª∫ËÆÆ„ÄÇ',
    card_script_desc:'Â∞ÜÂ≠óÊØç‰∏éËá™ÂÆö‰πâÂ≠óÁ¨¶ÂØπÂ∫îÔºåÂÆûÊó∂È¢ÑËßà„ÄÇ',
    card_phoneme_desc:'ËÆæÁΩÆÂÖÉÈü≥„ÄÅËæÖÈü≥ÂíåÈü≥ËäÇÁªìÊûÑ„ÄÇ‰∏ÄÈîÆÁîüÊàêÊñ∞ËØçÂ£∞Èü≥„ÄÇ',
    card_grammar_desc:'ËØ≠Â∫è„ÄÅÊ†º„ÄÅÊó∂ÊÄÅ„ÄÅÂèò‰Ωç„ÄÇËá™Âä®ÁîüÊàêÂèòÊ†ºË°®„ÄÇ',
    card_vocab_desc:'Ê†áÁ≠æÁÆ°ÁêÜ„ÄÅÈÄÜÂêëÊü•Êâæ„ÄÅÈöèÊú∫ÁîüÊàê„ÄÇÂèåÂêëÊêúÁ¥¢„ÄÇ',
    card_corpus_desc:'ÁßØÁ¥Ø‰æãÂè•Âç°ÁâáÔºåÁîüÊàêÂõæÁâáÂú®Á§æ‰∫§Â™í‰ΩìÂàÜ‰∫´„ÄÇ',
    card_not_set:'Â∞öÊú™ËÆæÁΩÆ',
    card_vocab_empty:'ËøòÊ≤°ÊúâÂçïËØç',
    card_corpus_empty:'ËøòÊ≤°Êúâ‰æãÂè•',
    card_vibe_title:'‰∏ñÁïåËßÇ‰∏éÊ∞õÂõ¥',
    card_script_title:'‰π¶ÂÜôÁ≥ªÁªü‰∏éÂ≠ó‰ΩìÊò†Â∞Ñ',
    card_grammar_title:'ËØ≠Ê≥ï + ÂèòÊ†ºÁü©Èòµ',
    card_vocab_title:'ËØçÊ±á‰∏éËØçÂÖ∏',
    card_corpus_title:'‰æãÂè•Â∫ì + ÂàÜ‰∫´',
    dash_reset:'‚Ü∫ ÈáçÁΩÆ',
    dash_export:'üì§ ÂØºÂá∫',
    dash_complete:'ÂÆåÊàêÂ∫¶',
    daily_input_hint:'Áî®ÊÇ®ÁöÑÂàõÈÄ†ËØ≠ÂÜôÂá∫Ëøô‰∏™Âè•Â≠ê',
    dash_daily_subtitle:'‰ªäÊó•‰æãÂè• ‚Äî',daily_label:'ÊØèÊó•‰∏ÄÂè•ÊåëÊàò',
    daily_submit:'Êèê‰∫§ & ‰øùÂ≠ò',daily_check:'‚úì Ê£ÄÊü•',daily_save:'‰øùÂ≠ò‰∏∫‰æãÂè•',
    daily_past:'ËøáÂéªÁöÑÂõûÁ≠î',daily_empty:'ËøòÊ≤°ÊúâÂõûÁ≠î„ÄÇ',
    g_tab_order:'ËØ≠Â∫è¬∑Ê†º',g_tab_verb:'Âä®ËØç¬∑Êó∂ÊÄÅ',g_tab_pattern:'ËØ≠Ê≥ïËßÑÂæã',
    g_tab_matrix:'ÂèòÊ†ºÁü©Èòµ',g_tab_notes:'ËØ≠Ê≥ïÁ¨îËÆ∞',g_tab_roadmap:'üó∫ Ë∑ØÁ∫øÂõæ',
    g_word_order:'Âü∫Êú¨ËØ≠Â∫è',g_cases:'ÂêçËØçÊ†º',g_gender:'ÊÄß‰∏éÊï∞',
    g_verb_conj:'Âä®ËØçÂèò‰Ωç',g_tense:'Êó∂ÊÄÅ',g_tense_hint:'ÈÄâÊã©"Êó†Êó∂ÊÄÅ"ÊÑèÂë≥ÁùÄÁî®ÂâØËØçË°®Á§∫Êó∂Èó¥„ÄÇ',
    g_pattern_what:'‰ªÄ‰πàÊòØËØ≠Ê≥ïËßÑÂæãÔºü',
    g_pattern_desc:'Âú®ÂçïËØçÂâç„ÄÅÂêéÊàñ‰∏≠Èó¥Âä†ÊàêÂàÜÊù•ÊîπÂèòÊÑè‰πâÁöÑËßÑÂàô„ÄÇÂ∞±ÂÉèËã±ËØ≠ÁöÑ "un-happy" ÊàñÊ±âËØ≠ÁöÑ "‰∏çÈ´òÂÖ¥"„ÄÇ',
    g_pattern_type_label:'ËßÑÂæãÁ±ªÂûã',g_pattern_add:'Ê∑ªÂä†Êñ∞ËßÑÂæã',
    g_form:'ÂΩ¢Âºè',g_meaning_fn:'Âê´‰πâ¬∑ÂäüËÉΩ',g_example_opt:'‰æãÂ≠êÔºàÂèØÈÄâÔºâ',g_category:'Á±ªÂà´',
    g_suggest_suffix:'Âª∫ËÆÆÂêéÁºÄ',g_suggest_prefix:'Âª∫ËÆÆÂâçÁºÄ',g_suggest_particle:'Âª∫ËÆÆÂä©ËØç',
    g_mat_hint:'ÈÄâÊã©Ê†ºÔºàË°åÔºâÂíåÊï∞/ÊÄßÔºàÂàóÔºâÊù•ÁîüÊàêÂèòÊ†ºË°®„ÄÇÂèØÁõ¥Êé•ÁºñËæëÊØè‰∏™ÂçïÂÖÉÊ†º„ÄÇ',
    g_add_row:'Ê∑ªÂä†Ê†ºÔºàË°åÔºâ',g_add_col:'Ê∑ªÂä†Êï∞/ÊÄßÔºàÂàóÔºâ',
    g_root_label:'ËØçÊ†π',g_auto_fill:'‚ú¶ Ëá™Âä®Â°´ÂÖÖËØçÂ∞æ',
    g_regen:'üîÑ ÈáçÊñ∞ÁîüÊàêË°®Ê†º',g_sample:'Â°´ÂÖ•Á§∫‰æãËØçÂ∞æ',g_clear_mat:'üóë Ê∏ÖÈô§',
    g_notes_placeholder:'# ËØ≠Ê≥ï‰π¶Ê†áÈ¢ò\n## Á´†ËäÇ\nÂú®ËøôÈáåÂÜôËØ≠Ê≥ïËßÑÂàô„ÄÇÊîØÊåÅMarkdown„ÄÇ',
    v_tab_gacha:'ÈöèÊú∫ÁîüÊàê',v_tab_manual:'ÊâãÂä®Ê∑ªÂä†',v_tab_dict:'ËØçÂÖ∏',v_tab_rev:'ÈÄÜÂêëÊü•Êâæ',v_tab_sound:'Èü≥Á≥ªËÅîÂä®ÁîüÊàê',
    v_gacha_gen:'ÁîüÊàê ‚ú¶',v_dict_header:'üìñ ËØçÂÖ∏',v_dict_alpha:'A‚Üë',v_dict_pos_sort:'ÊåâËØçÊÄßÊéíÂ∫è',
    v_search_placeholder:'üîç ÊêúÁ¥¢ÂàõÈÄ†ËØ≠ËØçÊ±áÊàñÂê´‰πâ‚Ä¶',
    v_search_both:'ÂÖ®ÈÉ®',v_search_conlang:'ËØç',v_search_jp:'‰πâ',
    v_pos_filter_all:'ÂÖ®ÈÉ®',
    v_rev_title:'üîé ÈÄÜÂêëÊü•ÊâæÔºàÂê´‰πâ ‚Üí ÂàõÈÄ†ËØ≠Ôºâ',v_rev_desc:'ÈÄöËøáÂê´‰πâÊü•ÊâæËØçÊ±á„ÄÇËØ∑ËæìÂÖ•Âê´‰πâ„ÄÇ',
    v_rev_placeholder:'‰æãÔºöÊ∞¥„ÄÅÁà±„ÄÅÁæé‰∏Ω„ÄÅË∑ë‚Ä¶',v_rev_pos_snap:'ÊåâËØçÊÄßÂàÜÁ±ªÂø´ÁÖß',
    v_add_dict_btn:'Ê∑ªÂä†Âà∞ËØçÂÖ∏ +',v_speak_btn:'üîä ÂèëÈü≥',v_script_preview_btn:'‚úç ‰π¶ÂÜôÈ¢ÑËßà',
    v_ipa_title:'üìã IPAËæìÂÖ•Âø´Êç∑ÈîÆ',v_ipa_desc:'Âø´ÈÄüÂêëËØªÈü≥Ê†èÊèíÂÖ•IPAÁ¨¶Âè∑',
    v_word_jp_label:'Âê´‰πâ',v_word_ipa_label:'ËØªÈü≥ÔºàIPAÔºâ',v_word_pos_label:'ËØçÊÄß',v_word_tags_label:'Ê†áÁ≠æ',
    v_script_picker_open:'ÊâìÂºÄ‰∏ñÁïåÊñáÂ≠óÈÄâÊã©Âô®',
    v_script_picker_hint:'‚ñº ÂÖàÁÇπÂáª"ÂàõÈÄ†ËØ≠ËØç"ËæìÂÖ•Ê°ÜÔºåÁÑ∂ÂêéÁÇπÂáªÂ≠óÁ¨¶Ôºö',
    v_syll_violation:'‚ö† Èü≥ËäÇÁªìÊûÑËøùËßÑ',
    v_pos_noun:'ÂêçËØç',v_pos_verb:'Âä®ËØç',v_pos_adj:'ÂΩ¢ÂÆπËØç',v_pos_adv:'ÂâØËØç',v_pos_pron:'‰ª£ËØç',v_pos_part:'Âä©ËØç',
    v_gacha_hint:'ËæìÂÖ•Âê´‰πâÔºåËá™Âä®ÁîüÊàêÂàõÈÄ†ËØ≠ËØçÊ±á',v_gacha_placeholder:'‰æãÔºöÊ∞¥„ÄÅÂ§©Á©∫„ÄÅÁà±„ÄÅÂâë‚Ä¶',
    v_gacha_rand:'ÈöèÊú∫ÁîüÊàê10‰∏™Âü∫Á°ÄËØçÊ±á',v_dict_empty:'ËøòÊ≤°ÊúâÂçïËØç„ÄÇÁî®ÁîüÊàêÂô®ÊàñÊâãÂä®Ê∑ªÂä†ÂêßÔºÅ',
    v_add_manual:'ÊâãÂä®Ê∑ªÂä†ÂçïËØç',v_word_cl:'ÂàõÈÄ†ËØ≠ËØç',v_word_jp:'Âê´‰πâ',
    v_word_read:'ËØªÈü≥ÔºàIPAÔºâ',v_word_pos:'ËØçÊÄß',v_word_tags:'Ê†áÁ≠æÔºàÈÄóÂè∑ÂàÜÈöîÔºâ',
    ph_vowels:'ÂÖÉÈü≥',ph_consonants:'ËæÖÈü≥',ph_syllable:'Èü≥ËäÇÁªìÊûÑ',ph_accent:'Â£∞Ë∞É¬∑ÈáçÈü≥',
    ph_chart:'IPAÂõæË°®ÔºàÁÇπÂáªÊ≥®ÂÜåÔºâ',ph_reg_on:'Ê≥®ÂÜåÊ®°Âºè ON',ph_reg_off:'Ê≥®ÂÜåÊ®°Âºè OFF',
    rm_title:'üó∫ ËØ≠Ê≥ïË∑ØÁ∫øÂõæ',rm_subtitle:'‰∏ÄÊ≠•‰∏ÄÊ≠•ÊûÑÂª∫ÊÇ®ÁöÑËØ≠Ê≥ï‚Äî‚ÄîÂÄüÈâ¥Â§öËØ≠Ë®ÄÂ≠¶‰π†ËßÜËßí',
    rm_done:'‚úÖ ÂÆåÊàê',rm_goto:'ËØïËØïÁúã ‚Üí',rm_progress:'Êï¥‰ΩìËøõÂ∫¶',
    rm_s1:'Á¨¨1Ê≠• ‚Äî ÂºÄÂè£ËØ¥ËØù',rm_s2:'Á¨¨2Ê≠• ‚Äî Êâ©Â±ïË°®Ëææ',
    rm_s3:'Á¨¨3Ê≠• ‚Äî ÊÉÖÊÑü‰∏éÊÑèÂøó',rm_s4:'Á¨¨4Ê≠• ‚Äî ÂÆåÊï¥ËØ≠Ê≥ï',
    // Welcome page
    w_sub:'Á´ãÂç≥ÂºÄÂßãÂàõÈÄ†Â±û‰∫éÊÇ®ÁöÑËØ≠Ë®Ä',
    w_name_label:'ËØ≠Ë®ÄÂêçÁß∞',w_name_placeholder:'‰æãÔºöSilv√°ri„ÄÅKaelon„ÄÅDrathun‚Ä¶',
    w_name_hint:'‰ª•ÂêéÈöèÊó∂ÂèØ‰ª•Êõ¥Êîπ',
    w_vibe_label:'‰ªÄ‰πàÈ£éÊ†ºÔºüÔºàÂèØÂ§öÈÄâ¬∑ÂèØË∑≥ËøáÔºâ',
    w_vibe_elf:'Á≤æÁÅµ¬∑Ëá™ÁÑ∂',w_vibe_dark:'ÈªëÊöó¬∑Â∏ùÂõΩ',w_vibe_cute:'ÂèØÁà±¬∑Â¶ñÁ≤æ',
    w_vibe_scifi:'Êú∫Ê¢∞¬∑ÁßëÂπª',w_vibe_ocean:'Êµ∑Ê¥ã¬∑Á≤æÁÅµ',w_vibe_ancient:'Âè§‰ª£¬∑Á•ûËØù',
    w_start:'ÂºÄÂßã',w_skip:'‰∏çËµ∑ÂêçÁõ¥Êé•ÂºÄÂßã',
    w_restore_label:'üíæ ÊâæÂà∞‰∏äÊ¨°ÁöÑËøõÂ∫¶',w_restore_btn:'ÁªßÁª≠‰∏äÊ¨°',
    w_unnamed:'Êó†ÂêçËØ≠Ë®Ä',
    w_google_login:'Áî®GoogleË¥¶Âè∑ÁôªÂΩï',
    w_or_guest:'ÊàñËÄÖ',
    w_guest_start:'‰ª•ËÆøÂÆ¢Ë∫´‰ªΩÂºÄÂßãÔºàÊó†ÈúÄÁôªÂΩïÔºâ',
    w_feat_sync:'ÊâãÊú∫„ÉªÁîµËÑëÈöèÊó∂ÂêåÊ≠•',
    w_feat_ai:'ÈÄöËøáAIÂØπËØù‰∏çÊñ≠‰∏∞ÂØåÊÇ®ÁöÑËØ≠Ë®Ä',
    w_feat_trial:'È´òÁ∫ßÁâàÁé∞Âú®ÂèØ‰ª•ÂÖçË¥πËØïÁî®14Â§©',
    w_logged_in:'Â∑≤ÁôªÂΩï',
    w_continue:'‚òëÔ∏è ÁªßÁª≠ ‚Üí',
    // AIÈôêÂà∂„Éª‰ªòË¥π
    ai_limit_label:'AIÂâ©‰ΩôÊ¨°Êï∞',
    ai_limit_upgrade:'ÂçáÁ∫ß',
    ai_limit_reached:'‰ªäÊó•AI‰ΩøÁî®Ê¨°Êï∞Â∑≤Ëææ‰∏äÈôê',
    ai_limit_prompt:'ÂçáÁ∫ßÈ´òÁ∫ßÁâàÔºåAIÂäüËÉΩÊó†Èôê‰ΩøÁî®',
    pro_cta:'‚ú¶ ÂÖçË¥πËØïÁî®2Âë®',
    upgrade_sub:'ÂÖçË¥πËØïÁî®14Â§©ÔºåÈöèÊó∂ÂèØÂèñÊ∂à',
    // AIÂØπËØù‰ªòË¥πÂ¢ô
    chat_paywall_title:'‰ªäÊó•AIÂØπËØùÂ∑≤ÁªìÊùü',
    chat_paywall_body:'Áé∞Âú®ÂçáÁ∫ßÈ´òÁ∫ßÁâàÂèØÂÖçË¥πËØïÁî®14Â§©ÔºåAIÂØπËØùÊó†ÈôêÂà∂‰ΩøÁî®„ÄÇ',
    chat_paywall_btn:'‚ú¶ ÂÖçË¥πËØïÁî®2Âë®',
    chat_paywall_reset:'ÊòéÂ§©ÂèØÂÜç‰ΩøÁî®10Ê¨°',
    chat_remaining:'‰ªäÊó•AIÂØπËØùÂâ©‰Ωô: %nÊ¨°',
    modal_plan_select:'ÈÄâÊã©Â•óÈ§ê',
    vp_count:'Â∑≤ÁôªÂΩï%n‰∏™ÂçïËØç',
    vp_sort_alpha:'A‚Üë',vp_sort_pos:'ËØçÊÄß‚Üë',
    fc_front_conlang:'ÂàõÈÄ†ËØ≠',fc_front_meaning:'Âê´‰πâ',
    fc_flip_hint:'ÁÇπÂáªÁøªËΩ¨',
    fc_correct:'Ê≠£Á°ÆÔºÅ',fc_wrong:'ÂÜçËØï‰∏ÄÊ¨°',
    fc_result_perfect:'ÂÆåÁæéÔºÅ',fc_result_good:'ÂÅöÂæóÂ•ΩÔºÅ',fc_result_ok:'ÂÜçÂä†Ê≤πÔºÅ',fc_result_try:'ÁªßÁª≠Â§ç‰π†ÔºÅ',
    fc_retry_wrong:'‚úó Â§ç‰π†ÈîôËØØ',fc_back_to_dict:'ËøîÂõûËØçÂÖ∏',fc_again:'ÂÜçÊù•‰∏ÄÊ¨°',
    fc_setup_direction:'ÊñπÂêë',fc_dir_cl2jp:'ÂàõÈÄ†ËØ≠ ‚Üí Âê´‰πâ',fc_dir_jp2cl:'Âê´‰πâ ‚Üí ÂàõÈÄ†ËØ≠',fc_dir_random:'ÈöèÊú∫',
    fc_range:'ËåÉÂõ¥',fc_range_all:'ÂÖ®ÈÉ®ÂçïËØç',fc_range_starred:'‚≠ê ‰ªÖÊî∂Ëóè',fc_range_wrong:'‚úó ‰ªÖÈîôËØØ',
    fc_start:'üÉè ÂºÄÂßã',
    // Bottom nav
    bnav_home:'‰∏ªÈ°µ',bnav_phoneme:'Èü≥Á≥ª',bnav_vocab:'ËØçÊ±á',bnav_grammar:'ËØ≠Ê≥ï',bnav_more:'Êõ¥Â§ö',
    // Mobile more menu
    mm_corpus:'‰æãÂè•Â∫ì',mm_daily:'ÊØèÊó•‰∏ÄÂè•',mm_script:'‰π¶ÂÜô',mm_vibe:'‰∏ñÁïåËßÇ',mm_library:'ËØ≠Ë®ÄÂ∫ì',mm_aichat:'AIÂØπËØù',
    // Autosave
    autosave_saved:'Â∑≤‰øùÂ≠ò',
    // Prompt dialogs
    prompt_rename:'ËØ∑ËæìÂÖ•ËØ≠Ë®ÄÂêçÁß∞',
    confirm_reset_title:'ÈáçÊñ∞ÂºÄÂßã',
    confirm_reset:'ÈáçÁΩÆÊâÄÊúâÊï∞ÊçÆÂπ∂ËøîÂõûÂàùÂßãÁïåÈù¢Ôºü\nÔºàÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºâ',
    // Dashboard dynamic
    script_label:'‰π¶ÂÜô',route_image:'‚ú¶ ÂõæÂÉèË∑ØÁ∫ø',route_custom:'‚äû Ëá™ÂÆöË∑ØÁ∫ø',
    // Daily
    daily_date_locale:'zh-CN',
    // AI chat
    ai_tutor_lang:'‰∏≠Êñá',
    // Editor labels
    ed_no_words:'ËØ∑ÂÖàÊ∑ªÂä†ËØçÊ±á',
    ed_no_new_words:'ËøòÊ≤°ÊúâÊñ∞ËØçÂª∫ËÆÆ„ÄÇÂú®AIÂØπËØù‰∏≠ËØïËØï"‚ú¶ Âª∫ËÆÆÊñ∞ËØç"ÔºÅ',
    ed_added_words:'‰∏™ËØçÂ∑≤Ê∑ªÂä†Âà∞ËØçÂÖ∏ÔºÅ',
    ed_saved_corpus:'Â∑≤‰øùÂ≠òÂà∞‰æãÂè•Â∫ìÔºÅ',
    ed_clipboard_ok:'ÂõæÁâáÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ',
    ed_clipboard_fail:'Â§çÂà∂Â§±Ë¥•ÔºåËØ∑Â∞ùËØï‰∏ãËΩΩ„ÄÇ',
    ed_clipboard_nosupport:'Ê≠§ÊµèËßàÂô®‰∏çÊîØÊåÅÂ§çÂà∂ÔºåËØ∑‰∏ãËΩΩ„ÄÇ',
    // Grammar check
    gc_checking:'Ê£ÄÊü•‰∏≠‚Ä¶',gc_ok:'‚úì Ê≤°ÊúâÈóÆÈ¢ò',gc_ok_msg:'Êú™ÂèëÁé∞‰∏éËßÑÂàôÂÜ≤Á™ÅÔºÅ',
    gc_warn:'‚ö† ÂèçÈ¶à',gc_unknown:'‰∏çÂú®ËØçÂÖ∏‰∏≠',
    // Corpus editor tabs & labels
    c_tab_add:'Ê∑ªÂä†‰æãÂè•',c_tab_list:'‰æãÂè•ÂàóË°®',c_tab_share:'‚ú¶ ÂàÜ‰∫´',
    c_lang_label:'ÂàõÈÄ†ËØ≠',c_read_label:'ËØªÈü≥ÔºàÂÅáÂêç¬∑IPAÔºâ',
    c_gloss_label:'ÈÄêËØçÁøªËØë¬∑ËØçÁ¥†ÂàÜÊûê',c_gloss_hint:'ÂèØÁúÅÁï•„ÄÇÂÜô"ÂçïËØç-Ê†º"Ê†ºÂºèÂèØÊèêÈ´òËØ≠Ë®ÄÂ≠¶ÂáÜÁ°ÆÊÄß„ÄÇ',
    c_jp_label:'ËØëÊñá',c_save_btn:'‰øùÂ≠ò‰æãÂè• +',c_build_btn:'‰ªéËØçÂÖ∏ÁªÑÂè•',
    c_auto_title:'‚ú¶ ‰ªéËØçÊ±áËá™Âä®ÁªÑÂè•',c_auto_body:'‰ΩøÁî®ËØçÂÖ∏‰∏≠Â∑≤Ê≥®ÂÜåÁöÑÂçïËØçÊù•ÁªÑÊàêÂè•Â≠ê',
    c_auto_chip:'ÁîüÊàê‰æãÂè•',c_share_desc:'ÈÄâÊã©‰∏Ä‰∏™‰æãÂè•ÔºåÁîüÊàêÂèØÂú®Á§æ‰∫§Â™í‰ΩìÂàÜ‰∫´ÁöÑÂõæÁâáÂç°Áâá„ÄÇ',
    c_share_sel_label:'ÈÄâÊã©Ë¶ÅÂàÜ‰∫´ÁöÑ‰æãÂè•',c_share_sel_placeholder:'ËØ∑ÈÄâÊã©‰æãÂè•‚Ä¶',
    c_dl_btn:'‚¨á ‰∏ãËΩΩÂõæÁâá',c_copy_btn:'üìã Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø',c_preview_btn:'üîÑ Âà∑Êñ∞È¢ÑËßà',
    c_del_btn:'Âà†Èô§',c_speak_btn:'üîä',c_share_btn:'‚ú¶ ÂàÜ‰∫´',
    c_empty:'ËøòÊ≤°Êúâ‰æãÂè•',
    // Daily editor
    de_today:'‰ªäÂ§©ÁöÑÂè•Â≠ê',de_write:'Áî®ÊÇ®ÁöÑÂàõÈÄ†ËØ≠ÂÜôÂá∫Ëøô‰∏™Âè•Â≠ê',de_input_placeholder:'ËæìÂÖ•ÁøªËØë‚Ä¶',
    de_submit:'Êèê‰∫§ & ‰øùÂ≠ò',de_check:'‚úì Ê£ÄÊü•',de_save_corpus:'‰øùÂ≠ò‰∏∫‰æãÂè•',
    de_past:'ËøáÂéªÁöÑÂõûÁ≠î',de_empty:'ËøòÊ≤°ÊúâÂõûÁ≠î',
    // Script editor
    sc_active_cell:'Ê≠£Âú®ËæìÂÖ•Ôºö"%s"',
    sc_world_picker:'‰∏ñÁïåÊñáÂ≠óÈÄâÊã©Âô®',
    // Suggest patterns
    sp_topic:'„Äú‰∏ªÈ¢òÔºà„ÅØ/„ÅåÔºâ',sp_acc:'„ÄúÂÆæÊ†ºÔºà„ÇíÔºâ',sp_conj:'„Äú‰∏éÔºàÊé•Áª≠Ôºâ',sp_q:'„ÄúÔºüÔºàÁñëÈóÆÔºâ',
    sp_cat_gram:'ËØ≠Ê≥ï',sp_cat_q:'ÁñëÈóÆ',
    // Word suggestion
    ws_convo:'ÂØπËØù',ws_noun:'ÂêçËØç',ws_tag_daily:'Êó•Â∏∏',ws_tag_emotion:'ÊÉÖÊÑü',
    ws_new:'Êñ∞ËØçÂª∫ËÆÆÔºö"%w"Ôºà%mÔºâ‚Äî‚ÄîÁî®"üìñ Ê∑ªÂä†Êñ∞ËØçÂà∞ËØçÂÖ∏"ÊåâÈíÆ‰øùÂ≠ò„ÄÇ',
  },
  es:{
    nav_home:'Inicio',nav_script:'Escritura',nav_phoneme:'Fonolog√≠a',nav_grammar:'Gram√°tica',
    nav_vocab:'Vocabulario',nav_corpus:'Corpus',nav_daily:'Frase del d√≠a',
    nav_library:'üåø Biblioteca',nav_aichat:'ü§ñ Chat IA',nav_faq:'‚ùì Preguntas',
    vis_private:'Privado',vis_unlisted:'No listado',vis_public:'P√∫blico',
    vis_popup_title:'üåç Visibilidad',
    vis_private_desc:'Solo t√∫ puedes verlo. Modo borrador.',
    vis_unlisted_desc:'Solo con el enlace pueden verlo.',
    vis_public_desc:'En la Biblioteca. Cualquiera puede verlo.',
    vis_importable:'Permitir importar',
    lib_title:'üåø Biblioteca de Lenguas',lib_sub:'Explora conlangs de la comunidad',
    lib_community:'Lenguas de la comunidad',lib_search:'Buscar por nombre o g√©nero‚Ä¶',
    lib_empty:'No se encontraron lenguas',lib_see_detail:'Toca para detalles ‚Üí',lib_author:'Autor',
    btn_import_json:'üì• Importar JSON',btn_export_json:'üì§ Exportar JSON',
    btn_close:'Cerrar',btn_cancel:'Cancelar',btn_import:'Importar',btn_send:'Enviar',
    btn_clear_chat:'üóë Limpiar',btn_export_vocab:'üìñ A√±adir palabras',
    btn_login:'Iniciar sesi√≥n',btn_start:'Empezar gratis',btn_save:'Guardar',btn_add:'A√±adir +',
    btn_back_home:'‚Üê Volver al inicio',btn_clear:'Limpiar',btn_clear_slots:'üóë Limpiar',btn_logout:'Cerrar sesi√≥n',
    btn_contact:'üí¨ Contacto',btn_send_contact:'Enviar',
    contact_title:'üí¨ Cont√°ctanos',contact_subtitle:'Esperamos sus comentarios, solicitudes de funciones e informes de errores',
    contact_category:'Categor√≠a',contact_email:'Correo electr√≥nico (opcional)',contact_message:'Mensaje',
    contact_message_placeholder:'Cu√©ntanos m√°s...',
    contact_cat_bug:'üêõ Informe de error',contact_cat_feature:'‚ú® Solicitud de funci√≥n',
    contact_cat_feedback:'üí≠ Comentarios',contact_cat_other:'Otro',
    contact_success:'Su mensaje ha sido enviado. ¬°Gracias!',
    contact_error:'Error al enviar. Int√©ntalo de nuevo.',
    contact_error_empty:'Por favor ingrese un mensaje',
    contact_email_label:'O env√≠e un correo directo:',
    // FAQ
    faq_title:'‚ùì Preguntas Frecuentes',faq_subtitle:'Sobre caracter√≠sticas, uso y precios de Lingua',
    faq_cat_basic:'üåü Caracter√≠sticas B√°sicas',faq_cat_features:'‚ö° Caracter√≠sticas',
    faq_cat_pricing:'üíé Precios',faq_cat_support:'üí¨ Soporte',
    faq_q1:'¬øQu√© es Lingua?',
    faq_a1:'Lingua es una aplicaci√≥n web para crear y gestionar lenguas construidas (conlangs). Gestiona sistemas de escritura, fonolog√≠a, gram√°tica, diccionario y corpus de ejemplos en un solo lugar. Incluye generaci√≥n de palabras y revisi√≥n gramatical con IA.',
    faq_q2:'¬øEs gratis?',
    faq_a2:'¬°S√≠! Las funciones b√°sicas son completamente gratuitas. Diccionario, gram√°tica, ejemplos, exportaci√≥n JSON y navegaci√≥n de biblioteca son gratis. Los planes Pro desbloquean IA ilimitada, sincronizaci√≥n en la nube y m√∫ltiples idiomas.',
    faq_q3:'¬øSe guardan mis datos?',
    faq_a3:'Los datos se guardan autom√°ticamente en el almacenamiento local del navegador. Los usuarios Pro obtienen sincronizaci√≥n en la nube para compartir datos entre dispositivos.',
    faq_q4:'¬øC√≥mo uso las funciones de IA?',
    faq_a4:'Use "Generaci√≥n aleatoria" en la pesta√±a de diccionario para generar palabras autom√°ticamente seg√∫n reglas fonol√≥gicas. El chat de IA permite practicar conversaci√≥n y revisar gram√°tica en tu idioma.',
    faq_q5:'¬øPuedo crear m√∫ltiples idiomas?',
    faq_a5:'El plan gratuito permite 1 idioma. Los planes Lite y Premium permiten idiomas ilimitados.',
    faq_q6:'¬øPuedo ver idiomas de otros?',
    faq_a6:'¬°S√≠! Navega e importa idiomas p√∫blicos desde la "üåø Biblioteca". Tambi√©n puedes compartir el tuyo cambiando la configuraci√≥n de visibilidad.',
    faq_q7:'¬øCu√°nto cuesta Pro?',
    faq_a7:'Lite: $4.99/mes, Premium: $9.99/mes. Prueba gratuita de 14 d√≠as disponible. Cancela en cualquier momento.',
    faq_q8:'¬øCu√°l es la diferencia con Free?',
    faq_a8:'<strong>Free:</strong> 1 idioma, 10 chats IA/d√≠a, solo almacenamiento local<br><strong>Lite:</strong> Idiomas ilimitados, 50 chats IA/d√≠a, sincronizaci√≥n en la nube<br><strong>Premium:</strong> Todo ilimitado, soporte prioritario, acceso anticipado a nuevas funciones',
    faq_q9:'¬øEncontraste un error?',
    faq_a9:'Rep√≥rtalo a trav√©s de "üí¨ Contacto" en la parte superior derecha, o env√≠a un correo directo a',
    faq_a9_2:'.',
    faq_q10:'¬øAceptan solicitudes de funciones?',
    faq_a10:'¬°Por supuesto! Selecciona "‚ú® Solicitud de funci√≥n" en el formulario de contacto. Valoramos la retroalimentaci√≥n del usuario.',
    faq_more:'¬øTienes m√°s preguntas?',faq_more_desc:'No dudes en contactarnos',
    aichat_sub:'Chatea con las reglas de tu conlang',aichat_badge:'Conlang-IA',
    aichat_welcome_title:'‚ú¶ ¬°Bienvenido a Conlang-IA!',
    aichat_welcome_body:'Tu diccionario, gram√°tica y fonolog√≠a est√°n cargados. ¬°Habla en tu conlang!',
    aichat_placeholder:'Escribe en tu conlang‚Ä¶ o en espa√±ol',
    aichat_quick_hi:'Hola',aichat_quick_name:'Mi nombre es‚Ä¶',
    aichat_quick_date:'¬øQu√© d√≠a es hoy?',aichat_quick_word:'‚ú¶ Sugerir palabra',
    import_title:'üì• Importar datos de lengua',
    import_desc:'Pega un archivo JSON de Lingua. Los datos actuales ser√°n reemplazados.',
    storage_ok:'üíæ Guardado',storage_warn:'‚ö† Tama√±o creciendo',storage_full:'‚ùå ¬°Cuota superada!',
    dash_complete:'Progreso',dash_words:'Palabras',dash_patterns:'Patrones',
    dash_corpus:'Corpus',dash_done:'Completado',
    chat_cleared:'Chat limpiado. ¬°Vuelve cuando quieras!',ai_assist_title:'‚ú¶ Asistente IA ‚Äî Preg√∫ntame lo que quieras',ai_assist_placeholder:'Escribe tu pregunta‚Ä¶ (ej. consejos para principiantes)',ai_thinking:'Pensando‚Ä¶',ph_chart_tab:'üìä Gr√°fico Fonol√≥gico',ph_not_set:'(no configurado)',ph_reg_on:'üî¥ Modo registro ON',ph_reg_off:'‚¨§ Modo registro OFF',ph_chart_empty:'Registra fonemas para ver el gr√°fico',gp_form_suffix:'Forma (sufijo)',gp_form_prefix:'Forma (prefijo)',gp_form_infix:'Forma (infijo)',gp_form_mutation:'Mutaci√≥n voc√°lica',gp_form_tone:'Regla tonal',gp_form_circumfix:'Prefijo¬∑Sufijo',gp_form_reduplication:'Reduplicaci√≥n',gp_form_particle:'Forma de part√≠cula',gp_form_label:'Forma',gp_category_default:'Gram√°tica',gp_enter_hint:'Introduzca‚Ä¶',
    settings_label:'Configuraci√≥n',
    dash_rename:'‚úé Renombrar',
    card_vibe_desc:'Describe el ambiente de tu lengua para obtener sugerencias de sonidos y gram√°tica.',
    card_script_desc:'Asigna letras a caracteres personalizados con vista previa en tiempo real.',
    card_phoneme_desc:'Configura vocales, consonantes y s√≠labas. Genera sonidos con un clic.',
    card_grammar_desc:'Orden, casos, tiempo, conjugaci√≥n. Genera tablas de declinaci√≥n autom√°ticamente.',
    card_vocab_desc:'Gesti√≥n de etiquetas, b√∫squeda inversa, generaci√≥n aleatoria. B√∫squeda bidireccional.',
    card_corpus_desc:'Acumula tarjetas de frases. Comp√°rtelas como im√°genes en redes sociales.',
    card_not_set:'A√∫n no configurado',
    card_vocab_empty:'Sin palabras a√∫n',
    card_corpus_empty:'Sin frases a√∫n',
    card_vibe_title:'Mundo y Est√©tica',
    card_script_title:'Sistema de Escritura',
    card_grammar_title:'Gram√°tica + Declinaci√≥n',
    card_vocab_title:'Vocabulario y Diccionario',
    card_corpus_title:'Corpus + Compartir',
    dash_reset:'‚Ü∫ Restablecer',
    dash_export:'üì§ Exportar',
    dash_complete:'Progreso',
    daily_input_hint:'Escribe esta frase en tu conlang',
    dash_daily_subtitle:'Frase del d√≠a ‚Äî',daily_label:'Desaf√≠o: frase del d√≠a',
    daily_submit:'Enviar y guardar',daily_check:'‚úì Revisar',daily_save:'Guardar en corpus',
    daily_past:'Respuestas anteriores',daily_empty:'A√∫n no hay respuestas.',
    g_tab_order:'Orden y casos',g_tab_verb:'Verbos y tiempo',g_tab_pattern:'Patrones gramaticales',
    g_tab_matrix:'Matriz de declinaci√≥n',g_tab_notes:'Notas gramaticales',g_tab_roadmap:'üó∫ Hoja de ruta',
    g_word_order:'Orden de palabras',g_cases:'Casos nominales',g_gender:'G√©nero y n√∫mero',
    g_verb_conj:'Conjugaci√≥n verbal',g_tense:'Tiempo verbal',g_tense_hint:'Elegir "Sin tiempo" significa usar adverbios para el tiempo.',
    g_pattern_what:'¬øQu√© es un patr√≥n gramatical?',
    g_pattern_desc:'Reglas para a√±adir prefijos, sufijos o part√≠culas. Como "in-feliz" o "feliz-mente" en espa√±ol.',
    g_pattern_type_label:'Tipo de patr√≥n',g_pattern_add:'A√±adir nuevo patr√≥n',
    g_form:'Forma',g_meaning_fn:'Significado / Funci√≥n',g_example_opt:'Ejemplo (opcional)',g_category:'Categor√≠a',
    g_suggest_suffix:'Sugerir sufijos',g_suggest_prefix:'Sugerir prefijos',g_suggest_particle:'Sugerir part√≠culas',
    g_mat_hint:'Selecciona casos (filas) y n√∫mero/g√©nero (cols) para la tabla de declinaci√≥n.',
    g_add_row:'A√±adir casos (filas)',g_add_col:'A√±adir n√∫mero/g√©nero (cols)',
    g_root_label:'Ra√≠z',g_auto_fill:'‚ú¶ Rellenar terminaciones',
    g_regen:'üîÑ Regenerar tabla',g_sample:'Terminaciones de ejemplo',g_clear_mat:'üóë Limpiar',
    g_notes_placeholder:'# T√≠tulo de gram√°tica\n## Secci√≥n\nEscribe tus reglas aqu√≠. Markdown disponible.',
    v_tab_gacha:'Generador',v_tab_manual:'A√±adir manual',v_tab_dict:'Diccionario',v_tab_rev:'B√∫squeda inversa',v_tab_sound:'Generaci√≥n fonol√≥gica',
    v_gacha_gen:'Generar ‚ú¶',v_dict_header:'üìñ Diccionario',v_dict_alpha:'A‚Üë',v_dict_pos_sort:'Por categor√≠a',
    v_search_placeholder:'üîç Buscar por palabra o significado‚Ä¶',
    v_search_both:'Ambos',v_search_conlang:'Palabra',v_search_jp:'Significado',
    v_pos_filter_all:'Todos',
    v_rev_title:'üîé B√∫squeda inversa (significado ‚Üí conlang)',v_rev_desc:'Busca palabras por significado. Introduce un significado.',
    v_rev_placeholder:'ej: agua, amor, hermoso, correr‚Ä¶',v_rev_pos_snap:'Resumen por categor√≠a gramatical',
    v_add_dict_btn:'A√±adir al diccionario +',v_speak_btn:'üîä Pronunciar',v_script_preview_btn:'‚úç Vista escritura',
    v_ipa_title:'üìã Atajos IPA',v_ipa_desc:'Inserta s√≠mbolos IPA r√°pidamente en el campo de lectura',
    v_word_jp_label:'Significado',v_word_ipa_label:'Lectura (IPA)',v_word_pos_label:'Categor√≠a gramatical',v_word_tags_label:'Etiquetas',
    v_script_picker_open:'Abrir selector de escrituras del mundo',
    v_script_picker_hint:'‚ñº Primero haz clic en el campo "Palabra conlang", luego toca un car√°cter:',
    v_syll_violation:'‚ö† Violaci√≥n de estructura sil√°bica',
    v_pos_noun:'sustantivo',v_pos_verb:'verbo',v_pos_adj:'adjetivo',v_pos_adv:'adverbio',v_pos_pron:'pronombre',v_pos_part:'part√≠cula',
    v_gacha_hint:'Ingresa significados y genera palabras autom√°ticamente',v_gacha_placeholder:'ej: agua, cielo, amor, espada‚Ä¶',
    v_gacha_rand:'Generar 10 palabras b√°sicas al azar',v_dict_empty:'¬°A√∫n no hay palabras. Usa el generador o a√±ade manualmente!',
    v_add_manual:'A√±adir palabra',v_word_cl:'Palabra conlang',v_word_jp:'Significado',
    v_word_read:'Pronunciaci√≥n (IPA)',v_word_pos:'Categor√≠a gramatical',v_word_tags:'Etiquetas (separadas por coma)',
    ph_vowels:'Vocales',ph_consonants:'Consonantes',ph_syllable:'Estructura sil√°bica',ph_accent:'Acento / Tono',
    ph_chart:'Tabla IPA (clic para registrar)',ph_reg_on:'Modo registro ON',ph_reg_off:'Modo registro OFF',
    rm_title:'üó∫ Hoja de ruta gramatical',rm_subtitle:'Construye tu gram√°tica paso a paso ‚Äî inspirado en el aprendizaje de idiomas',
    rm_done:'‚úÖ Hecho',rm_goto:'Intentarlo ‚Üí',rm_progress:'Progreso general',
    rm_s1:'PASO 1 ‚Äî Empieza a hablar',rm_s2:'PASO 2 ‚Äî Ampliar expresi√≥n',
    rm_s3:'PASO 3 ‚Äî Emociones e intenci√≥n',rm_s4:'PASO 4 ‚Äî Gram√°tica completa',
    // Welcome page
    w_sub:'Empieza a construir tu propia lengua ahora mismo',
    w_name_label:'Nombre de la lengua',w_name_placeholder:'ej: Silv√°ri, Kaelon, Drathun‚Ä¶',
    w_name_hint:'Podr√°s cambiarlo cuando quieras',
    w_vibe_label:'¬øQu√© est√©tica? (Varias OK ¬∑ se puede omitir)',
    w_vibe_elf:'√âlfico ¬∑ Naturaleza',w_vibe_dark:'Oscuro ¬∑ Imperio',w_vibe_cute:'Tierno ¬∑ Hada',
    w_vibe_scifi:'M√°quina ¬∑ Sci-Fi',w_vibe_ocean:'Oc√©ano ¬∑ Esp√≠ritu',w_vibe_ancient:'Antiguo ¬∑ Mito',
    w_start:'Comenzar',w_skip:'Empezar sin nombre',
    w_restore_label:'üíæ Sesi√≥n anterior encontrada',w_restore_btn:'Continuar',
    w_unnamed:'Lengua sin nombre',
    w_google_login:'Iniciar sesi√≥n con Google',
    w_or_guest:'o',
    w_guest_start:'Continuar como invitado (sin login)',
    w_feat_sync:'Sincroniza en m√≥vil y PC cuando quieras',
    w_feat_ai:'Desarrolla tu lengua con conversaciones de IA',
    w_feat_trial:'Premium ‚Äî prueba gratis 14 d√≠as',
    w_logged_in:'Has iniciado sesi√≥n',
    w_continue:'‚òëÔ∏è Continuar ‚Üí',
    // L√≠mites de IA y planes
    ai_limit_label:'Usos de IA restantes',
    ai_limit_upgrade:'Actualizar',
    ai_limit_reached:'L√≠mite diario de IA alcanzado',
    ai_limit_prompt:'Hazte Premium para IA ilimitada',
    pro_cta:'‚ú¶ Empieza gratis 2 semanas',
    upgrade_sub:'Prueba gratis 14 d√≠as ‚Äî cancela cuando quieras',
    // Muro de pago del chat IA
    chat_paywall_title:'Chats de IA de hoy agotados',
    chat_paywall_body:'Prueba Premium gratis 14 d√≠as ‚Äî chats de IA ilimitados.',
    chat_paywall_btn:'‚ú¶ Empieza gratis 2 semanas',
    chat_paywall_reset:'10 chats m√°s disponibles ma√±ana',
    chat_remaining:'Chats de IA restantes: %n hoy',
    modal_plan_select:'Elige tu plan',
    vp_count:'%n palabras registradas',
    vp_sort_alpha:'A‚Üë',vp_sort_pos:'POS‚Üë',
    fc_front_conlang:'Conlang',fc_front_meaning:'Significado',
    fc_flip_hint:'Toca para voltear',
    fc_correct:'¬°Correcto!',fc_wrong:'Otra vez',
    fc_result_perfect:'¬°Perfecto!',fc_result_good:'¬°Bien hecho!',fc_result_ok:'¬°Casi!',fc_result_try:'¬°Sigue practicando!',
    fc_retry_wrong:'‚úó Repasar errores',fc_back_to_dict:'Volver al diccionario',fc_again:'Otra vez',
    fc_setup_direction:'Direcci√≥n',fc_dir_cl2jp:'Conlang ‚Üí Significado',fc_dir_jp2cl:'Significado ‚Üí Conlang',fc_dir_random:'Aleatorio',
    fc_range:'Rango',fc_range_all:'Todas',fc_range_starred:'‚≠ê Solo favoritas',fc_range_wrong:'‚úó Solo errores',
    fc_start:'üÉè Iniciar',
    // Bottom nav
    bnav_home:'Inicio',bnav_phoneme:'Fonolog√≠a',bnav_vocab:'Vocab',bnav_grammar:'Gram√°tica',bnav_more:'M√°s',
    // Mobile more menu
    mm_corpus:'Corpus',mm_daily:'Frase',mm_script:'Escritura',mm_vibe:'Est√©tica',mm_library:'Biblioteca',mm_aichat:'Chat IA',
    // Autosave
    autosave_saved:'Guardado',
    // Prompt dialogs
    prompt_rename:'Introduce el nombre de la lengua',
    confirm_reset_title:'Empezar de nuevo',
    confirm_reset:'¬øRestablecer todos los datos y volver al inicio?\n(Esta acci√≥n no se puede deshacer)',
    // Dashboard dynamic
    script_label:'Escritura',route_image:'‚ú¶ Ruta imagen',route_custom:'‚äû Ruta propia',
    // Daily
    daily_date_locale:'es-ES',
    // AI chat
    ai_tutor_lang:'espa√±ol',
    // Editor labels
    ed_no_words:'Por favor a√±ade vocabulario primero',
    ed_no_new_words:'A√∫n no hay sugerencias. ¬°Prueba "‚ú¶ Sugerir palabra" en el Chat IA!',
    ed_added_words:'palabras a√±adidas al diccionario.',
    ed_saved_corpus:'¬°Guardado en el corpus!',
    ed_clipboard_ok:'¬°Imagen copiada al portapapeles!',
    ed_clipboard_fail:'Error al copiar. Prueba a descargar.',
    ed_clipboard_nosupport:'Copia no soportada en este navegador. Por favor descarga.',
    // Grammar check
    gc_checking:'Revisando‚Ä¶',gc_ok:'‚úì Sin problemas',gc_ok_msg:'¬°No se encontraron conflictos con tus reglas!',
    gc_warn:'‚ö† Sugerencias',gc_unknown:'no est√° en el diccionario',
    // Corpus editor tabs & labels
    c_tab_add:'A√±adir frase',c_tab_list:'Lista corpus',c_tab_share:'‚ú¶ Compartir',
    c_lang_label:'Conlang',c_read_label:'Lectura (Kana ¬∑ IPA)',
    c_gloss_label:'Glosa / An√°lisis morfol√≥gico',c_gloss_hint:'Opcional. Escribe "palabra-CASO" para mayor precisi√≥n ling√º√≠stica.',
    c_jp_label:'Traducci√≥n',c_save_btn:'Guardar frase +',c_build_btn:'Construir desde diccionario',
    c_auto_title:'‚ú¶ Componer desde vocabulario',c_auto_body:'Construye una frase con palabras de tu diccionario',
    c_auto_chip:'Generar frase',c_share_desc:'Selecciona una frase para generar una tarjeta compartible.',
    c_share_sel_label:'Selecciona frase a compartir',c_share_sel_placeholder:'Elige una frase‚Ä¶',
    c_dl_btn:'‚¨á Descargar imagen',c_copy_btn:'üìã Copiar al portapapeles',c_preview_btn:'üîÑ Actualizar vista previa',
    c_del_btn:'Eliminar',c_speak_btn:'üîä',c_share_btn:'‚ú¶ Compartir',
    c_empty:'A√∫n no hay frases',
    // Daily editor
    de_today:'La frase de hoy',de_write:'Escr√≠bela en tu conlang',de_input_placeholder:'Introduce la traducci√≥n‚Ä¶',
    de_submit:'Enviar y guardar',de_check:'‚úì Revisar',de_save_corpus:'Guardar en corpus',
    de_past:'Respuestas anteriores',de_empty:'A√∫n no hay respuestas',
    // Script editor
    sc_active_cell:'Editando: "%s"',
    sc_world_picker:'Selector de escrituras del mundo',
    // Suggest patterns
    sp_topic:'marcador de tema („ÅØ/„Åå)',sp_acc:'marcador acusativo („Çí)',sp_conj:'conjunci√≥n („Å®)',sp_q:'marcador de pregunta (?)',
    sp_cat_gram:'Gram√°tica',sp_cat_q:'Pregunta',
    // Word suggestion
    ws_convo:'conversaci√≥n',ws_noun:'sustantivo',ws_tag_daily:'cotidiano',ws_tag_emotion:'emoci√≥n',
    ws_new:'Nueva sugerencia: "%w" (%m) ‚Äî gu√°rdala con el bot√≥n "üìñ A√±adir palabras".',
  }
}
function t(key){return (I18N[S.lang]||I18N.ja)[key]||key}

// ===== V16: AUTH & PRO SYSTEM =====

// --- Áä∂ÊÖãÁÆ°ÁêÜ ---
// _authUser: null=„Ç≤„Çπ„Éà, {uid, name, email, photo}=„É≠„Ç∞„Ç§„É≥Ê∏à„Åø
// _isPro: true=ProË™≤ÈáëÊ∏à„Åø („Éá„É¢: localStorage 'lingua_pro' „Éï„É©„Ç∞„ÅßÂà∂Âæ°)
// _aiCheckCount: ‰ªäÊó•„ÅÆÁÑ°ÊñôAIÊ∑ªÂâä‰ΩøÁî®ÂõûÊï∞
let _authUser = null;
let _isPro = false;
let _plan = 'free'; // 'free' | 'light' | 'premium'
let _trialStart = null; // „Éà„É©„Ç§„Ç¢„É´ÈñãÂßãÊó•
let _aiCheckCount = 0;
let _aiChatCount = 0; // AI‰ºöË©±„ÅÆÈÄÅ‰ø°ÂõûÊï∞
const AI_FREE_LIMIT = 10;      // ÁÑ°Êñô: 1Êó•10ÂõûÔºàÊ∑ªÂâäÔºâ
const AI_LIGHT_LIMIT = 20;     // „É©„Ç§„Éà: 1Êó•20ÂõûÔºàÊ∑ªÂâäÔºâ
// ===== V25 AIÂà∂ÈôêÔºàFirestoreÂÆåÁµê„ÉªÊó•Êú¨ÊôÇÈñì4ÊôÇ„É™„Çª„ÉÉ„ÉàÔºâ =====
const AI_LIMITS = {
  free: 10,
  lite: 50,
  pro: 100
};

// Êó•Êú¨ÊôÇÈñì„ÅßÂçàÂâç4ÊôÇ„ÇíÂà§ÂÆö„Åô„ÇãÈñ¢Êï∞
function getJSTResetDate() {
  const now = new Date();
  const jst = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' }));
  
  const resetHour = 4; // ÂçàÂâç4ÊôÇ
  const today = new Date(jst.getFullYear(), jst.getMonth(), jst.getDate(), resetHour, 0, 0);
  
  // ÁèæÂú®ÊôÇÂàª„Åå4ÊôÇÂâç„Å™„ÇâÂâçÊó•„ÅÆ4ÊôÇ„ÄÅ4ÊôÇ‰ª•Èôç„Å™„Çâ‰ªäÊó•„ÅÆ4ÊôÇ
  if (jst.getHours() < resetHour) {
    today.setDate(today.getDate() - 1);
  }
  
  return today.toISOString().split('T')[0]; // YYYY-MM-DDÂΩ¢Âºè
}

// AI‰ΩøÁî®„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºà‰ΩøÁî®Ââç„Å´Âëº„Å∂Ôºâ
async function checkAIUsage() {
  if (!window.currentUser) {
    alert('„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
    return false;
  }
  
  const db = firebase.firestore();
  const userRef = db.collection('users').doc(window.currentUser.uid);
  
  try {
    const doc = await userRef.get();
    const userData = doc.data() || {};
    
    const plan = userData.plan || 'free';
    const limit = AI_LIMITS[plan];
    const today = getJSTResetDate();
    
    // „É™„Çª„ÉÉ„ÉàÊó•„ÅåÈÅï„ÅÜÂ†¥Âêà„ÅØ„Ç´„Ç¶„É≥„Éà„Çí„É™„Çª„ÉÉ„Éà
    if (userData.last_ai_reset !== today) {
      await userRef.update({
        ai_usage_count: 0,
        last_ai_reset: today
      });
      return true; // „É™„Çª„ÉÉ„ÉàÂæå„Å™„ÅÆ„Åß‰ΩøÁî®ÂèØËÉΩ
    }
    
    const currentCount = userData.ai_usage_count || 0;
    
    if (currentCount >= limit) {
      showAILimitModal(plan, limit, currentCount);
      return false;
    }
    
    return true;
  } catch (error) {
    console.error('AI usage check error:', error);
    return false;
  }
}

// AI‰ΩøÁî®Âæå„Å´„Ç´„Ç¶„É≥„Éà„ÇíÂ¢ó„ÇÑ„Åô
async function incrementAIUsage() {
  if (!window.currentUser) return;
  
  const db = firebase.firestore();
  const userRef = db.collection('users').doc(window.currentUser.uid);
  
  try {
    await userRef.update({
      ai_usage_count: firebase.firestore.FieldValue.increment(1)
    });
  } catch (error) {
    console.error('AI usage increment error:', error);
  }
}

// ‰∏äÈôêÂà∞ÈÅîÊôÇ„ÅÆ„É¢„Éº„ÉÄ„É´
function showAILimitModal(currentPlan, limit, currentCount) {
  const overlay = document.createElement('div');
  overlay.className = 'editor-overlay open';
  overlay.style.cssText = 'display:flex;z-index:9999;';
  
  let upgradeMessage = '';
  if (currentPlan === 'free') {
    upgradeMessage = `
      <p style="margin-bottom:20px;">
        Êú¨Êó•„ÅÆAIÊ©üËÉΩ„ÅÆÁÑ°ÊñôÂà©Áî®ÂõûÊï∞Ôºà${limit}ÂõûÔºâ„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇ<br>
        „Çà„ÇäÂ§ö„Åè„ÅÆAIÊ©üËÉΩ„Çí‰Ωø„ÅÑ„Åü„ÅÑÊñπ„ÅØ„ÄÅÊúâÊñô„Éó„É©„É≥„Å∏„ÅÆ„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„Çí„ÅîÊ§úË®é„Åè„Å†„Åï„ÅÑ„ÄÇ
      </p>
      <div style="display:flex;gap:12px;justify-content:center;margin-bottom:16px;">
        <button class="btn" onclick="openStripeCheckout('lite');this.closest('.editor-overlay').remove();">
          Lite„Éó„É©„É≥ ($9.9/Êúà)<br>
          <span style="font-size:0.7rem;">1Êó•50Âõû„Åæ„Åß</span>
        </button>
        <button class="btn btn-primary" onclick="openStripeCheckout('pro');this.closest('.editor-overlay').remove();">
          Pro„Éó„É©„É≥ ($19.9/Êúà)<br>
          <span style="font-size:0.7rem;">1Êó•100Âõû„Åæ„Åß</span>
        </button>
      </div>
    `;
  } else if (currentPlan === 'lite') {
    upgradeMessage = `
      <p style="margin-bottom:20px;">
        Êú¨Êó•„ÅÆAIÊ©üËÉΩ„ÅÆÂà©Áî®ÂõûÊï∞Ôºà${limit}ÂõûÔºâ„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇ<br>
        „Åï„Çâ„Å´Â§ö„Åè„ÅÆÂõûÊï∞„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅØ„ÄÅPro„Éó„É©„É≥„Å∏„ÅÆ„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„Çí„ÅîÊ§úË®é„Åè„Å†„Åï„ÅÑ„ÄÇ
      </p>
      <button class="btn btn-primary" onclick="openStripeCheckout('pro');this.closest('.editor-overlay').remove();" style="margin-bottom:16px;">
        Pro„Éó„É©„É≥ ($19.9/Êúà) „Å´„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ<br>
        <span style="font-size:0.7rem;">1Êó•100Âõû„Åæ„Åß</span>
      </button>
    `;
  } else {
    upgradeMessage = `
      <p style="margin-bottom:20px;">
        Êú¨Êó•„ÅÆAIÊ©üËÉΩ„ÅÆÂà©Áî®ÂõûÊï∞Ôºà${limit}ÂõûÔºâ„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇ<br>
        ÊòéÊó•„ÅÆÂçàÂâç4ÊôÇ„Å´„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åô„ÄÇ
      </p>
    `;
  }
  
  overlay.innerHTML = `
    <div class="editor-panel" style="max-width:500px;text-align:center;">
      <div style="font-size:3rem;margin:20px 0;">‚è∞</div>
      <h2 style="font-family:'Cinzel',serif;font-size:1.4rem;font-weight:700;margin-bottom:16px;color:var(--accent);">
        AIÂà©Áî®ÂõûÊï∞„ÅÆ‰∏äÈôê„Å´ÈÅî„Åó„Åæ„Åó„Åü
      </h2>
      <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:12px;">
        Êú¨Êó•„ÅÆ‰ΩøÁî®ÂõûÊï∞: ${currentCount} / ${limit}
      </div>
      ${upgradeMessage}
      <div style="font-size:0.75rem;color:var(--text-muted);margin-top:16px;">
        Âà©Áî®ÂõûÊï∞„ÅØÊØéÊó•ÂçàÂâç4ÊôÇÔºàÊó•Êú¨ÊôÇÈñìÔºâ„Å´„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åô
      </div>
      <button class="btn btn-ghost" onclick="this.closest('.editor-overlay').remove();" style="margin-top:12px;">
        Èñâ„Åò„Çã
      </button>
    </div>
  `;
  document.body.appendChild(overlay);
}

// ÂæåÊñπ‰∫íÊèõÁî®ÔºàÊóß„Ç≥„Éº„Éâ„Åå‰Ωø„Å£„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºâ
const AI_CHAT_FREE_LIMIT = 10;
const AI_CHAT_KEY = 'lingua_ai_chat_count';
const AI_CHAT_DATE_KEY = 'lingua_ai_chat_date';
const AI_CHECK_DATE_KEY = 'lingua_ai_date';
const AI_CHECK_COUNT_KEY = 'lingua_ai_count';
const AUTH_KEY = 'lingua_auth_user';
const PRO_KEY = 'lingua_pro';
const PLAN_KEY = 'lingua_plan';
const TRIAL_KEY = 'lingua_trial_start';

// --- ÂàùÊúüÂåñ ---
function initAuth(){
  // localStorage„Åã„ÇâÁä∂ÊÖã„ÇíÂæ©ÂÖÉ
  try {
    const saved = localStorage.getItem(AUTH_KEY);
    if(saved) _authUser = JSON.parse(saved);
    _isPro = localStorage.getItem(PRO_KEY) === '1';
    // „Éó„É©„É≥Âæ©ÂÖÉ
    const savedPlan = localStorage.getItem(PLAN_KEY);
    if(savedPlan) _plan = savedPlan;
    const savedTrial = localStorage.getItem(TRIAL_KEY);
    if(savedTrial) _trialStart = new Date(savedTrial);
    // AI‰ºöË©±„Ç´„Ç¶„É≥„ÉàÂæ©ÂÖÉÔºàÊó•‰ªò„É™„Çª„ÉÉ„ÉàÔºâ
    const chatToday = new Date().toDateString();
    if(localStorage.getItem(AI_CHAT_DATE_KEY) !== chatToday){
      localStorage.setItem(AI_CHAT_DATE_KEY, chatToday);
      localStorage.setItem(AI_CHAT_KEY, '0');
      _aiChatCount = 0;
    } else {
      _aiChatCount = parseInt(localStorage.getItem(AI_CHAT_KEY)||'0');
    }
    // „Éà„É©„Ç§„Ç¢„É´ÊúüÈôê„ÉÅ„Çß„ÉÉ„ÇØÔºà14Êó•Ôºâ
    if(_trialStart && _plan === 'premium'){
      const daysPassed = (Date.now() - _trialStart.getTime()) / (1000*60*60*24);
      if(daysPassed > 14){
        // „Éà„É©„Ç§„Ç¢„É´ÁµÇ‰∫Ü ‚Üí ÁÑ°Êñô„Å´Êàª„ÅôÔºàÊú¨Áï™„ÅØStripeÈÄ£Êê∫„ÅßÁÆ°ÁêÜÔºâ
        _plan = 'free'; _isPro = false;
        try{ localStorage.setItem(PLAN_KEY,'free'); localStorage.removeItem(PRO_KEY); }catch(e){}
      }
    }
    // AI‰ΩøÁî®ÂõûÊï∞ÔºàÊó•‰ªò„É™„Çª„ÉÉ„ÉàÔºâ
    const today = new Date().toDateString();
    if(localStorage.getItem(AI_CHECK_DATE_KEY) !== today){
      localStorage.setItem(AI_CHECK_DATE_KEY, today);
      localStorage.setItem(AI_CHECK_COUNT_KEY, '0');
      _aiCheckCount = 0;
    } else {
      _aiCheckCount = parseInt(localStorage.getItem(AI_CHECK_COUNT_KEY)||'0');
    }
  } catch(e){}
  
  // FirebaseË™çË®ºÁä∂ÊÖã„ÅÆÁõ£Ë¶ñ
  if(window.firebaseAuth && window.onAuthStateChanged){
    let _redirectHandled = false; // „É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÁµêÊûú„Å®ÈáçË§á„Åó„Å™„ÅÑ„Éï„É©„Ç∞

    window.onAuthStateChanged(window.firebaseAuth, async (user) => {
      if(user){
        _authUser = {
          uid: user.uid,
          name: user.displayName,
          email: user.email,
          photo: user.photoURL
        };
        window.currentUser = _authUser; // „Ç∞„É≠„Éº„Éê„É´„Å´Ë®≠ÂÆö
        try { localStorage.setItem(AUTH_KEY, JSON.stringify(_authUser)); } catch(e){}
        
        // V26: „Åæ„Åö„É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Çì„Åß„Åã„Çâ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å∏
        await loadUserDataFromFirestore(user.uid);
        updateAuthUI();
        
        // V25: „Éó„É©„É≥Áõ£Ë¶ñ„ÇíÈñãÂßã
        setupPlanMonitoring();

        // „É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÂá¶ÁêÜ„ÅåÊ∏à„Çì„Åß„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÈÅ∑Áßª
        if(!_redirectHandled){
          // „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„Å´„ÅÑ„ÇãÂ†¥Âêà„Å†„Åë„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å∏Ôºà„Çø„Ç§„Éü„É≥„Ç∞Ë™øÊï¥Ôºâ
          setTimeout(() => {
            const loginPage = document.getElementById('page-login');
            if(loginPage && loginPage.classList.contains('active')){
              console.log('üöÄ Entering dashboard after login');
              enterDashboard();
            }
          }, 300);
        }
      } else {
        // „É≠„Ç∞„Ç¢„Ç¶„ÉàÁä∂ÊÖã
        if(_authUser){
          _authUser = null;
          window.currentUser = null;
          try { localStorage.removeItem(AUTH_KEY); } catch(e){}
        }
        // „Éó„É©„É≥Áõ£Ë¶ñ„ÇíÂÅúÊ≠¢
        if (planSubscriptionUnsubscribe) {
          planSubscriptionUnsubscribe();
          planSubscriptionUnsubscribe = null;
        }
        updateAuthUI();
      }
    });

    // „É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÂæå„ÅÆ„É≠„Ç∞„Ç§„É≥ÁµêÊûú„ÇíÂá¶ÁêÜ
    if(window.getRedirectResult){
      window.getRedirectResult(window.firebaseAuth)
        .then(async (result) => {
          if(result && result.user){
            console.log('‚úÖ Redirect login success:', result.user.email);
            _redirectHandled = true;
            const user = result.user;
            _authUser = {
              uid: user.uid,
              name: user.displayName,
              email: user.email,
              photo: user.photoURL
            };
            try { localStorage.setItem(AUTH_KEY, JSON.stringify(_authUser)); } catch(e){}
            
            // V26: „Éá„Éº„ÇøË™≠„ÅøËæº„Åø„ÇíÂæÖ„Å£„Å¶„Åã„Çâ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å∏
            await loadUserDataFromFirestore(user.uid);
            updateAuthUI();
            showAutosave(t('w_google_login') + ' ‚úì');
            
            // „Çø„Ç§„Éü„É≥„Ç∞Ë™øÊï¥„Åó„Å¶„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å∏Á¢∫ÂÆü„Å´ÈÅ∑Áßª
            setTimeout(() => {
              console.log('üöÄ Entering dashboard after redirect');
              enterDashboard();
            }, 400);
          }
        })
        .catch((error) => {
          console.error("‚ùå Redirect result error:", error);
        });
    }
  }
  
  updateAuthUI();
}

// --- Google „É≠„Ç∞„Ç§„É≥ÔºàsignInWithRedirect: „Çπ„Éû„Éõ„ÉªPC‰∏°ÂØæÂøúÔºâ ---
function loginWithGoogle(){
  console.log('üîµ loginWithGoogle called');
  
  if(!window.firebaseReady){
    alert('FirebaseÂàùÊúüÂåñ‰∏≠„Åß„Åô„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
    console.log('‚ö†Ô∏è Firebase not ready');
    return;
  }
  
  if(!window.firebaseAuth || !window.GoogleAuthProvider || !window.signInWithRedirect){
    alert('Firebase„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    console.log('‚ö†Ô∏è Firebase modules not loaded');
    return;
  }
  
  console.log('‚úÖ Firebase ready, starting redirect login...');
  
  const provider = new window.GoogleAuthProvider();
  window.signInWithRedirect(window.firebaseAuth, provider)
    .catch((error) => {
      console.error('‚ùå Redirect error:', error);
      alert('„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
    });
}

// --- „Ç≤„Çπ„Éà„É¢„Éº„Éâ ---
function continueAsGuest(){
  _authUser = null;
  wStart(true);
}

// --- „É≠„Ç∞„Ç¢„Ç¶„Éà ---
function logout(){
  const clearLocal = () => {
    _authUser = null; _isPro = false; _plan = 'free'; _trialStart = null;
    try {
      localStorage.removeItem(AUTH_KEY);
      localStorage.removeItem(PRO_KEY);
      localStorage.removeItem(PLAN_KEY);
      localStorage.removeItem(TRIAL_KEY);
    } catch(e){}
  };
  if(window.firebaseAuth && window.signOut){
    window.signOut(window.firebaseAuth).then(() => {
      clearLocal(); updateAuthUI(); location.reload();
    }).catch((error) => { console.error('Logout error:', error); });
  } else {
    clearLocal(); updateAuthUI(); location.reload();
  }
}

// --- Pro „Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„ÉâÔºà„Éá„É¢Ôºâ ---
// --- „Éó„É©„É≥„Åî„Å®„ÅÆÊ©üËÉΩ„ÉÅ„Çß„ÉÉ„ÇØ ---
function getPlanLimit(){
  if(_plan === 'premium') return Infinity;
  if(_plan === 'light') return AI_LIGHT_LIMIT;
  return AI_FREE_LIMIT;
}
function isPremium(){ return _plan === 'premium' || _plan === 'pro' || _plan === 'lite'; }

// ===== V25 StripeÊ±∫Ê∏àÁµ±Âêà =====
const STRIPE_LINKS = {
  lite: 'https://buy.stripe.com/bJeaEZ3VYbJPfyEe292wU02', // $9.9/mo
  pro: 'https://buy.stripe.com/7sY14pboqaFLdqw2jr2wU03'   // $19.9/mo
};

function openStripeCheckout(plan) {
  const user = window.currentUser;
  let url = STRIPE_LINKS[plan];
  
  if (!url) {
    alert('ÁÑ°Âäπ„Å™„Éó„É©„É≥„Åß„Åô');
    return;
  }
  
  if (user && user.email) {
    url += `?prefilled_email=${encodeURIComponent(user.email)}`;
  }
  
  const successUrl = window.location.origin + window.location.pathname + '?payment=success&plan=' + plan;
  url += `${user && user.email ? '&' : '?'}success_url=${encodeURIComponent(successUrl)}`;
  
  window.location.href = url;
}

function showPaymentSuccessModal(plan) {
  const planName = plan === 'lite' ? 'Lite' : 'Pro';
  const overlay = document.createElement('div');
  overlay.className = 'editor-overlay open';
  overlay.style.cssText = 'display:flex;z-index:9999;';
  overlay.innerHTML = `
    <div class="editor-panel" style="max-width:500px;text-align:center;">
      <div style="font-size:4rem;margin:20px 0;">üéâ</div>
      <h2 style="font-family:'Cinzel',serif;font-size:1.6rem;font-weight:700;margin-bottom:16px;color:var(--gold);">
        „ÅäÁî≥„ÅóËæº„Åø„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ
      </h2>
      <p style="font-size:0.95rem;color:var(--text-secondary);line-height:1.8;margin-bottom:24px;">
        ${planName}„Éó„É©„É≥„Å∏„ÅÆ„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ<br>
        Êï∞ÂàÜ‰ª•ÂÜÖ„Å´Pro„ÅÆÊ©üËÉΩ„ÅåÊúâÂäπÂåñ„Åï„Çå„Åæ„Åô„ÄÇ<br>
        <br>
        ÁîªÈù¢„ÅåËá™ÂãïÁöÑ„Å´Êõ¥Êñ∞„Åï„Çå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅ<br>
        „Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
      </p>
      <button class="btn btn-primary" onclick="this.closest('.editor-overlay').remove();location.reload();">
        ‚úì ‰∫ÜËß£„Åó„Åæ„Åó„Åü
      </button>
      <div style="margin-top:20px;font-size:0.75rem;color:var(--text-muted);">
        È†òÂèéÊõ∏„ÅØ„ÅîÁôªÈå≤„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Å´ÈÄÅ‰ø°„Åï„Çå„Åæ„Åô
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
}

// ===== Firestore Pro„Éï„É©„Ç∞Áõ£Ë¶ñ =====
let planSubscriptionUnsubscribe = null;

function setupPlanMonitoring() {
  if (!window.currentUser) return;
  
  const db = firebase.firestore();
  const userRef = db.collection('users').doc(window.currentUser.uid);
  
  if (planSubscriptionUnsubscribe) {
    planSubscriptionUnsubscribe();
  }
  
  planSubscriptionUnsubscribe = userRef.onSnapshot((doc) => {
    if (!doc.exists) return;
    
    const data = doc.data();
    const newPlan = data.plan || 'free';
    
    if (window.currentUserPlan && window.currentUserPlan !== newPlan) {
      console.log('Plan changed from', window.currentUserPlan, 'to', newPlan);
      
      window.currentUserPlan = newPlan;
      _plan = newPlan === 'pro' || newPlan === 'lite' ? 'premium' : 'free';
      updatePlanUI(newPlan);
      
      if (newPlan === 'pro' || newPlan === 'lite') {
        showPlanUpgradeNotification(newPlan);
      }
    } else {
      window.currentUserPlan = newPlan;
      _plan = newPlan === 'pro' || newPlan === 'lite' ? 'premium' : 'free';
    }
  }, (error) => {
    console.error('Plan monitoring error:', error);
  });
}

function updatePlanUI(plan) {
  const badge = document.getElementById('topbar-plan-badge');
  if (badge) {
    if (plan === 'pro') {
      badge.className = 'pro-badge';
      badge.textContent = 'PRO';
    } else if (plan === 'lite') {
      badge.className = 'pro-badge';
      badge.textContent = 'LITE';
    } else {
      badge.className = 'free-badge';
      badge.textContent = 'FREE';
    }
  }
  
  if (typeof updateDashboard === 'function') {
    updateDashboard();
  }
}

function showPlanUpgradeNotification(plan) {
  const planName = plan === 'pro' ? 'Pro' : 'Lite';
  const toast = document.createElement('div');
  toast.style.cssText = `
    position:fixed;
    bottom:calc(var(--bottom-nav-h) + 20px);
    left:50%;
    transform:translateX(-50%);
    background:var(--gold);
    color:#1a0a0a;
    padding:16px 24px;
    border-radius:12px;
    font-weight:700;
    font-size:0.9rem;
    z-index:9999;
    box-shadow:0 8px 32px rgba(201,169,110,0.5);
    animation:slideUp 0.3s ease;
  `;
  toast.innerHTML = `üéâ ${planName}„Éó„É©„É≥„ÅåÊúâÂäπÂåñ„Åï„Çå„Åæ„Åó„ÅüÔºÅ`;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(-50%) translateY(10px)';
    setTimeout(() => toast.remove(), 300);
  }, 4000);
}
function isLight(){ return _plan === 'light' || _plan === 'premium'; }

// --- „Éà„É©„Ç§„Ç¢„É´ÊÆã„ÇäÊó•Êï∞ ---
function trialDaysLeft(){
  if(!_trialStart) return 14;
  const d = 14 - (Date.now() - _trialStart.getTime()) / (1000*60*60*24);
  return Math.max(0, Math.ceil(d));
}

// --- „Éó„É©„É≥ÈÅ∏Êäû„Åó„Å¶ÈñãÂßã ---
function startPlan(plan){
  // V25: StripeÊ±∫Ê∏à„Å´Êé•Á∂ö
  if (plan === 'light' || plan === 'lite') {
    openStripeCheckout('lite');
  } else if (plan === 'premium' || plan === 'pro') {
    openStripeCheckout('pro');
  }
  closeProModal();
}

function handleProCTA(){
  openProModal('upgrade');
}

// --- UIÊõ¥Êñ∞ ---
function updateAuthUI(){
  const badge = document.getElementById('topbar-plan-badge');
  const avatar = document.getElementById('topbar-avatar');
  const guestBanner = document.getElementById('dash-guest-banner');
  const upgradeBanner = document.getElementById('dash-upgrade-banner');

  // topbar: „Éê„ÉÉ„Ç∏
  if(badge){
    if(_plan === 'premium'){
      badge.innerHTML = '<span class="pro-badge">‚ú¶ PREMIUM</span>';
    } else if(_plan === 'light'){
      badge.innerHTML = '<span class="pro-badge" style="background:linear-gradient(135deg,var(--accent),var(--accent2))">‚ú¶ LIGHT</span>';
    } else if(_authUser){
      // „Éà„É©„Ç§„Ç¢„É´‰∏≠„ÅÆË°®Á§∫
      if(_trialStart){
        const days = trialDaysLeft();
        badge.innerHTML = `<span class="free-badge" style="color:var(--gold);border-color:var(--gold-border)">Ë©¶Áî® ÊÆã${days}Êó•</span>`;
      } else {
        badge.innerHTML = '<span class="free-badge">FREE</span>';
      }
    } else {
      badge.innerHTML = '<span class="free-badge" style="opacity:0.6">GUEST</span>';
    }
  }

  // topbar: „Ç¢„Éê„Çø„Éº
  if(avatar){
    if(_authUser?.photo){
      avatar.style.backgroundImage = `url(${_authUser.photo})`;
      avatar.style.backgroundSize = 'cover';
      avatar.textContent = '';
    } else if(_authUser) {
      avatar.textContent = (_authUser.name||'U')[0].toUpperCase();
    } else {
      avatar.textContent = '‚ú¶';
    }
  }

  // „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ
  if(guestBanner) guestBanner.style.display = (!_authUser) ? 'flex' : 'none';
  if(upgradeBanner) upgradeBanner.style.display = (_authUser && !_isPro) ? 'flex' : 'none';

  // „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„ÅÆ„Éê„Éä„Éº
  const loggedInBanner = document.getElementById('logged-in-banner');
  const loggedInName = document.getElementById('logged-in-name');
  if(loggedInBanner){
    if(_authUser){
      loggedInBanner.style.display = 'block';
      if(loggedInName) loggedInName.textContent = _authUser.name || _authUser.email || '';
    } else {
      loggedInBanner.style.display = 'none';
    }
  }

  // AIÂà∂Èôê„Éê„Éº„ÇíÊõ¥Êñ∞
  updateAILimitBar();
}

// --- AI‰ΩøÁî®ÂõûÊï∞„Ç´„Ç¶„É≥„Éà ---
function canUseAICheck(){
  if(isPremium()) return true;
  if(isLight()) return _aiCheckCount < AI_LIGHT_LIMIT;
  return _aiCheckCount < AI_FREE_LIMIT;
}

function incrementAICheck(){
  if(_isPro) return;
  _aiCheckCount++;
  try {
    localStorage.setItem(AI_CHECK_COUNT_KEY, String(_aiCheckCount));
    localStorage.setItem(AI_CHECK_DATE_KEY, new Date().toDateString());
  } catch(e){}
  updateAILimitBar();
}

function updateAILimitBar(){
  // daily-editor-feedback„ÅÆÂâç„Åã„ÄÅAIÊ∑ªÂâä„Ç®„É™„Ç¢„ÅÆ‰∏äÈÉ®„Å´Ë°®Á§∫
  const bars = document.querySelectorAll('.ai-limit-bar');
  bars.forEach(bar=>{
    const limit = getPlanLimit();
    const remaining = isPremium() ? Infinity : Math.max(0, limit - _aiCheckCount);
    const pct = isPremium() ? 100 : (remaining / limit * 100);
    const cls = isPremium() ? 'ok' : (remaining <= 1 ? 'full' : remaining <= 2 ? 'warn' : 'ok');
    const countLabel = isPremium() ? '‚àû' : (remaining + '/' + limit);
    bar.innerHTML = `<span class="ai-limit-label">${t('ai_limit_label')}</span>
      <div class="ai-limit-track"><div class="ai-limit-fill ${cls}" style="width:${Math.min(100,pct)}%"></div></div>
      <span class="ai-limit-count">${countLabel}</span>
      ${!isPremium()?`<button class="btn btn-sm" style="padding:2px 8px;font-size:0.62rem;color:var(--gold);border-color:var(--gold-border);background:var(--gold-dim)" onclick="openProModal('ai')">${t('ai_limit_upgrade')}</button>`:''}`;
  });
}

// --- AIÊ∑ªÂâä„ÇíÂà∂Èôê‰ªò„Åç„ÅßÂÆüË°å ---
function guardedAICheck(fn){
  if(canUseAICheck()){
    incrementAICheck();
    fn();
  } else {
    showAILimitReached();
  }
}

function showAILimitReached(){
  const targets = [
    document.getElementById('daily-editor-feedback'),
    document.getElementById('daily-feedback')
  ];
  const html = `<div class="ai-box" style="border-color:var(--gold-border);background:var(--gold-dim)">
    <div class="ai-label" style="color:var(--gold)">‚ö† ${t('ai_limit_reached')}</div>
    <div class="ai-content" style="font-size:0.8rem">${t('ai_limit_prompt')}</div>
    <div style="margin-top:8px"><button class="btn btn-sm btn-gold" onclick="openProModal('ai_limit')">${t('pro_cta')}</button></div>
  </div>`;
  targets.forEach(el=>{ if(el) el.innerHTML = html; });
}

// --- Pro„É¢„Éº„ÉÄ„É´ ---
function openProModal(from=''){
  // Êó¢Â≠ò„ÅÆ„É¢„Éº„ÉÄ„É´„Åå„ÅÇ„Çå„Å∞ÂâäÈô§„Åó„Å¶ÂÜçÁîüÊàê
  const existing = document.getElementById('pro-modal');
  if(existing) existing.remove();

  const isAILimit = from === 'ai_limit';
  const modal = document.createElement('div');
  modal.id = 'pro-modal';
  modal.className = 'editor-overlay open';
  modal.style.cssText = 'z-index:500;align-items:center;justify-content:center;padding:20px';
  modal.innerHTML = `
  <div style="background:var(--surface);border:1px solid var(--border-bright);border-radius:20px;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;padding:32px 28px;box-shadow:0 0 60px rgba(140,126,255,0.2);animation:fadeUp 0.3s ease both">
    <div style="text-align:center;margin-bottom:28px">
      <div style="font-size:2rem;margin-bottom:10px">‚ú¶</div>
      <h2 style="font-family:'Cinzel',serif;font-size:1.4rem;font-weight:700;background:linear-gradient(135deg,#e8e4f0,#8c7eff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:8px">
        ${isAILimit ? t('ai_limit_reached') : t('modal_plan_select')}
      </h2>
      <p style="font-size:0.83rem;color:var(--text-secondary)">
        ${isAILimit ? t('ai_limit_prompt') : t('upgrade_sub')}
      </p>
    </div>

    <!-- ÁÑ°Êñô„Éó„É©„É≥ -->
    <div style="border:1px solid var(--border);border-radius:14px;padding:18px;margin-bottom:12px;background:var(--surface-2)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div>
          <div style="font-size:0.95rem;font-weight:700;color:var(--text-primary)">ÁÑ°Êñô„Éó„É©„É≥</div>
          <div style="font-size:0.75rem;color:var(--text-muted);margin-top:2px">„Åö„Å£„Å®ÁÑ°Êñô</div>
        </div>
        <div style="font-family:'Cinzel',serif;font-size:1.3rem;font-weight:700;color:var(--text-secondary)">$0</div>
      </div>
      <div style="font-size:0.76rem;color:var(--text-secondary);display:flex;flex-direction:column;gap:5px">
        <div>‚úì Âü∫Êú¨Ê©üËÉΩ„Åô„Åπ„Å¶</div>
        <div>‚úì „ÇØ„É©„Ç¶„Éâ‰øùÂ≠òÔºà„É≠„Ç∞„Ç§„É≥ÂøÖÈ†àÔºâ</div>
        <div>‚úì AIÊ©üËÉΩ 1Êó•${AI_FREE_LIMIT}Âõû„Åæ„Åß</div>
        <div style="color:var(--text-muted)">‚úó ÂçòË™ûÊ©üËÉΩÂº∑Âåñ„Å™„Åó</div>
      </div>
    </div>

    <!-- „É©„Ç§„Éà„Éó„É©„É≥ -->
    <div style="border:1px solid var(--accent-border);border-radius:14px;padding:18px;margin-bottom:12px;background:var(--accent-dim);position:relative">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div>
          <div style="font-size:0.95rem;font-weight:700;color:var(--accent)">Lite„Éó„É©„É≥</div>
          <div style="font-size:0.75rem;color:var(--text-muted);margin-top:2px">ÊúàÈ°çË™≤Èáë</div>
        </div>
        <div style="text-align:right">
          <div style="font-family:'Cinzel',serif;font-size:1.3rem;font-weight:700;color:var(--accent)">$9.9</div>
          <div style="font-size:0.65rem;color:var(--text-muted)">/Êúà</div>
        </div>
      </div>
      <div style="font-size:0.76rem;color:var(--text-secondary);display:flex;flex-direction:column;gap:5px;margin-bottom:14px">
        <div>‚úì Âü∫Êú¨Ê©üËÉΩ„Åô„Åπ„Å¶</div>
        <div>‚úì „ÇØ„É©„Ç¶„Éâ‰øùÂ≠ò„ÉªÂêåÊúü</div>
        <div>‚úì AIÊ©üËÉΩ 1Êó•50Âõû„Åæ„Åß</div>
        <div>‚úì ÂçòË™ûÊ©üËÉΩÂº∑Âåñ</div>
      </div>
      <button onclick="startPlan('lite')" style="width:100%;padding:11px;border-radius:10px;border:none;background:var(--accent);color:#fff;font-family:inherit;font-size:0.88rem;font-weight:700;cursor:pointer;transition:filter 0.15s" onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter=''">
        Lite„Éó„É©„É≥„ÅßÂßã„ÇÅ„Çã
      </button>
    </div>

    <!-- Pro„Éó„É©„É≥ -->
    <div style="border:2px solid var(--gold-border);border-radius:14px;padding:18px;margin-bottom:20px;background:var(--gold-dim);position:relative">
      <div style="position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,var(--gold),#d4a76a);color:#1a0a0a;font-size:0.65rem;font-weight:700;padding:2px 12px;border-radius:20px;white-space:nowrap">„Åä„Åô„Åô„ÇÅ ‚ú¶</div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div>
          <div style="font-size:0.95rem;font-weight:700;color:var(--gold)">Pro„Éó„É©„É≥</div>
          <div style="font-size:0.75rem;color:var(--text-muted);margin-top:2px">ÊúàÈ°çË™≤Èáë</div>
        </div>
        <div style="text-align:right">
          <div style="font-family:'Cinzel',serif;font-size:1.3rem;font-weight:700;color:var(--gold)">$19.9</div>
          <div style="font-size:0.65rem;color:var(--text-muted)">/Êúà</div>
        </div>
      </div>
      <div style="font-size:0.76rem;color:var(--text-secondary);display:flex;flex-direction:column;gap:5px;margin-bottom:14px">
        <div>‚úì Lite„ÅÆÂÖ®Ê©üËÉΩ</div>
        <div>‚úì <strong style="color:var(--gold)">AIÊ©üËÉΩ 1Êó•100Âõû</strong></div>
        <div>‚úì <strong style="color:var(--gold)">ÂçòË™ûÊ©üËÉΩ ÂÆåÂÖ®Ëß£Êîæ</strong></div>
        <div>‚úì „Ç≥„Éü„É•„Éã„ÉÜ„Ç£ÂÖ¨Èñã„ÉªÂÖ±Êúâ</div>
        <div>‚úì ÂÑ™ÂÖà„Çµ„Éù„Éº„Éà</div>
      </div>
      <button onclick="startPlan('pro')" style="width:100%;padding:11px;border-radius:10px;border:none;background:linear-gradient(135deg,var(--gold),#d4a76a);color:#1a0a0a;font-family:inherit;font-size:0.88rem;font-weight:700;cursor:pointer;transition:filter 0.15s" onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter=''">
        Pro„Éó„É©„É≥„ÅßÂßã„ÇÅ„Çã ‚ú¶
      </button>
    </div>

    <p style="font-size:0.7rem;color:var(--text-muted);text-align:center;line-height:1.6">
      Stripe„ÅÆÂÆâÂÖ®„Å™Ê±∫Ê∏àÁîªÈù¢„Å´ÁßªÂãï„Åó„Åæ„Åô„ÄÇ<br>„ÅÑ„Å§„Åß„ÇÇ„Ç≠„É£„É≥„Çª„É´ÂèØËÉΩ„Åß„Åô„ÄÇ
    </p>
    <button onclick="closeProModal()" style="display:block;width:100%;margin-top:16px;padding:9px;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text-muted);font-family:inherit;font-size:0.82rem;cursor:pointer">
      ‰ªä„ÅØ„Åó„Å™„ÅÑ
    </button>
  </div>`;

  document.body.appendChild(modal);
  document.body.style.overflow = 'hidden';
  modal.addEventListener('click', (e) => { if(e.target === modal) closeProModal(); });
}

function closeProModal(){
  const modal = document.getElementById('pro-modal');
  if(modal){ modal.remove(); document.body.style.overflow=''; }
}

// --- Firestore „Éá„Éº„ÇøÂêåÊúü ---
async function loadUserDataFromFirestore(uid){
  if(!window.firebaseDb || !window.firestoreDoc || !window.firestoreGetDoc) {
    console.warn('‚ö†Ô∏è Firestore SDK not loaded');
    return;
  }
  
  try {
    const docRef = window.firestoreDoc(window.firebaseDb, 'users', uid);
    const docSnap = await window.firestoreGetDoc(docRef);
    
    if(docSnap.exists()){
      const data = docSnap.data();
      
      console.log('üì• Loading data from Firestore...');
      
      // Firestore„ÅÆ„Éá„Éº„Çø„ÅßÁä∂ÊÖã„ÇíÊõ¥Êñ∞
      if(data.langData){
        // localStorage„Å®„ÅÆÊØîËºÉÔºà„Çà„ÇäÊñ∞„Åó„ÅÑ„Éá„Éº„Çø„ÇíÂÑ™ÂÖàÔºâ
        const localRaw = localStorage.getItem(SAVE_KEY);
        let shouldOverwrite = true;
        
        if(localRaw && data.lastUpdated) {
          try {
            const localData = JSON.parse(localRaw);
            const localDate = localStorage.getItem('lingua_last_modified');
            
            // „É≠„Éº„Ç´„É´„ÅÆÊñπ„ÅåÊñ∞„Åó„ÅÑÂ†¥Âêà„ÅØË≠¶Âëä
            if(localDate && new Date(localDate) > new Date(data.lastUpdated)) {
              console.warn('‚ö†Ô∏è Local data is newer than cloud data');
              const confirmed = confirm(
                '„É≠„Éº„Ç´„É´„ÅÆ„Éá„Éº„Çø„Åå„ÇØ„É©„Ç¶„Éâ„Çà„ÇäÊñ∞„Åó„ÅÑ„Åß„Åô„ÄÇ„ÇØ„É©„Ç¶„Éâ„ÅÆ„Éá„Éº„Çø„Åß‰∏äÊõ∏„Åç„Åó„Åæ„Åô„Åã?\n\n' +
                '„ÄåOK„Äç‚Üí „ÇØ„É©„Ç¶„Éâ„Åã„ÇâË™≠„ÅøËæº„ÇÄ\n' +
                '„Äå„Ç≠„É£„É≥„Çª„É´„Äç‚Üí „É≠„Éº„Ç´„É´„Éá„Éº„Çø„Çí‰øùÊåÅ'
              );
              shouldOverwrite = confirmed;
            }
          } catch(e) {
            console.error('Error comparing data:', e);
          }
        }
        
        if(shouldOverwrite) {
          Object.keys(data.langData).forEach(k => { 
            if(k in S) S[k] = data.langData[k]; 
          });
          saveState(); // localStorage„Å´„ÇÇ‰øùÂ≠ò
          updateDashboard();
          showAutosave('‚òÅÔ∏è „ÇØ„É©„Ç¶„Éâ„Åã„Çâ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü');
          console.log('‚úÖ Data loaded from Firestore');
        } else {
          showAutosave('‚ÑπÔ∏è „É≠„Éº„Ç´„É´„Éá„Éº„Çø„Çí‰øùÊåÅ„Åó„Åæ„Åó„Åü');
        }
      }
      
      // ProÁä∂ÊÖã
      if(data.plan){ _plan = data.plan; }
      if(data.trialStart){ _trialStart = new Date(data.trialStart); }
      if(data.isPro || data.plan === 'light' || data.plan === 'premium'){
        _isPro = true;
        try { localStorage.setItem(PRO_KEY, '1'); } catch(e){}
      }
      
      updateAuthUI();
    } else {
      console.log('‚ÑπÔ∏è No cloud data found (first login)');
      
      // ÂàùÂõû„É≠„Ç∞„Ç§„É≥ÊôÇ„ÅØlocalStorage„ÅÆ„Éá„Éº„Çø„Çí„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò
      if(_authUser?.uid && _isPro) {
        console.log('üì§ Uploading local data to cloud...');
        saveUserDataToFirestore(_authUser.uid);
      }
    }
  } catch(error){
    console.error('‚ùå Firestore load error:', error);
    
    if(error.code === 'permission-denied') {
      showAutosave('‚ö†Ô∏è „ÇØ„É©„Ç¶„Éâ„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„ÅøÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
    } else if(error.code === 'unavailable') {
      showAutosave('‚ö†Ô∏è „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„ÉºÔºà„Ç™„Éï„É©„Ç§„É≥„ÅßÁ∂ôÁ∂öÔºâ');
    } else {
      showAutosave('‚ö†Ô∏è „ÇØ„É©„Ç¶„Éâ„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    }
  }
}

async function saveUserDataToFirestore(uid){
  if(!window.firebaseDb || !window.firestoreDoc || !window.firestoreSetDoc) {
    console.warn('‚ö†Ô∏è Firestore SDK not loaded');
    return;
  }
  if(!uid) {
    console.warn('‚ö†Ô∏è No UID provided');
    return;
  }
  
  // üîí Pro „ÉÅ„Çß„ÉÉ„ÇØ
  if(!_isPro) {
    console.log('‚ÑπÔ∏è Skipping cloud save (Free user)');
    return;
  }
  
  try {
    const docRef = window.firestoreDoc(window.firebaseDb, 'users', uid);
    
    // ‰øùÂ≠ò„Åô„Çã„Éá„Éº„Çø„ÇíÊ∫ñÂÇô
    const saveData = {
      plan: _plan,
      trialStart: _trialStart ? _trialStart.toISOString() : null,
      langData: S,
      isPro: _isPro,
      lastUpdated: new Date().toISOString(),
      version: 'v21',
      deviceInfo: {
        userAgent: navigator.userAgent.substring(0, 100),
        timestamp: Date.now()
      }
    };
    
    await window.firestoreSetDoc(docRef, saveData, { merge: true });
    
    showAutosave('‚òÅÔ∏è „ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
    console.log('‚úÖ Firestore save success');
  } catch(error) {
    console.error('‚ùå Firestore save error:', error);
    
    // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË©≥Á¥∞Âåñ
    if(error.code === 'permission-denied') {
      showAutosave('‚ö†Ô∏è „ÇØ„É©„Ç¶„Éâ‰øùÂ≠ò„ÅÆÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
    } else if(error.code === 'unavailable') {
      showAutosave('‚ö†Ô∏è „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„ÉºÔºàÂæå„ÅßÂÜçË©¶Ë°å„Åó„Åæ„ÅôÔºâ');
    } else {
      showAutosave('‚ö†Ô∏è „ÇØ„É©„Ç¶„Éâ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    }
  }
}

// Ëá™Âãï‰øùÂ≠òÊôÇ„Å´Firestore„Å´„ÇÇ‰øùÂ≠ò
let _firestoreSaveTimer = null;
function scheduleFirestoreSave(){
  // üîí Pro „É¶„Éº„Ç∂„Éº„ÉÅ„Çß„ÉÉ„ÇØ
  if(!_authUser?.uid || !_isPro) {
    console.log('‚ÑπÔ∏è Skipping cloud save (not Pro or not logged in)');
    return;
  }
  
  clearTimeout(_firestoreSaveTimer);
  _firestoreSaveTimer = setTimeout(() => {
    // ÊúÄÁµÇÊõ¥Êñ∞Êó•ÊôÇ„ÇíË®òÈå≤
    try {
      localStorage.setItem('lingua_last_modified', new Date().toISOString());
    } catch(e) {}
    
    saveUserDataToFirestore(_authUser.uid);
  }, 3000); // 3ÁßíÂæå„Å´„ÇØ„É©„Ç¶„Éâ‰øùÂ≠ò
}

// ===== END V16 AUTH & PRO =====

function applyI18n(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key=el.getAttribute('data-i18n');
    const tx=t(key);
    if(tx) el.textContent=tx;
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
    const key=el.getAttribute('data-i18n-placeholder');
    const tx=t(key);
    if(tx) el.placeholder=tx;
  });
  document.querySelectorAll('[data-i18n-title]').forEach(el=>{
    const key=el.getAttribute('data-i18n-title');
    const tx=t(key);
    if(tx) el.title=tx;
  });
  // Update autosave text if showing default
  const autosaveEl=document.getElementById('autosave-text');
  if(autosaveEl&&!autosaveEl.textContent.includes('üíæ')&&!autosaveEl.textContent.includes('‚ö†')&&!autosaveEl.textContent.includes('‚ùå')){
    autosaveEl.textContent=t('autosave_saved');
  }
}

// ===== V13: 4-language switcher =====
const LANG_SHORT = {ja:'JA',en:'EN',zh:'‰∏≠Êñá',es:'ES'};
function toggleLangMenu(e){
  e && e.stopPropagation();
  const m=document.getElementById('lang-menu');
  if(!m)return;
  const open = m.style.display==='block';
  m.style.display = open?'none':'block';
  // highlight active
  m.querySelectorAll('.lang-menu-btn').forEach(b=>{
    b.classList.toggle('active', b.textContent.includes(LANG_SHORT[S.lang]||S.lang));
  });
}
document.addEventListener('click',function(e){
  if(!e.target.closest('#lang-menu-wrap')){
    const m=document.getElementById('lang-menu');
    if(m)m.style.display='none';
  }
},{passive:true});

function setLang(lang){
  S.lang=lang;
  const cur=document.getElementById('lang-cur');
  if(cur)cur.textContent=LANG_SHORT[lang]||lang.toUpperCase();
  const menu=document.getElementById('lang-menu');
  if(menu)menu.style.display='none';
  applyI18n();
  
  // 1Êó•1Êñá„ÇíÊõ¥Êñ∞
  if(typeof window.updateDailySentence==='function'){
    window.updateDailySentence();
  }
  
  // Rebuild editor body if open (currentEditor is a module-scope let, not window prop)
  if(document.getElementById('editor-overlay')?.classList.contains('open') && currentEditor){
    const body=document.getElementById('editor-body');
    if(body){body.innerHTML=buildBody(currentEditor);setTimeout(()=>initAutoResize(),50);}
    // Update editor title too
    const titles=getEditorTitles()[currentEditor];
    if(titles){
      const titleEl=document.getElementById('editor-title');
      const descEl=document.getElementById('editor-desc');
      if(titleEl)titleEl.textContent=titles[0];
      if(descEl)descEl.textContent=titles[1];
    }
  }
  // Rebuild dashboard i18n labels
  applyDashboardI18n();
  // Reinit daily date locale
  if(document.getElementById('daily-date'))initDaily();
  scheduleSave();
}

// Update all hardcoded Japanese strings in the dashboard
function applyDashboardI18n(){
  const L=S.lang||'ja';
  // meta chips
  const scriptLabelMap={ja:'ÊñáÂ≠ó',en:'Script',zh:'‰π¶ÂÜô',es:'Escritura'};
  const routeLabelMap={
    ja:{image:'‚ú¶ „Ç§„É°„Éº„Ç∏„É´„Éº„Éà',custom:'‚äû Ëá™‰Ωú„É´„Éº„Éà'},
    en:{image:'‚ú¶ Image route',custom:'‚äû Custom route'},
    zh:{image:'‚ú¶ ÂõæÂÉèË∑ØÁ∫ø',custom:'‚äû Ëá™ÂÆöË∑ØÁ∫ø'},
    es:{image:'‚ú¶ Ruta imagen',custom:'‚äû Ruta propia'},
  };
  const metaScript=document.getElementById('meta-script');
  if(metaScript)metaScript.textContent=(scriptLabelMap[L]||'ÊñáÂ≠ó')+': '+(scriptLabels[S.script]||S.script||'‚Äî');
  const metaRoute=document.getElementById('meta-route');
  if(metaRoute){
    const rm=routeLabelMap[L]||routeLabelMap.ja;
    metaRoute.textContent=S.route==='image'?rm.image:rm.custom;
  }
  // vis chip
  const visChip=document.getElementById('dash-vis-chip');
  if(visChip){
    const icons={private:'üîí',unlisted:'üîó',public:'üåø'};
    const labels={
      ja:{private:'ÈùûÂÖ¨Èñã',unlisted:'ÈôêÂÆöÂÖ¨Èñã',public:'ÂÖ¨Èñã‰∏≠'},
      en:{private:'Private',unlisted:'Unlisted',public:'Public'},
      zh:{private:'ÁßÅÂØÜ',unlisted:'‰∏çÂÖ¨ÂºÄ',public:'ÂÖ¨ÂºÄ‰∏≠'},
      es:{private:'Privado',unlisted:'No listado',public:'P√∫blico'},
    };
    const lb=labels[L]||labels.ja;
    visChip.textContent=(icons[S.visibility]||'üîí')+' '+(lb[S.visibility]||lb.private);
  }
  // grammar preview chip suffix "„Éë„Çø„Éº„É≥"
  const patternSuffix={ja:'„Éë„Çø„Éº„É≥',en:'patterns',zh:'ËßÑÂæã',es:'patrones'};
  // rebuild grammar preview if visible
  updateDashboard();
}
// Keep old toggleLang for backwards compat
function toggleLang(){toggleLangMenu();}

function openVisPopup(){
  document.getElementById('vis-popup').style.display='flex';
  document.body.style.overflow='hidden';
  // sync selection
  ['private','unlisted','public'].forEach(v=>{
    const el=document.getElementById('vopt-'+v);
    if(el)el.classList.toggle('selected',S.visibility===v);
  });
  const cb=document.getElementById('vis-importable');
  if(cb)cb.checked=S.importable;
}
function closeVisPopup(){
  document.getElementById('vis-popup').style.display='none';
  document.body.style.overflow='';
}
function setVisibility(val){
  S.visibility=val;
  S.importable=document.getElementById('vis-importable')?.checked||false;
  ['private','unlisted','public'].forEach(v=>{
    const el=document.getElementById('vopt-'+v);
    if(el)el.classList.toggle('selected',val===v);
  });
  updateVisIndicator();
  scheduleSave();
}
function updateVisIndicator(){
  const dot=document.getElementById('vis-dot');
  const lbl=document.getElementById('vis-label');
  const colors={private:'var(--text-muted)',unlisted:'var(--gold)',public:'var(--success)'};
  const labels={private:t('vis_private'),unlisted:t('vis_unlisted'),public:t('vis_public')};
  if(dot)dot.style.background=colors[S.visibility]||colors.private;
  if(lbl)lbl.textContent=labels[S.visibility]||labels.private;
}

// ===== CONTACT FORM =====
function openContactForm(){
  // Now using page instead of popup
  goTo('contact');
  setNav('');
  setBNav('bnav-contact');
  // Pre-fill email if logged in
  const emailField = document.getElementById('contact-email');
  if(emailField && _authUser?.email) emailField.value = _authUser.email;
}
function closeContactForm(){
  // No longer needed with page-based approach, but kept for compatibility
  goTo('dashboard');
  setBNav('bnav-dash');
}
async function submitContactForm(){
  const category=document.getElementById('contact-category').value;
  const email=document.getElementById('contact-email').value;
  const message=document.getElementById('contact-message').value.trim();
  
  if(!message){
    alert('„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }
  
  const data={
    category,email:email||'anonymous',message,
    userId:_authUser?.uid||'guest',userName:_authUser?.name||'Guest',
    timestamp:new Date().toISOString(),userAgent:navigator.userAgent,language:S.lang||'ja'
  };
  
  try{
    if(window.firebaseDb && window.firestoreCollection && window.firestoreAddDoc){
      const colRef=window.firestoreCollection(window.firebaseDb,'contact_submissions');
      await window.firestoreAddDoc(colRef,data);
      alert(S.lang === 'en' ? 'Thank you for your message!' : '„ÅäÂïè„ÅÑÂêà„Çè„Åõ„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô!');
      // Clear form
      document.getElementById('contact-message').value='';
      if(email) document.getElementById('contact-email').value='';
      setTimeout(() => {
        goTo('dashboard');
        setBNav('bnav-dash');
      }, 500);
    }else{
      console.log('üìÆ Contact Form:',data);
      alert(S.lang === 'en' ? 'Thank you for your message!' : '„ÅäÂïè„ÅÑÂêà„Çè„Åõ„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô!');
      document.getElementById('contact-message').value='';
      if(email) document.getElementById('contact-email').value='';
      setTimeout(() => {
        goTo('dashboard');
        setBNav('bnav-dash');
      }, 500);
    }
  }catch(error){
    console.error('Contact form error:',error);
    alert(S.lang === 'en' ? 'Failed to send. Please try again.' : 'ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
  }
}

// ===== V9: EXPORT/IMPORT JSON =====
function exportJSON(){
  const data={
    langName:S.langName, script:S.script, route:S.route,
    vibe:S.vibe, vibeText:S.vibeText,
    scriptMap:S.scriptMap, phoneme:S.phoneme, grammar:S.grammar,
    dictionary:S.dictionary, corpus:S.corpus, sentences:S.sentences,
    grammarNotes:S.grammarNotes, pinnedIPA:S.pinnedIPA, syllableSlots:S.syllableSlots,
    visibility:S.visibility, importable:S.importable,
    exportedAt:new Date().toISOString(), version:'v9'
  };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=`${S.langName}_lingua_v9.json`;a.click();
  URL.revokeObjectURL(url);
}
function openImportJSON(){
  document.getElementById('import-popup').style.display='flex';
  document.body.style.overflow='hidden';
}
function closeImportPopup(){
  document.getElementById('import-popup').style.display='none';
  document.body.style.overflow='';
}
function doImportJSON(){
  const raw=document.getElementById('import-json-area')?.value.trim();
  if(!raw)return;
  try{
    const data=JSON.parse(raw);
    if(!data.langName&&!data.dictionary)throw new Error('Invalid format');
    // Merge into S
    if(data.langName)S.langName=data.langName;
    if(data.script)S.script=data.script;
    if(data.route)S.route=data.route;
    if(data.vibe)S.vibe=data.vibe;
    if(data.scriptMap)S.scriptMap=data.scriptMap;
    if(data.phoneme)S.phoneme=data.phoneme;
    if(data.grammar)S.grammar=data.grammar;
    if(data.dictionary)S.dictionary=data.dictionary;
    if(data.corpus)S.corpus=data.corpus;
    if(data.sentences)S.sentences=data.sentences;
    if(data.grammarNotes)S.grammarNotes=data.grammarNotes;
    if(data.pinnedIPA)S.pinnedIPA=data.pinnedIPA;
    if(data.syllableSlots)S.syllableSlots=data.syllableSlots;
    scheduleSave();
    updateDashboard();
    closeImportPopup();
    alert(`‚úÖ „Äå${S.langName}„Äç„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„ÅüÔºÅ`);
  }catch(e){
    alert('‚ùå JSON„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì: '+e.message);
  }
}

// ===== V9: LIBRARY =====
// Simulated community library ‚Äî just for browsing
const COMMUNITY_LIBRARY = [
  {
    id:'lib_001', langName:'„Ç¢„Ç®„É≠„É≥Ë™û', author:'Ë™û„ÇäÈÉ®K',
    words:42, corpus:8, vibe:['„Ç®„É´„Éï„ÉªËá™ÁÑ∂'],
    desc:'Ëá™ÁÑ∂„Å®Á≤æÈúä„Çí„ÉÜ„Éº„Éû„Å´„Åó„ÅüÂÑ™ÈõÖ„Å™Ë®ÄË™û„ÄÇCVÂûã„ÅÆÁæé„Åó„ÅÑÈü≥Èüª„ÅåÁâπÂæ¥„ÄÇÊ£Æ„ÅÆÁ≤æÈúä„Åü„Å°„ÅåË™û„Çä„Åã„Åë„Çã„Çà„ÅÜ„Å™Êüî„Çâ„Åã„Åï„Åå„ÅÇ„Çã„ÄÇ',
    grammar:{order:'VSO', cases:'4Ê†º', verbConj:'‰∫∫Áß∞Â§âÂåñ', tense:['ÁèæÂú®','ÈÅéÂéª']},
    phoneme:{vowels:['a','e','i','√´','o'], consonants:['l','r','n','k','m','s','v','t']},
    sample:[
      {cl:'Lumael kaelo mir√´.', read:'/luÀàmael Ààkaelo Ààmir…ô/', jp:'ÂÖâ„ÅØÁ©∫„ÅÆ„Çà„ÅÜ„Å´Áæé„Åó„ÅÑ'},
      {cl:'Silvara solen imal√´.', read:'/silvara Ààsolen Ààimal…ô/', jp:'ÁßÅ„ÅØÊ∞¥„ÅÆ„Åª„Å®„Çä„ÇíÊ≠©„Åè'},
    ],
    dict:[
      {cl:'silvara', jp:'Ê∞¥', pos:'ÂêçË©û'},{cl:'lumael', jp:'ÂÖâ', pos:'ÂêçË©û'},
      {cl:'kaelo', jp:'Á©∫', pos:'ÂêçË©û'},{cl:'mir√´', jp:'Áæé„Åó„ÅÑ', pos:'ÂΩ¢ÂÆπË©û'},
      {cl:'solen', jp:'Ê≠©„Åè', pos:'ÂãïË©û'},{cl:'imal√´', jp:'ÁßÅ', pos:'‰ª£ÂêçË©û'},
    ],
    color:'#8c7eff',
  },
  {
    id:'lib_002', langName:'„Ç∫„É©„Ç≠Ë™û', author:'ÊöóÈªí„Å¨„ÅÑ',
    words:31, corpus:5, vibe:['„ÉÄ„Éº„ÇØ„ÉªÂ∏ùÂõΩ'],
    desc:'Ëçí„ÄÖ„Åó„ÅÑÂ≠êÈü≥ÈÄ£Á∂ö„ÅåÁâπÂæ¥„ÅÆÂ∏ùÂõΩË™û„ÄÇÊ®©Â®Å„Å®ÊÅêÊÄñ„Çí‰ΩìÁèæ„Åô„Çã„ÄÇCVC„ÉªCCVCÂûã„Åå‰∏ªÊµÅ„ÅßÂäõÂº∑„ÅÑÈüø„Åç„ÇíÊåÅ„Å§„ÄÇ',
    grammar:{order:'SOV', cases:'2Ê†º', verbConj:'„Å™„Åó', tense:['ÁèæÂú®','ÈÅéÂéª']},
    phoneme:{vowels:['a','u','…î'], consonants:['d','r','k','v','z','n','g','x','t','s']},
    sample:[
      {cl:'Drakvul zorn krath.', read:'/drakÀàvul zorn kraŒ∏/', jp:'Êàë„Çâ„ÅØÂΩ±„Åã„ÇâÁèæ„Çå„Çã'},
      {cl:'Gortak ul nevras.', read:'/gorÀàtak ul nevras/', jp:'Â∏ùÂõΩ„ÅØÊ∞∏ÈÅ†„Å´Á∂ö„Åè'},
    ],
    dict:[
      {cl:'drakvul', jp:'ÂΩ±', pos:'ÂêçË©û'},{cl:'zorn', jp:'ÊÄí„Çä', pos:'ÂêçË©û'},
      {cl:'krath', jp:'Áèæ„Çå„Çã', pos:'ÂãïË©û'},{cl:'gortak', jp:'Â∏ùÂõΩ', pos:'ÂêçË©û'},
    ],
    color:'#e87a7a',
  },
  {
    id:'lib_003', langName:'„Éî„Ç¢„Éã„É£Ë™û', author:'„Åç„Çâ„Åç„ÇâÊòü',
    words:28, corpus:12, vibe:['„Åã„Çè„ÅÑ„ÅÑ„ÉªÂ¶ñÁ≤æ'],
    desc:'Â¶ñÁ≤æ„Åü„Å°„Åå‰Ωø„ÅÜÁîò„Åè„Å¶Êüî„Çâ„Åã„ÅÑË®ÄË™û„ÄÇ‰∫åÈü≥ÁØÄË™û„ÅåÂ§ö„ÅèÊ≠å„ÅÑ„ÇÑ„Åô„ÅÑ„ÄÇ/p/„Å®/n/„Å®/m/„Åå‰∏≠ÂøÉ„ÅßÂÑ™„Åó„ÅÑÈüø„Åç„ÄÇ',
    grammar:{order:'SVO', cases:'„Å™„Åó', verbConj:'„Å™„Åó', tense:['ÁèæÂú®']},
    phoneme:{vowels:['a','i','u','e'], consonants:['p','n','m','f','r','y']},
    sample:[
      {cl:'Pia nia furu miru!', read:'/pia nia furu miru/', jp:'Ëä±„Å®ÂÖâ„Åå„ÅÇ„Åµ„Çå„Å¶„ÇãÔºÅ'},
      {cl:'Nami piya ru.', read:'/nami piya ru/', jp:'ÁßÅ„ÅØÈ£õ„Åπ„Çã„Çà'},
    ],
    dict:[
      {cl:'pia', jp:'Ëä±', pos:'ÂêçË©û'},{cl:'nia', jp:'ÂÖâ', pos:'ÂêçË©û'},
      {cl:'furu', jp:'„ÅÇ„Åµ„Çå„Çã', pos:'ÂãïË©û'},{cl:'nami', jp:'ÁßÅ', pos:'‰ª£ÂêçË©û'},
    ],
    color:'#c07bff',
  },
  {
    id:'lib_004', langName:'„Çø„É©„Éª„Éû„Éº„É´Ë™û', author:'Êµ∑„ÅÆÊ∞ëT',
    words:55, corpus:18, vibe:['Êµ∑Ê¥ã„ÉªÁ≤æÈúä'],
    desc:'Êµ∑„Å®È¢®„ÅÆÁ≤æÈúä„ÇíËÆÉ„Åà„ÇãË®ÄË™û„ÄÇÈºªÈü≥„Å®ÊµÅÈü≥„ÅåË±äÂØå„ÅßÊ≥¢„ÅÆ„Çà„ÅÜ„Å™„É™„Ç∫„É†„Åå„ÅÇ„Çã„ÄÇÂêüÈÅäË©©‰∫∫„ÅåÂ•Ω„Çì„Åß‰Ωø„ÅÜ„ÄÇ',
    grammar:{order:'VOS', cases:'3Ê†º', verbConj:'ÊôÇÂà∂Â§âÂåñ', tense:['ÁèæÂú®','ÈÅéÂéª','Êú™Êù•']},
    phoneme:{vowels:['a','o','u','√£','√µ'], consonants:['m','n','l','r','t','k','s','w']},
    sample:[
      {cl:'Maren tol√´ sunavael.', read:'/maÀàren toÀàl…ô sunaÀàvael/', jp:'Êµ∑„ÅØÊ∞∏ÈÅ†„Å´Ê≠å„ÅÑÁ∂ö„Åë„Çã'},
      {cl:'Nolar wansu tol√´.', read:'/noÀàlar wansu toÀàl…ô/', jp:'È¢®„ÅØÊ≥¢„Å´Ë™û„Çä„Åã„Åë„Çã'},
    ],
    dict:[
      {cl:'maren', jp:'Êµ∑', pos:'ÂêçË©û'},{cl:'tol√´', jp:'Ê≠å„ÅÜ', pos:'ÂãïË©û'},
      {cl:'sunavael', jp:'Ê∞∏ÈÅ†', pos:'ÂêçË©û'},{cl:'nolar', jp:'È¢®', pos:'ÂêçË©û'},
    ],
    color:'#4db87a',
  },
  {
    id:'lib_005', langName:'„É¥„Ç©„É´„Çø„ÉÉ„ÇØË™û', author:'Ê©üÊ¢∞‰ªïÊéõ„Åë',
    words:38, corpus:6, vibe:['Ê©üÊ¢∞„ÉªSF'],
    desc:'AIÁµ±Ê≤ªÊôÇ‰ª£„ÅÆÂÖ¨Áî®Ë™û„ÄÇÁ°¨Ë≥™„Å™Â≠êÈü≥„Å®Áü≠„ÅÑÊØçÈü≥„ÅåÁâπÂæ¥„ÄÇÂäπÁéá„ÇíÊúÄÂÑ™ÂÖà„Åó„ÅüÊ•µ„ÇÅ„Å¶Ë´ñÁêÜÁöÑ„Å™ÊñáÊ≥ïÊßãÈÄ†„ÇíÊåÅ„Å§„ÄÇ',
    grammar:{order:'SVO', cases:'„Å™„Åó', verbConj:'„Å™„Åó', tense:['ÁèæÂú®','Êú™Êù•']},
    phoneme:{vowels:['a','i','u','…ô'], consonants:['v','k','t','r','x','z','n','s','p']},
    sample:[
      {cl:'Vortax nexus ziru.', read:'/vortaks neksus ziru/', jp:'„Ç≥„Ç¢„ÅåÊé•Á∂ö„ÇíË®àÁÆó„Åô„Çã'},
      {cl:'Tavar kratok sistax.', read:'/tavar krat…îk sistaks/', jp:'Ââ£„Åå„Ç∑„Çπ„ÉÜ„É†„ÇíÁ†¥Â£ä„Åô„Çã'},
    ],
    dict:[
      {cl:'vortax', jp:'„Ç®„Éç„É´„ÇÆ„Éº„Ç≥„Ç¢', pos:'ÂêçË©û'},{cl:'nexus', jp:'Êé•Á∂öÁÇπ', pos:'ÂêçË©û'},
      {cl:'ziru', jp:'Ë®àÁÆó„Åô„Çã', pos:'ÂãïË©û'},{cl:'kratok', jp:'Á†¥Â£ä„Åô„Çã', pos:'ÂãïË©û'},
    ],
    color:'#c9a96e',
  },
  {
    id:'lib_006', langName:'„Ç∑„É©„Éª„É¥„Ç°„É´„Éá„Ç£Ë™û', author:'Âè§ÊñáÊõ∏È§®',
    words:72, corpus:24, vibe:['Âè§‰ª£„ÉªÁ•ûË©±'],
    desc:'Âè§‰ª£„ÅÆÁ•û„ÄÖ„ÅåÁî®„ÅÑ„Åü„Å®„Åï„Çå„ÇãÊ≠ªË™û„ÄÇË±äÂØå„Å™Ê†ºÂ§âÂåñ„Å®Ë§áÈõë„Å™ÂãïË©ûÊ¥ªÁî®„ÇíÊåÅ„Å°„ÄÅÁ•ûË©±„ÉÜ„Ç≠„Çπ„Éà„ÅÆÁ†îÁ©∂ËÄÖ„Å´‰∫∫Ê∞ó„ÄÇ',
    grammar:{order:'SOV', cases:'6Ê†º+', verbConj:'‰∏°Êñπ„ÅÇ„Çä', tense:['ÁèæÂú®','ÈÅéÂéª','ÂÆå‰∫ÜÂΩ¢']},
    phoneme:{vowels:['a','e','i','o','u','ƒÅ','ƒì','≈ç'], consonants:['s','t','r','n','l','k','h','m','p','b','d','g']},
    sample:[
      {cl:'Arda-el solmen kali-oth.', read:'/arda-el solmen kali-oŒ∏/', jp:'Â§ßÂú∞„ÅØÂ§™ÈôΩ„ÅÆÂ≠ê„Å™„ÇäÔºà‰∏ªÊ†º„ÉªÂ±ûÊ†ºÔºâ'},
      {cl:'Valum sira-el domen.', read:'/valum sira-el domen/', jp:'Á•û„ÄÖ„ÅØÂ§©„ÇíÂâµÈÄ†„Åõ„Çä'},
    ],
    dict:[
      {cl:'arda', jp:'Â§ßÂú∞', pos:'ÂêçË©û'},{cl:'sira', jp:'Á•û', pos:'ÂêçË©û'},
      {cl:'solmen', jp:'Â§™ÈôΩ„ÅÆÂ≠ê', pos:'ÂêçË©û'},{cl:'domen', jp:'ÂâµÈÄ†„Åô„Çã', pos:'ÂãïË©û'},
    ],
    color:'#8c7eff',
  },
];

function renderLibrary(filter=''){
  const grid=document.getElementById('lib-grid');
  if(!grid)return;
  let langs=[...COMMUNITY_LIBRARY];
  if(filter){
    const fl=filter.toLowerCase();
    langs=langs.filter(l=>
      l.langName.includes(filter)||
      l.desc.includes(filter)||
      (l.author||'').includes(filter)||
      (l.vibe||[]).some(v=>v.includes(filter))
    );
  }
  if(!langs.length){
    grid.innerHTML=`<p style="color:var(--text-muted);font-size:0.82rem;font-style:italic;grid-column:1/-1;text-align:center;padding:40px 0">${t('lib_empty')}</p>`;
    return;
  }
  grid.innerHTML=langs.map(l=>langCardHtml(l)).join('');
}

function langCardHtml(l){
  const vibeEmoji={'„Ç®„É´„Éï„ÉªËá™ÁÑ∂':'üåø','„ÉÄ„Éº„ÇØ„ÉªÂ∏ùÂõΩ':'‚öîÔ∏è','„Åã„Çè„ÅÑ„ÅÑ„ÉªÂ¶ñÁ≤æ':'üå∏','Ê©üÊ¢∞„ÉªSF':'‚öôÔ∏è','Êµ∑Ê¥ã„ÉªÁ≤æÈúä':'üåä','Âè§‰ª£„ÉªÁ•ûË©±':'üèîÔ∏è'};
  const emoji=(l.vibe||[]).map(v=>vibeEmoji[v]||'‚ú¶').join('') || '‚ú¶';
  const accent=l.color||'var(--accent)';
  return`<div class="lang-card" onclick="openLangDetail('${l.id}')" style="--card-accent:${accent};cursor:pointer">
    <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,${accent},transparent)"></div>
    <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px">
      <div class="lang-card-name">${l.langName}</div>
      <span style="font-size:1.1rem;line-height:1">${emoji}</span>
    </div>
    <div class="lang-card-meta">
      <span class="lang-card-stat">üìñ ${l.words}Ë™û</span>
      <span class="lang-card-stat">üí¨ ${l.corpus}‰æãÊñá</span>
      <span class="lang-card-stat">${l.grammar?.order||'SOV'}</span>
    </div>
    ${l.sample?.[0]?`<div class="lang-sample" style="border-color:${accent}40;background:${accent}0d">
      <span style="color:${accent}">${l.sample[0].cl}</span>
      <span style="color:var(--text-muted);font-size:0.68rem;display:block;margin-top:2px">${l.sample[0].jp}</span>
    </div>`:''}
    <div class="lang-card-desc">${l.desc}</div>
    ${l.author?`<div class="lang-card-author">${t('lib_author')}: ${l.author} ¬∑ <span style="color:${accent};font-size:0.6rem">${t('lib_see_detail')}</span></div>`:''}
  </div>`;
}

function filterLibrary(){
  const v=document.getElementById('lib-search')?.value||'';
  renderLibrary(v);
}

function openLangDetail(id){
  const l=COMMUNITY_LIBRARY.find(x=>x.id===id);
  if(!l)return;
  const accent=l.color||'var(--accent)';
  const vibeEmoji={'„Ç®„É´„Éï„ÉªËá™ÁÑ∂':'üåø','„ÉÄ„Éº„ÇØ„ÉªÂ∏ùÂõΩ':'‚öîÔ∏è','„Åã„Çè„ÅÑ„ÅÑ„ÉªÂ¶ñÁ≤æ':'üå∏','Ê©üÊ¢∞„ÉªSF':'‚öôÔ∏è','Êµ∑Ê¥ã„ÉªÁ≤æÈúä':'üåä','Âè§‰ª£„ÉªÁ•ûË©±':'üèîÔ∏è'};

  const samplesHtml=(l.sample||[]).map(s=>`
    <div style="border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin-bottom:8px;position:relative;overflow:hidden">
      <div style="position:absolute;left:0;top:0;bottom:0;width:3px;background:${accent}"></div>
      <div style="font-family:'Cinzel',serif;font-size:1rem;color:var(--text-primary);margin-bottom:3px;padding-left:4px">${s.cl}</div>
      ${s.read?`<div style="font-family:monospace;font-size:0.72rem;color:${accent};padding-left:4px">${s.read}</div>`:''}
      <div style="font-size:0.78rem;color:var(--text-secondary);font-style:italic;margin-top:3px;padding-left:4px">${s.jp}</div>
    </div>`).join('');

  const dictHtml=(l.dict||[]).map(w=>`
    <div style="display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid var(--border)">
      <span style="font-family:monospace;color:${accent};font-weight:700;min-width:80px">${w.cl}</span>
      <span style="font-size:0.75rem;color:var(--text-secondary);flex:1">${w.jp}</span>
      <span style="font-size:0.6rem;color:var(--text-muted);background:var(--surface-2);border:1px solid var(--border);border-radius:4px;padding:1px 6px">${w.pos}</span>
    </div>`).join('');

  document.getElementById('lang-detail-body').innerHTML=`
    <div style="border-bottom:1px solid var(--border);padding-bottom:16px;margin-bottom:18px">
      <div style="font-family:'Cinzel',serif;font-size:1.3rem;font-weight:700;letter-spacing:0.04em;color:var(--text-primary);margin-bottom:6px">${l.langName}</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px">
        ${(l.vibe||[]).map(v=>`<span style="font-size:0.65rem;background:${accent}18;color:${accent};border:1px solid ${accent}44;border-radius:20px;padding:2px 9px">${vibeEmoji[v]||'‚ú¶'} ${v}</span>`).join('')}
      </div>
      <p style="font-size:0.82rem;color:var(--text-secondary);line-height:1.7;font-style:italic">${l.desc}</p>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:18px">
      <div style="text-align:center;background:var(--surface-2);border-radius:8px;padding:10px">
        <div style="font-family:'Cinzel',serif;font-size:1.2rem;font-weight:700;color:${accent}">${l.words}</div>
        <div style="font-size:0.62rem;color:var(--text-muted);margin-top:2px;text-transform:uppercase;letter-spacing:0.06em">Ë™ûÂΩôÊï∞</div>
      </div>
      <div style="text-align:center;background:var(--surface-2);border-radius:8px;padding:10px">
        <div style="font-family:'Cinzel',serif;font-size:1.2rem;font-weight:700;color:${accent}">${l.corpus}</div>
        <div style="font-size:0.62rem;color:var(--text-muted);margin-top:2px;text-transform:uppercase;letter-spacing:0.06em">‰æãÊñáÊï∞</div>
      </div>
      <div style="text-align:center;background:var(--surface-2);border-radius:8px;padding:10px">
        <div style="font-family:'Cinzel',serif;font-size:1.2rem;font-weight:700;color:${accent}">${l.grammar?.order||'‚Äî'}</div>
        <div style="font-size:0.62rem;color:var(--text-muted);margin-top:2px;text-transform:uppercase;letter-spacing:0.06em">Ë™ûÈ†Ü</div>
      </div>
    </div>

    <div style="background:var(--surface-2);border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin-bottom:16px">
      <div style="font-size:0.65rem;font-weight:700;color:var(--text-muted);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:8px">ÊñáÊ≥ï</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px">
        <span style="font-size:0.72rem;color:var(--text-secondary)">Ê†º: <strong style="color:var(--text-primary)">${l.grammar?.cases||'‚Äî'}</strong></span>
        <span style="color:var(--border);font-size:0.6rem">|</span>
        <span style="font-size:0.72rem;color:var(--text-secondary)">ÂãïË©û: <strong style="color:var(--text-primary)">${l.grammar?.verbConj||'‚Äî'}</strong></span>
        <span style="color:var(--border);font-size:0.6rem">|</span>
        <span style="font-size:0.72rem;color:var(--text-secondary)">ÊôÇÂà∂: <strong style="color:var(--text-primary)">${(l.grammar?.tense||[]).join('„Éª')}</strong></span>
      </div>
    </div>

    ${l.phoneme?.vowels?.length?`
    <div style="background:var(--surface-2);border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin-bottom:16px">
      <div style="font-size:0.65rem;font-weight:700;color:var(--text-muted);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:8px">Èü≥Èüª</div>
      <div style="margin-bottom:5px">
        <span style="font-size:0.68rem;color:var(--text-muted)">ÊØçÈü≥: </span>
        ${(l.phoneme.vowels||[]).map(v=>`<span style="font-family:monospace;font-size:0.8rem;color:${accent};margin-right:4px">${v}</span>`).join('')}
      </div>
      <div>
        <span style="font-size:0.68rem;color:var(--text-muted)">Â≠êÈü≥: </span>
        ${(l.phoneme.consonants||[]).map(c=>`<span style="font-family:monospace;font-size:0.8rem;color:var(--accent2);margin-right:4px">${c}</span>`).join('')}
      </div>
    </div>`:''
    }

    ${samplesHtml?`<div style="font-size:0.65rem;font-weight:700;color:var(--text-muted);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:8px">‰æãÊñá</div>${samplesHtml}`:''}

    ${dictHtml?`
    <div style="font-size:0.65rem;font-weight:700;color:var(--text-muted);letter-spacing:0.1em;text-transform:uppercase;margin:16px 0 8px">Ë™ûÂΩô„Çµ„É≥„Éó„É´</div>
    <div>${dictHtml}</div>`:''
    }

    ${l.author?`<div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border);font-size:0.72rem;color:var(--text-muted)">${t('lib_author')}: ${l.author}</div>`:''}
  `;

  document.getElementById('lang-detail-modal').style.display='flex';
  document.body.style.overflow='hidden';
}

function closeLangDetail(){
  document.getElementById('lang-detail-modal').style.display='none';
  document.body.style.overflow='';
}

// ===== V9: AI CHAT =====
let chatHistory=[];
let _pendingNewWords=[];

// ===== V10: ENHANCED AI CONTEXT =====
function buildSystemPrompt(){
  // ‚îÄ‚îÄ Ë™ûÂΩô (ËæûÊõ∏ÂÖ®‰Ωì„Çí„Ç´„ÉÜ„Ç¥„É™Âà•„Å´Êï¥ÁêÜ) ‚îÄ‚îÄ
  const byPos = {};
  S.dictionary.forEach(w=>{
    if(!byPos[w.pos])byPos[w.pos]=[];
    byPos[w.pos].push(w);
  });
  const dictLines = Object.entries(byPos).map(([pos,words])=>{
    const sample = words.slice(0,25).map(w=>`${w.conlang}„Äå${w.meaning}„Äç${w.read?'['+w.read+']':''}`).join(' / ');
    return `„Äê${pos}„Äë${sample}`;
  }).join('\n');

  const uiLang = t('ai_tutor_lang');
  const notSet = S.lang==='ja'?'Êú™Ë®≠ÂÆö':'(not set)';
  const none = S.lang==='ja'?'„Å™„Åó':'none';
  const noVocab = S.lang==='ja'?'ÔºàË™ûÂΩôÊú™ÁôªÈå≤Ôºâ':'(no vocabulary)';
  const noPattern = S.lang==='ja'?'  ÔºàÊú™Ë®≠ÂÆöÔºâ':'  (not set)';
  const noCorpus = S.lang==='ja'?'  Ôºà„Å™„ÅóÔºâ':'  (none)';

  // ‚îÄ‚îÄ Èü≥Èüª„É´„Éº„É´ ‚îÄ‚îÄ
  const phonRules = [
    `Vowels: ${S.phoneme.vowels.join(' ')||notSet}`,
    `Consonants: ${S.phoneme.consonants.join(' ')||notSet}`,
    `Syllable: ${S.phoneme.syllable||notSet}`,
    `Accent: ${S.phoneme.accent||none}`,
  ].join(' | ');

  // ‚îÄ‚îÄ ÊñáÊ≥ï ‚îÄ‚îÄ
  const grammarLines = [
    `Word order: ${S.grammar.order}`,
    `Cases: ${S.grammar.cases}`,
    `Verb conjugation: ${S.grammar.verbConj}`,
    `Tense: ${(S.grammar.tense||[]).join('/')|| none}`,
    `Gender/Number: ${(S.grammar.gender||[]).join('/')||none}`,
  ].join(' | ');

  // ‚îÄ‚îÄ ÊñáÊ≥ï„Éë„Çø„Éº„É≥ ‚îÄ‚îÄ
  const patternLines = S.grammar.patterns.length
    ? S.grammar.patterns.map(p=>`  ${p.suffix} ‚Üí ${p.meaning}Ôºà${p.category}Ôºâ`).join('\n')
    : noPattern;

  // ‚îÄ‚îÄ ‰æãÊñá„Ç≥„Éº„Éë„Çπ ‚îÄ‚îÄ
  const corpusSample = S.corpus.slice(0,5).map(c=>
    `  "${c.conlang}" = „Äå${c.jp}„Äç${c.read?'['+c.read+']':''}`
  ).join('\n') || noCorpus;

  // ‚îÄ‚îÄ ÊñáÊ≥ï„É°„É¢ÊäúÁ≤ã ‚îÄ‚îÄ
  const noteSnippet = S.grammarNotes
    ? S.grammarNotes.slice(0,300) + (S.grammarNotes.length>300?'‚Ä¶':'')
    : '';

  return `You are an expert AI tutor for the constructed language "${S.langName}".
All responses MUST be in ${uiLang}. Master the language data below and use it in every response.

‚ïê‚ïê‚ïê Language name ‚ïê‚ïê‚ïê
${S.langName}

‚ïê‚ïê‚ïê Vocabulary (${S.dictionary.length} words) ‚ïê‚ïê‚ïê
${dictLines||noVocab}

‚ïê‚ïê‚ïê Phonology ‚ïê‚ïê‚ïê
${phonRules}

‚ïê‚ïê‚ïê Grammar ‚ïê‚ïê‚ïê
${grammarLines}

‚ïê‚ïê‚ïê Grammar patterns / affixes ‚ïê‚ïê‚ïê
${patternLines}

‚ïê‚ïê‚ïê Corpus (${S.corpus.length} examples) ‚ïê‚ïê‚ïê
${corpusSample}
${noteSnippet?`\n‚ïê‚ïê‚ïê Grammar notes ‚ïê‚ïê‚ïê\n${noteSnippet}`:''}

‚ïê‚ïê‚ïê Behavior rules ‚ïê‚ïê‚ïê
1. Always compose sentences following the vocabulary and phonology of "${S.langName}".
2. If a word is missing ‚Üí suggest it as: "New word: [conlang]=meaning"
3. If the user's sentence has grammar/phonology errors ‚Üí explain: "üìù Correction: X ‚Üí should be Y (reason)"
4. Reply with a ${S.langName} sentence + ${uiLang} translation. Example: "Silvara pona! ÔºàWater is good!Ôºâ"
5. Keep conversation fun and friendly. Maximum 3 sentences per reply.
6. If the user writes only in ${uiLang}, translate it into ${S.langName} and provide the ${uiLang} translation.`;
}

async function sendChat(){
  const input=document.getElementById('aichat-input');
  if(!input||!input.value.trim())return;

  // --- V25 Firestore AIÂà∂Èôê„ÉÅ„Çß„ÉÉ„ÇØ ---
  const canUse = await checkAIUsage();
  if (!canUse) return;

  const userText=input.value.trim();
  input.value='';
  appendChatMsg(userText,'user');

  if(chatHistory.length===0){
    const systemPrompt=buildSystemPrompt();
    console.debug('[Lingua AI] System prompt:\n'+systemPrompt);
    chatHistory.push({role:'system',content:systemPrompt});
  }
  chatHistory.push({role:'user',content:userText});
  showTyping();

  setTimeout(async ()=>{
    hideTyping();
    const resp=generateAIResponse(userText);
    appendChatMsg(resp.text,'ai');
    if(resp.correction)appendChatMsg('üìù '+resp.correction,'correction');
    if(resp.newWord){
      _pendingNewWords.push(resp.newWord);
      appendChatMsg(`‚ú¶ ${t('ws_new').replace('%w',resp.newWord.conlang).replace('%m',resp.newWord.meaning)}`,'correction');
    }
    chatHistory.push({role:'assistant',content:resp.text});
    
    // AI‰ΩøÁî®„Ç´„Ç¶„É≥„Éà„ÇíÂ¢ó„ÇÑ„Åô
    await incrementAIUsage();
  }, 600 + Math.random()*700);
}

function showChatPaywall(){
  const msgs = document.getElementById('aichat-messages');
  if(!msgs) return;
  // Êó¢„Å´„Éö„Ç§„Ç¶„Ç©„Éº„É´„ÅåÂá∫„Å¶„ÅÑ„Åü„ÇâËøΩÂä†„Åó„Å™„ÅÑ
  if(document.getElementById('chat-paywall')) return;

  const div = document.createElement('div');
  div.id = 'chat-paywall';
  div.style.cssText = 'margin:16px 0;padding:22px;border:2px solid var(--gold-border);border-radius:16px;background:linear-gradient(135deg,rgba(201,169,110,0.12),rgba(140,126,255,0.08));text-align:center;animation:fadeIn 0.3s ease both';
  div.innerHTML = `
    <div style="font-size:1.6rem;margin-bottom:8px">‚ú¶</div>
    <div style="font-family:'Cinzel',serif;font-size:1.05rem;font-weight:700;color:var(--gold);margin-bottom:6px">\${t('chat_paywall_title')}</div>
    <div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:16px;line-height:1.7">\${t('chat_paywall_body')}</div>
    <button onclick="openProModal('chat_limit')" style="padding:11px 24px;border-radius:10px;border:none;background:linear-gradient(135deg,var(--gold),#d4a76a);color:#1a0a0a;font-family:inherit;font-size:0.88rem;font-weight:700;cursor:pointer;margin-bottom:8px;display:block;width:100%">
      \${t('chat_paywall_btn')}
    </button>
    <div style="font-size:0.7rem;color:var(--text-muted)">\${t('chat_paywall_reset')}</div>
  `;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;

  // ÂÖ•ÂäõÊ¨Ñ„ÇíÁÑ°ÂäπÂåñ
  const input = document.getElementById('aichat-input');
  if(input){ input.disabled = true; input.placeholder = t('ai_limit_prompt'); }
  const sendBtn = document.querySelector('[onclick="sendChat()"]');
  if(sendBtn){ sendBtn.disabled = true; sendBtn.style.opacity = '0.4'; }
}

function generateAIResponse(userText){
  const dict = S.dictionary;
  const V = S.phoneme.vowels.length ? S.phoneme.vowels : ['a','e','i','o','u'];
  const C = S.phoneme.consonants.length ? S.phoneme.consonants : ['k','r','n','s','l','m'];
  let correction = null;
  let newWord = null;
  const lower = userText.toLowerCase();

  const randSylAI = (seed=Math.random()) => generateWordFromPhonology(String(seed)+'ai');

  const buildSentence = () => {
    const nouns=dict.filter(w=>w.pos===t('ws_noun')||w.pos==='ÂêçË©û'||w.pos==='noun');
    const verbs=dict.filter(w=>w.pos==='ÂãïË©û'||w.pos==='verb');
    const adjs=dict.filter(w=>w.pos==='ÂΩ¢ÂÆπË©û'||w.pos==='adjective');
    const prons=dict.filter(w=>w.pos==='‰ª£ÂêçË©û'||w.pos==='pronoun');
    const subj=(prons[0]||nouns[0])?.conlang;
    const obj=nouns[Math.floor(Math.random()*nouns.length)]?.conlang;
    const verb=verbs[Math.floor(Math.random()*verbs.length)]?.conlang;
    const subjM=(prons[0]||nouns[0])?.meaning;
    const objM=nouns[Math.floor(Math.random()*nouns.length)]?.meaning;
    const verbM=verbs[Math.floor(Math.random()*verbs.length)]?.meaning;
    if(!subj||!verb)return null;
    const suffix=S.grammar.patterns.find(p=>p.type==='suffix'&&p.category==='ÈÄ≤Ë°å');
    const verbForm=suffix?verb+(suffix.suffix.startsWith('-')?suffix.suffix.slice(1):suffix.suffix):verb;
    let cl='',jp='';
    if(S.grammar.order==='SOV'){cl=`${subj} ${obj||''} ${verbForm}`.trim();jp=`${subjM}: ${objM||''} ${verbM}`;}
    else if(S.grammar.order==='VSO'){cl=`${verbForm} ${subj} ${obj||''}`.trim();jp=`${verbM}: ${subjM} ${objM||''}`;}
    else{cl=`${subj} ${verbForm} ${obj||''}`.trim();jp=`${subjM} ${verbM}${objM?' ('+objM+')':''}`;}
    return{cl,jp};
  };

  const foundWords=dict.filter(w=>userText.toLowerCase().includes(w.conlang.toLowerCase()));

  if(dict.length>0 && S.phoneme.consonants.length>0){
    const tokens=userText.split(/\s+/).filter(t=>t.length>1&&t.match(/[a-zA-Z√´√¶ƒÅ≈ç≈´…õ…î]/));
    const illegalTokens=tokens.filter(tok=>{
      if(dict.find(w=>w.conlang.toLowerCase()===tok.toLowerCase()))return false;
      const allSounds=[...V,...C];
      return tok.split('').some(ch=>!'aeiou√´√¶ƒÅ≈ç≈´…õ…î'.includes(ch)&&!allSounds.includes(ch)&&!'-_.'.includes(ch));
    });
    if(illegalTokens.length>0 && foundWords.length===0){
      correction=`"${illegalTokens[0]}" may contain sounds not in your phonology. Check the Phonology tab!`;
    }
  }

  let text='';

  // Advice mode
  if(lower.match(/advice|tip|help|how|teach|guide|„Ç¢„Éâ„Éê„Ç§„Çπ|„Å©„ÅÜ|Êïô„Åà„Å¶|conseil|ayuda|Âª∫ËÆÆ/)){
    const tips=[
      dict.length<5 ? `Start by creating <strong>5‚Äì10 basic nouns</strong> like "hello", "water", "light". The Vocab gacha button makes it easy!` : null,
      S.phoneme.vowels.length===0 ? `Go to the <strong>Phonology</strong> tab and select 3‚Äì5 vowels. This makes word generation feel much more natural!` : null,
      S.grammar.patterns.length===0 ? `Try adding one <strong>suffix pattern</strong> in the Grammar tab ‚Äî e.g. -vel (progressive). Your vocabulary instantly expands!` : null,
      S.corpus.length===0 ? `Add even <strong>one example sentence</strong> in the Corpus tab! It shows what kind of language "${S.langName}" is at a glance.` : null,
    ].filter(Boolean);
    const tip=tips.length>0?tips[0]:`${dict.length} words, ${S.grammar.patterns.length} grammar patterns, ${S.corpus.length} corpus entries ‚Äî great progress! Next: add more sentences or try complex inflections!`;
    return{text:`üí° Tip:<br>${tip}`,correction:null,newWord:null};
  }

  // Greeting
  if(lower.match(/^(hello|hi|hey|„Åì„Çì„Å´„Å°„ÅØ|„Åä„ÅØ„Çà„ÅÜ|konnichiha|toki|bonjour|hola|‰Ω†Â•Ω|n«ê h«éo)/)){
    const greet=dict.find(w=>['hello','hi','good','greeting','„Åì„Çì„Å´„Å°„ÅØ','ËâØ„ÅÑ','Êå®Êã∂','hola','bonjour','‰Ω†Â•Ω'].some(m=>w.meaning.includes(m)));
    if(greet){
      text=`${greet.conlang}ÔºÅÔºà${greet.meaning}Ôºâ<br>‚ú¶ Thanks for speaking ${S.langName}!<br>Your dictionary now has <strong>${dict.length} words</strong>. Try making a sentence!`;
    } else {
      const w=randSylAI(0.1);
      newWord={conlang:w,meaning:t('aichat_quick_hi'),pos:'interjection',tags:[t('ws_tag_daily')]};
      text=`"Hello" isn't in your ${S.langName} dictionary yet!<br>How about "<strong>${w}</strong>"? Save it with the "üìñ Add to Dictionary" button.<br>üí° Tip: Add words first, then use them here!`;
    }
  }
  // Self-introduction
  else if(lower.match(/name|who|ÂêçÂâç|„Å†„Çå|Ë™∞|nombre|nom|ÂêçÂ≠ó/)){
    const me=dict.find(w=>['I','me','ÁßÅ','Êàë','yo','je','–º–Ω–µ'].includes(w.meaning));
    const nameW=dict.find(w=>['name','ÂêçÂâç','nombre','nom','ÂêçÂ≠ó'].some(m=>w.meaning.includes(m)));
    if(me&&nameW) text=`${me.conlang} ${nameW.conlang} ${S.langName}-AIÔºÅ<br>(My name is ${S.langName}-AI!)<br>I'm here to help you build your language!`;
    else text=`I am <strong>${S.langName}-AI</strong>!<br>I help you practice "${S.langName}".<br>üí° Tip: Add words for "I" and "name" to have richer conversations!`;
  }
  // Word of the day
  else if(lower.match(/word|ÂçòË™û|today|‰ªäÊó•|palabra|mot|ÂçïËØç/)){
    const w=dict[Math.floor(Math.random()*dict.length)];
    if(w){
      const pattern=S.grammar.patterns.find(p=>p.type==='suffix'&&p.meaning.includes('Âåñ'));
      text=`üìñ <strong>Word of the day</strong><br>`;
      text+=`<span style="font-family:monospace;font-size:1.1rem;color:var(--accent)">${w.conlang}</span>`;
      if(w.read)text+=` <span style="font-size:0.8rem;color:var(--text-muted)">[${w.read}]</span>`;
      text+=`<br>Meaning: ${w.meaning} (${w.pos})`;
      if(pattern)text+=`<br>Usage: ${w.conlang}${pattern.suffix.replace('-','')} = "${w.meaning}" ${pattern.meaning}`;
      if(w.tags?.length)text+=`<br>Tags: ${w.tags.join(', ')}`;
    } else {
      text=`Your dictionary is empty! Go to the Vocab tab to add words with the gacha or manually.<br>üí° Add your first word and you can use it here!`;
    }
  }
  // Used a dictionary word
  else if(foundWords.length>0){
    const hit=foundWords[0];
    const sent=buildSentence();
    const patterns=S.grammar.patterns.filter(p=>p.type==='suffix'&&p.category!=='ÊñáÊ≥ï'&&p.category!=='Grammar');
    let response=`You used "<span style="font-family:monospace;color:var(--accent)">${hit.conlang}</span>" (${hit.meaning})!`;
    if(sent){
      response+=`<br><br>Example: "<strong>${sent.cl}</strong>" = "${sent.jp}"`;
    }
    if(patterns.length>0){
      const pat=patterns[0];
      const applied=hit.conlang+(pat.suffix.startsWith('-')?pat.suffix.slice(1):pat.suffix);
      response+=`<br><br>üí° Pattern: "<span style="font-family:monospace;color:var(--accent2)">${applied}</span>" = "${hit.meaning} + ${pat.meaning}"`;
    }
    text=response;
  }
  // Rich vocabulary
  else if(dict.length>=5){
    const sent=buildSentence();
    if(sent){
      text=`How about this sentence?<br><strong>${sent.cl}</strong><br>= "${sent.jp}"<br><br>`;
      const nouns=dict.filter(w=>w.pos==='ÂêçË©û'||w.pos==='noun');
      if(nouns.length>0){
        const n=nouns[Math.floor(Math.random()*nouns.length)];
        const relFam=SEMANTIC_FAMILIES[n.meaning];
        if(relFam){
          const missing=relFam.related.filter(r=>!dict.find(d=>d.meaning===r));
          if(missing.length>0) text+=`üí° A word for "${missing[0]}" would expand your expressions for "${n.meaning}"!`;
        }
      }
    } else {
      const w=randSylAI(0.5);
      newWord={conlang:w,meaning:t('ws_convo'),pos:t('ws_noun'),tags:[t('ws_tag_daily')]};
      text=`Adding more verbs and adjectives will enrich conversation!<br>How about "<strong>${w}</strong>" (${t('ws_convo')})? Save it with the "üìñ Add to Dictionary" button.`;
    }
  }
  // Few words ‚Äî guide gently
  else {
    const starterWords=['hello','water','sky','I','beautiful'];
    const missing=starterWords.filter(w=>!dict.find(d=>d.meaning===w||d.meaning===w));
    const suggest=missing[0]||'friend';
    const w=randSylAI(0.7);
    newWord={conlang:w,meaning:suggest,pos:suggest==='beautiful'?'adjective':t('ws_noun'),tags:[t('ws_tag_daily')]};
    text=`Let\'s make your first word!<br>"<strong>${w}</strong>" (${suggest}) ‚Äî how does that sound?<br>Feel free to change it if you don\'t like it.<br><br>üí° Tip: Use the gacha button in the Vocab tab to generate 10 words at once!`;
  }

  return{text:text||'Tell me more!',correction,newWord};
}
function sendChatPrompt(jp){
  const input=document.getElementById('aichat-input');
  if(input){input.value=jp;sendChat()}
}
function askForNewWord(){
  const V=S.phoneme.vowels.length?S.phoneme.vowels:['a','e','i'];
  const C=S.phoneme.consonants.length?S.phoneme.consonants:['k','r','n','s'];
  const rand=()=>C[Math.floor(Math.random()*C.length)]+V[Math.floor(Math.random()*V.length)];
  const word=rand()+rand();
  const meanings=[t('aichat_quick_hi')||'hello','star','song','dream','courage','joy','sadness'];
  const m=meanings[Math.floor(Math.random()*meanings.length)];
  const msg=t('ws_new').replace('%w',word).replace('%m',m);
  appendChatMsg(msg,'ai');
  _pendingNewWords.push({conlang:word,meaning:m,pos:t('ws_noun'),tags:[t('ws_tag_emotion')]});
}
function exportChatVocab(){
  if(!_pendingNewWords.length){alert(t('ed_no_new_words'));return;}
  let added=0;
  _pendingNewWords.forEach(w=>{
    if(!S.dictionary.find(d=>d.conlang===w.conlang)){
      S.dictionary.push(w);added++;
    }
  });
  _pendingNewWords=[];
  scheduleSave();updateDashboard();
  alert(`‚úÖ ${added}${t('ed_added_words')}`);
}
function appendChatMsg(text,type){
  const msgs=document.getElementById('aichat-messages');
  if(!msgs)return;
  const div=document.createElement('div');
  div.className='chat-msg '+type;
  // AI messages can contain HTML (bold, spans, line breaks)
  if(type==='ai'||type==='correction'){
    div.innerHTML=text;
  } else {
    div.textContent=text;
  }
  msgs.appendChild(div);
  msgs.scrollTop=msgs.scrollHeight;
}
function showTyping(){
  const msgs=document.getElementById('aichat-messages');
  if(!msgs)return;
  const div=document.createElement('div');
  div.className='chat-typing';div.id='typing-indicator';
  div.innerHTML='<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
  msgs.appendChild(div);msgs.scrollTop=msgs.scrollHeight;
}
function hideTyping(){document.getElementById('typing-indicator')?.remove()}
function clearChat(){
  chatHistory=[];_pendingNewWords=[];
  const msgs=document.getElementById('aichat-messages');
  if(msgs)msgs.innerHTML=`<div class="chat-msg ai">${t('chat_cleared')}</div>`;
  // ÂÖ•ÂäõÊ¨Ñ„ÇíÂæ©Ê¥ªÔºà„Éö„Ç§„Ç¶„Ç©„Éº„É´Ëß£Èô§Ôºâ
  const input = document.getElementById('aichat-input');
  if(input){ input.disabled = false; input.placeholder = t('aichat_placeholder')||'„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ‚Ä¶'; }
  const sendBtn = document.querySelector('[onclick="sendChat()"]');
  if(sendBtn){ sendBtn.disabled = false; sendBtn.style.opacity = '1'; }
}


// ===== ËæûÊõ∏Áã¨Á´ã„Éö„Éº„Ç∏ & „Éï„É©„ÉÉ„Ç∑„É•„Ç´„Éº„Éâ =====

let _vpSort = 'alpha'; // 'alpha' | 'pos' | 'recent'
let _vpPosFilter = '';
let _fcCards = [];
let _fcIndex = 0;
let _fcCorrect = 0;
let _fcWrong = 0;
let _fcFlipped = false;
let _fcCount = 10;
let _fcWrongIds = new Set();
let _fcCurrentCard = null;

function renderVocabPage(){
  const countEl = document.getElementById('vocab-page-count');
  if(countEl) countEl.textContent = S.dictionary.length + (S.lang==='ja'?'Ë™ûÁôªÈå≤Ê∏à„Åø':S.lang==='zh'?' ‰∏™ÂçïËØç':S.lang==='es'?' palabras':' words');

  // ÂìÅË©û„Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥ÁîüÊàê
  const posWrap = document.getElementById('vp-pos-filter');
  if(posWrap){
    const allPos = [t('v_pos_filter_all'),t('v_pos_noun'),t('v_pos_verb'),t('v_pos_adj'),t('v_pos_adv'),t('v_pos_pron'),t('v_pos_part')];
    posWrap.innerHTML = allPos.map(p=>`<button style="padding:3px 10px;border-radius:20px;border:1px solid ${_vpPosFilter===p||(p===t('v_pos_filter_all')&&!_vpPosFilter)?'var(--accent-border)':'var(--border)'};background:${_vpPosFilter===p||(p===t('v_pos_filter_all')&&!_vpPosFilter)?'var(--accent-dim)':'transparent'};color:${_vpPosFilter===p||(p===t('v_pos_filter_all')&&!_vpPosFilter)?'var(--accent)':'var(--text-muted)'};font-family:inherit;font-size:0.7rem;cursor:pointer;transition:all 0.12s" onclick="setVpPosFilter('${p==='All'||p==='ÂÖ®„Å¶'||p===t('v_pos_filter_all')?'':p}')">${p}</button>`).join('');
  }

  const search = (document.getElementById('vp-search')?.value||'').toLowerCase();
  let words = [...S.dictionary];

  // „Éï„Ç£„É´„Çø„Éº
  if(_vpPosFilter) words = words.filter(w=>w.pos===_vpPosFilter);
  if(search) words = words.filter(w=>w.conlang.toLowerCase().includes(search)||w.meaning.toLowerCase().includes(search));

  // „ÇΩ„Éº„Éà
  if(_vpSort==='alpha') words.sort((a,b)=>a.conlang.localeCompare(b.conlang));
  else if(_vpSort==='pos') words.sort((a,b)=>(a.pos||'').localeCompare(b.pos||''));

  const list = document.getElementById('vp-word-list');
  if(!list) return;

  if(!words.length){
    list.innerHTML = `<div style="text-align:center;padding:48px 20px;color:var(--text-muted)">
      <div style="font-size:2rem;margin-bottom:12px">üìñ</div>
      <div style="font-size:0.85rem">${search ? '‰∏ÄËá¥„Åô„ÇãÂçòË™û„Åå„ÅÇ„Çä„Åæ„Åõ„Çì' : t('v_dict_empty')}</div>
      ${!search?`<button onclick="openEditor('vocab')" class="btn btn-sm btn-gold" style="margin-top:12px">Ôºã ÊúÄÂàù„ÅÆÂçòË™û„ÇíËøΩÂä†</button>`:''}
    </div>`;
    return;
  }

  list.innerHTML = words.map((w,i) => {
    const starred = (w.starred||false);
    const wrong = _fcWrongIds.has(w.conlang);
    const script = Object.keys(S.scriptMap).length ? applyScriptMap(w.conlang) : '';
    return `<div style="background:var(--surface);border:1px solid ${wrong?'var(--rose-border)':starred?'var(--gold-border)':'var(--border)'};border-radius:12px;padding:14px 16px;margin-bottom:8px;display:flex;align-items:center;gap:12px;transition:all 0.15s" onmouseover="this.style.borderColor='var(--border-hover)'" onmouseout="this.style.borderColor='${wrong?'var(--rose-border)':starred?'var(--gold-border)':'var(--border)'}'">
      <div style="flex:1;min-width:0">
        <div style="display:flex;align-items:baseline;gap:8px;flex-wrap:wrap">
          <span style="font-family:'Cinzel',serif;font-size:1.05rem;font-weight:700;color:var(--text-primary)">${w.conlang}</span>
          ${script?`<span style="font-size:1rem;color:var(--accent2);font-family:monospace">${script}</span>`:''}
          ${w.read?`<span style="font-size:0.72rem;color:var(--accent);font-family:monospace">[${w.read}]</span>`:''}
        </div>
        <div style="font-size:0.82rem;color:var(--text-secondary);margin-top:3px">${w.meaning}</div>
        <div style="display:flex;gap:5px;flex-wrap:wrap;margin-top:5px">
          ${w.pos?`<span style="font-size:0.62rem;padding:1px 7px;border-radius:4px;background:var(--surface-2);border:1px solid var(--border);color:var(--text-muted)">${w.pos}</span>`:''}
          ${(w.tags||[]).map(tg=>`<span style="font-size:0.62rem;padding:1px 7px;border-radius:4px;background:var(--accent2-dim);border:1px solid rgba(192,123,255,0.2);color:var(--accent2)">${tg}</span>`).join('')}
          ${wrong?'<span style="font-size:0.62rem;padding:1px 7px;border-radius:4px;background:var(--rose-dim);border:1px solid var(--rose-border);color:var(--rose)">‚úó Ë¶ÅÂæ©Áøí</span>':''}
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0">
        <button onclick="vpSpeak('${w.conlang}','${w.read||''}')" style="width:32px;height:32px;border-radius:50%;border:1px solid var(--border);background:var(--surface-2);color:var(--text-secondary);cursor:pointer;font-size:0.85rem;display:flex;align-items:center;justify-content:center;transition:all 0.12s" onmouseover="this.style.borderColor='var(--accent-border)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-secondary)'">üîä</button>
        <button onclick="vpToggleStar(${i})" style="width:32px;height:32px;border-radius:50%;border:1px solid ${starred?'var(--gold-border)':'var(--border)'};background:${starred?'var(--gold-dim)':'var(--surface-2)'};color:${starred?'var(--gold)':'var(--text-muted)'};cursor:pointer;font-size:0.85rem;display:flex;align-items:center;justify-content:center;transition:all 0.12s">‚≠ê</button>
      </div>
    </div>`;
  }).join('');
}

function setVpPosFilter(pos){
  _vpPosFilter = pos;
  renderVocabPage();
}

function vpSortToggle(){
  const btn = document.getElementById('vp-sort-btn');
  if(_vpSort==='alpha'){ _vpSort='pos'; if(btn) btn.textContent='ÂìÅË©û‚Üë'; }
  else { _vpSort='alpha'; if(btn) btn.textContent='A‚Üë'; }
  renderVocabPage();
}

function vpSpeak(word, read){
  const text = read || word;
  if('speechSynthesis' in window){
    window.speechSynthesis.cancel();
    const utt = new SpeechSynthesisUtterance(text);
    utt.rate = 0.8; utt.pitch = 1;
    window.speechSynthesis.speak(utt);
  }
}

function vpToggleStar(idx){
  // Ê§úÁ¥¢„Éª„Éï„Ç£„É´„Çø„ÉºÂæå„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Å´ÂØæÂøú
  const search = (document.getElementById('vp-search')?.value||'').toLowerCase();
  let words = [...S.dictionary];
  if(_vpPosFilter) words = words.filter(w=>w.pos===_vpPosFilter);
  if(search) words = words.filter(w=>w.conlang.toLowerCase().includes(search)||w.meaning.toLowerCase().includes(search));
  if(_vpSort==='alpha') words.sort((a,b)=>a.conlang.localeCompare(b.conlang));

  const target = words[idx];
  if(!target) return;
  const orig = S.dictionary.find(w=>w.conlang===target.conlang&&w.meaning===target.meaning);
  if(orig) orig.starred = !orig.starred;
  scheduleSave();
  renderVocabPage();
}

function switchVocabPageTab(tab){
  ['dict','flash','add'].forEach(t=>{
    const btn = document.getElementById('vp-tab-'+t);
    const content = document.getElementById('vp-content-'+t);
    if(btn) btn.classList.toggle('active', t===tab);
    if(content) content.style.display = t===tab ? 'block' : 'none';
  });
  if(tab==='add'){
    const body = document.getElementById('vp-add-body');
    if(body && !body.innerHTML){
      // „Ç¨„ÉÅ„É£+ÊâãÂãïËøΩÂä†„ÇíÁ∞°ÊòìË°®Á§∫
      body.innerHTML = buildVocabAddSection();
      setTimeout(()=>initAutoResize(), 50);
    }
  }
  if(tab==='dict') renderVocabPage();
  if(tab==='flash') updateFcStatsSummary();
}

function buildVocabAddSection(){
  return `
  <div class="field-block" style="margin-bottom:20px">
    <span class="field-label">ÂçòË™û„Çí„Ç¨„ÉÅ„É£ÁîüÊàê</span>
    <div style="display:flex;gap:8px;margin-bottom:10px">
      <input class="input-field" placeholder="ÊÑèÂë≥„ÇíÂÖ•ÂäõÔºà‰æãÔºöÊ∞¥, Á©∫, ÊÑõÔºâ" id="vp-gacha-input" style="flex:1">
      <button class="btn btn-primary btn-sm" onclick="vpRunGacha()">ÁîüÊàê ‚ú¶</button>
    </div>
    <button class="gacha-btn" onclick="vpRunRandGacha()"><span>‚ú¶</span> „É©„É≥„ÉÄ„É†10Ë™ûÁîüÊàê</button>
    <div id="vp-gacha-result" style="margin-top:10px"></div>
  </div>
  <div class="field-block">
    <span class="field-label">ÊâãÂãï„ÅßËøΩÂä†</span>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <div>
        <span class="field-label" style="font-size:0.68rem">„Ç≥„É≥„É©„É≥„Ç∞Ë™û</span>
        <input class="input-field" placeholder="e.g. silvara" id="vp-word-cl" oninput="validateWordInput(this)" onfocus="_activeScriptCell=this">
      </div>
      <div>
        <span class="field-label" style="font-size:0.68rem">ÊÑèÂë≥</span>
        <input class="input-field" placeholder="e.g. Ê∞¥" id="vp-word-jp">
      </div>
      <div>
        <span class="field-label" style="font-size:0.68rem">Ë™≠„ÅøÔºàIPAÔºâ</span>
        <input class="input-field" placeholder="/silvara/" id="vp-word-read" style="font-family:monospace">
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn btn-primary btn-sm" onclick="vpAddManual()">ËæûÊõ∏„Å´ËøΩÂä† +</button>
      <button class="btn btn-sm" onclick="vpSpeak(document.getElementById('vp-word-cl').value,'')">üîä Áô∫Èü≥</button>
    </div>
  </div>`;
}

function vpRunGacha(){
  const inp = document.getElementById('vp-gacha-input');
  if(!inp) return;
  // Êó¢Â≠ò„ÅÆrunGachaÁõ∏ÂΩì
  const meanings = inp.value.split(/[,„ÄÅÔºå\s]+/).filter(Boolean);
  if(!meanings.length){alert('ÊÑèÂë≥„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');return;}
  const results = meanings.map(m=>({conlang:generateWordFromPhonology(m),meaning:m,pos:t('v_pos_noun'),tags:[]}));
  const el = document.getElementById('vp-gacha-result');
  if(el) el.innerHTML = `<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px">`+results.map(r=>`<div class="gen-word-chip" onclick="vpPromptAddWord('${r.conlang}','${r.meaning}')"><span>${r.conlang}</span><span>+</span></div>`).join('')+`</div>`;
}

function vpRunRandGacha(){
  const basics=['hello','water','sky','fire','love','friend','night','star','beautiful','home'];
  const results = basics.map(m=>({conlang:generateWordFromPhonology(m+Math.random()),meaning:m,pos:t('v_pos_noun'),tags:[]}));
  const el = document.getElementById('vp-gacha-result');
  if(el) el.innerHTML = `<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px">`+results.map(r=>`<div class="gen-word-chip" onclick="vpPromptAddWord('${r.conlang}','${r.meaning}')"><span>${r.conlang}</span><span>+</span></div>`).join('')+`</div>`;
}

function vpPromptAddWord(cl, meaning){
  S.dictionary.push({conlang:cl,meaning:meaning,pos:t('v_pos_noun'),tags:[],starred:false});
  scheduleSave(); updateDashboard();
  showAutosave('‚úì '+cl+' „ÇíËøΩÂä†');
  renderVocabPage();
}

function vpAddManual(){
  const cl = document.getElementById('vp-word-cl')?.value.trim();
  const jp = document.getElementById('vp-word-jp')?.value.trim();
  const read = document.getElementById('vp-word-read')?.value.trim();
  if(!cl||!jp){alert('„Ç≥„É≥„É©„É≥„Ç∞Ë™û„Å®ÊÑèÂë≥„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');return;}
  S.dictionary.push({conlang:cl,meaning:jp,read:read||'',pos:t('v_pos_noun'),tags:[],starred:false});
  document.getElementById('vp-word-cl').value='';
  document.getElementById('vp-word-jp').value='';
  document.getElementById('vp-word-read').value='';
  scheduleSave(); updateDashboard();
  showAutosave('‚úì '+cl+' „ÇíËøΩÂä†');
  renderVocabPage();
  switchVocabPageTab('dict');
}

// ===== „Éï„É©„ÉÉ„Ç∑„É•„Ç´„Éº„Éâ =====

function setFcCount(n, btn){
  _fcCount = n;
  document.querySelectorAll('#vp-flash-setup .toggle-chip').forEach(b=>b.classList.remove('selected'));
  if(btn) btn.classList.add('selected');
}

function updateFcStatsSummary(){
  const el = document.getElementById('fc-stats-summary');
  if(!el) return;
  const starred = S.dictionary.filter(w=>w.starred).length;
  const wrong = _fcWrongIds.size;
  el.textContent = `ÂÖ®${S.dictionary.length}Ë™û ÔΩú ‚≠ê ${starred}Ë™û ÔΩú ‚úó Ë¶ÅÂæ©Áøí${wrong}Ë™û`;
}

function startFlashcard(){
  switchVocabPageTab('flash');
}

function launchFlashcard(){
  const dir = document.querySelector('[name="fc-dir"]:checked')?.value||'cl2jp';
  const range = document.querySelector('[name="fc-range"]:checked')?.value||'all';

  let pool = [...S.dictionary];
  if(range==='stared') pool = pool.filter(w=>w.starred);
  if(range==='wrong') pool = pool.filter(w=>_fcWrongIds.has(w.conlang));

  if(!pool.length){
    alert(range==='stared'?'‚≠ê„Çπ„Çø„ÉºÊ∏à„Åø„ÅÆÂçòË™û„Åå„ÅÇ„Çä„Åæ„Åõ„Çì':range==='wrong'?'‚úó ‰∏çÊ≠£Ëß£„ÅÆÂçòË™û„Åå„ÅÇ„Çä„Åæ„Åõ„Çì':'ÂçòË™û„Åå„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇËøΩÂä†„Çø„Éñ„Åã„ÇâÂçòË™û„ÇíÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ');
    return;
  }

  // „Ç∑„É£„ÉÉ„Éï„É´
  pool = pool.sort(()=>Math.random()-0.5);
  if(_fcCount > 0) pool = pool.slice(0, _fcCount);

  // ÊñπÂêëË®≠ÂÆö
  _fcCards = pool.map(w=>{
    const r = dir==='random'?Math.random()>0.5:dir==='cl2jp';
    return {...w, showConlang:r};
  });

  _fcIndex = 0; _fcCorrect = 0; _fcWrong = 0; _fcFlipped = false;

  document.getElementById('vp-flash-setup').style.display = 'none';
  document.getElementById('vp-flash-result').style.display = 'none';
  document.getElementById('vp-flash-card').style.display = 'block';
  document.getElementById('fc-answer-btns').style.display = 'none';
  document.getElementById('fc-flip-hint').style.display = 'block';

  showFcCard();
}

function showFcCard(){
  if(_fcIndex >= _fcCards.length){ showFcResult(); return; }
  const card = _fcCards[_fcIndex];
  _fcCurrentCard = card;
  _fcFlipped = false;

  // „Ç´„Éº„Éâ„Çí„É™„Çª„ÉÉ„Éà
  const inner = document.getElementById('fc-card-inner');
  if(inner) inner.style.transform = '';
  document.getElementById('fc-answer-btns').style.display = 'none';
  document.getElementById('fc-flip-hint').style.display = 'block';

  // Ë°®Èù¢
  const frontLabel = document.getElementById('fc-front-label');
  const frontText = document.getElementById('fc-front-text');
  const frontRead = document.getElementById('fc-front-read');
  if(card.showConlang){
    if(frontLabel) frontLabel.textContent = '„Ç≥„É≥„É©„É≥„Ç∞';
    if(frontText){ frontText.textContent = card.conlang; frontText.style.fontFamily="'Cinzel',serif"; frontText.style.fontSize='2rem';}
    if(frontRead) frontRead.textContent = card.read ? `[${card.read}]` : '';
  } else {
    if(frontLabel) frontLabel.textContent = 'ÊÑèÂë≥';
    if(frontText){ frontText.textContent = card.meaning; frontText.style.fontFamily='inherit'; frontText.style.fontSize='1.8rem';}
    if(frontRead) frontRead.textContent = '';
  }

  // Ë£èÈù¢
  const backText = document.getElementById('fc-back-text');
  const backPos = document.getElementById('fc-back-pos');
  const backTags = document.getElementById('fc-back-tags');
  if(card.showConlang){
    if(backText) backText.textContent = card.meaning;
  } else {
    if(backText){ backText.textContent = card.conlang; backText.style.fontFamily="'Cinzel',serif";}
  }
  if(backPos) backPos.textContent = card.pos||'';
  if(backTags) backTags.textContent = (card.tags||[]).join(' ¬∑ ');

  // ÈÄ≤Êçó
  const total = _fcCards.length;
  document.getElementById('fc-progress-label').textContent = `${_fcIndex+1} / ${total}`;
  document.getElementById('fc-score-label').textContent = `‚úì ${_fcCorrect}„ÄÄ‚úó ${_fcWrong}`;
  document.getElementById('fc-progress-bar').style.width = `${(_fcIndex/total)*100}%`;
}

function flipCard(){
  if(_fcFlipped) return;
  _fcFlipped = true;
  const inner = document.getElementById('fc-card-inner');
  if(inner) inner.style.transform = 'rotateY(180deg)';
  document.getElementById('fc-answer-btns').style.display = 'flex';
  document.getElementById('fc-flip-hint').style.display = 'none';
}

function fcAnswer(correct){
  if(correct){
    _fcCorrect++;
    _fcWrongIds.delete(_fcCurrentCard.conlang);
  } else {
    _fcWrong++;
    _fcWrongIds.add(_fcCurrentCard.conlang);
  }
  _fcIndex++;

  // „Ç´„Éº„Éâ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
  const wrap = document.getElementById('fc-card-wrap');
  if(wrap){
    wrap.style.opacity='0';wrap.style.transform='scale(0.92)';
    setTimeout(()=>{wrap.style.transition='none';wrap.style.opacity='1';wrap.style.transform='scale(1)';wrap.style.transition='opacity 0.2s,transform 0.2s';showFcCard();},200);
  } else {
    showFcCard();
  }
}

function fcSpeak(){
  const card = _fcCurrentCard;
  if(!card) return;
  vpSpeak(card.conlang, card.read||'');
}

function showFcResult(){
  document.getElementById('vp-flash-card').style.display = 'none';
  document.getElementById('vp-flash-result').style.display = 'block';

  const total = _fcCorrect + _fcWrong;
  const pct = total ? Math.round(_fcCorrect/total*100) : 0;

  let emoji = pct>=90?'üèÜ':pct>=70?'üéâ':pct>=50?'üòä':'üí™';
  let title = pct>=90?'ÂÆåÁíßÔºÅ':pct>=70?'„Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ':pct>=50?'„ÇÇ„ÅÜÂ∞ë„ÅóÔºÅ':'Âæ©Áøí„Åó„Çà„ÅÜÔºÅ';

  document.getElementById('fc-result-emoji').textContent = emoji;
  document.getElementById('fc-result-title').textContent = title;
  document.getElementById('fc-result-body').textContent = `${total}Âïè‰∏≠ ${_fcCorrect}ÂïèÊ≠£Ëß£Ôºà${pct}%Ôºâ`;
  document.getElementById('fc-progress-bar').style.width = '100%';

  const retryBtn = document.getElementById('fc-retry-wrong-btn');
  if(retryBtn) retryBtn.style.display = _fcWrong>0?'inline-flex':'none';

  updateFcStatsSummary();
}

function showWrongWords(){
  document.querySelector('[name="fc-range"][value="wrong"]').checked = true;
  launchFlashcard();
}

// ===== END ËæûÊõ∏Áã¨Á´ã„Éö„Éº„Ç∏ & „Éï„É©„ÉÉ„Ç∑„É•„Ç´„Éº„Éâ =====

// ===== V21: TEMPLATES, ONBOARDING, SHARE CARD =====

// „ÉÜ„É≥„Éó„É¨„Éº„ÉàÊ©üËÉΩ
const LANGUAGE_TEMPLATES = {
  elvish: {
    id: 'elvish', name: '„Ç®„É´„ÉïË™ûÈ¢®', icon: 'üßù',
    description: 'ÂÑ™ÈõÖ„ÅßÊµÅ„Çå„Çã„Çà„ÅÜ„Å™Èüø„Åç„ÄÇ„Éà„Éº„É´„Ç≠„É≥„ÅÆ„Ç®„É´„ÉïË™û„Å´„Ç§„É≥„Çπ„Éë„Ç§„Ç¢',
    phonology: { consonants: ['l','r','n','m','v','th','s','h'], vowels: ['a','e','i','o','u','√´','√°'] },
    syllableStructure: '(C)V(n)',
    sampleWords: [
      {conlang:'eldar',meaning:'Êòü„ÅÆÊ∞ë',pos:'ÂêçË©û',tags:['Á®ÆÊóè']},
      {conlang:'l√≥rien',meaning:'Â§¢„ÅÆÂõΩ',pos:'ÂêçË©û',tags:['Âú∞Âêç']},
      {conlang:'mithril',meaning:'ÈäÄ„ÅÆÂÖâ',pos:'ÂêçË©û',tags:['Áâ©Ë≥™']},
      {conlang:'anar',meaning:'Â§™ÈôΩ',pos:'ÂêçË©û',tags:['Ëá™ÁÑ∂']},
      {conlang:'l√∫thien',meaning:'È≠îÊ≥ï‰Ωø„ÅÑ',pos:'ÂêçË©û',tags:['ËÅ∑Ê•≠']}
    ],
    vibe: 'Âè§‰ª£„ÅÆÊ£Æ„Å´Èüø„Åè„ÄÅÈÄèÊòé„ÅßÂè°Êô∫„Å´Ê∫Ä„Å°„ÅüË®ÄË™û„ÄÇÈï∑„ÅÑÊ≠¥Âè≤„Å®‰ºùÁµ±„ÇíÊåÅ„Å§Á®ÆÊóè„ÅÆË®ÄËëâ„ÄÇ',
    wordOrder: 'VSO'
  },
  cyberpunk: {
    id: 'cyberpunk', name: '„Çµ„Ç§„Éê„Éº„Éë„É≥„ÇØÈ¢®', icon: 'ü§ñ',
    description: 'Á°¨Ë≥™„ÅßÊú™Êù•ÁöÑ„Å™Èü≥„ÄÇ„Éç„Ç™„É≥Ëºù„ÅèÈÉΩÂ∏Ç„ÅÆË®ÄË™û',
    phonology: { consonants: ['k','z','x','ch','sh','v','t','r'], vowels: ['a','e','i','o','y'] },
    syllableStructure: 'CV(C)',
    sampleWords: [
      {conlang:'zyrex',meaning:'„Çµ„Ç§„Éê„ÉºÁ©∫Èñì',pos:'ÂêçË©û',tags:['„ÉÜ„ÇØ„Éé„É≠„Ç∏„Éº']},
      {conlang:'nextek',meaning:'„Éè„ÉÉ„Ç´„Éº',pos:'ÂêçË©û',tags:['ËÅ∑Ê•≠']},
      {conlang:'kvolt',meaning:'ÈõªËÑ≥„Ç¶„Ç§„É´„Çπ',pos:'ÂêçË©û',tags:['„ÉÜ„ÇØ„Éé„É≠„Ç∏„Éº']},
      {conlang:'shyrix',meaning:'„Éá„Éº„ÇøÊµÅ',pos:'ÂêçË©û',tags:['Ê¶ÇÂøµ']},
      {conlang:'tekron',meaning:'„Éç„Ç™„É≥ÈÉΩÂ∏Ç',pos:'ÂêçË©û',tags:['Â†¥ÊâÄ']}
    ],
    vibe: '„Éç„Ç™„É≥ÁÖå„ÇÅ„ÅèÊú™Êù•ÈÉΩÂ∏Ç„Åß‰Ωø„Çè„Çå„Çã„ÄÅ„Ç®„ÉÉ„Ç∏„ÅÆÂäπ„ÅÑ„ÅüË®ÄË™û„ÄÇÁü≠„ÅèÈã≠„ÅÑÈü≥„ÅåÁâπÂæ¥„ÄÇ',
    wordOrder: 'SVO'
  },
  ancient: {
    id: 'ancient', name: 'Âè§‰ª£Ë™ûÈ¢®', icon: 'üìú',
    description: 'Â®ÅÂé≥„ÅÇ„ÇãÈáçÂéö„Å™Èüø„Åç„ÄÇ„É©„ÉÜ„É≥Ë™û„ÉªÂè§‰ª£„ÇÆ„É™„Ç∑„É£Ë™û„ÅÆ„Çà„ÅÜ„Å™',
    phonology: { consonants: ['p','t','k','s','r','n','m','l','kh','ph'], vowels: ['a','e','i','o','u','ae','ei'] },
    syllableStructure: 'CVC',
    sampleWords: [
      {conlang:'imperator',meaning:'ÁöáÂ∏ù',pos:'ÂêçË©û',tags:['Áß∞Âè∑']},
      {conlang:'philosophia',meaning:'Áü•ÊÅµ„ÅÆÊÑõ',pos:'ÂêçË©û',tags:['Ê¶ÇÂøµ']},
      {conlang:'lexicon',meaning:'Ë®ÄËëâ„ÅÆÈõÜÁ©ç',pos:'ÂêçË©û',tags:['Êõ∏Áâ©']},
      {conlang:'virtus',meaning:'ÂãáÊ∞ó',pos:'ÂêçË©û',tags:['Âæ≥']},
      {conlang:'gloria',meaning:'Ê†ÑÂÖâ',pos:'ÂêçË©û',tags:['Ê¶ÇÂøµ']}
    ],
    vibe: 'Áü≥ÈÄ†„Çä„ÅÆÁ•ûÊÆø„Å´Âàª„Åæ„Çå„ÅüÁ¢ëÊñá„ÅÆ„Çà„ÅÜ„Å™„ÄÅÊ†ºÂºèÈ´ò„ÅÑÂè§ÂÖ∏Ë™û„ÄÇ',
    wordOrder: 'SOV'
  },
  kawaii: {
    id: 'kawaii', name: '„Åã„Çè„ÅÑ„ÅÑÁ≥ª', icon: 'üå∏',
    description: 'Êüî„Çâ„Åã„ÅèË¶™„Åó„Åø„ÇÑ„Åô„ÅÑÈüø„Åç„ÄÇÊó•Êú¨„ÅÆ„Åã„Çè„ÅÑ„ÅÑÊñáÂåñ',
    phonology: { consonants: ['p','k','n','m','r','y','w','h'], vowels: ['a','i','u','e','o'] },
    syllableStructure: 'CV',
    sampleWords: [
      {conlang:'puni',meaning:'„Åµ„Çè„Åµ„Çè',pos:'ÂΩ¢ÂÆπË©û',tags:['ÊÑüËß¶']},
      {conlang:'kyun',meaning:'„Å®„Åç„ÇÅ„Åç',pos:'ÂêçË©û',tags:['ÊÑüÊÉÖ']},
      {conlang:'mochi',meaning:'Êüî„Çâ„Åã„ÅÑÂèãÈÅî',pos:'ÂêçË©û',tags:['Áîü„ÅçÁâ©']},
      {conlang:'nyan',meaning:'Áå´„ÅÆ„Çà„ÅÜ„Å™',pos:'ÂΩ¢ÂÆπË©û',tags:['ÊßòÂ≠ê']},
      {conlang:'pika',meaning:'„Åç„Çâ„Åç„Çâ',pos:'ÂâØË©û',tags:['ÊßòÂ≠ê']}
    ],
    vibe: '„Åµ„Çì„Çè„Çä„Å®ÂÑ™„Åó„Åè„ÄÅËÅû„ÅÑ„Å¶„ÅÑ„Çã„Å†„Åë„ÅßÁ¨ëÈ°î„Å´„Å™„Çå„ÇãË®ÄË™û„ÄÇ',
    wordOrder: 'SOV'
  },
  dragon: {
    id: 'dragon', name: '„Éâ„É©„Ç¥„É≥Ë™ûÈ¢®', icon: 'üêâ',
    description: 'ÂäõÂº∑„ÅèËçòÂé≥„Å™Èüø„Åç„ÄÇÁÇé„ÅÆ„Çà„ÅÜ„Å™ÊøÄ„Åó„Åï',
    phonology: { consonants: ['d','g','r','z','kh','th','v','sh'], vowels: ['a','o','u','aa','uu'] },
    syllableStructure: 'CVC',
    sampleWords: [
      {conlang:'drakaar',meaning:'ÁÇé„ÅÆÊÅØ',pos:'ÂêçË©û',tags:['È≠îÊ≥ï']},
      {conlang:'zul',meaning:'Âäõ',pos:'ÂêçË©û',tags:['Ê¶ÇÂøµ']},
      {conlang:'groth',meaning:'Áøº',pos:'ÂêçË©û',tags:['Ë∫´‰Ωì']},
      {conlang:'vokun',meaning:'ÂΩ±',pos:'ÂêçË©û',tags:['Ëá™ÁÑ∂']},
      {conlang:'thur',meaning:'Ë¶áËÄÖ',pos:'ÂêçË©û',tags:['Áß∞Âè∑']}
    ],
    vibe: 'Âè§Á´ú„ÅåÂî∏„Çã„Çà„ÅÜ„Å™„ÄÅÊ∑±„ÅèÂÖ±È≥¥„Åô„ÇãË®ÄË™û„ÄÇÊ®©Â®Å„Å®ÁïèÊÄñ„ÇíÊÑü„Åò„Åï„Åõ„Çã„ÄÇ',
    wordOrder: 'VSO'
  },
  minimal: {
    id: 'minimal', name: '„Éü„Éã„Éû„É´', icon: '‚ñ´Ô∏è',
    description: '„Ç∑„É≥„Éó„É´„ÅßË¶ö„Åà„ÇÑ„Åô„ÅÑ„ÄÇÂàùÂøÉËÄÖ„Å´„Åä„Åô„Åô„ÇÅ',
    phonology: { consonants: ['k','t','p','n','m','s'], vowels: ['a','i','u'] },
    syllableStructure: 'CV',
    sampleWords: [
      {conlang:'toki',meaning:'Ë®ÄËëâ',pos:'ÂêçË©û',tags:['Âü∫Êú¨']},
      {conlang:'pana',meaning:'‰∏é„Åà„Çã',pos:'ÂãïË©û',tags:['Ë°åÁÇ∫']},
      {conlang:'suno',meaning:'Â§™ÈôΩ',pos:'ÂêçË©û',tags:['Ëá™ÁÑ∂']},
      {conlang:'mani',meaning:'„ÅäÈáë',pos:'ÂêçË©û',tags:['Áâ©']},
      {conlang:'sina',meaning:'„ÅÇ„Å™„Åü',pos:'‰ª£ÂêçË©û',tags:['Âü∫Êú¨']}
    ],
    vibe: 'ÂøÖË¶ÅÊúÄÂ∞èÈôê„ÅÆÈü≥Á¥†„ÅßÊúÄÂ§ßÈôê„ÅÆË°®Áèæ„Çí„ÄÇÂ≠¶„Å≥„ÇÑ„Åô„Åè‰Ωø„ÅÑ„ÇÑ„Åô„ÅÑ„ÄÇ',
    wordOrder: 'SVO'
  }
};

function applyTemplate(templateId){
  const template=LANGUAGE_TEMPLATES[templateId];
  if(!template)return false;
  if(S.dictionary.length>0){
    if(!confirm(`„ÉÜ„É≥„Éó„É¨„Éº„Éà„Äå${template.name}„Äç„ÇíÈÅ©Áî®„Åô„Çã„Å®„ÄÅÁèæÂú®„ÅÆË®≠ÂÆö„Åå‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü`))return false;
  }
  S.phoneme.consonants=[...template.phonology.consonants];
  S.phoneme.vowels=[...template.phonology.vowels];
  S.dictionary=[...template.sampleWords];
  if(S.vibe.length===0)S.vibe.push({category:'„Ç≥„É≥„Çª„Éó„Éà',description:template.vibe});
  S.grammar.wordOrder=template.wordOrder;
  scheduleSave();updateDashboard();
  showToast(`‚ú® „ÉÜ„É≥„Éó„É¨„Éº„Éà„Äå${template.name}„Äç„ÇíÈÅ©Áî®„Åó„Åæ„Åó„ÅüÔºÅ`,'success');
  if(typeof completeQuest==='function')completeQuest('use_template');
  return true;
}

function showTemplateSelector(){
  const html=`<div class="editor-overlay open" id="template-selector" onclick="if(event.target===this)closeTemplateSelector()">
    <div class="editor-panel" style="max-width:900px">
      <div class="editor-handle"></div>
      <div class="editor-header">
        <div><div class="editor-title">üé® „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÈÅ∏Êäû</div>
        <div class="editor-desc">„Éó„É™„Çª„ÉÉ„Éà„Åã„ÇâÂßã„ÇÅ„Å¶„ÄÅ„ÅÇ„Å™„ÅüÂ•Ω„Åø„Å´„Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Åó„Åæ„Åó„Çá„ÅÜ</div></div>
        <button class="editor-close" onclick="closeTemplateSelector()">√ó</button>
      </div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;margin-top:20px">
        ${Object.values(LANGUAGE_TEMPLATES).map(t=>`<div class="template-card" onclick="selectTemplate('${t.id}')">
          <div class="template-icon">${t.icon}</div>
          <div class="template-name">${t.name}</div>
          <div class="template-desc">${t.description}</div>
          <div class="template-phonemes">
            <span>Â≠êÈü≥: ${t.phonology.consonants.slice(0,5).join(' ')}</span>
            <span>ÊØçÈü≥: ${t.phonology.vowels.slice(0,4).join(' ')}</span>
          </div>
          <div class="template-sample">‰æã: ${t.sampleWords[0].conlang}</div>
        </div>`).join('')}
      </div>
      <div style="margin-top:24px;padding-top:20px;border-top:1px solid var(--border);display:flex;justify-content:center;gap:10px">
        <button class="btn btn-ghost" onclick="closeTemplateSelector()">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="btn" onclick="closeTemplateSelector();openEditor('phoneme')">üíé „Çº„É≠„Åã„Çâ‰ΩúÊàê</button>
      </div>
    </div>
  </div>`;
  document.body.insertAdjacentHTML('beforeend',html);
}

function selectTemplate(id){
  closeTemplateSelector();
  applyTemplate(id);
}

function closeTemplateSelector(){
  const selector=document.getElementById('template-selector');
  if(selector)selector.remove();
}

// „Éà„Éº„Çπ„ÉàÈÄöÁü•
function showToast(message,type='info'){
  const colors={success:'var(--success)',error:'var(--rose)',info:'var(--accent)'};
  const toast=document.createElement('div');
  toast.style.cssText=`position:fixed;bottom:calc(var(--bottom-nav-h) + 20px);left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid ${colors[type]};border-radius:12px;padding:12px 20px;font-size:0.85rem;color:${colors[type]};z-index:1000;box-shadow:0 8px 32px rgba(0,0,0,0.4);animation:slideUp 0.3s ease`;
  toast.textContent=message;
  document.body.appendChild(toast);
  setTimeout(()=>{toast.style.opacity='0';toast.style.transform='translateX(-50%) translateY(10px)';setTimeout(()=>toast.remove(),300)},3000);
}

// „Ç™„É≥„Éú„Éº„Éá„Ç£„É≥„Ç∞„ÇØ„Ç®„Çπ„Éà
const ONBOARDING_QUESTS=[
  {id:'name_lang',title:'Ë®ÄË™û„Å´ÂêçÂâç„Çí„Å§„Åë„Çà„ÅÜ',description:'„ÅÇ„Å™„Åü„ÅÆË®ÄË™û„ÅÆÂêçÂâç„ÇíÊ±∫„ÇÅ„Åæ„Åó„Çá„ÅÜ',icon:'‚ú®',reward:10,
   check:()=>S.langName&&S.langName.length>0,
   action:()=>{const name=prompt('Ë®ÄË™û„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:',S.langName||'');if(name){S.langName=name;scheduleSave();updateDashboard()}}},
  {id:'use_template',title:'„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíË©¶„Åù„ÅÜ',description:'„Éó„É™„Çª„ÉÉ„Éà„Åã„ÇâÂßã„ÇÅ„Çã„Å®Á∞°Âçò„Åß„Åô',icon:'üé®',reward:15,
   check:()=>S.dictionary.length>=5,action:()=>showTemplateSelector()},
  {id:'first_word',title:'ÊúÄÂàù„ÅÆÂçòË™û„ÇíÁôªÈå≤',description:'ËæûÊõ∏„Å´1„Å§ÁõÆ„ÅÆÂçòË™û„ÇíËøΩÂä†',icon:'üìñ',reward:20,
   check:()=>S.dictionary.length>=1,action:()=>openEditor('vocab')},
  {id:'five_words',title:'5„Å§„ÅÆÂçòË™û„ÇíÁôªÈå≤',description:'Ë™ûÂΩô„ÇíÂ¢ó„ÇÑ„Åó„Å¶Ë°®ÁèæÂäõ„Ç¢„ÉÉ„Éó',icon:'üìö',reward:30,
   check:()=>S.dictionary.length>=5,action:()=>openEditor('vocab')},
  {id:'set_phonology',title:'Èü≥Èüª„Ç∑„Çπ„ÉÜ„É†„ÇíË®≠ÂÆö',description:'Ë®ÄË™û„ÅÆÈü≥„ÇíÂÆöÁæ©„Åó„Åæ„Åó„Çá„ÅÜ',icon:'üîä',reward:25,
   check:()=>S.phoneme.consonants.length>=5&&S.phoneme.vowels.length>=3,action:()=>openEditor('phoneme')},
  {id:'first_sentence',title:'ÊúÄÂàù„ÅÆÊñá„Çí‰ΩúÊàê',description:'‰æãÊñá„Çí1„Å§ËøΩÂä†„Åó„Åæ„Åó„Çá„ÅÜ',icon:'üí¨',reward:35,
   check:()=>S.corpus.length>=1,action:()=>openEditor('corpus')},
  {id:'share_card',title:'„Ç∑„Çß„Ç¢„Ç´„Éº„Éâ„ÇíÁîüÊàê',description:'‰ΩúÂìÅ„ÇíSNS„Åß„Ç∑„Çß„Ç¢„Åó„Çà„ÅÜ',icon:'üé¥',reward:40,
   check:()=>localStorage.getItem('lingua_shared')==='true',action:()=>generateShareCard()},
  {id:'flashcard_10',title:'„Éï„É©„ÉÉ„Ç∑„É•„Ç´„Éº„Éâ„Çí10Âõû',description:'Ë™ûÂΩô„ÇíÂæ©Áøí„Åó„Å¶ÂÆöÁùÄ„Åï„Åõ„Çà„ÅÜ',icon:'üÉè',reward:50,
   check:()=>{const count=parseInt(localStorage.getItem('lingua_fc_count')||'0');return count>=10},
   action:()=>{goTo('vocab');setTimeout(()=>{const fcBtn=document.querySelector('[onclick*="launchFlashcard"]');if(fcBtn)fcBtn.scrollIntoView({behavior:'smooth',block:'center'})},300)}}
];

function saveQuestProgress(){
  const completed=ONBOARDING_QUESTS.filter(q=>q.check()).map(q=>q.id);
  localStorage.setItem('lingua_quests_completed',JSON.stringify(completed));
}

function getCompletedQuests(){
  try{return JSON.parse(localStorage.getItem('lingua_quests_completed')||'[]')}catch{return[]}
}

function completeQuest(questId){
  const completed=getCompletedQuests();
  if(!completed.includes(questId)){
    completed.push(questId);
    localStorage.setItem('lingua_quests_completed',JSON.stringify(completed));
    const quest=ONBOARDING_QUESTS.find(q=>q.id===questId);
    if(quest)showQuestCompleteAnimation(quest);
    updateQuestDisplay();
  }
}

function showQuestCompleteAnimation(quest){
  const popup=document.createElement('div');
  popup.style.cssText=`position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0.8);background:var(--surface);border:2px solid var(--gold-border);border-radius:20px;padding:32px;text-align:center;z-index:9999;box-shadow:0 20px 60px rgba(0,0,0,0.6),0 0 80px var(--gold);animation:questPop 0.5s cubic-bezier(0.68,-0.55,0.265,1.55);max-width:90vw`;
  popup.innerHTML=`<div style="font-size:4rem;margin-bottom:16px;animation:bounce 0.6s ease infinite">${quest.icon}</div>
    <div style="font-size:1.2rem;font-weight:700;color:var(--gold);margin-bottom:8px">„ÇØ„Ç®„Çπ„ÉàÈÅîÊàêÔºÅ</div>
    <div style="font-size:0.95rem;color:var(--text-primary);margin-bottom:16px">${quest.title}</div>
    <div style="font-size:1.4rem;font-weight:700;color:var(--accent);font-family:'Cinzel',serif">+${quest.reward} XP ‚≠ê</div>`;
  document.body.appendChild(popup);
  setTimeout(()=>{popup.style.transition='all 0.3s ease';popup.style.opacity='0';popup.style.transform='translate(-50%,-50%) scale(0.9)';setTimeout(()=>popup.remove(),300)},2500);
}

function updateQuestDisplay(){
  const container=document.getElementById('quest-container');
  if(!container)return;
  const completed=getCompletedQuests();
  const totalXP=completed.reduce((sum,id)=>{const quest=ONBOARDING_QUESTS.find(q=>q.id===id);return sum+(quest?quest.reward:0)},0);
  const nextQuest=ONBOARDING_QUESTS.find(q=>!completed.includes(q.id));
  if(!nextQuest){
    container.innerHTML=`<div style="background:linear-gradient(135deg,var(--gold-dim),var(--accent-dim));border:2px solid var(--gold-border);border-radius:14px;padding:24px;text-align:center">
      <div style="font-size:3rem;margin-bottom:12px">üèÜ</div>
      <div style="font-size:1.1rem;font-weight:700;color:var(--gold);margin-bottom:6px">ÂÖ®„ÇØ„Ç®„Çπ„ÉàÈÅîÊàêÔºÅ</div>
      <div style="font-size:0.85rem;color:var(--text-secondary)">ÂêàË®à ${totalXP} XP „ÇíÁç≤Âæó„Åó„Åæ„Åó„Åü</div></div>`;
    return;
  }
  const progress=(completed.length/ONBOARDING_QUESTS.length)*100;
  container.innerHTML=`<div style="margin-bottom:20px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div style="font-size:0.75rem;font-weight:600;color:var(--accent);letter-spacing:0.1em">‚≠ê ${totalXP} XP</div>
      <div style="font-size:0.7rem;color:var(--text-muted)">${completed.length} / ${ONBOARDING_QUESTS.length} ÂÆå‰∫Ü</div>
    </div>
    <div style="height:8px;background:var(--surface-3);border-radius:4px;overflow:hidden">
      <div style="height:100%;background:linear-gradient(90deg,var(--accent),var(--gold));border-radius:4px;transition:width 0.5s ease;width:${progress}%"></div>
    </div></div>
    <div class="onboarding-quest" onclick="(${nextQuest.action})()">
      <div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--gold),transparent)"></div>
      <div style="display:flex;align-items:center;gap:16px">
        <div style="font-size:2.5rem;flex-shrink:0">${nextQuest.icon}</div>
        <div style="flex:1">
          <div style="font-size:0.95rem;font-weight:700;color:var(--text-primary);margin-bottom:4px">${nextQuest.title}</div>
          <div style="font-size:0.78rem;color:var(--text-secondary);line-height:1.5">${nextQuest.description}</div>
        </div>
        <div style="text-align:center;flex-shrink:0">
          <div style="font-size:1.2rem;font-weight:700;color:var(--gold);font-family:'Cinzel',serif">+${nextQuest.reward}</div>
          <div style="font-size:0.6rem;color:var(--text-muted);letter-spacing:0.08em">XP</div>
        </div>
      </div>
    </div>`;
}

function initQuests(){
  ONBOARDING_QUESTS.forEach(quest=>{if(quest.check())completeQuest(quest.id)});
  updateQuestDisplay();
}

function checkQuestsAfterAction(){
  saveQuestProgress();
  updateQuestDisplay();
}

// „Ç∑„Çß„Ç¢„Ç´„Éº„ÉâÁîüÊàê
function generateShareCard(word=null,customText=null){
  if(!word&&S.dictionary.length>0){
    word=S.dictionary[Math.floor(Math.random()*S.dictionary.length)];
  }
  if(!word&&!customText){alert('„Ç∑„Çß„Ç¢„Åô„ÇãÂÜÖÂÆπ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂÖà„Å´ÂçòË™û„ÇíÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');return}
  const canvas=document.createElement('canvas');
  canvas.width=1200;canvas.height=630;
  const ctx=canvas.getContext('2d');
  const gradient=ctx.createLinearGradient(0,0,1200,630);
  gradient.addColorStop(0,'#1a0a2e');gradient.addColorStop(0.5,'#0e1a2e');gradient.addColorStop(1,'#0a0a1e');
  ctx.fillStyle=gradient;ctx.fillRect(0,0,1200,630);
  ctx.fillStyle='rgba(255,255,255,0.8)';
  for(let i=0;i<100;i++){
    const x=Math.random()*1200,y=Math.random()*630,r=Math.random()*2;
    ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fill();
  }
  const glowGradient=ctx.createRadialGradient(600,315,0,600,315,400);
  glowGradient.addColorStop(0,'rgba(140,126,255,0.15)');glowGradient.addColorStop(1,'transparent');
  ctx.fillStyle=glowGradient;ctx.fillRect(0,0,1200,630);
  if(word){
    ctx.font='600 28px "Noto Sans JP", sans-serif';ctx.fillStyle='#8a8498';ctx.textAlign='center';
    ctx.fillText(S.langName||'My Conlang',600,120);
    ctx.font='700 120px "Cinzel", serif';ctx.fillStyle='#8c7eff';ctx.shadowColor='rgba(140,126,255,0.6)';ctx.shadowBlur=30;
    ctx.fillText(word.conlang,600,280);ctx.shadowBlur=0;
    if(word.read){ctx.font='400 40px monospace';ctx.fillStyle='#c07bff';ctx.fillText(`[${word.read}]`,600,340)}
    ctx.font='500 48px "Noto Sans JP", sans-serif';ctx.fillStyle='#e8e4f0';ctx.fillText(word.meaning,600,420);
    if(word.pos){ctx.font='600 28px "Noto Sans JP", sans-serif';ctx.fillStyle='#c9a96e';ctx.fillText(word.pos,600,470)}
  }
  ctx.font='600 32px "Cinzel", serif';ctx.fillStyle='#44404e';ctx.textAlign='center';ctx.fillText('‚ú¶ LINGUA',600,580);
  showShareCardDialog(canvas);
  localStorage.setItem('lingua_shared','true');
  if(typeof completeQuest==='function')completeQuest('share_card');
}

function showShareCardDialog(canvas){
  const dataURL=canvas.toDataURL('image/png');
  const dialog=document.createElement('div');
  dialog.className='editor-overlay open';
  dialog.onclick=(e)=>{if(e.target===dialog)dialog.remove()};
  dialog.innerHTML=`<div class="editor-panel" style="max-width:700px" onclick="event.stopPropagation()">
    <div class="editor-handle"></div>
    <div class="editor-header">
      <div><div class="editor-title">üé¥ „Ç∑„Çß„Ç¢„Ç´„Éº„Éâ„ÅåÂÆåÊàê„Åó„Åæ„Åó„Åü</div>
      <div class="editor-desc">SNS„Å´ÊäïÁ®ø„Åó„Å¶„ÄÅ„ÅÇ„Å™„Åü„ÅÆË®ÄË™û„Çí‰∏ñÁïå„Å´Â∫É„ÇÅ„Åæ„Åó„Çá„ÅÜ</div></div>
      <button class="editor-close" onclick="this.closest('.editor-overlay').remove()">√ó</button>
    </div>
    <div style="margin:24px 0">
      <img src="${dataURL}" style="width:100%;border-radius:12px;border:1px solid var(--border-hover);box-shadow:0 8px 32px rgba(0,0,0,0.3)">
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <button class="btn btn-primary" onclick="downloadShareCard('${dataURL}')">üì• ÁîªÂÉè„Çí‰øùÂ≠ò</button>
      <button class="btn" onclick="copyShareCard('${dataURL}')">üìã „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº</button>
    </div>
    <div style="margin-top:16px;padding:14px;background:var(--surface-2);border:1px solid var(--border);border-radius:10px;font-size:0.78rem;color:var(--text-secondary);line-height:1.7">
      <strong style="color:var(--text-primary)">üí° ÊäïÁ®ø„ÅÆ„Éí„É≥„Éà:</strong><br>
      „Äå#„Ç≥„É≥„É©„É≥„Ç∞ #‰∫∫Â∑•Ë®ÄË™û #Lingua„Äç„Å™„Å©„ÅÆ„Éè„ÉÉ„Ç∑„É•„Çø„Ç∞„Çí„Å§„Åë„Çã„Å®„ÄÅÂêå„ÅòË∂£Âë≥„ÅÆ‰∫∫„Å´Â±ä„Åç„ÇÑ„Åô„Åè„Å™„Çä„Åæ„ÅôÔºÅ
    </div>
  </div>`;
  document.body.appendChild(dialog);
}

function downloadShareCard(dataURL){
  const link=document.createElement('a');
  link.download=`${S.langName||'conlang'}_share.png`;
  link.href=dataURL;
  link.click();
  showToast('‚úÖ ÁîªÂÉè„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü','success');
}

async function copyShareCard(dataURL){
  try{
    const response=await fetch(dataURL);
    const blob=await response.blob();
    await navigator.clipboard.write([new ClipboardItem({'image/png':blob})]);
    showToast('‚úÖ „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü','success');
  }catch(err){
    console.error('Copy failed:',err);
    showToast('‚ùå „Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü','error');
  }
}

// ===== END V21 FEATURES =====

// ===== END V9 FUNCTIONS =====

// ==== INIT (V9) ====
(function(){
  // WelcomeÁîªÈù¢„Å´„Éà„ÉÉ„Éó„Éä„Éì„ÇíÈùûË°®Á§∫
  document.getElementById('topbar-nav').style.display='none';

  // ‰øùÂ≠ò„Éá„Éº„Çø„ÅÆÁ¢∫Ë™ç
  try {
    const raw = localStorage.getItem('lingua_v13_state');
    if (raw) {
      const parsed = JSON.parse(raw);
      const langName = parsed.langName || '';
      const hasContent = parsed.dictionary?.length > 0 || parsed.corpus?.length > 0 || parsed.vibe?.length > 0;
      if (hasContent && langName) {
        const restoreEl = document.getElementById('w-restore');
        const restoreNameEl = document.getElementById('w-restore-name');
        if (restoreEl) restoreEl.style.display = 'block';
        if (restoreNameEl) restoreNameEl.textContent = langName;
        // ÂÖ•ÂäõÊ¨Ñ„Å´„ÇÇÂâçÂõû„ÅÆÂêçÂâç„ÇíÂèçÊò†
        const nameEl = document.getElementById('w-langname');
        if (nameEl) nameEl.value = langName;
      }
      // Restore V9 state fields
      if(parsed.visibility) S.visibility = parsed.visibility;
      if(parsed.importable) S.importable = parsed.importable;
      if(parsed.lang) S.lang = parsed.lang;
    }
  } catch(e) {}

  // Apply i18n
  applyI18n();

  // V16: Ë™çË®º„ÉªPro„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ
  initAuth();

  // V11: blur auto-save + ipa tap feedback
  initBlurSave();

  // V13: init lang display
  const ltbInit=document.getElementById('lang-cur');
  const LS={ja:'JA',en:'EN',zh:'‰∏≠Êñá',es:'ES'};
  if(ltbInit)ltbInit.textContent=LS[S.lang]||S.lang.toUpperCase();

  // V25: Ê±∫Ê∏àÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('payment') === 'success') {
    const plan = urlParams.get('plan');
    setTimeout(() => showPaymentSuccessModal(plan), 1000);
    window.history.replaceState({}, '', window.location.pathname);
  }

  // V21: Init quests - „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´ÂÖ•„Å£„ÅüÊôÇ„ÅÆ„ÅøÂàùÊúüÂåñ
  // („É≠„Ç∞„Ç§„É≥ÁîªÈù¢„ÅßÂÆüË°å„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´‰øÆÊ≠£)

  // goTo('login') „ÅØ‰∏çË¶Å ‚Äî page-login„ÅØ„Éá„Éï„Ç©„É´„Éà„Åßactive
})();

// ===== V25 Ê≥ïÁöÑË°®Ë®ò„ÉªÂà©Áî®Ë¶èÁ¥Ñ =====
const LEGAL_CONTENT = {
  tokusho: {
    title: 'ÁâπÂÆöÂïÜÂèñÂºïÊ≥ï„Å´Âü∫„Å•„ÅèË°®Ë®ò',
    content: `
      <div style="margin-bottom:24px;">
        <h3 style="font-size:1rem;font-weight:700;color:var(--text-primary);margin-bottom:12px;">Ë≤©Â£≤Ê•≠ËÄÖ</h3>
        <p>LinguaÈÅãÂñ∂‰∫ãÂãôÂ±Ä<br>
        „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ: support@lingua-app.com</p>
      </div>

      <div style="margin-bottom:24px;">
        <h3 style="font-size:1rem;font-weight:700;color:var(--text-primary);margin-bottom:12px;">„Çµ„Éº„Éì„ÇπÂÜÖÂÆπ</h3>
        <p>‰∫∫Â∑•Ë®ÄË™ûÔºà„Ç≥„É≥„É©„É≥„Ç∞Ôºâ‰ΩúÊàêÊîØÊè¥„Çµ„Éº„Éì„Çπ<br>
        „ÉªFree„Éó„É©„É≥: ÁÑ°ÊñôÔºàAIÊ©üËÉΩ1Êó•10Âõû„Åæ„ÅßÔºâ<br>
        „ÉªLite„Éó„É©„É≥: ÊúàÈ°ç$9.9ÔºàAIÊ©üËÉΩ1Êó•50Âõû„Åæ„ÅßÔºâ<br>
        „ÉªPro„Éó„É©„É≥: ÊúàÈ°ç$19.9ÔºàAIÊ©üËÉΩ1Êó•100Âõû„Åæ„ÅßÔºâ</p>
      </div>

      <div style="margin-bottom:24px;">
        <h3 style="font-size:1rem;font-weight:700;color:var(--text-primary);margin-bottom:12px;">ÊñôÈáë„ÉªÊîØÊâï„ÅÑÊñπÊ≥ï</h3>
        <p>„ÉªÊúàÈ°çÊñôÈáë„ÅØÊØéÊúàËá™ÂãïÊõ¥Êñ∞„Åï„Çå„Åæ„Åô<br>
        „ÉªÊîØÊâï„ÅÑÊñπÊ≥ï: „ÇØ„É¨„Ç∏„ÉÉ„Éà„Ç´„Éº„ÉâÔºàStripeÁµåÁî±Ôºâ<br>
        „ÉªÊ±∫Ê∏à„Çø„Ç§„Éü„É≥„Ç∞: ÂàùÂõûÁôªÈå≤ÊôÇ„Åä„Çà„Å≥ÊØéÊúà„ÅÆÊõ¥Êñ∞Êó•</p>
      </div>

      <div style="margin-bottom:24px;">
        <h3 style="font-size:1rem;font-weight:700;color:var(--text-primary);margin-bottom:12px;">ËøîÂìÅ„Éª„Ç≠„É£„É≥„Çª„É´„ÉªËß£Á¥Ñ</h3>
        <p>„Éª„Éá„Ç∏„Çø„É´„Çµ„Éº„Éì„Çπ„ÅÆÊÄßË≥™‰∏ä„ÄÅËøîÈáë„ÅØÂéüÂâá„Å®„Åó„Å¶Êâø„Å£„Å¶„Åä„Çä„Åæ„Åõ„Çì<br>
        „ÉªËß£Á¥Ñ„ÅØ„ÅÑ„Å§„Åß„ÇÇÂèØËÉΩ„Åß„Åô„ÄÇËß£Á¥ÑÂæå„ÇÇÂΩìÊúàÊú´„Åæ„ÅßÂà©Áî®ÂèØËÉΩ„Åß„Åô<br>
        „ÉªËß£Á¥ÑÊñπÊ≥ï: support@lingua-app.com „Åæ„Åß„ÅîÈÄ£Áµ°„Åè„Å†„Åï„ÅÑ</p>
      </div>
    `
  },
  terms: {
    title: 'Âà©Áî®Ë¶èÁ¥Ñ',
    content: `
      <div style="margin-bottom:24px;">
        <h3 style="font-size:1rem;font-weight:700;color:var(--text-primary);margin-bottom:12px;">Á¨¨1Êù°ÔºàÈÅ©Áî®Ôºâ</h3>
        <p>Êú¨Ë¶èÁ¥Ñ„ÅØ„ÄÅLinguaÔºà‰ª•‰∏ã„ÄåÂΩì„Çµ„Éº„Éì„Çπ„ÄçÔºâ„ÅÆÂà©Áî®„Å´Èñ¢„Åô„ÇãÊù°‰ª∂„ÇíÂÆö„ÇÅ„Çã„ÇÇ„ÅÆ„Åß„Åô„ÄÇ</p>
      </div>

      <div style="margin-bottom:24px;">
        <h3 style="font-size:1rem;font-weight:700;color:var(--text-primary);margin-bottom:12px;">Á¨¨2Êù°ÔºàÁ¶ÅÊ≠¢‰∫ãÈ†ÖÔºâ</h3>
        <p>Âà©Áî®ËÄÖ„ÅØ„ÄÅ‰ª•‰∏ã„ÅÆË°åÁÇ∫„ÇíË°å„Å£„Å¶„ÅØ„Å™„Çä„Åæ„Åõ„ÇìÔºö<br>
        „ÉªÊ≥ï‰ª§„Åæ„Åü„ÅØÂÖ¨Â∫èËâØ‰øó„Å´ÈÅïÂèç„Åô„ÇãË°åÁÇ∫<br>
        „Éª„Çµ„Éº„Éì„Çπ„ÅÆÈÅãÂñ∂„ÇíÂ¶®ÂÆ≥„Åô„ÇãË°åÁÇ∫<br>
        „Éª‰ªñ„ÅÆÂà©Áî®ËÄÖ„Åæ„Åü„ÅØÁ¨¨‰∏âËÄÖ„ÅÆÊ®©Âà©„Çí‰æµÂÆ≥„Åô„ÇãË°åÁÇ∫</p>
      </div>

      <div style="margin-bottom:24px;">
        <h3 style="font-size:1rem;font-weight:700;color:var(--text-primary);margin-bottom:12px;">Á¨¨3Êù°ÔºàAIÊ©üËÉΩ„ÅÆÂà©Áî®Ôºâ</h3>
        <p>„ÉªAIÊ©üËÉΩ„ÅØÂ§ñÈÉ®API„ÇíÂà©Áî®„Åó„Å¶Êèê‰æõ„Åï„Çå„Åæ„Åô<br>
        „ÉªÁîüÊàê„Åï„Çå„Åü„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆËëó‰ΩúÊ®©„ÅØÂà©Áî®ËÄÖ„Å´Â∏∞Â±û„Åó„Åæ„Åô<br>
        „Éª„Éó„É©„É≥ÊØé„ÅÆÂà©Áî®ÂõûÊï∞Âà∂Èôê„Åå„ÅÇ„Çä„Åæ„Åô</p>
      </div>

      <div style="margin-bottom:24px;">
        <h3 style="font-size:1rem;font-weight:700;color:var(--text-primary);margin-bottom:12px;">Á¨¨4Êù°ÔºàÂÖçË≤¨‰∫ãÈ†ÖÔºâ</h3>
        <p>„Çµ„Éº„Éì„Çπ„ÅÆ‰∏≠Êñ≠„ÄÅ„Ç®„É©„Éº„ÄÅ„Éá„Éº„ÇøÊêçÂ§±„Å´„Å§„ÅÑ„Å¶‰∏ÄÂàá„ÅÆË≤¨‰ªª„ÇíË≤†„ÅÑ„Åæ„Åõ„Çì„ÄÇ</p>
      </div>
    `
  },
  privacy: {
    title: '„Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº',
    content: `
      <div style="margin-bottom:24px;">
        <h3 style="font-size:1rem;font-weight:700;color:var(--text-primary);margin-bottom:12px;">1. ÂèéÈõÜ„Åô„ÇãÊÉÖÂ†±</h3>
        <p>ÂΩì„Çµ„Éº„Éì„Çπ„Åß„ÅØ‰ª•‰∏ã„ÅÆÊÉÖÂ†±„ÇíÂèéÈõÜ„Åó„Åæ„ÅôÔºö<br>
        „ÉªGoogleË™çË®ºÊÉÖÂ†±Ôºà„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÄÅË°®Á§∫ÂêçÔºâ<br>
        „Éª‰ΩúÊàê„Åï„Çå„ÅüË®ÄË™û„Éá„Éº„ÇøÔºàÂçòË™û„ÄÅÊñáÊ≥ï„ÄÅ‰æãÊñáÁ≠âÔºâ<br>
        „ÉªÂà©Áî®Áä∂Ê≥ÅÔºà„É≠„Ç∞„Ç§„É≥Â±•Ê≠¥„ÄÅAIÂà©Áî®ÂõûÊï∞Ôºâ</p>
      </div>

      <div style="margin-bottom:24px;">
        <h3 style="font-size:1rem;font-weight:700;color:var(--text-primary);margin-bottom:12px;">2. Â§ñÈÉ®„Çµ„Éº„Éì„Çπ„ÅÆÂà©Áî®</h3>
        <p>ÂΩì„Çµ„Éº„Éì„Çπ„ÅØ‰ª•‰∏ã„ÅÆÂ§ñÈÉ®„Çµ„Éº„Éì„Çπ„ÇíÂà©Áî®„Åó„Å¶„ÅÑ„Åæ„ÅôÔºö<br>
        „ÉªFirebaseÔºàGoogleÔºâ: Ë™çË®º„ÄÅ„Éá„Éº„Çø„Éô„Éº„Çπ<br>
        „ÉªStripe: Ê±∫Ê∏àÂá¶ÁêÜ<br>
        „ÉªAnthropic Claude API: AIÊ©üËÉΩ</p>
      </div>

      <div style="margin-bottom:24px;">
        <h3 style="font-size:1rem;font-weight:700;color:var(--text-primary);margin-bottom:12px;">3. „ÅäÂïè„ÅÑÂêà„Çè„Åõ</h3>
        <p>„Éó„É©„Ç§„Éê„Ç∑„Éº„Å´Èñ¢„Åô„Çã„ÅäÂïè„ÅÑÂêà„Çè„ÅõÔºö<br>
        support@lingua-app.com</p>
      </div>
    `
  }
};

function showLegalModal(type) {
  const modal = document.getElementById('legal-modal');
  if (!modal) return;
  
  const title = document.getElementById('legal-modal-title');
  const content = document.getElementById('legal-modal-content');
  
  const data = LEGAL_CONTENT[type];
  if (!data) return;
  
  title.textContent = data.title;
  content.innerHTML = data.content;
  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeLegalModal() {
  const modal = document.getElementById('legal-modal');
  if (!modal) return;
  modal.style.display = 'none';
  document.body.style.overflow = '';
}

function openCustomerPortal() {
  const overlay = document.createElement('div');
  overlay.className = 'editor-overlay open';
  overlay.style.cssText = 'display:flex;z-index:9999;';
  overlay.innerHTML = `
    <div class="editor-panel" style="max-width:500px;">
      <div class="editor-header">
        <div>
          <div class="editor-title">„Çµ„Éñ„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥ÁÆ°ÁêÜ</div>
        </div>
        <button class="editor-close" onclick="this.closest('.editor-overlay').remove()">√ó</button>
      </div>
      <div style="padding:20px 4px;font-size:0.9rem;line-height:1.8;color:var(--text-secondary);">
        <p style="margin-bottom:16px;">
          „Çµ„Éñ„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥„ÅÆÂ§âÊõ¥„ÉªËß£Á¥Ñ„Çí„ÅîÂ∏åÊúõ„ÅÆÂ†¥Âêà„ÅØ„ÄÅ<br>
          ‰ª•‰∏ã„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Åæ„Åß„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑÔºö
        </p>
        <div style="background:var(--surface-2);padding:16px;border-radius:10px;text-align:center;margin-bottom:16px;">
          <a href="mailto:support@lingua-app.com?subject=„Çµ„Éñ„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥ÁÆ°ÁêÜ„Å´„Å§„ÅÑ„Å¶" 
             style="color:var(--accent);font-weight:700;text-decoration:none;font-size:1.05rem;">
            support@lingua-app.com
          </a>
        </div>
        <p style="font-size:0.8rem;color:var(--text-muted);">
          ‚Äª Ëß£Á¥ÑÂæå„ÇÇÂΩìÊúàÊú´„Åæ„ÅßÂà©Áî®ÂèØËÉΩ„Åß„Åô<br>
          ‚Äª ÈÄöÂ∏∏24ÊôÇÈñì‰ª•ÂÜÖ„Å´ÂØæÂøú„ÅÑ„Åü„Åó„Åæ„Åô
        </p>
      </div>
      <div style="padding:0 24px 24px;">
        <button class="btn btn-ghost" onclick="this.closest('.editor-overlay').remove();">
          Èñâ„Åò„Çã
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
}
</script>

<!-- Ê≥ïÁöÑË°®Ë®ò„É¢„Éº„ÉÄ„É´ -->
<div id="legal-modal" class="editor-overlay" style="display:none;" onclick="if(event.target===this)closeLegalModal()">
  <div class="editor-panel" style="max-width:800px;max-height:90dvh;overflow-y:auto;" onclick="event.stopPropagation()">
    <div class="editor-handle"></div>
    <div class="editor-header">
      <div>
        <div class="editor-title" id="legal-modal-title">Ê≥ïÁöÑË°®Ë®ò</div>
      </div>
      <button class="editor-close" onclick="closeLegalModal()">√ó</button>
    </div>
    <div id="legal-modal-content" style="padding:0 4px;font-size:0.85rem;line-height:1.9;color:var(--text-secondary);">
      <!-- „Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅØÂãïÁöÑ„Å´ÊåøÂÖ• -->
    </div>
  </div>
</div>

<!-- „Éï„ÉÉ„Çø„Éº -->
<footer style="background:var(--surface);border-top:1px solid var(--border);padding:32px 24px;margin-top:60px;text-align:center;margin-bottom:calc(var(--bottom-nav-h) + 10px);">
  <div style="max-width:1040px;margin:0 auto;">
    <div style="font-family:'Cinzel',serif;font-size:1.2rem;font-weight:700;margin-bottom:16px;background:linear-gradient(135deg,#e8e4f0,#8c7eff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">
      ‚ú¶ LINGUA
    </div>
    <div style="font-size:0.78rem;color:var(--text-secondary);margin-bottom:20px;line-height:1.8;">
      „ÅÇ„Å™„Åü„Å†„Åë„ÅÆË®ÄË™û„ÇíÂâµÈÄ†„Åó„ÄÅÂ≠¶„Å≥„ÄÅÂÖ±Êúâ„Åô„Çã„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†
    </div>
    <div style="display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin-bottom:20px;">
      <a href="#" onclick="showLegalModal('tokusho');return false;" style="color:var(--text-secondary);text-decoration:none;font-size:0.75rem;transition:color 0.15s;cursor:pointer;">
        ÁâπÂÆöÂïÜÂèñÂºïÊ≥ï„Å´Âü∫„Å•„ÅèË°®Ë®ò
      </a>
      <a href="#" onclick="showLegalModal('terms');return false;" style="color:var(--text-secondary);text-decoration:none;font-size:0.75rem;transition:color 0.15s;cursor:pointer;">
        Âà©Áî®Ë¶èÁ¥Ñ
      </a>
      <a href="#" onclick="showLegalModal('privacy');return false;" style="color:var(--text-secondary);text-decoration:none;font-size:0.75rem;transition:color 0.15s;cursor:pointer;">
        „Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº
      </a>
      <a href="#" onclick="goTo('contact');return false;" style="color:var(--text-secondary);text-decoration:none;font-size:0.75rem;transition:color 0.15s;cursor:pointer;">
        üí¨ „ÅäÂïè„ÅÑÂêà„Çè„Åõ
      </a>
    </div>
    <div style="font-size:0.68rem;color:var(--text-muted);">
      ¬© 2025 Lingua. All rights reserved.
    </div>
  </div>
</footer>

<script>
// ===== „É°„É¢ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É† =====
let MEMOS = [];
let currentEditingMemoId = null;

// „É°„É¢„ÇíIndexedDB„Åã„ÇâË™≠„ÅøËæº„Åø
async function loadMemosFromDB() {
  try {
    const memos = await dbGet('app_memos');
    MEMOS = memos || [];
    renderMemoList();
  } catch(error) {
    console.error('Failed to load memos:', error);
    MEMOS = [];
    renderMemoList();
  }
}

// „É°„É¢„ÇíIndexedDB„Å´‰øùÂ≠ò
async function saveMemos–¢oDB() {
  try {
    await dbSet('app_memos', MEMOS);
  } catch(error) {
    console.error('Failed to save memos:', error);
  }
}

// „É°„É¢„É™„Çπ„Éà„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞
function renderMemoList(filter = '') {
  const listEl = document.getElementById('memo-list');
  const emptyEl = document.getElementById('memo-empty');
  
  if (!listEl || !emptyEl) return;
  
  const filteredMemos = filter 
    ? MEMOS.filter(m => 
        m.title.toLowerCase().includes(filter.toLowerCase()) || 
        m.content.toLowerCase().includes(filter.toLowerCase())
      )
    : MEMOS;
  
  if (filteredMemos.length === 0) {
    listEl.style.display = 'none';
    emptyEl.style.display = 'block';
    return;
  }
  
  listEl.style.display = 'grid';
  emptyEl.style.display = 'none';
  
  listEl.innerHTML = filteredMemos
    .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
    .map(memo => `
      <div class="memo-card" onclick="editMemo('${memo.id}')">
        <div class="memo-card-title">${escapeHtml(memo.title || 'ÁÑ°È°å„ÅÆ„É°„É¢')}</div>
        <div class="memo-card-preview">${escapeHtml(memo.content.substring(0, 150))}</div>
        <div class="memo-card-footer">
          <div class="memo-card-date">
            <span>üïê</span>
            <span>${formatMemoDate(memo.updatedAt)}</span>
          </div>
          <div style="color:var(--text-muted)">
            ${memo.content.length} ÊñáÂ≠ó
          </div>
        </div>
      </div>
    `).join('');
}

// „É°„É¢Ê§úÁ¥¢„Éï„Ç£„É´„Çø„Éº
function filterMemos(query) {
  renderMemoList(query);
}

// Êñ∞Ë¶è„É°„É¢‰ΩúÊàê
function createNewMemo() {
  currentEditingMemoId = null;
  document.getElementById('memo-editor-title').value = '';
  document.getElementById('memo-editor-content').value = '';
  document.getElementById('memo-delete-btn').style.display = 'none';
  document.getElementById('memo-editor-overlay').style.display = 'flex';
  document.body.style.overflow = 'hidden';
  
  // „Éï„Ç©„Éº„Ç´„Çπ
  setTimeout(() => {
    document.getElementById('memo-editor-title').focus();
  }, 100);
}

// „É°„É¢Á∑®ÈõÜ
function editMemo(memoId) {
  const memo = MEMOS.find(m => m.id === memoId);
  if (!memo) return;
  
  currentEditingMemoId = memoId;
  document.getElementById('memo-editor-title').value = memo.title;
  document.getElementById('memo-editor-content').value = memo.content;
  document.getElementById('memo-delete-btn').style.display = 'flex';
  document.getElementById('memo-editor-overlay').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

// „É°„É¢‰øùÂ≠ò
async function saveMemo() {
  const title = document.getElementById('memo-editor-title').value.trim();
  const content = document.getElementById('memo-editor-content').value.trim();
  
  if (!content) {
    alert('„É°„É¢„ÅÆÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }
  
  const now = new Date().toISOString();
  
  if (currentEditingMemoId) {
    // Êó¢Â≠ò„É°„É¢„ÅÆÊõ¥Êñ∞
    const memo = MEMOS.find(m => m.id === currentEditingMemoId);
    if (memo) {
      memo.title = title || 'ÁÑ°È°å„ÅÆ„É°„É¢';
      memo.content = content;
      memo.updatedAt = now;
    }
  } else {
    // Êñ∞Ë¶è„É°„É¢„ÅÆ‰ΩúÊàê
    const newMemo = {
      id: 'memo_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      title: title || 'ÁÑ°È°å„ÅÆ„É°„É¢',
      content: content,
      createdAt: now,
      updatedAt: now
    };
    MEMOS.push(newMemo);
  }
  
  await saveMemos–¢oDB();
  renderMemoList();
  closeMemoEditor();
  
  // ‰øùÂ≠òÂÆå‰∫Ü„ÅÆÈÄöÁü•
  showToast(S.lang === 'en' ? 'Memo saved' : '„É°„É¢„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
}

// „É°„É¢ÂâäÈô§
async function deleteMemo() {
  if (!currentEditingMemoId) return;
  
  const confirmed = confirm(S.lang === 'en' 
    ? 'Delete this memo?' 
    : '„Åì„ÅÆ„É°„É¢„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü');
  
  if (!confirmed) return;
  
  MEMOS = MEMOS.filter(m => m.id !== currentEditingMemoId);
  await saveMemos–¢oDB();
  renderMemoList();
  closeMemoEditor();
  
  showToast(S.lang === 'en' ? 'Memo deleted' : '„É°„É¢„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
}

// „É°„É¢„Ç®„Éá„Ç£„Çø„Éº„ÇíÈñâ„Åò„Çã
function closeMemoEditor() {
  document.getElementById('memo-editor-overlay').style.display = 'none';
  document.body.style.overflow = '';
  currentEditingMemoId = null;
}

// Êó•‰ªò„Éï„Ç©„Éº„Éû„ÉÉ„Éà
function formatMemoDate(isoString) {
  const date = new Date(isoString);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 1) return '‰ªä';
  if (diffMins < 60) return `${diffMins}ÂàÜÂâç`;
  if (diffHours < 24) return `${diffHours}ÊôÇÈñìÂâç`;
  if (diffDays < 7) return `${diffDays}Êó•Ââç`;
  
  return date.toLocaleDateString(S.lang === 'en' ? 'en-US' : 'ja-JP', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}

// HTML„Ç®„Çπ„Ç±„Éº„Éó
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// „Éà„Éº„Çπ„ÉàÈÄöÁü•
function showToast(message) {
  const toast = document.createElement('div');
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    bottom: calc(var(--bottom-nav-h) + 20px);
    left: 50%;
    transform: translateX(-50%);
    background: var(--surface);
    color: var(--text-primary);
    padding: 1